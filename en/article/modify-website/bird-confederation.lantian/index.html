<!DOCTYPE html><html lang="en-US" itemscope="" itemtype="https://schema.org/Article" data-astro-cid-porej7z2=""> <head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Configure BGP Confederation &amp; Fake Confederation in Bird (Updated 2020-06-07) - Lan Tian @ Blog</title><script>
  ;(() => {
    try {
      const mode = localStorage.getItem('user-color-scheme')
      if (mode == 'dark' || mode == 'light') {
        document.documentElement.setAttribute('data-user-color-scheme', mode)
      }
    } catch {
      // Ignore errors
    }
  })()
</script><link rel="stylesheet" href="/assets/index.CUlf1-Vz.css"><style>#post-navi[data-astro-cid-gfbmwgei]{padding:5px;border-top:1px solid var(--lt-border-weak);border-bottom:1px solid var(--lt-border-weak)}
ol[data-astro-cid-nj3qel45]{margin:0;padding:0;line-height:1.5}ol[data-astro-cid-nj3qel45] .toc-item[data-astro-cid-nj3qel45]{list-style:none}ol[data-astro-cid-nj3qel45] .toc-child[data-astro-cid-nj3qel45],ol[data-astro-cid-nj3qel45] .toc[data-astro-cid-nj3qel45]{padding:0}ol[data-astro-cid-nj3qel45] .toc-link[data-astro-cid-nj3qel45]{display:block;margin-left:1em;padding:.25em 0}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;width:1em;padding:.25em 0;float:left;font-style:normal;font-variant:normal;font-weight:900;font-family:Font Awesome\ 6 Free;font-feature-settings:normal;text-align:center}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before{content:""}ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{content:""}.post-info-wrap[data-astro-cid-dckccua4]{-ms-flex:0 0 2.5em;flex:0 0 2.5em;background-color:var(--lt-component-bg-emphasis)}@media(min-width:768px){.post-info[data-astro-cid-dckccua4]{position:sticky;top:0}}@media(max-width:767.98px){.post-info[data-astro-cid-dckccua4]{position:absolute}}
</style><script type="module" src="/assets/PageLayout.astro_astro_type_script_index_0_lang.C1wfUPs6.js"></script><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Referrer-Policy" content="no-referrer, strict-origin-when-cross-origin"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="imagemode" content="force"><meta name="nightmode" content="disable"><meta name="wap-font-scale" content="no"><meta name="title" content="Configure BGP Confederation &#38; Fake Confederation in Bird (Updated 2020-06-07) - Lan Tian @ Blog"><meta name="keywords" content=""><meta name="author" content="Lan Tian"><link rel="canonical" href="https://lantian.pub/en/article/modify-website/bird-confederation.lantian/"><link rel="alternate" type="application/rss+xml" title="Lan Tian @ Blog" href="https://lantian.pub/rss2.xml"><link rel="alternate" type="application/atom+xml" title="Lan Tian @ Blog" href="https://lantian.pub/feed.xml"><link rel="alternate" href="https://lantian.pub/article/modify-website/bird-confederation.lantian/" hreflang="zh"><link rel="alternate" href="https://lantian.pub/en/article/modify-website/bird-confederation.lantian/" hreflang="en"><meta name="copyright" content="Copyright 2012-2025 Lan Tian @ Blog"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#03a9f4"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#212121"><meta name="application-name" content="Lan Tian @ Blog"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="apple-touch-icon" sizes="1024x1024" href="/apple-touch-icon-1024x1024.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#03a9f4"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Lan Tian @ Blog"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-640x1136.png"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1136x640.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-750x1334.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1334x750.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1125x2436.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2436x1125.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1170x2532.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2532x1170.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1179x2556.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2556x1179.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-828x1792.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1792x828.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2688.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2688x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2208.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2208x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1284x2778.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2778x1284.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1290x2796.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2796x1290.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1488x2266.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2266x1488.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1536x2048.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2048x1536.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1620x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1620.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1640x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1640.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2388.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2388x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2224.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2224x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-2048x2732.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2732x2048.png"><meta name="msapplication-TileColor" content="#bbdefb"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"><meta property="og:url" content="https://lantian.pub/en/article/modify-website/bird-confederation.lantian/"><meta property="og:type" content="website"><meta property="og:title" content="Configure BGP Confederation &#38; Fake Confederation in Bird (Updated 2020-06-07) - Lan Tian @ Blog"><meta property="og:image" content="https://lantian.pub/apple-touch-icon.png"><meta content="Changelog 2020-10-01: Add warning to not filter private ASNs within the internal network 2020-06-07: Add limitations of Bird confederation and a way to simulate confederation 2020-05-17: Initial version Comparison of BGP Interconnection Schemes within an ISP Most ISPs, or Internet Service Providers, use the BGP protocol to exchange their route information. Each ISP will obtain an ASN (Autonomous System Number) from the regional NIC (Network Information Center, e.g., APNIC, RIPE), like China Telecom's ASN is 4134 for example. Then, ISPs connect their boundary routers via physical links (copper line, fiber, satellite link, etc.), and configure BGP protocol on the boundary routers, so they will tell the other part that: &#34;I'm AS4134, and I can provide access to the IP block of 202.101.0...."><meta property="og:site_name" content="Lan Tian @ Blog"><meta property="og:locale" content="en"><meta name="twitter:card" content="summary"><meta name="twitter:url" content="https://lantian.pub/en/article/modify-website/bird-confederation.lantian/"><meta name="twitter:title" content="Configure BGP Confederation &#38; Fake Confederation in Bird (Updated 2020-06-07) - Lan Tian @ Blog"><meta property="twitter:image" content="https://lantian.pub/apple-touch-icon.png"><meta content="Changelog 2020-10-01: Add warning to not filter private ASNs within the internal network 2020-06-07: Add limitations of Bird confederation and a way to simulate confederation 2020-05-17: Initial version Comparison of BGP Interconnection Schemes within an ISP Most ISPs, or Internet Service Providers, use the BGP protocol to exchange their route information. Each ISP will obtain an ASN (Autonomous System Number) from the regional NIC (Network Information Center, e.g., APNIC, RIPE), like China Telecom's ASN is 4134 for example. Then, ISPs connect their boundary routers via physical links (copper line, fiber, satellite link, etc.), and configure BGP protocol on the boundary routers, so they will tell the other part that: &#34;I'm AS4134, and I can provide access to the IP block of 202.101.0...."><meta name="twitter:dnt" content="on"><meta itemprop="name" content="Configure BGP Confederation &#38; Fake Confederation in Bird (Updated 2020-06-07) - Lan Tian @ Blog"><meta property="image" content="https://lantian.pub/apple-touch-icon.png"><meta content="Changelog 2020-10-01: Add warning to not filter private ASNs within the internal network 2020-06-07: Add limitations of Bird confederation and a way to simulate confederation 2020-05-17: Initial version Comparison of BGP Interconnection Schemes within an ISP Most ISPs, or Internet Service Providers, use the BGP protocol to exchange their route information. Each ISP will obtain an ASN (Autonomous System Number) from the regional NIC (Network Information Center, e.g., APNIC, RIPE), like China Telecom's ASN is 4134 for example. Then, ISPs connect their boundary routers via physical links (copper line, fiber, satellite link, etc.), and configure BGP protocol on the boundary routers, so they will tell the other part that: &#34;I'm AS4134, and I can provide access to the IP block of 202.101.0...."><meta content="Changelog 2020-10-01: Add warning to not filter private ASNs within the internal network 2020-06-07: Add limitations of Bird confederation and a way to simulate confederation 2020-05-17: Initial version Comparison of BGP Interconnection Schemes within an ISP Most ISPs, or Internet Service Providers, use the BGP protocol to exchange their route information. Each ISP will obtain an ASN (Autonomous System Number) from the regional NIC (Network Information Center, e.g., APNIC, RIPE), like China Telecom's ASN is 4134 for example. Then, ISPs connect their boundary routers via physical links (copper line, fiber, satellite link, etc.), and configure BGP protocol on the boundary routers, so they will tell the other part that: &#34;I'm AS4134, and I can provide access to the IP block of 202.101.0...."><link rel="me" href="https://mastodon.social/@lantian"></head> <body data-astro-cid-porej7z2=""> <div id="bg" data-astro-cid-j6vmxtef=""></div>   <div id="container" class="container" data-astro-cid-porej7z2=""> <nav class="lantian navbar navbar-expand-lg" data-astro-cid-wu5dj4rx=""> <div class="container-fluid" data-astro-cid-wu5dj4rx=""> <a class="navbar-brand" href="/en/" data-astro-cid-wu5dj4rx="">Lan Tian @ Blog</a> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#lantian-navbar" aria-controls="lantian-navbar" aria-expanded="false" aria-label="Toggle navigation" data-astro-cid-wu5dj4rx=""> <span class="navbar-toggler-icon" data-astro-cid-wu5dj4rx=""></span> </button> <div class="collapse navbar-collapse" id="lantian-navbar" data-astro-cid-wu5dj4rx=""> <ul class="navbar-nav" data-astro-cid-wu5dj4rx=""> <li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/archive/index.html" data-astro-cid-wu5dj4rx=""> Posts </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> Himawari </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> <li class="nav-item dropdown d-block d-lg-none" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="pages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-file" data-astro-cid-wu5dj4rx=""></i> Page  <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="pages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/archive/index.html" data-astro-cid-wu5dj4rx=""> Posts </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> Himawari </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> </ul> </li> </ul> <ul class="navbar-nav ms-auto" data-astro-cid-wu5dj4rx=""> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="languages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-language" data-astro-cid-wu5dj4rx=""></i> Language <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="languages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/article/modify-website/bird-confederation.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-cn" data-astro-cid-wu5dj4rx=""></span> Chinese Simplified / 简体中文 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item active" href="/en/article/modify-website/bird-confederation.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-us" data-astro-cid-wu5dj4rx=""></span> English </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">Not all pages have translations.</a> </li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">You may see 404 - this is normal.</a> </li> </ul> </li> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="color-scheme-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> Night Mode </a> <ul class="dropdown-menu" aria-labelledby="color-scheme-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-auto" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> Auto </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-light" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-sun" data-astro-cid-wu5dj4rx=""></i> Light</a> </li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-dark" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-moon" data-astro-cid-wu5dj4rx=""></i> Dark</a> </li> </ul> </li> </ul> </div> </div> </nav> <script type="module">const m="user-color-scheme",s="data-user-color-scheme",u=(e,t)=>{try{localStorage.setItem(e,t)}catch{}},i=e=>{try{return localStorage.getItem(e)}catch{return null}},c=e=>{const t={dark:!0,light:!0,auto:!0},o=e===null||!Object.keys(t).includes(e)?"auto":e;u(m,o);for(const l in t){const n=document.getElementById("color-scheme-"+l);n&&(l==o?n.classList.add("active"):n.classList.remove("active"))}o!="auto"?document.documentElement.setAttribute(s,o):document.documentElement.removeAttribute(s)};c(i(m));const r=document.getElementById("color-scheme-auto");r&&r.addEventListener("click",()=>c("auto"));const a=document.getElementById("color-scheme-light");a&&a.addEventListener("click",()=>c("light"));const d=document.getElementById("color-scheme-dark");d&&d.addEventListener("click",()=>c("dark"));</script>  <div class="d-flex" data-astro-cid-porej7z2=""> <div id="content" data-astro-cid-porej7z2="">  <article> <div class="d-flex"> <div class="post-info-wrap" data-astro-cid-dckccua4=""> <div class="post-info" data-astro-cid-dckccua4=""> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-clock"></span> <br> <small>06-07</small> </p> <div class="post-meta-value"> Published on<span class="badge badge-tag" data-astro-cid-dckccua4=""> 2020-06-07 21:51 </span>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-file-alt"></span> <br> <small>Website and Servers</small> </p> <div class="post-meta-value"> Category <a class="badge badge-tag" href="/en/category/modify-website" data-astro-cid-dckccua4=""> Website and Servers </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-tag"></span> <br> <small>3 tags</small> </p> <div class="post-meta-value"> Tags  <a class="badge badge-tag" href="/en/tag/BGP" data-astro-cid-dckccua4=""> BGP </a>  <a class="badge badge-tag" href="/en/tag/Bird" data-astro-cid-dckccua4=""> Bird </a>  <a class="badge badge-tag" href="/en/tag/Confederation" data-astro-cid-dckccua4=""> Confederation </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-list"></span> <br> <small>ToC</small> </p> <div class="post-meta-value">  <ol data-astro-cid-nj3qel45=""> <li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#changelog" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Changelog</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#comparison-of-bgp-interconnection-schemes-within-an-isp" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Comparison of BGP Interconnection Schemes within an ISP</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#confederation-in-bird" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Confederation in Bird</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#checking-confederation-status" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Checking Confederation Status</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#emulating-a-confederation" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Emulating a Confederation</span> </a> </li> </ol>   </div> </div> </div> </div>  </div>  <div class="post-wrap">  <h1 class="post-title"> <a href="/en/article/modify-website/bird-confederation.lantian/" rel="bookmark" title="Configure BGP Confederation &#38; Fake Confederation in Bird (Updated 2020-06-07)">Configure BGP Confederation &amp; Fake Confederation in Bird (Updated 2020-06-07)</a> </h1> <div class="post-text">   <h2 id="changelog">Changelog</h2>
<ul>
<li>2020-10-01: Add warning to not filter private ASNs within the internal network</li>
<li>2020-06-07: Add limitations of Bird confederation and a way to simulate
confederation</li>
<li>2020-05-17: Initial version</li>
</ul>
<h2 id="comparison-of-bgp-interconnection-schemes-within-an-isp">Comparison of BGP Interconnection Schemes within an ISP</h2>
<p>Most ISPs, or Internet Service Providers, use the BGP protocol to exchange their
route information. Each ISP will obtain an ASN (Autonomous System Number) from
the regional NIC (Network Information Center, e.g., APNIC, RIPE), like China
Telecom's ASN is 4134 for example. Then, ISPs connect their boundary routers via
physical links (copper line, fiber, satellite link, etc.), and configure BGP
protocol on the boundary routers, so they will tell the other part that: "I'm
AS4134, and I can provide access to the IP block of <code>202.101.0.0/18</code>". Routers
directly connected to China Telecom will proceed on repeating that message: "I'm
ASxxxx, and I'm 1 step from the source of <code>202.101.0.0/18</code>". And it goes on.
Routers of each ISP will then consider parameters, including distance to the
target, and send packets to the best target that this router can reach.</p>
<p>(Note: The scenario above is simplified, and there are more complicated rules
for ISP interconnection and best path selection in the real world.)</p>
<p>BGP can also be necessary within a large-scale AS. For example, China Telecom,
which operates a network across the entire Mainland China, has its core routers
in each city. Each core router is responsible for a small fraction of IP ranges
China Telecom owns. To make the routers aware of the responsible router for a
specific IP, there is a couple of ways:</p>
<ol>
<li>
<p>Manually setting a static route.</p>
<ul>
<li>This is the most simple and naive way, in which a human operator tells the
router to send packets to an IP range to a specific router.</li>
<li>The downside is also apparent: for a network sized like China Telecom, the
burden on operators is so much that errors can be easily made.</li>
<li>In addition, if there is a physical connection issue between two places,
the static route will fail, and the network connection between them will
stop working. Whenever this happens, human intervention is required to
reroute the network traffic to another place.</li>
</ul>
</li>
<li>
<p>Using iBGP</p>
<ul>
<li>
<p>Just like peering with other ISPs, BGP sessions can be set up between
routers where both ends use the same ASN. This type of BGP session is
called iBGP, while sessions with different ASNs are called eBGP.</p>
</li>
<li>
<p>Only some one-time BGP session setup is needed on each of the routers. Then
on a physical link failure, all routers will automatically remove the
invalid route information and choose the next available best route.</p>
</li>
<li>
<p>But there is a severe limitation of iBGP: all routers should be connected
to each other. The reason is that:</p>
<ul>
<li>
<p>Suppose we have such a network topology:</p>
<p><!--?xml version="1.0" encoding="UTF-8" standalone="no"?--><!-- Generated by graphviz version 14.0.2 (0)
 --><!-- Pages: 1 -->
<svg width="320pt" height="155pt" viewBox="0.00 0.00 320.00 155.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 151)">
<polygon fill="white" stroke="none" points="-4,4 -4,-151 315.87,-151 315.87,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_1</title>
<polygon fill="lightgrey" stroke="lightgrey" points="8,-8 8,-139 123.87,-139 123.87,-8 8,-8"></polygon>
<text xml:space="preserve" text-anchor="middle" x="65.93" y="-122.4" font-family="Times,serif" font-size="14.00">AS1</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_2</title>
<polygon fill="lightgrey" stroke="lightgrey" points="143.87,-8 143.87,-139 303.87,-139 303.87,-8 143.87,-8"></polygon>
<text xml:space="preserve" text-anchor="middle" x="223.87" y="-122.4" font-family="Times,serif" font-size="14.00">AS2</text>
</g><!-- A -->
<g id="node1" class="node">
<title>A</title>
<polygon fill="white" stroke="white" points="92.93,-52 38.93,-52 38.93,-16 92.93,-16 92.93,-52"></polygon>
<text xml:space="preserve" text-anchor="middle" x="65.93" y="-29.8" font-family="Times,serif" font-size="14.00">A</text>
</g><!-- 10.0.0.0/8 -->
<g id="node2" class="node">
<title>10.0.0.0/8</title>
<ellipse fill="white" stroke="white" cx="65.93" cy="-88" rx="49.93" ry="18"></ellipse>
<text xml:space="preserve" text-anchor="middle" x="65.93" y="-83.8" font-family="Times,serif" font-size="14.00">10.0.0.0/8</text>
</g><!-- A&#45;&#45;10.0.0.0/8 -->
<g id="edge1" class="edge">
<title>A--10.0.0.0/8</title>
<path fill="none" stroke="black" d="M65.93,-52.14C65.93,-57.93 65.93,-63.72 65.93,-69.51"></path>
</g><!-- B -->
<g id="node3" class="node">
<title>B</title>
<polygon fill="white" stroke="white" points="205.87,-52 151.87,-52 151.87,-16 205.87,-16 205.87,-52"></polygon>
<text xml:space="preserve" text-anchor="middle" x="178.87" y="-29.8" font-family="Times,serif" font-size="14.00">B</text>
</g><!-- A&#45;&#45;B -->
<g id="edge5" class="edge">
<title>A--B</title>
<path fill="none" stroke="black" d="M93.22,-34C110.78,-34 133.78,-34 151.38,-34"></path>
</g><!-- C -->
<g id="node4" class="node">
<title>C</title>
<polygon fill="white" stroke="white" points="205.87,-106 151.87,-106 151.87,-70 205.87,-70 205.87,-106"></polygon>
<text xml:space="preserve" text-anchor="middle" x="178.87" y="-83.8" font-family="Times,serif" font-size="14.00">C</text>
</g><!-- B&#45;&#45;C -->
<g id="edge2" class="edge">
<title>B--C</title>
<path fill="none" stroke="black" d="M178.87,-52.14C178.87,-57.93 178.87,-63.72 178.87,-69.51"></path>
</g><!-- D -->
<g id="node5" class="node">
<title>D</title>
<polygon fill="white" stroke="white" points="295.87,-79 241.87,-79 241.87,-43 295.87,-43 295.87,-79"></polygon>
<text xml:space="preserve" text-anchor="middle" x="268.87" y="-56.8" font-family="Times,serif" font-size="14.00">D</text>
</g><!-- B&#45;&#45;D -->
<g id="edge3" class="edge">
<title>B--D</title>
<path fill="none" stroke="black" d="M206.27,-42.1C217.41,-45.52 230.35,-49.49 241.48,-52.9"></path>
</g><!-- C&#45;&#45;D -->
<g id="edge4" class="edge">
<title>C--D</title>
<path fill="none" stroke="black" d="M206.27,-79.9C217.41,-76.48 230.35,-72.51 241.48,-69.1"></path>
</g>
</g>
</svg>
</p>
<ul>
<li>A belongs to AS1, and B, C, D belong to AS2.</li>
<li>Now A broadcasts that it provides access to <code>10.0.0.0/8</code>.</li>
<li>B receives A's broadcast and tells C and D that it's 1 step away from
<code>10.0.0.0/8</code>, with path <code>AS2 -> AS1</code>.
<ul>
<li>Note that for a BGP path, the information of exact routers chosen is
not available; only the ASes (or ISPs) it has passed will be
recorded.</li>
</ul>
</li>
<li>C receives B's announcement and tells D that it's 2 steps away from the
target, with path <code>AS2 -> AS2 -> AS1</code>. Meanwhile, D tells C the same
thing.</li>
<li>Since BGP's path selection algorithm is not always minimizing the path
length, and can be adjusted manually or via code assigning priority, C
may route packets to D with path <code>AS2 -> AS2 -> AS2 -> AS1</code>.</li>
<li>Now, B thinks it can reach the target via either A or C. Then after
running a weird selection algorithm, B gives up on the route to A (dumb
but possible!) and routes packets to C.</li>
<li>Now, the path is <code>B -> C -> D -> B -> A</code>, where a loop is formed, and
the packet will never reach its destination.</li>
<li>What's worse, this path will be further announced to D, then C, then
B... With such an infinite loop going on, the RAM of each router will
be exhausted, the system will crash, and all packet forwarding will
come to a complete stop.</li>
</ul>
</li>
<li>
<p>To prevent such an accident from happening, there is an additional
limitation of iBGP: If a route is announced from an router from the same
AS, the route will not be announced to other routers in the same AS. Now:</p>
<ul>
<li>B sends the route to C and D.</li>
<li>Both C and D receive the route information but will not proceed to
exchange this route.</li>
<li>Now, there is a unique path from either C or D to the target, and the
infinite loop of forwarding won't happen anymore.</li>
</ul>
</li>
<li>
<p>But now a disaster strikes, and B and D are disconnected.</p>
<ul>
<li>Since C won't announce <code>10.0.0.0/8</code> to D, D doesn't know how to reach
the target anymore.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>This means that each and every pair of routers in an AS must be connected,
with BGP sessions configured.</p>
<ul>
<li>In an actual setup, a physical link between each pair is not necessary,
and routing protocols such as OSPF, Babel, etc., can handle routing
within an ISP. But since routes involving packet forwarding across ASes
(ISPs) must be handled by BGP, there must be a configured session between
each pair of routers.</li>
<li>Such a setup is unrealistic for a China-Telecom-level ISP. We need better
solutions.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Using BGP Route Reflector</p>
<ul>
<li>Route Reflector is a router with special configurations. It collects route
information from all other routers within the same AS and distributes them
to all other routers.</li>
<li>In this case, only one BGP session from each other router to the route
reflector is needed.</li>
<li>But this also means that if the Route Reflector crashes, other routers will
not have complete route information anymore, and the network will fail.</li>
<li>Of course, you can set up multiple Route Reflectors for redundancy, but
undeniably the concept of Route Reflector is opposing to the decentralized
nature of the Internet.</li>
</ul>
</li>
<li>
<p>Applying for a lot of ASNs from NIC, assign different ASNs to each router,
and configure eBGP</p>
<ul>
<li>Yes, this does result in a fully decentralized architecture. No matter the
connectivity status between any two routers, each router will obtain full
routing information, and a single point failure will not kill the whole
network.</li>
<li>The downside is obvious: Lots of ASN adds to the workload of ISP and NIC
staff, and there is a high handling fee to pay.</li>
</ul>
</li>
<li>
<p>Using BGP Confederation</p>
<ul>
<li>
<p>In BGP Confederation, each router also gets a different ASN. But unlike 4,
these internally-used ASNs do not have to be assigned from a NIC.</p>
<ul>
<li>The range of ASN 4200000000 - 4294967295 is reserved for "internal use",
and ISPs can directly use them internally. Of course, these ASNs aren't
recognized by a NIC and (usually) cannot be announced to other ISPs.
<ul>
<li><a href="/en/article/modify-website/dn42-experimental-network-2020.lantian">DN42 Experimental Network</a>,
for example, takes a small fraction of the ASN space.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Then, the ISP assigned a different internal ASN from the range to each
router. While BGP routing only does bookkeeping on ASNs passed, since each
router has a different ASN, it's the same as keeping the list of routers
passed, and therefore a loop will not happen.</p>
</li>
<li>
<p>But these private ASNs aren't recognized by other networks and may even
conflict with them (when other ISPs are using them for testing, for
example), so when sending the router information to another ISP, all
private ASNs need to be removed and replaced with the official ASN of the
ISP assigned from NIC.</p>
</li>
<li>
<p>But since each router has a different ASN, how can they know if a router is
"friendly" (within the same ISP) or "hostile" (from another ISP)? A common
identifier can be assigned to all routers in the same ISP (called
Confederation Identifier) to assist.</p>
</li>
<li>
<p>Suppose we have such a network topology:</p>
<p><!--?xml version="1.0" encoding="UTF-8" standalone="no"?--><!-- Generated by graphviz version 14.0.2 (0)
 --><!-- Pages: 1 -->
<svg width="410pt" height="155pt" viewBox="0.00 0.00 410.00 155.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 151)">
<polygon fill="white" stroke="none" points="-4,4 -4,-151 405.87,-151 405.87,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_1</title>
<polygon fill="lightgrey" stroke="lightgrey" points="8,-8 8,-139 123.87,-139 123.87,-8 8,-8"></polygon>
<text xml:space="preserve" text-anchor="middle" x="65.93" y="-122.4" font-family="Times,serif" font-size="14.00">AS1</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_2</title>
<polygon fill="lightgrey" stroke="lightgrey" points="143.87,-8 143.87,-139 303.87,-139 303.87,-8 143.87,-8"></polygon>
<text xml:space="preserve" text-anchor="middle" x="223.87" y="-122.4" font-family="Times,serif" font-size="14.00">AS2</text>
</g>
<g id="clust5" class="cluster">
<title>cluster_3</title>
<polygon fill="lightgrey" stroke="lightgrey" points="323.87,-8 323.87,-85 393.87,-85 393.87,-8 323.87,-8"></polygon>
<text xml:space="preserve" text-anchor="middle" x="358.87" y="-68.4" font-family="Times,serif" font-size="14.00">AS3</text>
</g><!-- A -->
<g id="node1" class="node">
<title>A</title>
<polygon fill="white" stroke="white" points="92.93,-52 38.93,-52 38.93,-16 92.93,-16 92.93,-52"></polygon>
<text xml:space="preserve" text-anchor="middle" x="65.93" y="-29.8" font-family="Times,serif" font-size="14.00">A</text>
</g><!-- 10.0.0.0/8 -->
<g id="node2" class="node">
<title>10.0.0.0/8</title>
<ellipse fill="white" stroke="white" cx="65.93" cy="-88" rx="49.93" ry="18"></ellipse>
<text xml:space="preserve" text-anchor="middle" x="65.93" y="-83.8" font-family="Times,serif" font-size="14.00">10.0.0.0/8</text>
</g><!-- A&#45;&#45;10.0.0.0/8 -->
<g id="edge1" class="edge">
<title>A--10.0.0.0/8</title>
<path fill="none" stroke="black" d="M65.93,-52.14C65.93,-57.93 65.93,-63.72 65.93,-69.51"></path>
</g><!-- B -->
<g id="node3" class="node">
<title>B</title>
<polygon fill="white" stroke="white" points="205.87,-52 151.87,-52 151.87,-16 205.87,-16 205.87,-52"></polygon>
<text xml:space="preserve" text-anchor="middle" x="178.87" y="-29.8" font-family="Times,serif" font-size="14.00">B</text>
</g><!-- A&#45;&#45;B -->
<g id="edge5" class="edge">
<title>A--B</title>
<path fill="none" stroke="black" d="M93.22,-34C110.78,-34 133.78,-34 151.38,-34"></path>
</g><!-- C -->
<g id="node4" class="node">
<title>C</title>
<polygon fill="white" stroke="white" points="205.87,-106 151.87,-106 151.87,-70 205.87,-70 205.87,-106"></polygon>
<text xml:space="preserve" text-anchor="middle" x="178.87" y="-83.8" font-family="Times,serif" font-size="14.00">C</text>
</g><!-- B&#45;&#45;C -->
<g id="edge2" class="edge">
<title>B--C</title>
<path fill="none" stroke="black" d="M178.87,-52.14C178.87,-57.93 178.87,-63.72 178.87,-69.51"></path>
</g><!-- D -->
<g id="node5" class="node">
<title>D</title>
<polygon fill="white" stroke="white" points="295.87,-52 241.87,-52 241.87,-16 295.87,-16 295.87,-52"></polygon>
<text xml:space="preserve" text-anchor="middle" x="268.87" y="-29.8" font-family="Times,serif" font-size="14.00">D</text>
</g><!-- B&#45;&#45;D -->
<g id="edge3" class="edge">
<title>B--D</title>
<path fill="none" stroke="black" d="M206.27,-34C217.41,-34 230.35,-34 241.48,-34"></path>
</g><!-- C&#45;&#45;D -->
<g id="edge4" class="edge">
<title>C--D</title>
<path fill="none" stroke="black" d="M206.27,-71.8C217.41,-64.96 230.35,-57.02 241.48,-50.19"></path>
</g><!-- E -->
<g id="node6" class="node">
<title>E</title>
<polygon fill="white" stroke="white" points="385.87,-52 331.87,-52 331.87,-16 385.87,-16 385.87,-52"></polygon>
<text xml:space="preserve" text-anchor="middle" x="358.87" y="-29.8" font-family="Times,serif" font-size="14.00">E</text>
</g><!-- D&#45;&#45;E -->
<g id="edge6" class="edge">
<title>D--E</title>
<path fill="none" stroke="black" d="M296.27,-34C307.41,-34 320.35,-34 331.48,-34"></path>
</g>
</g>
</svg>
</p>
<ul>
<li>A belongs to AS1, B, C, D belongs to AS2, and E belongs to AS3.</li>
<li>AS2 has BGP Confederation configured, and B, C, D has private ASNs 21,
22, and 23.</li>
<li>A announces <code>10.0.0.0/8</code>, and when B, C, D receives that, they obtain the
path:
<ul>
<li>B: <code>AS21 -> AS1</code>.</li>
<li>C: <code>AS22 -> AS21 -> AS1</code> or <code>AS22 -> AS23 -> AS21 -> AS1</code>.</li>
<li>D: <code>AS23 -> AS21 -> AS1</code> or <code>AS23 -> AS22 -> AS21 -> AS1</code>.</li>
</ul>
</li>
<li>When C sends route information to E, it removes the confederation route
within AS2 and replaces it with <code>AS2</code>, the identifier for the whole AS.
<ul>
<li>E: <code>AS3 -> AS2 -> AS1</code>.</li>
</ul>
</li>
<li>Now, when a disaster strikes and cuts connection from B to D, D can still
obtain the path <code>AS23 -> AS22 -> AS21 -> AS1</code>, and maintain normal packet
forwarding.</li>
</ul>
</li>
<li>
<p>This solution preserves the decentralized nature of the Internet against a
single point failure while also reducing the workload of NIC.</p>
</li>
<li>
<p>But there is some problem when using Confederation in Bird:</p>
<ul>
<li>Bird won't consider the confederation part while calculating distance,
which leads to weird routing results.
<ul>
<li>For example C receives <code>A -> B -> C</code> and <code>A -> B -> D -> C</code> at the same
time, and they have the same priority. Now Bird thinks the two paths
have <strong>equal</strong> lengths, and selects a route <strong>randomly</strong>, which may
lead to unnecessary traffic detours.</li>
</ul>
</li>
<li>Bird neither provides a variable for the filter to calculate
confederation length and make manual adjustments.
<ul>
<li><code>bgp_path.len</code> in Bird doesn't contain the length of Confederation, as
stated above;</li>
<li>The functionality that is most similar to my need is AIGP, a path cost
that accumulates across AS. But the value cannot be accessed by a
filter.
<ul>
<li><del>The <code>bgp_aigp</code> variable is of void type. Dunno what developers are
thinking.</del></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Manual Emulation of BGP Confederation</p>
<ul>
<li>It's the same thing as Confederation, but instead of assigning a common
Confederation Identifier, all routers still run individually.</li>
<li>Then while broadcasting routes to other ASes, a filter is used to remove
private ASNs to simulate the effect of Confederation.
<ul>
<li><strong>WARNING:</strong> Do not filter your private ASNs within your network! Or you
will end up with a routing loop.</li>
</ul>
</li>
<li>The advantage is that all goodness of Confederation is kept, and the path
length is calculated normally (no more detours);</li>
<li>The disadvantage is that it's easier to make configuration mistakes, like
broadcasting routes without removing private ASNs.</li>
</ul>
</li>
</ol>
<p>Next I will first introduce the configuration of native Confederation in Bird,
then the emulation of Confederation.</p>
<h2 id="confederation-in-bird">Confederation in Bird</h2>
<p>I will take my DN42 network as an example. Except the
<a href="/en/page/dn42">4 nodes that I publically accept peerings</a>, I have 14 other
nodes that aren't open to peerings due to duplicated region, stability, or
system configuration reasons. However all of them are still connected to DN42
and run Bird to exchange BGP routes.</p>
<p>Before I setup Confederation, it's cumbersome to monitor and maintain BGP
sessions between 18 nodes. The ZeroTier One VPN has stability issues from time
to time, and a BGP session disconnection will occur, stopping nodes from
obtaining full route information.</p>
<p>I had a configuration file similar to:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">template</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> bgp</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> lantian_internal</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">  local</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> as</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> DN42_AS</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  path</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> metric</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  direct</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  enable</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> extended</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> messages</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> on</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  ipv4</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">    next</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> hop</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> self</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> yes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">    import</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> filter</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ltnet_filter_v4</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(); };</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    export</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> filter</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> { </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">ltnet_filter_v4</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(); };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  ipv6</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">    next</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> hop</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> self</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> yes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">    import</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> filter</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ltnet_filter_v6</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(); };</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    export</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> filter</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> { </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">ltnet_filter_v6</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(); };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">protocol</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> bgp</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ltnet_other_server</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> from</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> lantian_internal</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  neighbor</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> NEIGHBOR_IP</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> as</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> DN42_AS</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">};</span></span></code></pre>
<p>This is a standard iBGP configuration (except that I enabled extended message
and next-hop self).</p>
<p>For Confederation I need to assign a private ASN to each node. Since my nodes
are connected to both DN42 and NeoNetwork, which occupy <code>424242XXXX</code> and
<code>420127XXXX</code> respectively, I chose <code>422547XXXX</code> as my private ASN range to avoid
conflicts.</p>
<p>(No hobby network will take this range right? Right?)</p>
<p>Since I use ZeroTier One for my internal network, and each node gets an
automatically assign IP in <code>172.18.0.0/24</code>, I simply format the ASN as
<code>4225470000 + Last digits of IP</code>.</p>
<p>Next, let's modify Bird configuration. First set Confederation Identifier to
identify friendlies:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">confederation</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> DN42_AS</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">confederation</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> member</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> yes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span></code></pre>
<p>I simply used my DN42 ASN (4242422547) as Confederation Identifier and enabled
<code>confederation member</code> option to tell Bird that it's a fellow peer on the other
side.</p>
<p>Then change the local ASN from what's assigned from DN42 into something in the
private range:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">local</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> as</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> LTNET_AS</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span></code></pre>
<p>The next problem is deciding the ASN for the neighbor (the other side). Yes, I
can fill in the neighbor ASNs one by one, but this is too much of a hassle.
Luckily Bird supports setting a neighbor as "External" without specifying an
ASN. Now, as long as the neighbor ASN isn't the same as yours, a BGP session can
be established:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">neighbor</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> NEIGHBOR_IP</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> external</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span></code></pre>
<p>The updated configuration file looks like:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">template</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> bgp</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> lantian_internal</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">  local</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> as</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> LTNET_AS</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  confederation</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> DN42_AS</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  confederation</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> member</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> yes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  path</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> metric</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  direct</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  enable</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> extended</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> messages</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> on</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  ipv4</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">    next</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> hop</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> self</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> yes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">    import</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> filter</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ltnet_filter_v4</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(); };</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    export</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> filter</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> { </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">ltnet_filter_v4</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(); };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  ipv6</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">    next</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> hop</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> self</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> yes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">    import</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> filter</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ltnet_filter_v6</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(); };</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    export</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> filter</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> { </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">ltnet_filter_v6</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(); };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">protocol</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> bgp</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ltnet_other_server</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> from</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> lantian_internal</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  neighbor</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> NEIGHBOR_IP</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> external</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">};</span></span></code></pre>
<h2 id="checking-confederation-status">Checking Confederation Status</h2>
<p>After modifying all configuration and running <code>birdc configure</code>, check the route
on one of the nodes:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># birdc show route for 172.23.0.53 all</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Only one route is kept to shorten the paragraph</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">BIRD</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 2.0.7</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ready.</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Table</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> master4:</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">172.23.0.53/32</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">       unicast</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> [ltnet_hostdare </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">20:16:32.922</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> from</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> fcf9:a876:eddd:c85a:8a93::1]</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> *</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (100) [AS4242422601i]</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        via</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 172.18.0.65</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> on</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ztppir7etp</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        Type:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> BGP</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> univ</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        BGP.origin:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> IGP</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        BGP.as_path:</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (4225470065) 4242422601</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        BGP.next_hop:</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 172.18.0.65</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        BGP.med:</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 0</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        BGP.local_pref:</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 9103</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        BGP.community:</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (64511,6) (</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">64511,24</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) (</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">64511,33</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) (</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">64511,44</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        BGP.large_community:</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (4242422601, </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">120,</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 26</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"></span></code></pre>
<p>Now an ASN is put into brackets in <code>BGP.as_path</code>, which is the private ASN in
Confederation. From the perspective of another ASN, this route looks like:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># birdc show route for 172.23.0.53 all</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Only one route is kept to shorten the paragraph</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">BIRD</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 2.0.7</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ready.</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Table</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> master4:</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">172.23.0.53/32</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">       unicast</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> [ltnet_gigsgigscloud </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">16:39:43.377</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> from</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> fcf9:a876:ed8b:c606:ba01::1]</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> *</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (100) [AS4242422601i]</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        via</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 172.18.0.1</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> on</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> zt0</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        Type:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> BGP</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> univ</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        BGP.origin:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> IGP</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        BGP.as_path:</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 4242422547</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 4242422601</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        BGP.next_hop:</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 172.18.0.1</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        BGP.local_pref:</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 9103</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        BGP.community:</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (64511,6) (</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">64511,24</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) (</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">64511,33</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) (</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">64511,44</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        BGP.large_community:</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (4242422601, </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">120,</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 26</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span></code></pre>
<p>The private ASN previously in brackets is automatically replaced with
4242422547, the ASN assigned by DN42. Now when viewed outside, the whole AS is
still a whole AS.</p>
<h2 id="emulating-a-confederation">Emulating a Confederation</h2>
<p>The internal network configuration is mostly the same as Bird Confederation,
assigning different ASNs and updating neighbor definitions:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># See Bird Confederation for details</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">local</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> as</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> LTNET_AS</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">neighbor</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> NEIGHBOR_IP</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> external</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span></code></pre>
<p>But <strong>do not</strong> add the following lines which enable Bird's own Confederation:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">confederation</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> DN42_AS</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">confederation</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> member</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> yes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span></code></pre>
<p>Instead, we modify all external BGP sessions and add this filter:=</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">export</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> filter</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Add this line which removes all internal ASNs</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Remember to change to your own range!</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  bgp_path.delete([4225470000..4225479999]</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">);</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Other rules may exist here, but omitted</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  accept</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p><strong>WARNING Again:</strong> Do not add this filter to internal peerings, or you will end
up with a loop.</p>
<p>You need to make sure that <strong>every</strong> external BGP session is properly
configured, or something interesting will happen.</p>  </div>  <div class="clearfix" id="post-navi" data-astro-cid-gfbmwgei=""> <div class="float-end text-end" data-astro-cid-gfbmwgei=""> <a href="/en/article/modify-website/x32-abi-docker-containers.lantian/" title="x32 ABI and Docker Containers" data-astro-cid-gfbmwgei=""> x32 ABI and Docker Containers </a> <br data-astro-cid-gfbmwgei=""> Next post »
</div> <div class="float-start text-start position-absolute" data-astro-cid-gfbmwgei="">
« Previous post <br data-astro-cid-gfbmwgei=""> <a href="/en/article/modify-computer/senior-design-sensor-network-bugs-resolve.lantian/" title="Graduation Design - Sensor Network Development Log" data-astro-cid-gfbmwgei=""> Graduation Design - Sensor Network Development Log </a> </div> </div>  <div id="waline" data-waline-language="en-US" data-waline-path="/en/article/modify-website/bird-confederation.lantian"></div> <script type="module" src="/assets/WalineComment.astro_astro_type_script_index_0_lang.Dqib3X1E.js"></script>  </div> </div> </article>  </div> <aside class="d-none d-xl-block"> <section class="widget"> <h3>Latest posts</h3> <ul class="list-unstyled"> <li> 07-20  <a href="/en/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/">Legal LTE Network at Home with Open5GS</a> </li><li> 06-27  <a href="/en/article/modify-computer/sidestore-without-stosvpn-across-lan.lantian/">Using SideStore without StosVPN across your LAN</a> </li><li> 05-19  <a href="/en/article/modify-computer/nix-logarithmetic-math-library-from-zero.lantian/">Nix Logarithmic Math Library from Ground Zero</a> </li><li> 04-06  <a href="/en/article/modify-computer/legal-lte-network-at-home-for-100-bucks.lantian/">Legal LTE Network at Home for $100</a> </li><li> 02-10  <a href="/en/article/modify-computer/build-custom-android-kernel-with-nix.lantian/">Building Custom Android Kernel with Nix</a> </li><li> 04-20  <a href="/en/article/modify-website/migrate-blog-to-astro-js.lantian/">Migrating My Blog to Astro.js</a> </li><li> 12-16  <a href="/en/article/modify-computer/nixos-low-ram-vps.lantian/">NixOS Series 5: Creating Disk Image for Low RAM VPS</a> </li><li> 09-20  <a href="/en/article/modify-computer/nix-trigonometric-math-library-from-zero.lantian/">Nix Trigonometric Math Library from Ground Zero</a> </li><li> 05-29  <a href="/en/article/random-notes/pipewire-sigkill-fix.lantian/">Preventing Pipewire from being SIGKILLed</a> </li><li> 05-12  <a href="/en/article/modify-website/how-to-kill-the-dn42-network.lantian/">How to Kill the DN42 Network (Updated 2023-05-12)</a> </li><li> 05-08  <a href="/en/article/modify-computer/laptop-muxed-nvidia-passthrough.lantian/">NVIDIA GPU Passthrough on an Optimus MUXed Laptop (Updated 2023-05)</a> </li><li> 04-17  <a href="/en/article/random-notes/fix-china-telecom-roaming-no-4g-on-aosp-rom.lantian/">Fix China Telecom 4G Roaming on AOSP ROM by Changing APN</a> </li><li> 03-26  <a href="/en/article/random-notes/old-hp-workstation-as-all-in-one.lantian/">Notes on Setting Up NAS+Router on Old HP Workstation</a> </li><li> 01-14  <a href="/en/article/modify-computer/nixos-impermanence.lantian/">NixOS Series 4: &quot;Stateless&quot; Operating System</a> </li><li> 06-21  <a href="/en/article/modify-computer/nixos-packaging.lantian/">NixOS Series 3: Software Packaging 101</a> </li> </ul> </section> <section class="widget"> <h3>Latest comments</h3> <ul class="list-unstyled" id="recent-comments">  <li><a href="#">Loading...</a></li>  </ul> </section> <script type="module">const i=window.location.hostname=="localhost"?"https://comments.lantian.pub":window.location.origin;fetch(`${i}/api/comment?type=recent&count=10`).then(t=>{if(t.status!==200)throw new Error(`Server returned bad HTTP status ${t.status}`);return t.json()}).then(t=>{const e=document.getElementById("recent-comments");e&&(e.innerHTML=t.data.map(n=>{const o=n.comment.replace(/(<([^>]+)>)/gi,"");return"<li>"+n.nick+' <a href="'+n.url+'">'+o+"</a></li>"}).join(""))});</script> <section class="widget"> <h3>Others</h3> <ul class="list-unstyled">  <li> <i class="fas fa-fw fa-rss"></i>  <a href="/rss2.xml" target="_blank">RSS Feed</a> |  <a href="/feed.xml" target="_blank">Atom</a> |  <a href="/feed.json" target="_blank">JSON</a> </li> <li> <i class="fas fa-fw fa-globe"></i>  <a href="https://stats.uptimerobot.com/BLK6VsRkR" target="_blank"> Sever Status </a> </li> <li> <i class="fas fa-fw fa-sitemap"></i>  <a href="https://lg.lantian.pub" target="_blank">DN42 Looking Glass</a> </li> <li> <i class="fas fa-fw fa-link"></i>  <a href="gopher://lantian.pub" target="_blank">Access with Gopher protocol</a> </li>  </ul> </section> <section class="widget"> <h3>Links</h3> <ul class="list-unstyled"> <li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://0x7f.cc"> 0x7f Blog 🐑 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="http://foreverblog.cn"> 10 Year&#39;s Promise (Forever Blog) </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://alanyhq.com"> Alanyhq </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.baoshuo.ren/?utm_source=friends"> Baoshuo&#39;s Blog </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.cas7.moe"> Blog of Moecast </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://jerryxiao.cc"> JerryXiao </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://sangsir.com"> SangSir </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://snli.org"> Shucheng Li </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://yuetau.net"> YuetAu&#39;s Spot </a> </li> </ul> </section> </aside> </div> <footer class="lantian clearfix" data-astro-cid-w3csb3e3="">  <div id="copyright" class="float-end text-end" data-astro-cid-w3csb3e3=""> <i class="fas fa-copyright" data-astro-cid-w3csb3e3=""></i> 2012-2025 Lan Tian @ Blog<br data-astro-cid-w3csb3e3=""> <small data-astro-cid-w3csb3e3=""> Powered by Astro v5.15.1 @ 2025-10-25 23:46:38 </small> </div> <script type="module">function v(c,o,r){const h=/^localhost$|^127(?:\.[0-9]+){0,2}\.[0-9]+$|^(?:0*:)*?:?0*1$/.test(location.hostname)||location.protocol==="file:";if(!o.trackLocalhost&&h)return console.warn("[Plausible] Ignoring event because website is running locally");try{if(window.localStorage.plausible_ignore==="true")return console.warn('[Plausible] Ignoring event because "plausible_ignore" is set to "true" in localStorage')}catch{}const p={n:c,u:o.url,d:o.domain,r:o.referrer,w:o.deviceWidth,h:o.hashMode?1:0,p:r&&r.props?JSON.stringify(r.props):void 0},s=new XMLHttpRequest;s.open("POST",`${o.apiHost}/api/event`,!0),s.setRequestHeader("Content-Type","text/plain"),s.send(JSON.stringify(p)),s.onreadystatechange=()=>{s.readyState===4&&r&&r.callback&&r.callback()}}function b(c){const o=()=>({hashMode:!1,trackLocalhost:!1,url:location.href,domain:location.hostname,referrer:document.referrer||null,deviceWidth:window.innerWidth,apiHost:"https://plausible.io",...c}),r=(t,n,i)=>{v(t,{...o(),...i},n)},h=(t,n)=>{r("pageview",n,t)};return{trackEvent:r,trackPageview:h,enableAutoPageviews:()=>{const t=()=>h(),n=history.pushState;return n&&(history.pushState=function(i,l,u){n.apply(this,[i,l,u]),t()},addEventListener("popstate",t)),c&&c.hashMode&&addEventListener("hashchange",t),h(),function(){n&&(history.pushState=n,removeEventListener("popstate",t)),c&&c.hashMode&&removeEventListener("hashchange",t)}},enableAutoOutboundTracking:(t=document,n={subtree:!0,childList:!0,attributes:!0,attributeFilter:["href"]})=>{function i(e){r("Outbound Link: Click",{props:{url:this.href}}),typeof process<"u"&&process,setTimeout(()=>{location.href=this.href},150),e.preventDefault()}const l=new Set;function u(e){e instanceof HTMLAnchorElement?e.host!==location.host&&(e.addEventListener("click",i),l.add(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(u)}function f(e){e instanceof HTMLAnchorElement?(e.removeEventListener("click",i),l.delete(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(f)}const d=new MutationObserver(e=>{e.forEach(a=>{a.type==="attributes"?(f(a.target),u(a.target)):a.type==="childList"&&(a.addedNodes.forEach(u),a.removedNodes.forEach(f))})});return t.querySelectorAll("a").forEach(u),d.observe(t,n),function(){l.forEach(a=>{a.removeEventListener("click",i)}),l.clear(),d.disconnect()}}}}const g=b({domain:"lantian.pub",trackLocalhost:!0,apiHost:""});g.trackPageview();</script> </footer>  </div>  </body> </html>