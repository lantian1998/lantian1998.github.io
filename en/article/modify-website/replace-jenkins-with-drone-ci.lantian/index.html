<!DOCTYPE html><html lang="en-US" itemscope="" itemtype="https://schema.org/Article" data-astro-cid-porej7z2=""> <head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Replace Jenkins with Drone CI - Lan Tian @ Blog</title><script>
  ;(() => {
    try {
      const mode = localStorage.getItem('user-color-scheme')
      if (mode == 'dark' || mode == 'light') {
        document.documentElement.setAttribute('data-user-color-scheme', mode)
      }
    } catch {
      // Ignore errors
    }
  })()
</script><link rel="stylesheet" href="/assets/index.CUlf1-Vz.css"><style>#post-navi[data-astro-cid-gfbmwgei]{padding:5px;border-top:1px solid var(--lt-border-weak);border-bottom:1px solid var(--lt-border-weak)}
ol[data-astro-cid-nj3qel45]{margin:0;padding:0;line-height:1.5}ol[data-astro-cid-nj3qel45] .toc-item[data-astro-cid-nj3qel45]{list-style:none}ol[data-astro-cid-nj3qel45] .toc-child[data-astro-cid-nj3qel45],ol[data-astro-cid-nj3qel45] .toc[data-astro-cid-nj3qel45]{padding:0}ol[data-astro-cid-nj3qel45] .toc-link[data-astro-cid-nj3qel45]{display:block;margin-left:1em;padding:.25em 0}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;width:1em;padding:.25em 0;float:left;font-style:normal;font-variant:normal;font-weight:900;font-family:Font Awesome\ 6 Free;font-feature-settings:normal;text-align:center}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before{content:""}ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{content:""}.post-info-wrap[data-astro-cid-dckccua4]{-ms-flex:0 0 2.5em;flex:0 0 2.5em;background-color:var(--lt-component-bg-emphasis)}@media(min-width:768px){.post-info[data-astro-cid-dckccua4]{position:sticky;top:0}}@media(max-width:767.98px){.post-info[data-astro-cid-dckccua4]{position:absolute}}
</style><script type="module" src="/assets/PageLayout.astro_astro_type_script_index_0_lang.C1wfUPs6.js"></script><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Referrer-Policy" content="no-referrer, strict-origin-when-cross-origin"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="imagemode" content="force"><meta name="nightmode" content="disable"><meta name="wap-font-scale" content="no"><meta name="title" content="Replace Jenkins with Drone CI - Lan Tian @ Blog"><meta name="keywords" content=""><meta name="author" content="Lan Tian"><link rel="canonical" href="https://lantian.pub/en/article/modify-website/replace-jenkins-with-drone-ci.lantian/"><link rel="alternate" type="application/rss+xml" title="Lan Tian @ Blog" href="https://lantian.pub/rss2.xml"><link rel="alternate" type="application/atom+xml" title="Lan Tian @ Blog" href="https://lantian.pub/feed.xml"><link rel="alternate" href="https://lantian.pub/article/modify-website/replace-jenkins-with-drone-ci.lantian/" hreflang="zh"><link rel="alternate" href="https://lantian.pub/en/article/modify-website/replace-jenkins-with-drone-ci.lantian/" hreflang="en"><meta name="copyright" content="Copyright 2012-2025 Lan Tian @ Blog"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#03a9f4"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#212121"><meta name="application-name" content="Lan Tian @ Blog"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="apple-touch-icon" sizes="1024x1024" href="/apple-touch-icon-1024x1024.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#03a9f4"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Lan Tian @ Blog"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-640x1136.png"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1136x640.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-750x1334.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1334x750.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1125x2436.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2436x1125.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1170x2532.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2532x1170.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1179x2556.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2556x1179.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-828x1792.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1792x828.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2688.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2688x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2208.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2208x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1284x2778.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2778x1284.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1290x2796.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2796x1290.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1488x2266.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2266x1488.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1536x2048.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2048x1536.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1620x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1620.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1640x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1640.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2388.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2388x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2224.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2224x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-2048x2732.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2732x2048.png"><meta name="msapplication-TileColor" content="#bbdefb"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"><meta property="og:url" content="https://lantian.pub/en/article/modify-website/replace-jenkins-with-drone-ci.lantian/"><meta property="og:type" content="website"><meta property="og:title" content="Replace Jenkins with Drone CI - Lan Tian @ Blog"><meta property="og:image" content="https://lantian.pub/apple-touch-icon.png"><meta content="Jenkins is a free and open-source CI/CD software widely used in all kinds of scenarios. The main advantage of Jenkins is its grand collection of plugins capable of all sorts of jobs, including deploying with SCP or Ansible , analyzing code with Cppcheck , and notifying job status with Telegram or DingTalk . Previously I also used Jenkins for automation of numerous jobs, like rebuilding my Docker images , deploying the blog you're visiting right now, and even auto sign-in to Genshin Impact . But Jenkins is a CI with a long history, and its predecessor Hudson was released back in 2005. Therefore, Jenkins executes commands directly when it comes to running jobs instead of using modern approaches such as containers...."><meta property="og:site_name" content="Lan Tian @ Blog"><meta property="og:locale" content="en"><meta name="twitter:card" content="summary"><meta name="twitter:url" content="https://lantian.pub/en/article/modify-website/replace-jenkins-with-drone-ci.lantian/"><meta name="twitter:title" content="Replace Jenkins with Drone CI - Lan Tian @ Blog"><meta property="twitter:image" content="https://lantian.pub/apple-touch-icon.png"><meta content="Jenkins is a free and open-source CI/CD software widely used in all kinds of scenarios. The main advantage of Jenkins is its grand collection of plugins capable of all sorts of jobs, including deploying with SCP or Ansible , analyzing code with Cppcheck , and notifying job status with Telegram or DingTalk . Previously I also used Jenkins for automation of numerous jobs, like rebuilding my Docker images , deploying the blog you're visiting right now, and even auto sign-in to Genshin Impact . But Jenkins is a CI with a long history, and its predecessor Hudson was released back in 2005. Therefore, Jenkins executes commands directly when it comes to running jobs instead of using modern approaches such as containers...."><meta name="twitter:dnt" content="on"><meta itemprop="name" content="Replace Jenkins with Drone CI - Lan Tian @ Blog"><meta property="image" content="https://lantian.pub/apple-touch-icon.png"><meta content="Jenkins is a free and open-source CI/CD software widely used in all kinds of scenarios. The main advantage of Jenkins is its grand collection of plugins capable of all sorts of jobs, including deploying with SCP or Ansible , analyzing code with Cppcheck , and notifying job status with Telegram or DingTalk . Previously I also used Jenkins for automation of numerous jobs, like rebuilding my Docker images , deploying the blog you're visiting right now, and even auto sign-in to Genshin Impact . But Jenkins is a CI with a long history, and its predecessor Hudson was released back in 2005. Therefore, Jenkins executes commands directly when it comes to running jobs instead of using modern approaches such as containers...."><meta content="Jenkins is a free and open-source CI/CD software widely used in all kinds of scenarios. The main advantage of Jenkins is its grand collection of plugins capable of all sorts of jobs, including deploying with SCP or Ansible , analyzing code with Cppcheck , and notifying job status with Telegram or DingTalk . Previously I also used Jenkins for automation of numerous jobs, like rebuilding my Docker images , deploying the blog you're visiting right now, and even auto sign-in to Genshin Impact . But Jenkins is a CI with a long history, and its predecessor Hudson was released back in 2005. Therefore, Jenkins executes commands directly when it comes to running jobs instead of using modern approaches such as containers...."><link rel="me" href="https://mastodon.social/@lantian"></head> <body data-astro-cid-porej7z2=""> <div id="bg" data-astro-cid-j6vmxtef=""></div>   <div id="container" class="container" data-astro-cid-porej7z2=""> <nav class="lantian navbar navbar-expand-lg" data-astro-cid-wu5dj4rx=""> <div class="container-fluid" data-astro-cid-wu5dj4rx=""> <a class="navbar-brand" href="/en/" data-astro-cid-wu5dj4rx="">Lan Tian @ Blog</a> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#lantian-navbar" aria-controls="lantian-navbar" aria-expanded="false" aria-label="Toggle navigation" data-astro-cid-wu5dj4rx=""> <span class="navbar-toggler-icon" data-astro-cid-wu5dj4rx=""></span> </button> <div class="collapse navbar-collapse" id="lantian-navbar" data-astro-cid-wu5dj4rx=""> <ul class="navbar-nav" data-astro-cid-wu5dj4rx=""> <li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/archive/index.html" data-astro-cid-wu5dj4rx=""> Posts </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> Himawari </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> <li class="nav-item dropdown d-block d-lg-none" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="pages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-file" data-astro-cid-wu5dj4rx=""></i> Page  <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="pages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/archive/index.html" data-astro-cid-wu5dj4rx=""> Posts </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> Himawari </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> </ul> </li> </ul> <ul class="navbar-nav ms-auto" data-astro-cid-wu5dj4rx=""> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="languages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-language" data-astro-cid-wu5dj4rx=""></i> Language <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="languages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/article/modify-website/replace-jenkins-with-drone-ci.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-cn" data-astro-cid-wu5dj4rx=""></span> Chinese Simplified / 简体中文 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item active" href="/en/article/modify-website/replace-jenkins-with-drone-ci.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-us" data-astro-cid-wu5dj4rx=""></span> English </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">Not all pages have translations.</a> </li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">You may see 404 - this is normal.</a> </li> </ul> </li> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="color-scheme-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> Night Mode </a> <ul class="dropdown-menu" aria-labelledby="color-scheme-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-auto" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> Auto </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-light" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-sun" data-astro-cid-wu5dj4rx=""></i> Light</a> </li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-dark" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-moon" data-astro-cid-wu5dj4rx=""></i> Dark</a> </li> </ul> </li> </ul> </div> </div> </nav> <script type="module">const m="user-color-scheme",s="data-user-color-scheme",u=(e,t)=>{try{localStorage.setItem(e,t)}catch{}},i=e=>{try{return localStorage.getItem(e)}catch{return null}},c=e=>{const t={dark:!0,light:!0,auto:!0},o=e===null||!Object.keys(t).includes(e)?"auto":e;u(m,o);for(const l in t){const n=document.getElementById("color-scheme-"+l);n&&(l==o?n.classList.add("active"):n.classList.remove("active"))}o!="auto"?document.documentElement.setAttribute(s,o):document.documentElement.removeAttribute(s)};c(i(m));const r=document.getElementById("color-scheme-auto");r&&r.addEventListener("click",()=>c("auto"));const a=document.getElementById("color-scheme-light");a&&a.addEventListener("click",()=>c("light"));const d=document.getElementById("color-scheme-dark");d&&d.addEventListener("click",()=>c("dark"));</script>  <div class="d-flex" data-astro-cid-porej7z2=""> <div id="content" data-astro-cid-porej7z2="">  <article> <div class="d-flex"> <div class="post-info-wrap" data-astro-cid-dckccua4=""> <div class="post-info" data-astro-cid-dckccua4=""> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-clock"></span> <br> <small>08-29</small> </p> <div class="post-meta-value"> Published on<span class="badge badge-tag" data-astro-cid-dckccua4=""> 2021-08-29 02:18 </span>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-file-alt"></span> <br> <small>Website and Servers</small> </p> <div class="post-meta-value"> Category <a class="badge badge-tag" href="/en/category/modify-website" data-astro-cid-dckccua4=""> Website and Servers </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-tag"></span> <br> <small>3 tags</small> </p> <div class="post-meta-value"> Tags  <a class="badge badge-tag" href="/en/tag/CI" data-astro-cid-dckccua4=""> CI </a>  <a class="badge badge-tag" href="/en/tag/Jenkins" data-astro-cid-dckccua4=""> Jenkins </a>  <a class="badge badge-tag" href="/en/tag/Drone" data-astro-cid-dckccua4=""> Drone </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-list"></span> <br> <small>ToC</small> </p> <div class="post-meta-value">  <ol data-astro-cid-nj3qel45=""> <li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#install-drone" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Install Drone</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#basic-drone-cicd" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Basic Drone CI/CD</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#matrix-build" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Matrix Build</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#aborting-build-early" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Aborting Build Early</span> </a> </li> </ol>   </div> </div> </div> </div>  </div>  <div class="post-wrap">  <h1 class="post-title"> <a href="/en/article/modify-website/replace-jenkins-with-drone-ci.lantian/" rel="bookmark" title="Replace Jenkins with Drone CI">Replace Jenkins with Drone CI</a> </h1> <div class="post-text">   <p>Jenkins is a free and open-source CI/CD software widely used in all kinds of
scenarios. The main advantage of Jenkins is its grand collection of plugins
capable of all sorts of jobs, including deploying with
<a href="https://plugins.jenkins.io/scp/" rel="noopener noreferrer" target="_blank">SCP</a> or
<a href="https://plugins.jenkins.io/ansible/" rel="noopener noreferrer" target="_blank">Ansible</a>, analyzing code with
<a href="https://plugins.jenkins.io/cppcheck/" rel="noopener noreferrer" target="_blank">Cppcheck</a>, and notifying job status with
<a href="https://plugins.jenkins.io/telegram-notifications/" rel="noopener noreferrer" target="_blank">Telegram</a> or
<a href="https://plugins.jenkins.io/dingding-notifications/" rel="noopener noreferrer" target="_blank">DingTalk</a>.</p>
<p>Previously I also used Jenkins for automation of numerous jobs, like rebuilding
<a href="https://github.com/xddxdd/dockerfiles" rel="noopener noreferrer" target="_blank">my Docker images</a>, deploying the blog
you're visiting right now, and even
<a href="https://github.com/y1ndan/genshinhelper" rel="noopener noreferrer" target="_blank">auto sign-in to Genshin Impact</a>.</p>
<p>But Jenkins is a CI with a long history, and its predecessor Hudson was released
back in 2005. Therefore, Jenkins executes commands directly when it comes to
running jobs instead of using modern approaches such as containers. This means
that whether a CI pipeline succeeds will largely depend on the environment of
the Worker host. For example, I rented a dedicated server with higher specs. As
I rebuilt my whole environment, I was greeted with a number of weird issues,
which took me about a week to find out and fix.</p>
<p>In addition, Jenkins is written in Java, hence its high memory consumption. A
Jenkins instance can take as much as 1GB RAM, which makes it impossible for a
low specs server to run even the simplest tasks. In addition, it's hard to use
all the awesomeness of Jenkins plugins from a configuration file. A lot of
plugins didn't implement the functionality of setting parameters from a
Jenkinsfile, and such plugins can only be configured one-by-one on the Jenkins
webpage, which is a complicated and error-prone process.</p>
<p>By comparison, <a href="https://www.drone.io/" rel="noopener noreferrer" target="_blank">Drone</a> the container-based CI is a
relatively modern approach. Drone recommends its
<a href="https://readme.drone.io/runner/docker/overview/" rel="noopener noreferrer" target="_blank">Docker-container-based Worker (called Runner by the Drone folks)</a>.
As containers are used as execution environments, Drone fully exploits the
advantage of containers: consistency. As long as the container image is
consistent, you can be sure that those CI commands will be executed under the
same environment every time, and its output should be stable. Of course, if your
script cannot run in a container by any means, Drone also has runners for
<a href="https://readme.drone.io/runner/exec/overview/" rel="noopener noreferrer" target="_blank">executing commands directly on host</a>
or
<a href="https://readme.drone.io/runner/digitalocean/overview/" rel="noopener noreferrer" target="_blank">in a DigitalOcean cloud server</a>.</p>
<p>Drone also has a lot of other advantages: Drone is written in Go, using
one-tenth the memory of Jenkins; Drone's configuration files are written in YAML
or Jsonnet, unlike the special language of Jenkinsfile; Although the number of
<a href="http://plugins.drone.io/" rel="noopener noreferrer" target="_blank">Drone's plugins</a> is comparatively smaller to Jenkins,
all of them are Docker containers and can be used from the configuration file.</p>








































<table><thead><tr><th></th><th>Jenkins</th><th>Drone</th></tr></thead><tbody><tr><td>Environment</td><td>Worker's host</td><td>Your choice: Docker container, Worker's host, or DigitalOcean cloud server</td></tr><tr><td>Config syntax</td><td>Special language: Jenkinsfile</td><td>Generic YAML/Jsonnet</td></tr><tr><td>Plugins</td><td>More, 1836 (as of this is written)</td><td>Less, 102</td></tr><tr><td>Plugin config</td><td>Web-based, some available through config file</td><td>All in config file</td></tr><tr><td>Programming Language</td><td>Java</td><td>Go</td></tr><tr><td>Memory Usage</td><td>More, around 1GB</td><td>Less, around 100MB</td></tr></tbody></table>
<h2 id="install-drone">Install Drone</h2>
<p>As a containerized CI, Drone itself is a Docker container and is configured
through environment variables. Drone can be connected to
<a href="https://readme.drone.io/server/provider/github/" rel="noopener noreferrer" target="_blank">GitHub</a>,
<a href="https://readme.drone.io/server/provider/gitlab/" rel="noopener noreferrer" target="_blank">GitLab</a>,
<a href="https://readme.drone.io/server/provider/gitea/" rel="noopener noreferrer" target="_blank">Gitea</a> or
<a href="https://readme.drone.io/server/provider/bitbucket-cloud/" rel="noopener noreferrer" target="_blank">BitBucket</a>, please
refer to the linked official documents for guides. However, one Drone instance
can only connect to one of them. If you are like me, who needs CI on both GitHub
and my own Gitea instance, you will need two sets of Drone.</p>
<p>If you plan to use Drone for deploying, you will need some way to pass your
deployment keys to Drone. I use secret management software
<a href="https://www.vaultproject.io/" rel="noopener noreferrer" target="_blank">Vault</a>,
<a href="https://docs.drone.io/secret/external/vault/" rel="noopener noreferrer" target="_blank">with official support from Drone</a>.
Of course, you can simply store your secrets in Drone, but not through its web
UI. You must
<a href="https://readme.drone.io/secret/" rel="noopener noreferrer" target="_blank">use Drone's command-line tool for that</a>.</p>
<p>Here is my configuration with Vault and Drone for reference:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'2.4'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Secret management, Vault instance, and plugin for Drone</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  vault</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">vault</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    container_name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">vault</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    restart</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">unless-stopped</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    command</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'server'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    labels</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">com.centurylinklabs.watchtower.enable=false</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    volumes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'./conf/vault:/vault/config:ro'</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'./data/vault:/vault/file'</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  drone-vault</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">drone/vault</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    container_name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">drone-vault</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    restart</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">unless-stopped</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    environment</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_DEBUG</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'true'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_SECRET</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'***drone-vault secret***'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      VAULT_ADDR</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'https://vault.lantian.pub'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      VAULT_TOKEN</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'***Vault secret***'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    depends_on</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">vault</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Drone #1 for my own Gitea</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  drone</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">drone/drone:2</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    container_name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">drone</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    restart</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">unless-stopped</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    environment</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_GITEA_SERVER</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'https://git.lantian.pub'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_GITEA_CLIENT_ID</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'***Gitea OAuth ID***'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_GITEA_CLIENT_SECRET</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'***Gitea OAuth Secret***'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_RPC_SECRET</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">        '***Drone Runner Secret, generate with openssl rand -hex 16***'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_SERVER_HOST</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">ci.lantian.pub</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_SERVER_PROTO</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">https</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_USER_CREATE</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">username:lantian,admin:true</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # Admin account</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_JSONNET_ENABLED</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'true'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_STARLARK_ENABLED</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'true'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    volumes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'./data/drone:/data'</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Drone #1's Docker Runner</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  drone-runner-docker</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">drone/drone-runner-docker:1</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    container_name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">drone-runner-docker</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    restart</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">unless-stopped</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    environment</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_RPC_PROTO</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">https</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_RPC_HOST</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">ci.lantian.pub</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_RPC_SECRET</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'***Drone Secret, same as DRONE_RPC_SECRET above'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_RUNNER_CAPACITY</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">4</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # Max parallel jobs</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_RUNNER_NAME</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">drone-docker</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_SECRET_PLUGIN_ENDPOINT</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">http://drone-vault:3000</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_SECRET_PLUGIN_TOKEN</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'***drone-vault secret***'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    volumes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'/var/run:/var/run'</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'/cache:/cache'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    depends_on</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">drone</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">drone-vault</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Drone #1 for GitHub</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  drone-github</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">drone/drone:2</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    container_name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">drone-github</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    restart</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">unless-stopped</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    environment</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_GITHUB_CLIENT_ID</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'**GitHub OAuth ID**'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_GITHUB_CLIENT_SECRET</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'***GitHub OAuth Secret***'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_RPC_SECRET</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">        '***Drone Runner Secret, generate with openssl rand -hex 16***'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_SERVER_HOST</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">ci-github.lantian.pub</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_SERVER_PROTO</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">https</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_USER_CREATE</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">username:xddxdd,admin:true</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # Admin account</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_REGISTRATION_CLOSED</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'true'</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # Disallow new user registration</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_JSONNET_ENABLED</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'true'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_STARLARK_ENABLED</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'true'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    volumes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'./data/drone-github:/data'</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Drone #2's Docker Runner</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  drone-github-runner-docker</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">drone/drone-runner-docker:1</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    container_name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">drone-github-runner-docker</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    restart</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">unless-stopped</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    environment</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_RPC_PROTO</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">https</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_RPC_HOST</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">ci-github.lantian.pub</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_RPC_SECRET</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'***Drone Secret, same as DRONE_RPC_SECRET above'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_RUNNER_CAPACITY</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">4</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # Max parallel jobs</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_RUNNER_NAME</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">drone-docker</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_SECRET_PLUGIN_ENDPOINT</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">http://drone-vault:3000</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      DRONE_SECRET_PLUGIN_TOKEN</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'***drone-vault secret***'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    volumes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'/var/run:/var/run'</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'/cache:/cache'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    depends_on</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">drone-github</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">drone-vault</span></span></code></pre>
<h2 id="basic-drone-cicd">Basic Drone CI/CD</h2>
<p>After setting up Drone, the next step is to add a task. Here I'll use the
example of deploying my Hexo blog.</p>
<p>I already have a set of deployment scripts for the following tasks:</p>
<ul>
<li>Install node_modules</li>
<li><code>hexo generate</code></li>
<li><code>hexo deploy</code> to GitHub Pages (as a backup)</li>
<li>Convert all images to WebP, and Gzip and Brotli compress all static resources</li>
<li>Rsync generated files to all of my nodes with Ansible</li>
</ul>
<p>In addition, since my blog uses Dependabot to update dependencies automatically,
Dependabot may create pull requests from time to time. Obviously, the pull
requests shouldn't be deployed to my nodes. The CI should just try generating
the files and see if it fails.</p>
<p>So here comes the most basic form of our configuration, written to
<code>.drone.yaml</code>:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">kind</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">pipeline</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">type</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">docker</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">default</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">trigger</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  branch</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">master</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">steps</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  - </span><span style="--shiki-dark:#569CD6;--shiki-light:#800000">name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">hexo generate</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">node:15-alpine</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    commands</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # Not all packages are needed: this is to be consistent with following steps</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">apk add --no-cache build-base bash git openssh wget python3 gzip brotli</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">        zstd parallel imagemagick</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">npm install</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">node_modules/hexo/bin/hexo generate</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  - </span><span style="--shiki-dark:#569CD6;--shiki-light:#800000">name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">hexo deploy</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">node:15-alpine</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    commands</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # Install packages</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">apk add --no-cache build-base bash git openssh wget python3 gzip brotli</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">        zstd parallel imagemagick</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">node_modules/hexo/bin/hexo deploy</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Don't deploy Dependabot's PRs</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    when</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      event</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">        exclude</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">          - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">pull_request</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Some subsequent steps are skipped</span></span></code></pre>
<p>This config will generate the static files and attempt <code>hexo deploy</code>, but it
will fail since it doesn't have the SSH keys. For obvious reason I won't
recommend adding your SSH key directly to the config. You should instead add it
to Vault (or Drone's secret storage), and use it from the config file:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Fetch SSH key from Vault, the repository must be set to Trusted in Drone</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">kind</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">secret</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">id_ed25519</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">get</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # This path is shown as kv/ssh in Vault. "data" must be added.</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  path</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">kv/data/ssh</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">id_ed25519</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">---</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">kind</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">pipeline</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">type</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">docker</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">default</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">steps</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  - </span><span style="--shiki-dark:#569CD6;--shiki-light:#800000">name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">hexo deploy</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">node:15-alpine</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    environment</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # Use the SSH key fetched from Vault, set as environment variable</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      SSH_KEY</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">        from_secret</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">id_ed25519</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    commands</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # Install SSH key</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">mkdir -p /root/.ssh/</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">echo "$SSH_KEY" > /root/.ssh/id_ed25519</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">chmod 600 /root/.ssh/id_ed25519</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # Configure SSH, mainly disable host key verification, or login will fail</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">|</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">        cat &#x3C;&#x3C;EOF >/root/.ssh/config</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">        StrictHostKeyChecking no</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">        UserKnownHostsFile=/dev/null</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">        VerifyHostKeyDNS yes</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">        LogLevel ERROR</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">        EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # Install packages... redacted</span></span></code></pre>
<p>Now we have SSH keys in the CI containers, and it will be able to connect to
GitHub or other deployment targets via SSH.</p>
<p>But another problem exists: every time the build is started, the container is in
a clean state without <code>node_modules</code>, which means a considerable amount of time
is needed to download <del>this blackhole</del>.</p>
<p>The good news is that Drone provides a plugin to cache intermediate directories
and decompress them on the next build:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># ...</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">steps</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Restore the last cache</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  - </span><span style="--shiki-dark:#569CD6;--shiki-light:#800000">name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">restore cache</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">meltwater/drone-cache:dev</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    settings</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      backend</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'filesystem'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      restore</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      cache_key</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'volume'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      archive_format</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'gzip'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      filesystem_cache_root</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'/cache'</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # Cache these two folders</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      mount</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'node_modules'</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'img_cache'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    volumes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#569CD6;--shiki-light:#800000">name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">cache</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">        path</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">/cache</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  - </span><span style="--shiki-dark:#569CD6;--shiki-light:#800000">name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">hexo generate</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Cache result generated this time</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  - </span><span style="--shiki-dark:#569CD6;--shiki-light:#800000">name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">rebuild cache</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">meltwater/drone-cache:dev</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    settings</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      backend</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'filesystem'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      rebuild</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      cache_key</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'volume'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      archive_format</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'gzip'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      filesystem_cache_root</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'/cache'</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # Cache these two folders</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      mount</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'node_modules'</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'img_cache'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    volumes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#569CD6;--shiki-light:#800000">name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">cache</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">        path</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">/cache</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Cache files are stored to /cache on the host, need repo set to Trusted in Drone</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">volumes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  - </span><span style="--shiki-dark:#569CD6;--shiki-light:#800000">name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">cache</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    host</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      path</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">/cache</span></span></code></pre>
<p>We can also have Telegram notifications on build failures:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Fetch Telegram token and target account from Vault</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">kind</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">secret</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">tg_token</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">get</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  path</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">kv/data/telegram</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">token</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">---</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">kind</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">secret</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">tg_target</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">get</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  path</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">kv/data/telegram</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">---</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># ...</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">steps</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Handle notification on failure</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  - </span><span style="--shiki-dark:#569CD6;--shiki-light:#800000">name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">telegram notification for failure</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">appleboy/drone-telegram</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    settings</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      token</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">        from_secret</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">tg_token</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      to</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">        from_secret</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">tg_target</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    when</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      status</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">failure</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Handle notification on failure, not sent when triggered from a cron job</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  - </span><span style="--shiki-dark:#569CD6;--shiki-light:#800000">name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">telegram notification for success</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">appleboy/drone-telegram</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    settings</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      token</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">        from_secret</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">tg_token</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      to</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">        from_secret</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">tg_target</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    when</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      branch</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">master</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      status</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">success</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      event</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">        exclude</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">          - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">cron</span></span></code></pre>
<p>Now we have a Drone configuration with deployments, caching, and Telegram
notifications.</p>
<h2 id="matrix-build">Matrix Build</h2>
<p>Sometimes we need to test our programs on different environments, such as Python
2.7/3.6/3.7/3.8/3.9, GCC/Clang, etc. Drone supports the Jsonnet configuration
format to define jobs in batches.</p>
<p><a href="https://github.com/xddxdd/route-chain/blob/master/.drone.jsonnet" rel="noopener noreferrer" target="_blank">Take my route-chain project for example</a>,
some contents are removed/simplified for demonstration:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">// Define a "function" to create a pipeline</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">local DebianCompileJob(image, kernel_headers) = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">  "kind"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"pipeline"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">  "type"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"docker"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">  "name"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">  "steps"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: [</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">      "name"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"build"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">      "image"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">      "commands"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        "apt-get update"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        "DEBIAN_FRONTEND=noninteractive apt-get -y --no-install-recommends install build-essential "</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131"> +</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131"> kernel_headers</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        "make"</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      ]</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    },</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">      "name"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"telegram notification"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">      "image"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"appleboy/drone-telegram"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">      "settings"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">        "token"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">          "from_secret"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"tg_token"</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        },</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">        "to"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">          "from_secret"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"tg_target"</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        }</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      }</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    }</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ]</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  // Telegram token and target account</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">    "kind"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"secret"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">    "name"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"tg_token"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">    "get"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">      "path"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"kv/data/telegram"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">      "name"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"token"</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    }</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  },</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">    "kind"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"secret"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">    "name"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"tg_target"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">    "get"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">      "path"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"kv/data/telegram"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">      "name"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"target"</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    }</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  },</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  // Call DebianCompileJob in batches to create jobs for different images and linux-headers packages</span></span>
<span class="line"><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">  DebianCompileJob('debian:jessie'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">'linux-headers-amd</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">64</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">')</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">  DebianCompileJob('debian:stretch'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">'linux-headers-amd</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">64</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">')</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">  DebianCompileJob('debian:buster'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">'linux-headers-amd</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">64</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">')</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">  DebianCompileJob('debian:bullseye'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">'linux-headers-amd</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">64</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">')</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">  DebianCompileJob('debian:unstable'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">'linux-headers-amd</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">64</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">')</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">  DebianCompileJob('ubuntu:xenial'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">'linux-headers-generic')</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">  DebianCompileJob('ubuntu:bionic'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">'linux-headers-generic')</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">  DebianCompileJob('ubuntu:focal'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">'linux-headers-generic')</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">]</span></span></code></pre>
<p>Save the config to <code>.drone.jsonnet</code>, and change the config file name from
<code>.drone.yaml</code> to <code>.drone.jsonnet</code>, and you're good to go.</p>
<h2 id="aborting-build-early">Aborting Build Early</h2>
<p>Sometimes we don't need to run all jobs in a Matrix Build. For example, I don't
need to rebuild all Docker images on every commit to my
<a href="https://github.com/xddxdd/dockerfiles" rel="noopener noreferrer" target="_blank">Dockerfiles repository</a>, specifically 14
(images) multiplied by 8 (architectures) to 112 jobs.</p>
<p>Fortunately, Drone supports aborting a pipeline early, just quit at some step
with exit code 78 like this:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># ...</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">steps</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  - </span><span style="--shiki-dark:#569CD6;--shiki-light:#800000">name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">skip build</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">alpine</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    commands</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">./should_build.sh &#x26;&#x26; exit 0 || exit 78</span></span></code></pre>
<p>An actual example can be found
<a href="https://github.com/xddxdd/dockerfiles/blob/4268d0f076ee76efdff670e2f9b0dae5961a968f/.drone.jsonnet" rel="noopener noreferrer" target="_blank">at this commit in my Dockerfiles repo</a>.</p>
<p>But since Drone runs builds in containers, and containers are somewhat slow to
start, handling 112 pipelines alone needs tens of minutes, even if all jobs quit
immediately. Therefore,
<a href="https://github.com/xddxdd/dockerfiles/blob/master/.drone.jsonnet" rel="noopener noreferrer" target="_blank">I adjusted the Dockerfiles repo configuration to run one pipeline for each architecture</a>,
and to determine the images to be built from the commit message. In this case,
only 8 pipelines are needed, and the execution time for an empty job won't be
too long.</p>  </div>  <div class="clearfix" id="post-navi" data-astro-cid-gfbmwgei=""> <div class="float-end text-end" data-astro-cid-gfbmwgei=""> <a href="/en/article/modify-website/lookup-any-whois-with-nginx.lantian/" title="Lookup Any Public WHOIS with this nginx-based Server" data-astro-cid-gfbmwgei=""> Lookup Any Public WHOIS with this nginx-based Server </a> <br data-astro-cid-gfbmwgei=""> Next post »
</div> <div class="float-start text-start position-absolute" data-astro-cid-gfbmwgei="">
« Previous post <br data-astro-cid-gfbmwgei=""> <a href="/en/article/modify-website/nixos-why.lantian/" title="NixOS Series 1: Why I fell in love" data-astro-cid-gfbmwgei=""> NixOS Series 1: Why I fell in love </a> </div> </div>  <div id="waline" data-waline-language="en-US" data-waline-path="/en/article/modify-website/replace-jenkins-with-drone-ci.lantian"></div> <script type="module" src="/assets/WalineComment.astro_astro_type_script_index_0_lang.Dqib3X1E.js"></script>  </div> </div> </article>  </div> <aside class="d-none d-xl-block"> <section class="widget"> <h3>Latest posts</h3> <ul class="list-unstyled"> <li> 07-20  <a href="/en/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/">Legal LTE Network at Home with Open5GS</a> </li><li> 06-27  <a href="/en/article/modify-computer/sidestore-without-stosvpn-across-lan.lantian/">Using SideStore without StosVPN across your LAN</a> </li><li> 05-19  <a href="/en/article/modify-computer/nix-logarithmetic-math-library-from-zero.lantian/">Nix Logarithmic Math Library from Ground Zero</a> </li><li> 04-06  <a href="/en/article/modify-computer/legal-lte-network-at-home-for-100-bucks.lantian/">Legal LTE Network at Home for $100</a> </li><li> 02-10  <a href="/en/article/modify-computer/build-custom-android-kernel-with-nix.lantian/">Building Custom Android Kernel with Nix</a> </li><li> 04-20  <a href="/en/article/modify-website/migrate-blog-to-astro-js.lantian/">Migrating My Blog to Astro.js</a> </li><li> 12-16  <a href="/en/article/modify-computer/nixos-low-ram-vps.lantian/">NixOS Series 5: Creating Disk Image for Low RAM VPS</a> </li><li> 09-20  <a href="/en/article/modify-computer/nix-trigonometric-math-library-from-zero.lantian/">Nix Trigonometric Math Library from Ground Zero</a> </li><li> 05-29  <a href="/en/article/random-notes/pipewire-sigkill-fix.lantian/">Preventing Pipewire from being SIGKILLed</a> </li><li> 05-12  <a href="/en/article/modify-website/how-to-kill-the-dn42-network.lantian/">How to Kill the DN42 Network (Updated 2023-05-12)</a> </li><li> 05-08  <a href="/en/article/modify-computer/laptop-muxed-nvidia-passthrough.lantian/">NVIDIA GPU Passthrough on an Optimus MUXed Laptop (Updated 2023-05)</a> </li><li> 04-17  <a href="/en/article/random-notes/fix-china-telecom-roaming-no-4g-on-aosp-rom.lantian/">Fix China Telecom 4G Roaming on AOSP ROM by Changing APN</a> </li><li> 03-26  <a href="/en/article/random-notes/old-hp-workstation-as-all-in-one.lantian/">Notes on Setting Up NAS+Router on Old HP Workstation</a> </li><li> 01-14  <a href="/en/article/modify-computer/nixos-impermanence.lantian/">NixOS Series 4: &quot;Stateless&quot; Operating System</a> </li><li> 06-21  <a href="/en/article/modify-computer/nixos-packaging.lantian/">NixOS Series 3: Software Packaging 101</a> </li> </ul> </section> <section class="widget"> <h3>Latest comments</h3> <ul class="list-unstyled" id="recent-comments">  <li><a href="#">Loading...</a></li>  </ul> </section> <script type="module">const i=window.location.hostname=="localhost"?"https://comments.lantian.pub":window.location.origin;fetch(`${i}/api/comment?type=recent&count=10`).then(t=>{if(t.status!==200)throw new Error(`Server returned bad HTTP status ${t.status}`);return t.json()}).then(t=>{const e=document.getElementById("recent-comments");e&&(e.innerHTML=t.data.map(n=>{const o=n.comment.replace(/(<([^>]+)>)/gi,"");return"<li>"+n.nick+' <a href="'+n.url+'">'+o+"</a></li>"}).join(""))});</script> <section class="widget"> <h3>Others</h3> <ul class="list-unstyled">  <li> <i class="fas fa-fw fa-rss"></i>  <a href="/rss2.xml" target="_blank">RSS Feed</a> |  <a href="/feed.xml" target="_blank">Atom</a> |  <a href="/feed.json" target="_blank">JSON</a> </li> <li> <i class="fas fa-fw fa-globe"></i>  <a href="https://stats.uptimerobot.com/BLK6VsRkR" target="_blank"> Sever Status </a> </li> <li> <i class="fas fa-fw fa-sitemap"></i>  <a href="https://lg.lantian.pub" target="_blank">DN42 Looking Glass</a> </li> <li> <i class="fas fa-fw fa-link"></i>  <a href="gopher://lantian.pub" target="_blank">Access with Gopher protocol</a> </li>  </ul> </section> <section class="widget"> <h3>Links</h3> <ul class="list-unstyled"> <li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://0x7f.cc"> 0x7f Blog 🐑 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="http://foreverblog.cn"> 10 Year&#39;s Promise (Forever Blog) </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://alanyhq.com"> Alanyhq </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.baoshuo.ren/?utm_source=friends"> Baoshuo&#39;s Blog </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.cas7.moe"> Blog of Moecast </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://jerryxiao.cc"> JerryXiao </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://sangsir.com"> SangSir </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://snli.org"> Shucheng Li </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://yuetau.net"> YuetAu&#39;s Spot </a> </li> </ul> </section> </aside> </div> <footer class="lantian clearfix" data-astro-cid-w3csb3e3="">  <div id="copyright" class="float-end text-end" data-astro-cid-w3csb3e3=""> <i class="fas fa-copyright" data-astro-cid-w3csb3e3=""></i> 2012-2025 Lan Tian @ Blog<br data-astro-cid-w3csb3e3=""> <small data-astro-cid-w3csb3e3=""> Powered by Astro v5.15.1 @ 2025-10-25 23:46:38 </small> </div> <script type="module">function v(c,o,r){const h=/^localhost$|^127(?:\.[0-9]+){0,2}\.[0-9]+$|^(?:0*:)*?:?0*1$/.test(location.hostname)||location.protocol==="file:";if(!o.trackLocalhost&&h)return console.warn("[Plausible] Ignoring event because website is running locally");try{if(window.localStorage.plausible_ignore==="true")return console.warn('[Plausible] Ignoring event because "plausible_ignore" is set to "true" in localStorage')}catch{}const p={n:c,u:o.url,d:o.domain,r:o.referrer,w:o.deviceWidth,h:o.hashMode?1:0,p:r&&r.props?JSON.stringify(r.props):void 0},s=new XMLHttpRequest;s.open("POST",`${o.apiHost}/api/event`,!0),s.setRequestHeader("Content-Type","text/plain"),s.send(JSON.stringify(p)),s.onreadystatechange=()=>{s.readyState===4&&r&&r.callback&&r.callback()}}function b(c){const o=()=>({hashMode:!1,trackLocalhost:!1,url:location.href,domain:location.hostname,referrer:document.referrer||null,deviceWidth:window.innerWidth,apiHost:"https://plausible.io",...c}),r=(t,n,i)=>{v(t,{...o(),...i},n)},h=(t,n)=>{r("pageview",n,t)};return{trackEvent:r,trackPageview:h,enableAutoPageviews:()=>{const t=()=>h(),n=history.pushState;return n&&(history.pushState=function(i,l,u){n.apply(this,[i,l,u]),t()},addEventListener("popstate",t)),c&&c.hashMode&&addEventListener("hashchange",t),h(),function(){n&&(history.pushState=n,removeEventListener("popstate",t)),c&&c.hashMode&&removeEventListener("hashchange",t)}},enableAutoOutboundTracking:(t=document,n={subtree:!0,childList:!0,attributes:!0,attributeFilter:["href"]})=>{function i(e){r("Outbound Link: Click",{props:{url:this.href}}),typeof process<"u"&&process,setTimeout(()=>{location.href=this.href},150),e.preventDefault()}const l=new Set;function u(e){e instanceof HTMLAnchorElement?e.host!==location.host&&(e.addEventListener("click",i),l.add(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(u)}function f(e){e instanceof HTMLAnchorElement?(e.removeEventListener("click",i),l.delete(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(f)}const d=new MutationObserver(e=>{e.forEach(a=>{a.type==="attributes"?(f(a.target),u(a.target)):a.type==="childList"&&(a.addedNodes.forEach(u),a.removedNodes.forEach(f))})});return t.querySelectorAll("a").forEach(u),d.observe(t,n),function(){l.forEach(a=>{a.removeEventListener("click",i)}),l.clear(),d.disconnect()}}}}const g=b({domain:"lantian.pub",trackLocalhost:!0,apiHost:""});g.trackPageview();</script> </footer>  </div>  </body> </html>