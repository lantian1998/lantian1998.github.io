<!DOCTYPE html><html lang="en-US" itemscope="" itemtype="https://schema.org/Article" data-astro-cid-porej7z2=""> <head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>NixOS Series 1: Why I fell in love - Lan Tian @ Blog</title><script>
  ;(() => {
    try {
      const mode = localStorage.getItem('user-color-scheme')
      if (mode == 'dark' || mode == 'light') {
        document.documentElement.setAttribute('data-user-color-scheme', mode)
      }
    } catch {
      // Ignore errors
    }
  })()
</script><link rel="stylesheet" href="/assets/index.CUlf1-Vz.css"><style>#post-navi[data-astro-cid-gfbmwgei]{padding:5px;border-top:1px solid var(--lt-border-weak);border-bottom:1px solid var(--lt-border-weak)}
ol[data-astro-cid-nj3qel45]{margin:0;padding:0;line-height:1.5}ol[data-astro-cid-nj3qel45] .toc-item[data-astro-cid-nj3qel45]{list-style:none}ol[data-astro-cid-nj3qel45] .toc-child[data-astro-cid-nj3qel45],ol[data-astro-cid-nj3qel45] .toc[data-astro-cid-nj3qel45]{padding:0}ol[data-astro-cid-nj3qel45] .toc-link[data-astro-cid-nj3qel45]{display:block;margin-left:1em;padding:.25em 0}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;width:1em;padding:.25em 0;float:left;font-style:normal;font-variant:normal;font-weight:900;font-family:Font Awesome\ 6 Free;font-feature-settings:normal;text-align:center}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before{content:""}ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{content:""}.post-info-wrap[data-astro-cid-dckccua4]{-ms-flex:0 0 2.5em;flex:0 0 2.5em;background-color:var(--lt-component-bg-emphasis)}@media(min-width:768px){.post-info[data-astro-cid-dckccua4]{position:sticky;top:0}}@media(max-width:767.98px){.post-info[data-astro-cid-dckccua4]{position:absolute}}
</style><script type="module" src="/assets/PageLayout.astro_astro_type_script_index_0_lang.C1wfUPs6.js"></script><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Referrer-Policy" content="no-referrer, strict-origin-when-cross-origin"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="imagemode" content="force"><meta name="nightmode" content="disable"><meta name="wap-font-scale" content="no"><meta name="title" content="NixOS Series 1: Why I fell in love - Lan Tian @ Blog"><meta name="keywords" content=""><meta name="author" content="Lan Tian"><link rel="canonical" href="https://lantian.pub/en/article/modify-website/nixos-why.lantian/"><link rel="alternate" type="application/rss+xml" title="Lan Tian @ Blog" href="https://lantian.pub/rss2.xml"><link rel="alternate" type="application/atom+xml" title="Lan Tian @ Blog" href="https://lantian.pub/feed.xml"><link rel="alternate" href="https://lantian.pub/article/modify-website/nixos-why.lantian/" hreflang="zh"><link rel="alternate" href="https://lantian.pub/en/article/modify-website/nixos-why.lantian/" hreflang="en"><meta name="copyright" content="Copyright 2012-2025 Lan Tian @ Blog"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#03a9f4"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#212121"><meta name="application-name" content="Lan Tian @ Blog"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="apple-touch-icon" sizes="1024x1024" href="/apple-touch-icon-1024x1024.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#03a9f4"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Lan Tian @ Blog"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-640x1136.png"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1136x640.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-750x1334.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1334x750.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1125x2436.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2436x1125.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1170x2532.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2532x1170.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1179x2556.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2556x1179.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-828x1792.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1792x828.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2688.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2688x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2208.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2208x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1284x2778.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2778x1284.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1290x2796.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2796x1290.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1488x2266.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2266x1488.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1536x2048.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2048x1536.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1620x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1620.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1640x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1640.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2388.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2388x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2224.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2224x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-2048x2732.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2732x2048.png"><meta name="msapplication-TileColor" content="#bbdefb"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"><meta property="og:url" content="https://lantian.pub/en/article/modify-website/nixos-why.lantian/"><meta property="og:type" content="website"><meta property="og:title" content="NixOS Series 1: Why I fell in love - Lan Tian @ Blog"><meta property="og:image" content="https://lantian.pub/usr/uploads/202110/nixos-social-preview.png"><meta content="Right now, I&#38;#39;m gradually migrating my servers from Devuan Linux to NixOS . NixOS is a Linux distribution centered on a set of Nix configuration files located in /etc/nixos , which is used to install and configure the whole operating system. Because this configuration set defines ALL config files and packages on the system, as long as you use the same config files, you will absolutely get the same operating system every time you reinstall. Nix configuration language is also Turing complete, so you will be able to generate config files with Nix, no matter how complicated that software is. Another important feature of the Nix package manager is reproducible builds. Every package in NixOS is defined with Nix config files, and the Nix package manager can promise that,..."><meta property="og:site_name" content="Lan Tian @ Blog"><meta property="og:locale" content="en"><meta name="twitter:card" content="summary"><meta name="twitter:url" content="https://lantian.pub/en/article/modify-website/nixos-why.lantian/"><meta name="twitter:title" content="NixOS Series 1: Why I fell in love - Lan Tian @ Blog"><meta property="twitter:image" content="https://lantian.pub/usr/uploads/202110/nixos-social-preview.png"><meta content="Right now, I&#38;#39;m gradually migrating my servers from Devuan Linux to NixOS . NixOS is a Linux distribution centered on a set of Nix configuration files located in /etc/nixos , which is used to install and configure the whole operating system. Because this configuration set defines ALL config files and packages on the system, as long as you use the same config files, you will absolutely get the same operating system every time you reinstall. Nix configuration language is also Turing complete, so you will be able to generate config files with Nix, no matter how complicated that software is. Another important feature of the Nix package manager is reproducible builds. Every package in NixOS is defined with Nix config files, and the Nix package manager can promise that,..."><meta name="twitter:dnt" content="on"><meta itemprop="name" content="NixOS Series 1: Why I fell in love - Lan Tian @ Blog"><meta property="image" content="https://lantian.pub/usr/uploads/202110/nixos-social-preview.png"><meta content="Right now, I&#38;#39;m gradually migrating my servers from Devuan Linux to NixOS . NixOS is a Linux distribution centered on a set of Nix configuration files located in /etc/nixos , which is used to install and configure the whole operating system. Because this configuration set defines ALL config files and packages on the system, as long as you use the same config files, you will absolutely get the same operating system every time you reinstall. Nix configuration language is also Turing complete, so you will be able to generate config files with Nix, no matter how complicated that software is. Another important feature of the Nix package manager is reproducible builds. Every package in NixOS is defined with Nix config files, and the Nix package manager can promise that,..."><meta content="Right now, I&#38;#39;m gradually migrating my servers from Devuan Linux to NixOS . NixOS is a Linux distribution centered on a set of Nix configuration files located in /etc/nixos , which is used to install and configure the whole operating system. Because this configuration set defines ALL config files and packages on the system, as long as you use the same config files, you will absolutely get the same operating system every time you reinstall. Nix configuration language is also Turing complete, so you will be able to generate config files with Nix, no matter how complicated that software is. Another important feature of the Nix package manager is reproducible builds. Every package in NixOS is defined with Nix config files, and the Nix package manager can promise that,..."><link rel="me" href="https://mastodon.social/@lantian"></head> <body data-astro-cid-porej7z2=""> <div id="bg" data-astro-cid-j6vmxtef=""></div>   <div id="container" class="container" data-astro-cid-porej7z2=""> <nav class="lantian navbar navbar-expand-lg" data-astro-cid-wu5dj4rx=""> <div class="container-fluid" data-astro-cid-wu5dj4rx=""> <a class="navbar-brand" href="/en/" data-astro-cid-wu5dj4rx="">Lan Tian @ Blog</a> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#lantian-navbar" aria-controls="lantian-navbar" aria-expanded="false" aria-label="Toggle navigation" data-astro-cid-wu5dj4rx=""> <span class="navbar-toggler-icon" data-astro-cid-wu5dj4rx=""></span> </button> <div class="collapse navbar-collapse" id="lantian-navbar" data-astro-cid-wu5dj4rx=""> <ul class="navbar-nav" data-astro-cid-wu5dj4rx=""> <li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/archive/index.html" data-astro-cid-wu5dj4rx=""> Posts </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> Himawari </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> <li class="nav-item dropdown d-block d-lg-none" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="pages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-file" data-astro-cid-wu5dj4rx=""></i> Page  <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="pages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/archive/index.html" data-astro-cid-wu5dj4rx=""> Posts </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> Himawari </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> </ul> </li> </ul> <ul class="navbar-nav ms-auto" data-astro-cid-wu5dj4rx=""> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="languages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-language" data-astro-cid-wu5dj4rx=""></i> Language <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="languages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/article/modify-website/nixos-why.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-cn" data-astro-cid-wu5dj4rx=""></span> Chinese Simplified / 简体中文 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item active" href="/en/article/modify-website/nixos-why.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-us" data-astro-cid-wu5dj4rx=""></span> English </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">Not all pages have translations.</a> </li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">You may see 404 - this is normal.</a> </li> </ul> </li> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="color-scheme-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> Night Mode </a> <ul class="dropdown-menu" aria-labelledby="color-scheme-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-auto" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> Auto </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-light" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-sun" data-astro-cid-wu5dj4rx=""></i> Light</a> </li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-dark" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-moon" data-astro-cid-wu5dj4rx=""></i> Dark</a> </li> </ul> </li> </ul> </div> </div> </nav> <script type="module">const m="user-color-scheme",s="data-user-color-scheme",u=(e,t)=>{try{localStorage.setItem(e,t)}catch{}},i=e=>{try{return localStorage.getItem(e)}catch{return null}},c=e=>{const t={dark:!0,light:!0,auto:!0},o=e===null||!Object.keys(t).includes(e)?"auto":e;u(m,o);for(const l in t){const n=document.getElementById("color-scheme-"+l);n&&(l==o?n.classList.add("active"):n.classList.remove("active"))}o!="auto"?document.documentElement.setAttribute(s,o):document.documentElement.removeAttribute(s)};c(i(m));const r=document.getElementById("color-scheme-auto");r&&r.addEventListener("click",()=>c("auto"));const a=document.getElementById("color-scheme-light");a&&a.addEventListener("click",()=>c("light"));const d=document.getElementById("color-scheme-dark");d&&d.addEventListener("click",()=>c("dark"));</script>  <div class="d-flex" data-astro-cid-porej7z2=""> <div id="content" data-astro-cid-porej7z2="">  <article> <div class="d-flex"> <div class="post-info-wrap" data-astro-cid-dckccua4=""> <div class="post-info" data-astro-cid-dckccua4=""> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-clock"></span> <br> <small>10-11</small> </p> <div class="post-meta-value"> Published on<span class="badge badge-tag" data-astro-cid-dckccua4=""> 2021-10-11 16:06 </span>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-file-alt"></span> <br> <small>Website and Servers</small> </p> <div class="post-meta-value"> Category <a class="badge badge-tag" href="/en/category/modify-website" data-astro-cid-dckccua4=""> Website and Servers </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-tag"></span> <br> <small>1 tags</small> </p> <div class="post-meta-value"> Tags  <a class="badge badge-tag" href="/en/tag/NixOS" data-astro-cid-dckccua4=""> NixOS </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-list"></span> <br> <small>ToC</small> </p> <div class="post-meta-value">  <ol data-astro-cid-nj3qel45=""> <li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#before-i-use-nixos" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Before I use NixOS</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#managing-multiple-servers" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Managing Multiple Servers</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#distributing-binaries" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Distributing Binaries</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#fixing-system-crashes" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Fixing System Crashes</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#installing-nixos" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Installing NixOS</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#managing-multiple-servers-but-with-nixos" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Managing Multiple Servers, but with NixOS</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#binary-distribution-but-with-nix-package-manager" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Binary Distribution, but with Nix Package Manager</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#fixing-system-crashes-but-luckily-with-nixos" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Fixing System Crashes, but Luckily with NixOS</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#conclusion-and-followups" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Conclusion and Followups</span> </a> </li> </ol>   </div> </div> </div> </div>  </div>  <div class="post-wrap"> <div class="post-image-wrap"> <picture> <source srcset="/usr/uploads/202110/nixos-social-preview.png.thumb.png.webp" type="image/webp"> <source srcset="/usr/uploads/202110/nixos-social-preview.png.thumb.png.avif" type="image/avif"> <source srcset="/usr/uploads/202110/nixos-social-preview.png.thumb.png.jxl" type="image/jxl"> <img src="/usr/uploads/202110/nixos-social-preview.png.thumb.png" alt="Illustration for NixOS Series 1: Why I fell in love" width="200" height="150"> </picture> </div> <h1 class="post-title"> <a href="/en/article/modify-website/nixos-why.lantian/" rel="bookmark" title="NixOS Series 1: Why I fell in love">NixOS Series 1: Why I fell in love</a> </h1> <div class="post-text">  <blockquote><p>List of NixOS series posts:</p><ul><li><a href="/en/article/modify-website/nixos-why.lantian/">NixOS Series 1: Why I fell in love</a> (current post)</li><li><a href="/en/article/modify-website/nixos-initial-config-flake-deploy.lantian/">NixOS Series 2: Basic Config, Nix Flake &amp; Batch Deploy</a> </li><li><a href="/en/article/modify-computer/nixos-packaging.lantian/">NixOS Series 3: Software Packaging 101</a> </li><li><a href="/en/article/modify-computer/nixos-impermanence.lantian/">NixOS Series 4: &quot;Stateless&quot; Operating System</a> </li><li><a href="/en/article/modify-computer/nixos-low-ram-vps.lantian/">NixOS Series 5: Creating Disk Image for Low RAM VPS</a> </li></ul></blockquote> <p>Right now, I&#39;m gradually migrating my servers from Devuan Linux to
<a href="https://nixos.org/" rel="noopener noreferrer" target="_blank">NixOS</a>. NixOS is a Linux distribution centered on a set of
Nix configuration files located in <code>/etc/nixos</code>, which is used to install and
configure the whole operating system. Because this configuration set defines
<strong>ALL</strong> config files and packages on the system, as long as you use the same
config files, you will absolutely get the same operating system every time you
reinstall. Nix configuration language is also Turing complete, so you will be
able to generate config files with Nix, no matter how complicated that software
is.</p>
<p>Another important feature of the Nix package manager is reproducible builds.
Every package in NixOS is defined with Nix config files, and the Nix package
manager can promise that, as long as the software doesn&#39;t deliberately fight
back, you will get binaries with the exact same functionality, and in most
cases, get binaries with the same hash values (such as MD5 and SHA256).</p>
<p>Since NixOS the Linux distribution is quite unfriendly to beginners, I will
write a series of posts on my whole transition process. This is the first post
in the series and mainly focuses on the reason I fall in love with it.</p>
<h1 id="before-i-use-nixos">Before I use NixOS</h1>
<h2 id="managing-multiple-servers">Managing Multiple Servers</h2>
<p>How many servers do you have? I have 10. In addition to the 4 VPSes listed on my
<a href="/en/page/dn42/">DN42 Peering Page</a>, which I run my website and BGP network on,
I also have 1 dedicated server for my CI and backups, 3 Oracle cloud servers
that I got for free, 1 VPS with large RAM from VirMach New York that I use to
run Java apps like Keycloak, and 1 VPS planned to replace the Virtono node in
Frankfurt, Germany.</p>
<p>When you have that many servers, you will find managing all of them be
difficult. If I want to edit the BIRD config on all my nodes, I will have to do:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Pull the config from a random node</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">scp</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> hostdare.lantian.pub:/etc/bird/bird.conf</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> .</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Edit the config</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">nano</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> bird.conf</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Push the new config to all nodes with Ansible, and tell BIRD to reload</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">ansible</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> all</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -m</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> copy</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -a</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;src=bird.conf dest=/etc/bird&quot;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">ansible</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> all</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -m</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> shell</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -a</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;birdc configure&quot;</span></span></code></pre>
<p>And this is the most trivial scenario. Things are more troublesome when the
config file is supposed to be different on all my nodes. In this case, I have to
log in to each node and do the config change manually. Half an hour would have
passed for some config changes on all 10 nodes.</p>
<p>As an attempt to resolve this problem, earlier this year I started to generate
the config files with Ansible&#39;s template module. This is one of my BIRD config
files for example:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">define</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> LTNET_IPv4</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> =</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {{</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ltnet_prefix_v4</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> }}.1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">define</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> LTNET_IPv6</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> =</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {{</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ltnet_prefix_v6</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> }}::1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">define</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> LTNET_AS</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> =</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {{</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 4225470000</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> +</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ltnet_index</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> }}</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span></code></pre>
<p>With this, I can define variables for each node in the Ansible inventory, and
generate the config files automatically:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">all</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  hosts</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    hostdare.lantian.pub</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      ltnet_index</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">3</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      ltnet_prefix_v4</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">172.18.3</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">      ltnet_prefix_v6</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">fdbc:f9dc:67ad:3</span></span></code></pre>
<p>Once I finished changing the config, I simply ran <code>ansible-playbook</code> to call my
predefined playbook to automatically generate new configs onto every node and
reload BIRD. This resolves the issue for managing BIRD config, but I have more
pieces of components that require similar work, like Nginx, CoreDNS, Tinc VPS,
etc. In addition, the configuration of the system itself, from the list of
preinstalled packages to <code>sysctl.conf</code> and <code>motd</code>, needs dedicated playbooks.
Now I have bunches of playbooks and bunches of templates.</p>
<p>That&#39;s not the end of the story. Apparently, I cannot rerun each and every
playbook when I&#39;m changing something, or it would take several hours. Therefore,
I need to determine which playbooks I should call manually. Since I have a LOT
of playbooks, I&#39;ve had several oops where I cannot see the changes from my
config update, and it ended to be using the wrong playbooks.</p>
<p>We&#39;re still not done yet. My nodes can be unstable sometimes, making deployments
fail, as they are cheap VPSes anyway. When this happens, I usually wait until
that node recovers and rerun the deployment. Only if I still remember to do it,
that is. If I forgot to deploy my last config change and my new change happened
to rely on that, some more time would be spent diagnosing the issue.</p>
<h2 id="distributing-binaries">Distributing Binaries</h2>
<p>I have a lot of software that I developed or modified myself, like my
<a href="/en/article/modify-website/serve-dn42-whois-with-nginx.lantian/">modified Nginx</a>,
<a href="/en/article/creations/traceroute-chain.lantian/">Traceroute poet</a>,
<a href="/en/article/modify-website/go-bird-looking-glass.lantian/">BIRD Looking Glass</a>,
and my customized slimmed-down kernel. Apparently, I cannot compile them on my
cheap VPSes, or my provider may shut them down for excessive CPU usage and GG. I
need to compile the software somewhere and then deploy them to all the nodes.</p>
<p>Before I switch to NixOS, I use the
<a href="https://www.devuan.org" rel="noopener noreferrer" target="_blank">Devuan Linux distro</a> (basically Debian without
SystemD). Debian is infamous for the complexity of packaging software, as you
need to write a complicated Makefile just for packaging into DEB files. In
addition, complicated programs may depend on lots of customized libraries. For
example, my Nginx depends on Brotli, Zlib modified by Cloudflare, BoringSSL, and
a bunch of third-party Nginx modules. This makes it even harder to pack
everything into one DEB file. Therefore, I simply gave up on DEB packages and
started to search for better solutions.</p>
<p>The next solution is Docker containers. Docker containers are really easy to
use,
<a href="/en/article/modify-website/migrate-website-docker.lantian/">I started with them back in 2016</a>.
However, with continuous version updates and the addition of new features, the
memory consumption of Docker is rising as well. <code>dockerd</code> usually takes 80-100MB
RAM on my nodes, and that&#39;s not counting another 20-30MB from <code>containerd</code>. For
my small VPS boxes with only 512MB RAM, that&#39;s almost one-fourth of my total RAM
allotment.</p>
<blockquote>
<p>RAM usage is also the main reason I switched from Debian to Devuan. The
various processes of SystemD took some 50MB of RAM, but since Devuan is still
using the sysvinit framework from Debian 7 and earlier, the resident memory
usage of <code>init</code>, <code>udev</code> and <code>rsyslog</code> adds up to only 20MB. And as I have
Docker, I don&#39;t need the advanced features of SystemD anyway.</p>
<p>If I ever ran out of RAM on these small VPS boxes, it can get anywhere from
being terribly slow due to bad IO performance and slow SWAP operations, to
being completely frozen for high IO latency or being shut down for excessive
IOPS.</p>
</blockquote>
<p>There is a replacement for <code>dockerd</code>, of course, the Podman developed by Red
Hat. Podman&#39;s largest difference is that it doesn&#39;t have a residual background
process like <code>dockerd</code>, and it only creates one or two processes for each
running container for monitoring, logging, and DNS resolution purposes. However,
lacking a background process means no autostart on system bootup, and Podman
relies on an external process manager like SystemD or Supervisord to do that. In
addition, while Podman strives to emulate the Docker API, the compatibility work
is still far from complete, and it is hard to use tools like Docker Compose with
it. For me, the biggest no-go is the lack of
<a href="https://github.com/robbertkl/docker-ipv6nat" rel="noopener noreferrer" target="_blank">IPv6 NAT</a>, which basically means
no IPv6 connectivity in my containers, and no access to services in containers
from the IPv6 network.</p>
<p>This leads to the next problem: container networking is hard. By default, Docker
containers get their own network namespaces with their own IP addresses. This
means that containers cannot access each other from <code>127.0.0.1 (localhost)</code>.
Instead, they need to resolve the names via DNS. For example, PHP-FPM sitting in
a container cannot connect to a MySQL database via <code>127.0.0.1</code>. It has to
resolve the IP of the container <code>mysql</code> with DNS before it can make a
connection. Now, programs in containers cannot only listen on <code>127.0.0.1</code>. They
need to listen on <code>0.0.0.0</code> instead so that the host and other containers can
access it. Since databases like MySQL usually default to listening on
<code>127.0.0.1</code> for security, some extra config changes are needed either when
packing the Docker image or using it.</p>
<p>DNS resolution causes new issues as well. Programs may not refresh their DNS
cache in time, with one major example being Nginx. For example, I have two
containers, A (<code>172.17.0.100</code>) and B (<code>172.17.0.101</code>). I changed their config
and redeployed them with <code>docker-compose</code>. Since <code>docker-compose</code> creates the
containers in parallel with no deterministic order, A gets <code>172.17.0.101</code> this
time, and B gets <code>172.17.0.100</code>. Since Nginx doesn&#39;t refresh DNS resolution
results in time, whenever I try to access A, I actually get to B, and vice
versa. To avoid this issue, I have to restart all containers related to A and B,
and this is some extra maintenance cost.</p>
<p>Yes, you can actually resolve this with Docker: you can set the networking mode
of containers to <code>host</code> (aka <code>--net host</code>) to let the containers share the
network namespace and IPs with the host. But remember that Docker containers
usually listen on <code>0.0.0.0</code>? Many Docker images had already changed the config
for you to listen on <code>0.0.0.0</code>, and as you use <code>host</code> mode, you&#39;re exposing the
port to the public Internet, causing a security risk. Now you need to change the
config back to what it was. Too much trouble!</p>
<p>Another way that would have worked is manually assigning an IP to each
container, so that each of them gets the same IP after recreate. For obvious
reasons, manually assigning IPs to dozens of containers isn&#39;t fun.</p>
<h2 id="fixing-system-crashes">Fixing System Crashes</h2>
<p>Since I change my system config from time to time, it&#39;s common for me to
accidentally kill the network or kill the kernel at the initrd boot stage.
Whenever this happens, I will have to use a slow VNC console, or even some IPMI
that supports only Java 7, to change the config back. If I&#39;m even less lucky and
the system doesn&#39;t boot at all, I will need to fix that in a rescue system.</p>
<p>Rescue systems from different providers vary, and you will encounter strange
issues. I&#39;ve had a rescue system with kernel 4.9 not recognizing my
Zstd-compressed Btrfs filesystem, and another rescue system not providing kernel
headers, making it impossible to compile ZFS kernel modules and load my ZFS
partition.</p>
<p>In addition, you are lucky if you nailed it on your first attempt. As I don&#39;t
reboot my nodes often, the boot failure I&#39;m dealing with may be caused by some
change 3 months ago. Therefore, I have to check my Git history and guess the
cause while I repeatedly boot to the rescue system, mount my partitions and
change the config, and reboot back to the hard drive, praying it will work this
time.</p>
<p>The day would have passed once I finally fixed the problem.</p>
<h1 id="installing-nixos">Installing NixOS</h1>
<p>The unique Nix package/config management system resolves all the issues above.
Let&#39;s start by installing NixOS first. Since NixOS is a distro based on config
files, the installation process comes down to 3 steps:</p>
<ol>
<li>Partition the disk and mount to <code>/mnt</code>. Anyone who has installed Arch Linux
or Gentoo already knows what to do.</li>
<li>Generate a default config and make some changes.
<code>nixos-generate-config --root /mnt</code> will autodetect your hardware and create
a config at <code>/mnt/etc/nixos/configuration.nix</code>。</li>
<li>Install your system based on the config file with <code>nixos-install</code>。</li>
</ol>
<p>The installation manual of NixOS is
<a href="https://nixos.org/manual/nixos/stable/index.html#sec-installation" rel="noopener noreferrer" target="_blank">on this page</a>,
and its ISO images can be downloaded
<a href="https://nixos.org/download.html" rel="noopener noreferrer" target="_blank">on this page</a>.</p>
<p>If you want to install NixOS on a VPS, but your provider cannot mount an ISO for
you, and your VPS is too low on RAM to boot the NixOS installation image from
the network (<a href="https://netboot.xyz/" rel="noopener noreferrer" target="_blank">Netboot.xyz</a>), you can also use
<a href="https://github.com/elitak/nixos-infect" rel="noopener noreferrer" target="_blank">NixOS-Infect</a> to replace your existing
system with NixOS.</p>
<blockquote>
<p>NixOS-Infect automatically mounts a Swap file on servers with low RAM to avoid
memory exhaustion during the installation process. But if you use Btrfs, ZFS,
or any filesystem that doesn&#39;t support mounting a Swapfile, you need to
comment out the <code>makeSwap</code> and <code>removeSwap</code> functions from the <code>nixos-infect</code>
script.</p>
</blockquote>
<h2 id="managing-multiple-servers-but-with-nixos">Managing Multiple Servers, but with NixOS</h2>
<p>At the very beginning, I mentioned that one important feature of NixOS is
managing each and every package and config with a set of Nix config files.
Therefore, we can use any tools we like, for example Ansible, Rsync, or even
Git, to manage the config at <code>/etc/nixos</code>. Since this is the only config file we
care about, we no longer need a bunch of complicated Ansible playbooks or dozens
of Rsync commands. We only need to overwrite <code>/etc/nixos</code>, run
<code>nixos-rebuild switch</code>, and call it a day.</p>
<p>Since each config update is equivalent to overwriting all programs and config in
the whole system, you don&#39;t need to decide on which special script to use, which
services to reboot, and which config files you forgot to copy onto the node.
NixOS will automatically compare your new config to the last one and restart the
services on demand.</p>
<p>NixOS, as a Linux distro with some history, also has some software ecosystem
around it, like the <a href="https://github.com/serokell/deploy-rs" rel="noopener noreferrer" target="_blank">Deploy-RS tool</a>. It
can read your Nix Flakes config file (a variation of Nix config file), compute
the result on your local machine, and copy it to all your nodes and activate it.</p>
<h2 id="binary-distribution-but-with-nix-package-manager">Binary Distribution, but with Nix Package Manager</h2>
<p>The Nix package manager stores binaries in paths like
<code>/nix/store/wadmyilr414n7bimxysbny876i2vlm5r-bash-5.1-p8</code>. The hash value at the
middle corresponds to all inputs from the package config, including the version
of the source code (like URLs to <code>tar.gz</code>, Git commit hashes, etc.), SHA256 of
the source code, compilation and installation commands, and versions of all
libraries it depends on. To make sure the software is exactly the same, Nix
compiles them in a sandbox. Compilation scripts in the sandbox can only access
the dependent libraries. It cannot even get the system time (fixed to UNIX
timestamp 0 or 1970-01-01 00:00:00) or connect to the Internet.</p>
<p>Let&#39;s take an example. It&#39;s well known that most programs on Linux depends on
the system Libc. Let&#39;s find out which Libc the bash we&#39;re talking about is
depending on:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">$</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ldd</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /nix/store/wadmyilr414n7bimxysbny876i2vlm5r-bash-5.1-p8/bin/bash</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">linux-vdso.so.1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (0x00007ffe169d8000)</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">libdl.so.2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> =&gt; </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/nix/store/mij848h2x5wiqkwhg027byvmf9x3gx7y-glibc-2.33-50/lib/libdl.so.2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (0x00007f767f863000)</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">libc.so.6</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> =&gt; </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/nix/store/mij848h2x5wiqkwhg027byvmf9x3gx7y-glibc-2.33-50/lib/libc.so.6</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (0x00007f767f69e000)</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">/nix/store/mij848h2x5wiqkwhg027byvmf9x3gx7y-glibc-2.33-50/lib/ld-linux-x86-64.so.2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> =&gt; </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/usr/lib64/ld-linux-x86-64.so.2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (0x00007f767f86a000)</span></span></code></pre>
<p>This Bash can only use a Glibc in a fixed location in <code>/nix/store</code>, or the exact
copy used during compilation. Therefore, the Nix package manager also avoids
program crashing due to shared library updates. Since programs can only use the
libraries at exact paths, and an exact path with config hash must correspond to
the exact library, as long as a programs works during compile time, it will
continue to work exactly that way.</p>
<blockquote>
<p>This doesn&#39;t include cases where the program has deliberate countermeasures,
like generating compilation results from <code>/dev/random</code>, or behaving
differently based on system time (aka time bomb). However, these behaviors are
extremely rare in normal programs, so for the vast majority of programs, the
Nix package management system can fulfill its promise.</p>
</blockquote>
<p>Likewise, If I copy this Bash and its dependent libraries to another system, as
long as the path is still the same, this Bash program will surely work the same.
Therefore, there is a version of the Nix package manager that installs onto
other distros like Ubuntu or Arch Linux, which shares most binaries with NixOS
and have the same functionality without interfering with the system&#39;s own
package management.</p>
<p>That is exactly what the <a href="https://github.com/serokell/deploy-rs" rel="noopener noreferrer" target="_blank">Deploy-RS tool</a>
mentioned above is based on. It downloads or builds all packages locally and
then copies the results from <code>/nix/stores</code> onto the target nodes, so no
compilations are necessary on the target nodes.</p>
<p>By the way, the Nix package manager treats config files in the same fashion as
packages. For example, <code>/nix/store/dpgmxhxkf55dfgwnrhz7hc4ahckkx78b-nginx.conf</code>
is my Nginx config file. Deploy-RS uses the same logic to generate the config
files locally, then copy them to the remote server.</p>
<h2 id="fixing-system-crashes-but-luckily-with-nixos">Fixing System Crashes, but Luckily with NixOS</h2>
<p>Since all binaries of NixOS are stored in <code>/nix/store</code> and there is no unified
path, NixOS will adjust the <code>PATH</code> environment variable to include all <code>bin</code>
folders of packages, so you can call them directly in Bash; In addition, NixOS
will link some config files to <code>/etc</code> so programs can find them at their desired
location.</p>
<p>If the new config files crashed the system, theoretically, you only need to
adjust <code>PATH</code> and links in <code>/etc</code> to recover to the last correct config, and the
system will recover to an older state. Therefore, NixOS directly provides the
options in its boot menu, so you can boot to a specific deployment state:</p>
<p><picture><source srcset="/usr/uploads/202110/nixos-bootloader.jpg.webp" type="image/webp"><source srcset="/usr/uploads/202110/nixos-bootloader.jpg.avif" type="image/avif"><source srcset="/usr/uploads/202110/nixos-bootloader.jpg.jxl" type="image/jxl"><img src="/usr/uploads/202110/nixos-bootloader.jpg" alt="NixOS Boot Menu"></picture></p>
<blockquote>
<p>Image downloaded from
<a href="https://discourse.nixos.org/t/how-to-make-uefis-grub2-menu-the-same-as-bioss-one/10074" rel="noopener noreferrer" target="_blank">https://discourse.nixos.org/t/how-to-make-uefis-grub2-menu-the-same-as-bioss-one/10074</a></p>
</blockquote>
<p>Therefore, NixOS doesn&#39;t need a rescue system in most cases, as it can recover
itself with an older config state. Once the system is up, you can proceed to
redeploy the fixed config or continue to use the older system as if nothing has
happened.</p>
<blockquote>
<p>Note that this NixOS mechanism is not a filesystem snapshot and cannot
rollback data files of programs.</p>
<p>Assuming that I upgraded to MariaDB 10.6 and rolled back to an older config
with MariaDB 10.5. Since MariaDB 10.6 auto-upgraded the data files, MariaDB
10.5 wouldn&#39;t recognize them and will refuse to start. NixOS cannot and does
not intend to fix the issue.</p>
</blockquote>
<h1 id="conclusion-and-followups">Conclusion and Followups</h1>
<p>This post mainly focuses on introducing the advantages of NixOS and its package
management system over other Linux distros. In the follow-up posts, I will
explain the process of configuring everything in NixOS and replacing my nodes
step by step.</p>  </div>  <div class="clearfix" id="post-navi" data-astro-cid-gfbmwgei=""> <div class="float-end text-end" data-astro-cid-gfbmwgei=""> <a href="/en/article/modify-website/replace-jenkins-with-drone-ci.lantian/" title="Replace Jenkins with Drone CI" data-astro-cid-gfbmwgei=""> Replace Jenkins with Drone CI </a> <br data-astro-cid-gfbmwgei=""> Next post »
</div> <div class="float-start text-start position-absolute" data-astro-cid-gfbmwgei="">
« Previous post <br data-astro-cid-gfbmwgei=""> <a href="/en/article/modify-website/nixos-initial-config-flake-deploy.lantian/" title="NixOS Series 2: Basic Config, Nix Flake &#38; Batch Deploy" data-astro-cid-gfbmwgei=""> NixOS Series 2: Basic Config, Nix Flake &amp; Batch Deploy </a> </div> </div>  <div id="waline" data-waline-language="en-US" data-waline-path="/en/article/modify-website/nixos-why.lantian"></div> <script type="module" src="/assets/WalineComment.astro_astro_type_script_index_0_lang.Dqib3X1E.js"></script>  </div> </div> </article>  </div> <aside class="d-none d-xl-block"> <section class="widget"> <h3>Latest posts</h3> <ul class="list-unstyled"> <li> 07-20  <a href="/en/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/">Legal LTE Network at Home with Open5GS</a> </li><li> 06-27  <a href="/en/article/modify-computer/sidestore-without-stosvpn-across-lan.lantian/">Using SideStore without StosVPN across your LAN</a> </li><li> 05-19  <a href="/en/article/modify-computer/nix-logarithmetic-math-library-from-zero.lantian/">Nix Logarithmic Math Library from Ground Zero</a> </li><li> 04-06  <a href="/en/article/modify-computer/legal-lte-network-at-home-for-100-bucks.lantian/">Legal LTE Network at Home for $100</a> </li><li> 02-10  <a href="/en/article/modify-computer/build-custom-android-kernel-with-nix.lantian/">Building Custom Android Kernel with Nix</a> </li><li> 04-20  <a href="/en/article/modify-website/migrate-blog-to-astro-js.lantian/">Migrating My Blog to Astro.js</a> </li><li> 12-16  <a href="/en/article/modify-computer/nixos-low-ram-vps.lantian/">NixOS Series 5: Creating Disk Image for Low RAM VPS</a> </li><li> 09-20  <a href="/en/article/modify-computer/nix-trigonometric-math-library-from-zero.lantian/">Nix Trigonometric Math Library from Ground Zero</a> </li><li> 05-29  <a href="/en/article/random-notes/pipewire-sigkill-fix.lantian/">Preventing Pipewire from being SIGKILLed</a> </li><li> 05-12  <a href="/en/article/modify-website/how-to-kill-the-dn42-network.lantian/">How to Kill the DN42 Network (Updated 2023-05-12)</a> </li><li> 05-08  <a href="/en/article/modify-computer/laptop-muxed-nvidia-passthrough.lantian/">NVIDIA GPU Passthrough on an Optimus MUXed Laptop (Updated 2023-05)</a> </li><li> 04-17  <a href="/en/article/random-notes/fix-china-telecom-roaming-no-4g-on-aosp-rom.lantian/">Fix China Telecom 4G Roaming on AOSP ROM by Changing APN</a> </li><li> 03-26  <a href="/en/article/random-notes/old-hp-workstation-as-all-in-one.lantian/">Notes on Setting Up NAS+Router on Old HP Workstation</a> </li><li> 01-14  <a href="/en/article/modify-computer/nixos-impermanence.lantian/">NixOS Series 4: &quot;Stateless&quot; Operating System</a> </li><li> 06-21  <a href="/en/article/modify-computer/nixos-packaging.lantian/">NixOS Series 3: Software Packaging 101</a> </li> </ul> </section> <section class="widget"> <h3>Latest comments</h3> <ul class="list-unstyled" id="recent-comments">  <li><a href="#">Loading...</a></li>  </ul> </section> <script type="module">const i=window.location.hostname=="localhost"?"https://comments.lantian.pub":window.location.origin;fetch(`${i}/api/comment?type=recent&count=10`).then(t=>{if(t.status!==200)throw new Error(`Server returned bad HTTP status ${t.status}`);return t.json()}).then(t=>{const e=document.getElementById("recent-comments");e&&(e.innerHTML=t.data.map(n=>{const o=n.comment.replace(/(<([^>]+)>)/gi,"");return"<li>"+n.nick+' <a href="'+n.url+'">'+o+"</a></li>"}).join(""))});</script> <section class="widget"> <h3>Others</h3> <ul class="list-unstyled">  <li> <i class="fas fa-fw fa-rss"></i>  <a href="/rss2.xml" target="_blank">RSS Feed</a> |  <a href="/feed.xml" target="_blank">Atom</a> |  <a href="/feed.json" target="_blank">JSON</a> </li> <li> <i class="fas fa-fw fa-globe"></i>  <a href="https://stats.uptimerobot.com/BLK6VsRkR" target="_blank"> Sever Status </a> </li> <li> <i class="fas fa-fw fa-sitemap"></i>  <a href="https://lg.lantian.pub" target="_blank">DN42 Looking Glass</a> </li> <li> <i class="fas fa-fw fa-link"></i>  <a href="gopher://lantian.pub" target="_blank">Access with Gopher protocol</a> </li>  </ul> </section> <section class="widget"> <h3>Links</h3> <ul class="list-unstyled"> <li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://0x7f.cc"> 0x7f Blog 🐑 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="http://foreverblog.cn"> 10 Year&#39;s Promise (Forever Blog) </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://alanyhq.com"> Alanyhq </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.baoshuo.ren/?utm_source=friends"> Baoshuo&#39;s Blog </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.cas7.moe"> Blog of Moecast </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://jerryxiao.cc"> JerryXiao </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://sangsir.com"> SangSir </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://snli.org"> Shucheng Li </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://yuetau.net"> YuetAu&#39;s Spot </a> </li> </ul> </section> </aside> </div> <footer class="lantian clearfix" data-astro-cid-w3csb3e3="">  <div id="copyright" class="float-end text-end" data-astro-cid-w3csb3e3=""> <i class="fas fa-copyright" data-astro-cid-w3csb3e3=""></i> 2012-2025 Lan Tian @ Blog<br data-astro-cid-w3csb3e3=""> <small data-astro-cid-w3csb3e3=""> Powered by Astro v5.15.1 @ 2025-10-25 23:46:38 </small> </div> <script type="module">function v(c,o,r){const h=/^localhost$|^127(?:\.[0-9]+){0,2}\.[0-9]+$|^(?:0*:)*?:?0*1$/.test(location.hostname)||location.protocol==="file:";if(!o.trackLocalhost&&h)return console.warn("[Plausible] Ignoring event because website is running locally");try{if(window.localStorage.plausible_ignore==="true")return console.warn('[Plausible] Ignoring event because "plausible_ignore" is set to "true" in localStorage')}catch{}const p={n:c,u:o.url,d:o.domain,r:o.referrer,w:o.deviceWidth,h:o.hashMode?1:0,p:r&&r.props?JSON.stringify(r.props):void 0},s=new XMLHttpRequest;s.open("POST",`${o.apiHost}/api/event`,!0),s.setRequestHeader("Content-Type","text/plain"),s.send(JSON.stringify(p)),s.onreadystatechange=()=>{s.readyState===4&&r&&r.callback&&r.callback()}}function b(c){const o=()=>({hashMode:!1,trackLocalhost:!1,url:location.href,domain:location.hostname,referrer:document.referrer||null,deviceWidth:window.innerWidth,apiHost:"https://plausible.io",...c}),r=(t,n,i)=>{v(t,{...o(),...i},n)},h=(t,n)=>{r("pageview",n,t)};return{trackEvent:r,trackPageview:h,enableAutoPageviews:()=>{const t=()=>h(),n=history.pushState;return n&&(history.pushState=function(i,l,u){n.apply(this,[i,l,u]),t()},addEventListener("popstate",t)),c&&c.hashMode&&addEventListener("hashchange",t),h(),function(){n&&(history.pushState=n,removeEventListener("popstate",t)),c&&c.hashMode&&removeEventListener("hashchange",t)}},enableAutoOutboundTracking:(t=document,n={subtree:!0,childList:!0,attributes:!0,attributeFilter:["href"]})=>{function i(e){r("Outbound Link: Click",{props:{url:this.href}}),typeof process<"u"&&process,setTimeout(()=>{location.href=this.href},150),e.preventDefault()}const l=new Set;function u(e){e instanceof HTMLAnchorElement?e.host!==location.host&&(e.addEventListener("click",i),l.add(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(u)}function f(e){e instanceof HTMLAnchorElement?(e.removeEventListener("click",i),l.delete(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(f)}const d=new MutationObserver(e=>{e.forEach(a=>{a.type==="attributes"?(f(a.target),u(a.target)):a.type==="childList"&&(a.addedNodes.forEach(u),a.removedNodes.forEach(f))})});return t.querySelectorAll("a").forEach(u),d.observe(t,n),function(){l.forEach(a=>{a.removeEventListener("click",i)}),l.clear(),d.disconnect()}}}}const g=b({domain:"lantian.pub",trackLocalhost:!0,apiHost:""});g.trackPageview();</script> </footer>  </div>  </body> </html>