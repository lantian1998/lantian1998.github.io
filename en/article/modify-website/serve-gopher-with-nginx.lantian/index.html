<!DOCTYPE html><html lang="en-US" itemscope="" itemtype="https://schema.org/Article" data-astro-cid-porej7z2=""> <head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Setting up Gopher Site with Nginx - Lan Tian @ Blog</title><script>
  ;(() => {
    try {
      const mode = localStorage.getItem('user-color-scheme')
      if (mode == 'dark' || mode == 'light') {
        document.documentElement.setAttribute('data-user-color-scheme', mode)
      }
    } catch {
      // Ignore errors
    }
  })()
  ;(() => {
    window.lantianImageFallback = (img, src) => {
      img.onerror = null
      img.srcset = src
      img.src = src
      if (img.parentNode.nodeName.toLowerCase() === 'picture') {
        const picture = img.parentNode
        picture.innerHTML = ''
        picture.appendChild(img)
      }
    }
  })()
</script><link rel="stylesheet" href="/assets/index.CN3CN3hr.css"><style>.post-image-wrap[data-astro-cid-potdituc]{margin:0 -5px}.post-image-wrap[data-astro-cid-potdituc] img[data-astro-cid-potdituc]{height:150px;-o-object-fit:cover;object-fit:cover;-o-object-position:center;object-position:center}@media(min-width:768px){.post-image-wrap[data-astro-cid-potdituc]{padding:5px;float:right}.post-image-wrap[data-astro-cid-potdituc] img[data-astro-cid-potdituc]{max-width:200px}}@media(max-width:767.98px){.post-image-wrap[data-astro-cid-potdituc]{text-align:center}.post-image-wrap[data-astro-cid-potdituc] img[data-astro-cid-potdituc]{max-width:100%}}#post-navi[data-astro-cid-gfbmwgei]{padding:5px;border-top:1px solid var(--lt-border-weak);border-bottom:1px solid var(--lt-border-weak)}
</style><link rel="stylesheet" href="/assets/index.DC6W6NZY.css"><script type="module" src="/assets/PageLayout.astro_astro_type_script_index_0_lang.Co1i7321.js"></script><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Referrer-Policy" content="no-referrer, strict-origin-when-cross-origin"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="imagemode" content="force"><meta name="nightmode" content="disable"><meta name="wap-font-scale" content="no"><meta name="title" content="Setting up Gopher Site with Nginx - Lan Tian @ Blog"><meta name="keywords" content=""><meta name="author" content="Lan Tian"><link rel="canonical" href="https://lantian.pub/en/article/modify-website/serve-gopher-with-nginx.lantian/"><link rel="alternate" type="application/rss+xml" title="Lan Tian @ Blog" href="https://lantian.pub/rss2.xml"><link rel="alternate" type="application/atom+xml" title="Lan Tian @ Blog" href="https://lantian.pub/feed.xml"><link rel="alternate" href="https://lantian.pub/article/modify-website/serve-gopher-with-nginx.lantian/" hreflang="zh"><link rel="alternate" href="https://lantian.pub/en/article/modify-website/serve-gopher-with-nginx.lantian/" hreflang="en"><meta name="copyright" content="Copyright 2012-2026 Lan Tian @ Blog"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#03a9f4"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#212121"><meta name="application-name" content="Lan Tian @ Blog"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="apple-touch-icon" sizes="1024x1024" href="/apple-touch-icon-1024x1024.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#03a9f4"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Lan Tian @ Blog"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-640x1136.png"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1136x640.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-750x1334.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1334x750.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1125x2436.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2436x1125.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1170x2532.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2532x1170.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1179x2556.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2556x1179.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-828x1792.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1792x828.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2688.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2688x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2208.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2208x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1284x2778.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2778x1284.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1290x2796.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2796x1290.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1488x2266.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2266x1488.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1536x2048.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2048x1536.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1620x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1620.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1640x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1640.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2388.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2388x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2224.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2224x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-2048x2732.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2732x2048.png"><meta name="msapplication-TileColor" content="#bbdefb"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"><meta property="og:url" content="https://lantian.pub/en/article/modify-website/serve-gopher-with-nginx.lantian/"><meta property="og:type" content="website"><meta property="og:title" content="Setting up Gopher Site with Nginx - Lan Tian @ Blog"><meta property="og:image" content="https://lantian.pub/usr/uploads/202103/gopher-gopherus-en.png"><meta content="Changelog 2021-03-24: Improve post-processing, add scripts for parsing links and images. 2021-03-21: Initial version. What's Gopher Gopher is a protocol born in the early ages of the Internet. It was invented at the University of Minnesota in 1991, with a purpose similar to HTTP today. The protocol itself is extremely simple: Client connects to TCP port 70 of the server, and send one line of URL ending with CRLF, e.g. some_dir/hello.txt Server sends data of the requested file and closes the connection. And we're done. The server could be returning a text file, a picture, a binary file, or a Gopher list file called Gophermap with special formatting. Each line of the file is composed of the following fields: A character representing the type of this line, may it be text ( i ),..."><meta property="og:site_name" content="Lan Tian @ Blog"><meta property="og:locale" content="en"><meta name="twitter:card" content="summary"><meta name="twitter:url" content="https://lantian.pub/en/article/modify-website/serve-gopher-with-nginx.lantian/"><meta name="twitter:title" content="Setting up Gopher Site with Nginx - Lan Tian @ Blog"><meta property="twitter:image" content="https://lantian.pub/usr/uploads/202103/gopher-gopherus-en.png"><meta content="Changelog 2021-03-24: Improve post-processing, add scripts for parsing links and images. 2021-03-21: Initial version. What's Gopher Gopher is a protocol born in the early ages of the Internet. It was invented at the University of Minnesota in 1991, with a purpose similar to HTTP today. The protocol itself is extremely simple: Client connects to TCP port 70 of the server, and send one line of URL ending with CRLF, e.g. some_dir/hello.txt Server sends data of the requested file and closes the connection. And we're done. The server could be returning a text file, a picture, a binary file, or a Gopher list file called Gophermap with special formatting. Each line of the file is composed of the following fields: A character representing the type of this line, may it be text ( i ),..."><meta name="twitter:dnt" content="on"><meta itemprop="name" content="Setting up Gopher Site with Nginx - Lan Tian @ Blog"><meta property="image" content="https://lantian.pub/usr/uploads/202103/gopher-gopherus-en.png"><meta content="Changelog 2021-03-24: Improve post-processing, add scripts for parsing links and images. 2021-03-21: Initial version. What's Gopher Gopher is a protocol born in the early ages of the Internet. It was invented at the University of Minnesota in 1991, with a purpose similar to HTTP today. The protocol itself is extremely simple: Client connects to TCP port 70 of the server, and send one line of URL ending with CRLF, e.g. some_dir/hello.txt Server sends data of the requested file and closes the connection. And we're done. The server could be returning a text file, a picture, a binary file, or a Gopher list file called Gophermap with special formatting. Each line of the file is composed of the following fields: A character representing the type of this line, may it be text ( i ),..."><meta content="Changelog 2021-03-24: Improve post-processing, add scripts for parsing links and images. 2021-03-21: Initial version. What's Gopher Gopher is a protocol born in the early ages of the Internet. It was invented at the University of Minnesota in 1991, with a purpose similar to HTTP today. The protocol itself is extremely simple: Client connects to TCP port 70 of the server, and send one line of URL ending with CRLF, e.g. some_dir/hello.txt Server sends data of the requested file and closes the connection. And we're done. The server could be returning a text file, a picture, a binary file, or a Gopher list file called Gophermap with special formatting. Each line of the file is composed of the following fields: A character representing the type of this line, may it be text ( i ),..."><link rel="me" href="https://mastodon.social/@lantian"></head> <body data-astro-cid-porej7z2=""> <div id="bg" data-astro-cid-j6vmxtef=""></div>   <div id="container" class="container" data-astro-cid-porej7z2=""> <nav class="lantian navbar navbar-expand-lg" data-astro-cid-wu5dj4rx=""> <div class="container-fluid" data-astro-cid-wu5dj4rx=""> <a class="navbar-brand" href="/en/" data-astro-cid-wu5dj4rx="">Lan Tian @ Blog</a> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#lantian-navbar" aria-controls="lantian-navbar" aria-expanded="false" aria-label="Toggle navigation" data-astro-cid-wu5dj4rx=""> <span class="navbar-toggler-icon" data-astro-cid-wu5dj4rx=""></span> </button> <div class="collapse navbar-collapse" id="lantian-navbar" data-astro-cid-wu5dj4rx=""> <ul class="navbar-nav" data-astro-cid-wu5dj4rx=""> <li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/archive/index.html" data-astro-cid-wu5dj4rx=""> Posts </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> Himawari </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> <li class="nav-item dropdown d-block d-lg-none" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="pages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-file" data-astro-cid-wu5dj4rx=""></i> Page  <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="pages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/archive/index.html" data-astro-cid-wu5dj4rx=""> Posts </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> Himawari </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> </ul> </li> </ul> <ul class="navbar-nav ms-auto" data-astro-cid-wu5dj4rx=""> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="languages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-language" data-astro-cid-wu5dj4rx=""></i> Language <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="languages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/article/modify-website/serve-gopher-with-nginx.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-cn" data-astro-cid-wu5dj4rx=""></span> Chinese Simplified / 简体中文 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item active" href="/en/article/modify-website/serve-gopher-with-nginx.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-us" data-astro-cid-wu5dj4rx=""></span> English </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">Not all pages have translations.</a> </li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">You may see 404 - this is normal.</a> </li> </ul> </li> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="color-scheme-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> Night Mode </a> <ul class="dropdown-menu" aria-labelledby="color-scheme-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-auto" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> Auto </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-light" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-sun" data-astro-cid-wu5dj4rx=""></i> Light</a> </li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-dark" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-moon" data-astro-cid-wu5dj4rx=""></i> Dark</a> </li> </ul> </li> </ul> </div> </div> </nav> <script type="module">const m="user-color-scheme",s="data-user-color-scheme",u=(e,t)=>{try{localStorage.setItem(e,t)}catch{}},i=e=>{try{return localStorage.getItem(e)}catch{return null}},c=e=>{const t={dark:!0,light:!0,auto:!0},o=e===null||!Object.keys(t).includes(e)?"auto":e;u(m,o);for(const l in t){const n=document.getElementById("color-scheme-"+l);n&&(l==o?n.classList.add("active"):n.classList.remove("active"))}o!="auto"?document.documentElement.setAttribute(s,o):document.documentElement.removeAttribute(s)};c(i(m));const r=document.getElementById("color-scheme-auto");r&&r.addEventListener("click",()=>c("auto"));const a=document.getElementById("color-scheme-light");a&&a.addEventListener("click",()=>c("light"));const d=document.getElementById("color-scheme-dark");d&&d.addEventListener("click",()=>c("dark"));</script>  <div class="d-flex" data-astro-cid-porej7z2=""> <div id="content" data-astro-cid-porej7z2="">  <article> <div class="d-flex"> <div class="post-info-wrap" data-astro-cid-dckccua4=""> <div class="post-info" data-astro-cid-dckccua4=""> <div class="post-meta-wrap" data-astro-cid-tde7heiu=""> <div class="post-meta" data-astro-cid-tde7heiu=""> <p data-astro-cid-tde7heiu=""> <span class="fas fa-clock" data-astro-cid-tde7heiu=""></span> <br data-astro-cid-tde7heiu=""> <small data-astro-cid-tde7heiu="">03-21</small> </p> <div class="post-meta-value" data-astro-cid-tde7heiu=""> Published on<span class="badge badge-tag" data-astro-cid-dckccua4=""> 2021-03-21 22:16 </span>  </div> </div> </div>   <div class="post-meta-wrap" data-astro-cid-tde7heiu=""> <div class="post-meta" data-astro-cid-tde7heiu=""> <p data-astro-cid-tde7heiu=""> <span class="fas fa-file-alt" data-astro-cid-tde7heiu=""></span> <br data-astro-cid-tde7heiu=""> <small data-astro-cid-tde7heiu="">Website and Servers</small> </p> <div class="post-meta-value" data-astro-cid-tde7heiu=""> Category <a class="badge badge-tag" href="/en/category/modify-website" data-astro-cid-dckccua4=""> Website and Servers </a>  </div> </div> </div>   <div class="post-meta-wrap" data-astro-cid-tde7heiu=""> <div class="post-meta" data-astro-cid-tde7heiu=""> <p data-astro-cid-tde7heiu=""> <span class="fas fa-tag" data-astro-cid-tde7heiu=""></span> <br data-astro-cid-tde7heiu=""> <small data-astro-cid-tde7heiu="">2 tags</small> </p> <div class="post-meta-value" data-astro-cid-tde7heiu=""> Tags  <a class="badge badge-tag" href="/en/tag/nginx" data-astro-cid-dckccua4=""> nginx </a>  <a class="badge badge-tag" href="/en/tag/Gopher" data-astro-cid-dckccua4=""> Gopher </a>  </div> </div> </div>   <div class="post-meta-wrap" data-astro-cid-tde7heiu=""> <div class="post-meta" data-astro-cid-tde7heiu=""> <p data-astro-cid-tde7heiu=""> <span class="fas fa-list" data-astro-cid-tde7heiu=""></span> <br data-astro-cid-tde7heiu=""> <small data-astro-cid-tde7heiu="">ToC</small> </p> <div class="post-meta-value" data-astro-cid-tde7heiu="">  <ol data-astro-cid-nj3qel45=""> <li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#changelog" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Changelog</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#whats-gopher" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">What&#39;s Gopher</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#why-nginx" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Why Nginx?</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#let-nginx-support-gopher" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Let Nginx support Gopher</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#nginx-patch-and-usage" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">nginx Patch and Usage</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#generating-gophermaps" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Generating Gophermaps</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#final-results" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Final Results</span> </a> </li> </ol>   </div> </div> </div>   </div>  </div>  <div class="post-wrap"> <div class="post-image-wrap" data-astro-cid-potdituc=""><picture data-astro-cid-potdituc=""><source srcset="/usr/uploads/202103/gopher-gopherus-en.png.thumb.png.webp" type="image/webp" data-astro-cid-potdituc=""><source srcset="/usr/uploads/202103/gopher-gopherus-en.png.thumb.png.avif" type="image/avif" data-astro-cid-potdituc=""><source srcset="/usr/uploads/202103/gopher-gopherus-en.png.thumb.png.jxl" type="image/jxl" data-astro-cid-potdituc=""><img src="/usr/uploads/202103/gopher-gopherus-en.png.thumb.png" alt="Illustration for Setting up Gopher Site with Nginx" height="150" onerror="window.lantianImageFallback(this, '/usr/uploads/202103/gopher-gopherus-en.png.thumb.png')" data-astro-cid-potdituc=""></picture></div> <h1 class="post-title"> <a href="/en/article/modify-website/serve-gopher-with-nginx.lantian/" rel="bookmark" title="Setting up Gopher Site with Nginx">Setting up Gopher Site with Nginx</a> </h1> <div class="post-text">   <h2 id="changelog">Changelog</h2>
<ul>
<li>2021-03-24: Improve post-processing, add scripts for parsing links and images.</li>
<li>2021-03-21: Initial version.</li>
</ul>
<h2 id="whats-gopher">What's Gopher</h2>
<p>Gopher is a protocol born in the early ages of the Internet. It was invented at
the University of Minnesota in 1991, with a purpose similar to HTTP today. The
protocol itself is extremely simple:</p>
<ol>
<li>Client connects to TCP port 70 of the server, and send one line of URL ending
with CRLF, e.g. <code>some_dir/hello.txt</code></li>
<li>Server sends data of the requested file and closes the connection.</li>
<li>And we're done.</li>
</ol>
<p>The server could be returning a text file, a picture, a binary file, or a Gopher
list file called <code>Gophermap</code> with special formatting. Each line of the file is
composed of the following fields:</p>
<ol>
<li>A character representing the type of this line, may it be text (<code>i</code>), a link
to a text file (<code>0</code>), a link to another Gophermap (<code>1</code>), a picture (<code>I</code>), or
a binary (<code>9</code>). Of course, there are other types meant for protocols no
longer used today. See
<a href="https://tools.ietf.org/html/rfc1436#section-3.8" rel="noopener noreferrer" target="_blank">RFC1436 Section 3.8</a> for
more details.</li>
<li>A message line to be shown for this line, e.g., <code>Hello World</code>.</li>
<li>A TAB character.</li>
<li>Target path of the link, e.g., <code>/some_dir/hello.txt</code>.</li>
<li>A TAB character.</li>
<li>Target hostname of the link, e.g., <code>gopher.lantian.pub</code>.</li>
<li>A TAB character.</li>
<li>Target port of the link, usually <code>70</code>.</li>
<li>CR+LF as line ending.</li>
</ol>
<p>At the end of the <code>Gophermap</code> there is a single period on its own line, marking
the end of the map.</p>
<p>Take a look at these examples:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># A line of information. It has no link target for part 4, and you may fill anything for the target host and port</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">iHello</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> World[TAB][TAB]invalid.host[TAB]70[CR][LF]</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Example of a link</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">iProject</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Description[TAB]/project/description.txt[TAB]gopher.lantian.pub[TAB]70[CR][LF]</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Example of a picture</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">iScreenshot[TAB]/project/screenshot.jpg[TAB]gopher.lantian.pub[TAB]70[CR][LF]</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># End marker of Gophermap</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">.</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">[CR][LF]</span></span></code></pre>
<p>Under the background of lacking computing power, the Gopher protocol was widely
used in the 1990s due to its extreme simplicity. But since the only thing a
client can do is to send a URL, it is much more complicated to allow the client
to post data onto the server, like for searching or comment sections. In
addition, the server can only return the file itself but nothing else, unlike
HTTP where additional response headers are allowed. This means the client needs
to find out the type of response based on previous Gophermaps, or even guess on
its own. Therefore, Gopher was eventually replaced with functionally superior
HTTP.</p>
<p>But Gopher protocol isn't dead. As of now (the year 2021), there are still
actively maintained Gopher server software such as
<a href="https://github.com/gophernicus/gophernicus" rel="noopener noreferrer" target="_blank">Gophernicus</a>, and there are sites
serving over Gopher.</p>
<p>If you want to try visiting Gopher sites, you may try
<a href="https://gopher.floodgap.com/overbite/" rel="noopener noreferrer" target="_blank">Overbite extension for Firefox</a>, or
client software like <a href="http://gopherus.sourceforge.net/" rel="noopener noreferrer" target="_blank">Gopherus</a>.</p>
<h2 id="why-nginx">Why Nginx?</h2>
<p>Compared to some software designed specifically for Gopher, such as Gophernicus,
Nginx has better support for modern dynamic web pages. For example, it can
dynamically generate responses based on PHP and ASP.NET (Mono) over FastCGI, or
proxy requests to other HTTP servers, effectively making it a Gopher gateway.
Comparatively, Gophernicus only supports classic CGI and no proxy functionality.
In addition, Nginx is well known for its high performance.</p>
<p>But there is one more reason I chose Nginx: I was
<a href="/en/article/modify-website/serve-dn42-whois-with-nginx.lantian/">modifying Nginx to use it as a WHOIS server</a>
(for DN42), and WHOIS protocol is almost the same as Gopher: one request and one
response. With minor adjustments, I can make my new feature work with Gopher.</p>
<h2 id="let-nginx-support-gopher">Let Nginx support Gopher</h2>
<p>Nginx, by itself, is an HTTP server. Let us ignore for a moment the modern
HTTP/2.0 with binary commands, or UDP-based QUIC or HTTP/3.0, and look back at
the HTTP/1.1, which was once widely used. Back then, a request looks like this:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">GET</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /test.php</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> HTTP/1.1</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Host:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> localhost</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">User-Agent:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> curl/7.75.0</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Accept:</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> *</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">*</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">HTTP/1.1</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 200</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> OK</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Server:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> nginx/1.18.0</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Date:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Sun,</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 21</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Mar</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 2021</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> 12:08:07</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> GMT</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Content-Type:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> text/html</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">; </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">charset</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">=</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">UTF-8</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Transfer-Encoding:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> chunked</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Connection:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> keep-alive</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">X-Powered-By:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> PHP/8.0.3</span></span></code></pre>
<p>The first part is the client request, of which <code>GET http://localhost/ HTTP/1.1</code>
and <code>Host: localhost</code> are necessary. They tell the server the path (<code>/test.php</code>)
and domain (<code>localhost</code>) the client is trying to access.</p>
<p>The other parts, such as User-Agent headers commonly seen, are not an essential
part of the HTTP protocol. We can connect to the server manually with
<code>telnet localhost 80</code> and only send the first two lines:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">GET</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /test.php</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> HTTP/1.1</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Host:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> localhost</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">HTTP/1.1</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 200</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> OK</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Server:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> nginx/1.18.0</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Date:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Sun,</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 21</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Mar</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 2021</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> 12:13:58</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> GMT</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Content-Type:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> text/html</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">; </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">charset</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">=</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">UTF-8</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Transfer-Encoding:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> chunked</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Connection:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> keep-alive</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">X-Powered-By:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> PHP/8.0.3</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">c</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Hello</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> World</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">^CConnection</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> closed</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> by</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> foreign</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> host.</span></span></code></pre>
<p>The server still gave back contents for the page, but there are things more than
we actually need:</p>
<ul>
<li>Gopher clients won't recognize the 200 status code of HTTP;</li>
<li>There are extra response headers including Date, Content-Type, etc.;</li>
<li>The responses of Nginx are encoded with <code>Transfer-Encoding: chunked</code>, which
Gopher clients have no idea about;</li>
<li>We need to press Enter twice after the <code>Host:</code> line before Nginx sends the
response. Gopher clients will only do it once;</li>
<li>Most importantly, have you noticed the <code>^C</code>? It's there because I manually
pressed <code>Ctrl+C</code> to terminate the connection. Nginx has
<code>Connection: keep-alive</code> enabled by default and won't actively close the
connection after the request is completed. Instead, it will wait for the
client to send a second request. A Gopher client, in this case, will wait
forever.</li>
</ul>
<p>Therefore, there's too much to change based on HTTP/1.1. But if there's 1.1,
there's also 1.0. How about we have a try of HTTP/1.0?</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">GET</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /test.php</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> HTTP/1.0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">HTTP/1.1</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 200</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> OK</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Server:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> nginx/1.18.0</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Date:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Sun,</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 21</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Mar</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 2021</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> 12:20:24</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> GMT</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Content-Type:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> text/html</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">; </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">charset</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">=</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">UTF-8</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Connection:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> close</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">X-Powered-By:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> PHP/8.0.3</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Hello</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> World</span></span></code></pre>
<p>This time, the server actively closed the connection, and returned raw data
instead of <code>chunk</code> encoded ones, which is good. But there are still extra HTTP
response headers. Do we need to disable all logic related to HTTP headers?
There's still a lot to do. And we still need to press Enter twice, by the way.</p>
<p>Here's some good news: there was an extremely simple version of HTTP/0.9 before
HTTP/1.0, and it is just a single line:</p>
<pre><code>GET /test.php
Hello World
</code></pre>
<p>The client only sent the first <code>GET</code> line. Once it sends a line feed, Nginx
replies back <code>Hello World</code> without needing the second line feed, without status
code 200 or other headers, and not forgetting to close the connection. This is
very close to what we want: the HTTP client sent <code>GET /test.php[ENTER]</code> this
time, while a Gopher client will probably send <code>test.php[ENTER]</code>.</p>
<p>Now we have a plan: add a protocol to parse Gopher requests, set the request
type to GET, add a slash <code>/</code> before the URL, and copy/reuse HTTP/0.9 logic for
the rest part.</p>
<h2 id="nginx-patch-and-usage">nginx Patch and Usage</h2>
<p>I made a patch using the method above, which can be directly applied to the
source code of Nginx 1.19.7. The patch can be obtained from
<a href="https://gist.github.com/xddxdd/293becc41d805d7b8cfb5d11b6e326e1" rel="noopener noreferrer" target="_blank">https://gist.github.com/xddxdd/293becc41d805d7b8cfb5d11b6e326e1</a></p>
<p>Overall, this patch did three changes:</p>
<ol>
<li>A new option, <code>plain</code>, is added to <code>listen</code>, meaning this port will be used
to receive Gopher connections without the GET part.
<ul>
<li>Use it like <code>listen 70 plain default_server;</code></li>
<li>Attention: a <code>plain</code> port cannot receive normal HTTP requests! So do not
add it to the <code>listen</code> for port 80, and never use it with other protocols
like <code>http2</code>.</li>
<li>SSL is theoretically supported, but I never tried.</li>
</ul>
</li>
<li>A state machine for parsing <code>plain</code> URLs is added. Compared to HTTP state
machines, everything related to parsing request type (<code>GET</code>), domain
(<code>http://localhost</code>), and HTTP version (<code>HTTP/1.1</code>) is removed. The request
type is hardcoded to <code>GET</code>, the domain set to <code>null</code> (just like HTTP/1.0),
and the HTTP version is set to 0.9.</li>
<li>Before starting to receive requests from the client, a slash <code>/</code> is stored
into the receiving buffer to insert it to the beginning of the URL. Nginx
will use the pointers to the URL many times during the entire process, and
compared to changing all URL-related logic, inserting a slash is simple,
effective, and reliable.</li>
</ol>
<p>Remember to enable <code>--with-http_plain_module</code> while compiling Nginx, and
remember to set <code>index gophermap;</code> so Nginx looks for the Gophermap by default.</p>
<h2 id="generating-gophermaps">Generating Gophermaps</h2>
<p>Now that we have a server, the next thing we need is files for the website.
Since I use Hexo, a static site generator, and all my posts are written in
Markdown, I simply went the lazy way of reformatting Markdown files with
<a href="https://github.com/remarkjs/remark" rel="noopener noreferrer" target="_blank">Remark</a>, capping to 70 characters per line
with <a href="https://github.com/prettier/prettier" rel="noopener noreferrer" target="_blank">Prettier</a>. Then I search for all
links and images with a regex, put them to their own lines as link (<code>1</code>) or
image (<code>I</code>), since Gophermap doesn't support mixing text and link in the same
line. All other texts are set as <code>i</code>:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">const</span><span style="--shiki-dark:#4FC1FF;--shiki-light:#0070C1"> crlf</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\r\n</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">const</span><span style="--shiki-dark:#4FC1FF;--shiki-light:#0070C1"> gopherBefore</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'i'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">const</span><span style="--shiki-dark:#4FC1FF;--shiki-light:#0070C1"> gopherBeforeLink</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'1'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">const</span><span style="--shiki-dark:#4FC1FF;--shiki-light:#0070C1"> gopherBeforeImage</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'I'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">const</span><span style="--shiki-dark:#4FC1FF;--shiki-light:#0070C1"> gopherAfter</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\t\t</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">{{server_addr}}</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\t</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">{{server_port}}'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">crlf</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">const</span><span style="--shiki-dark:#4FC1FF;--shiki-light:#0070C1"> gopherEOF</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'.'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">crlf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">function</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> markdown_formatter</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">rel_path</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">md</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) {</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">  const</span><span style="--shiki-dark:#4FC1FF;--shiki-light:#0070C1"> markdownRegex</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#D16969;--shiki-light:#811F3F">/</span><span style="--shiki-dark:#CE9178;--shiki-light:#D16969">([^</span><span style="--shiki-dark:#D16969;--shiki-light:#811F3F">!</span><span style="--shiki-dark:#CE9178;--shiki-light:#D16969">]</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#000000">?</span><span style="--shiki-dark:#CE9178;--shiki-light:#D16969">)(</span><span style="--shiki-dark:#D16969;--shiki-light:#811F3F">!</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#000000">?</span><span style="--shiki-dark:#CE9178;--shiki-light:#D16969">)</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\[</span><span style="--shiki-dark:#CE9178;--shiki-light:#D16969">([^</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\]</span><span style="--shiki-dark:#CE9178;--shiki-light:#D16969">]</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#000000">+</span><span style="--shiki-dark:#CE9178;--shiki-light:#D16969">)</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\]\(</span><span style="--shiki-dark:#CE9178;--shiki-light:#D16969">([^</span><span style="--shiki-dark:#D16969;--shiki-light:#811F3F">)</span><span style="--shiki-dark:#CE9178;--shiki-light:#D16969">]</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#000000">+</span><span style="--shiki-dark:#CE9178;--shiki-light:#D16969">)</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\)</span><span style="--shiki-dark:#CE9178;--shiki-light:#D16969">(</span><span style="--shiki-dark:#D16969;--shiki-light:#811F3F">.</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#000000">?</span><span style="--shiki-dark:#CE9178;--shiki-light:#D16969">)</span><span style="--shiki-dark:#D16969;--shiki-light:#811F3F">/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">g</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">  var</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> rows</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">md</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">split</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\n</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">  for</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">var</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> i</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">; </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">i</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> &#x3C; </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">rows</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">length</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">; </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">i</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">++) {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    // Recognize all [Link](url) 和 ![Image](image)</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    if</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">rows</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">i</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">].</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">match</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">markdownRegex</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)) {</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">      var</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> replace_at_beginning</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">        replace_at_end</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">      var</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> replace_fn</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">match</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">prefix</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">img_marker</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">label</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">href</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">suffix</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">=></span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">        // Don't replace external links like http://, gopher://</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">        // Gopher browsers don't support them</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">        if</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">href</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">match</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'://'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)) {</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">          return</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> match</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">        if</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">prefix</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> !== </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">null</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">          // Mark there's link or image at line beginning</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">          // Don't add prefix anymore</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">          replace_at_beginning</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        }</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">        if</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">suffix</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> !== </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">null</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">          // Mark there's link or image at line end</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">          // Don't add suffix anymore</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">          replace_at_end</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">        href</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">path</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">join</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'/'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">rel_path</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">href</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">        return</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">          (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">prefix</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ? </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">prefix</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gopherAfter</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> : </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">''</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) +</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">          (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">img_marker</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> === </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'!'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ? </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gopherBeforeImage</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> : </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gopherBeforeLink</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) +</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">          label</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> +</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">          '</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\t</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> +</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">          href</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> +</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">          '</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\t</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">{{server_addr}}</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\t</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">{{server_port}}'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> +</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">          crlf</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> +</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">          (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">suffix</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ? </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gopherBefore</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">suffix</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> : </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">''</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        )</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">      rows</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">i</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">] = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">rows</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">i</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">].</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">replaceAll</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">markdownRegex</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">replace_fn</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">      rows</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">i</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">] =</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">replace_at_beginning</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ? </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">''</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> : </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gopherBefore</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) +</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">        rows</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">i</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">] +</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">replace_at_end</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ? </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">''</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> : </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gopherAfter</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    } </span><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">else</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">      rows</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">i</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">] = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gopherBefore</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">rows</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">i</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">] + </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gopherAfter</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    }</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">  return</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> rows</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">join</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">''</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) + </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gopherEOF</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">// Key logic</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">unified</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">()</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  .</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">use</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">remark_parse</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  .</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">use</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">remark_stringify</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    bullet:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> '-'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    fences:</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    listItemIndent:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> 'one'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    resourceLink:</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  })</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  .</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">process</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">data</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">page</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">raw</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) </span><span style="--shiki-dark:#6A9955;--shiki-light:#008000">// Get source Markdown data</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  .</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">then</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">file</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> =></span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    var</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> md</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">String</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">file</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    if</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (!</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">md</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) </span><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">return</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    // Cap to 70 chars per line</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    md</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">prettier</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">format</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">md</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">      parser:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> 'markdown'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">      printWidth:</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 70</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">      tabWidth:</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">      proseWrap:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> 'always'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">      endOfLine:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> 'lf'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    })</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    if</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (!</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">md</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) </span><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">return</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    // Reformat each line to Gophermap</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    md</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">markdown_formatter</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">path</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">dirname</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">data</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">path</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">), </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">md</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    // Write files, omitted</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  })</span></span></code></pre>
<p>The generated file will look like:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">iDN42,</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> aka</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Decentralized</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Network</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> 42,</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> is</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> a</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> large,</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> decentralized</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">          {{server_addr}}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {{server_port}}</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">iVPN-based</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> network.</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> But</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> unlike</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> other</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> traditional</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> VPNs,</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> DN42</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> itself</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">              {{server_addr}}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {{server_port}}</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">idoesn</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">'t provide any VPN exits, which means it doesn'</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">t</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> allow</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> you</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> to</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">             {{server_addr}}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {{server_port}}</span></span></code></pre>
<p>(Actual files have Tabs in them; my editor converted them to spaces)</p>
<p>See the <code>{{server_addr}}</code> and <code>{{server_port}}</code>? They point to the target host
and port. They can neither be omitted or replaced with some "relative" value. I
simply hand the task of setting values for them to nginx:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">location</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">    sub_filter</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "{{server_addr}}\t{{server_port}}"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$gopher_addr</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">\t</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$server_port</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">    sub_filter_once</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> off</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">    sub_filter_types</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> '*'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>With posts ready, I need a list of contents as my index page. I simply wrote a
<code>for</code> loop, generating a link and two lines of summary for each post. The key
logic is as below:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">const</span><span style="--shiki-dark:#4FC1FF;--shiki-light:#0070C1"> crlf</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\r\n</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">const</span><span style="--shiki-dark:#4FC1FF;--shiki-light:#0070C1"> gopherBefore</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'i'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">const</span><span style="--shiki-dark:#4FC1FF;--shiki-light:#0070C1"> gopherBeforeLink</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'1'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">const</span><span style="--shiki-dark:#4FC1FF;--shiki-light:#0070C1"> gopherAfter</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\t\t</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">{{server_addr}}</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\t</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">{{server_port}}'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">crlf</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">const</span><span style="--shiki-dark:#4FC1FF;--shiki-light:#0070C1"> gopherEOF</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'.'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">crlf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">var</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> data</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">''</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">// Title</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">data</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> += </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gopherBefore</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'# '</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">hexo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">config</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">title</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gopherAfter</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">data</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> += </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gopherBefore</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gopherAfter</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">// List of posts</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">locals</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">posts</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sort</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'date'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'desc'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">).</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">each</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">post</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> =></span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  data</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> +=</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    gopherBeforeLink</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> +</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    '- '</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> +</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    post</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">title</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">slice</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">56</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) +</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    ' ('</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> +</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    new</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> Date</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">post</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">date</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">).</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">toISOString</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">().</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">replace</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'T'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">' '</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">).</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">substr</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">19</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) +</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    ')'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> +</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    '</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\t</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> +</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    post</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">path</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">replace</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#D16969;--shiki-light:#811F3F">/index</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\.</span><span style="--shiki-dark:#D16969;--shiki-light:#811F3F">html</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#EE0000">$</span><span style="--shiki-dark:#D16969;--shiki-light:#811F3F">/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">g</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">''</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) +</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    '</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\t</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">{{server_addr}}</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\t</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">{{server_port}}'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> +</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    crlf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  data</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> += </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gopherBefore</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'  '</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">post</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">excerpt</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">slice</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">68</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) + </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gopherAfter</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  data</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> += </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gopherBefore</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'  '</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">post</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">excerpt</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">slice</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">68</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">68</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) + </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gopherAfter</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  data</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> += </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gopherBefore</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gopherAfter</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">})</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">data</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> += </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gopherEOF</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">return</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> data</span></span></code></pre>
<p>I posted my logic of generating Gophermaps in Hexo to
<a href="https://gist.github.com/xddxdd/99170395595e339ed5735cdf9b9b2cd1" rel="noopener noreferrer" target="_blank">https://gist.github.com/xddxdd/99170395595e339ed5735cdf9b9b2cd1</a>.
Place <code>gopher.js</code> to the <code>scripts</code> directory of your theme (e.g.
<code>themes/lantian/scripts/gopher.js</code>) to use it. One reminder though, I removed
some code specific to my site (mainly multilingual support stuff) and didn't
test it again afterwards, so there could be minor issues.</p>
<h2 id="final-results">Final Results</h2>
<p>First, let's take a look at how things look like with Gopherus browser under the
Linux terminal:</p>
<p><picture><source srcset="/usr/uploads/202103/gopher-gopherus.png.webp" type="image/webp"><source srcset="/usr/uploads/202103/gopher-gopherus.png.avif" type="image/avif"><source srcset="/usr/uploads/202103/gopher-gopherus.png.jxl" type="image/jxl"><img src="/usr/uploads/202103/gopher-gopherus.png" alt="Gopherus on Chinese contents"></picture></p>
<p>The site is displayed normally, but it's a bit different from expected: Gopherus
cut each line at 80 bytes, but Chinese characters are 3 bytes each in UTF-8
encoding. This means approximately <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><mn>3</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> of the content each line wraps
to the next line. My English site is shown correctly:</p>
<p><picture><source srcset="/usr/uploads/202103/gopher-gopherus-en.png.webp" type="image/webp"><source srcset="/usr/uploads/202103/gopher-gopherus-en.png.avif" type="image/avif"><source srcset="/usr/uploads/202103/gopher-gopherus-en.png.jxl" type="image/jxl"><img src="/usr/uploads/202103/gopher-gopherus-en.png" alt="Gopherus on English contents"></picture></p>
<p>There are modern solutions compared to Gopherus, which is the Firefox browser
with Overbite plugin:</p>
<p><picture><source srcset="/usr/uploads/202103/gopher-overbite.png.webp" type="image/webp"><source srcset="/usr/uploads/202103/gopher-overbite.png.avif" type="image/avif"><source srcset="/usr/uploads/202103/gopher-overbite.png.jxl" type="image/jxl"><img src="/usr/uploads/202103/gopher-overbite.png" alt="Firefox + Overbite on Chinese contents"></picture></p>
<p>Chinese contents layout is much better than Gopherus. Of course, English
contents can be shown normally as well:</p>
<p><picture><source srcset="/usr/uploads/202103/gopher-overbite-en.png.webp" type="image/webp"><source srcset="/usr/uploads/202103/gopher-overbite-en.png.avif" type="image/avif"><source srcset="/usr/uploads/202103/gopher-overbite-en.png.jxl" type="image/jxl"><img src="/usr/uploads/202103/gopher-overbite-en.png" alt="Firefox + Overbite on English contents"></picture></p>
<p>Let's try browsing a post. Although it's just plain Markdown without much extra
processing, the post itself is readable:</p>
<p><picture><source srcset="/usr/uploads/202103/gopher-overbite-article.png.webp" type="image/webp"><source srcset="/usr/uploads/202103/gopher-overbite-article.png.avif" type="image/avif"><source srcset="/usr/uploads/202103/gopher-overbite-article.png.jxl" type="image/jxl"><img src="/usr/uploads/202103/gopher-overbite-article.png" alt="Firefox + Overbite on Chinese contents"></picture></p>
<p><picture><source srcset="/usr/uploads/202103/gopher-overbite-article-en.png.webp" type="image/webp"><source srcset="/usr/uploads/202103/gopher-overbite-article-en.png.avif" type="image/avif"><source srcset="/usr/uploads/202103/gopher-overbite-article-en.png.jxl" type="image/jxl"><img src="/usr/uploads/202103/gopher-overbite-article-en.png" alt="Firefox + Overbite on English contents"></picture></p>
<p>You can visit <a href="gopher://gopher.lantian.pub">gopher://gopher.lantian.pub</a> with
your own Gopher client to see the results.</p>  </div>  <script type="module" src="/assets/WalineComment.astro_astro_type_script_index_0_lang.Cd-Au78J.js"></script> <div class="clearfix" id="post-navi" data-astro-cid-gfbmwgei=""> <div class="float-end text-end" data-astro-cid-gfbmwgei=""> <a href="/en/article/modify-website/4kb-infinite-sleep-docker-image.lantian/" title="Make an Infinite Sleep Program in Only 4KB" data-astro-cid-gfbmwgei=""> Make an Infinite Sleep Program in Only 4KB </a> <br data-astro-cid-gfbmwgei=""> Next post »
</div> <div class="float-start text-start position-absolute" data-astro-cid-gfbmwgei="">
« Previous post <br data-astro-cid-gfbmwgei=""> <a href="/en/article/modify-website/serve-dn42-whois-with-nginx.lantian/" title="Setting up DN42 WHOIS Server with Nginx" data-astro-cid-gfbmwgei=""> Setting up DN42 WHOIS Server with Nginx </a> </div> </div>  <div id="waline" data-waline-language="en-US" data-waline-path="/en/article/modify-website/serve-gopher-with-nginx.lantian"></div>   </div> </div> </article>  </div> <aside class="d-none d-xl-block" data-astro-cid-porej7z2=""> <section class="widget"> <h3>Latest posts</h3> <ul class="list-unstyled"> <li> 12-07  <a href="/en/article/modify-website/dn42-flapalerted-reduce-flapping.lantian/">Using FlapAlerted to Suppress flapping in DN42</a> </li><li> 07-20  <a href="/en/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/">Legal LTE Network at Home with Open5GS</a> </li><li> 06-27  <a href="/en/article/modify-computer/sidestore-without-stosvpn-across-lan.lantian/">Using SideStore without StosVPN across your LAN</a> </li><li> 05-19  <a href="/en/article/modify-computer/nix-logarithmetic-math-library-from-zero.lantian/">Nix Logarithmic Math Library from Ground Zero</a> </li><li> 04-06  <a href="/en/article/modify-computer/legal-lte-network-at-home-for-100-bucks.lantian/">Legal LTE Network at Home for $100</a> </li><li> 02-10  <a href="/en/article/modify-computer/build-custom-android-kernel-with-nix.lantian/">Building Custom Android Kernel with Nix</a> </li><li> 04-20  <a href="/en/article/modify-website/migrate-blog-to-astro-js.lantian/">Migrating My Blog to Astro.js</a> </li><li> 12-16  <a href="/en/article/modify-computer/nixos-low-ram-vps.lantian/">NixOS Series 5: Creating Disk Image for Low RAM VPS</a> </li><li> 09-20  <a href="/en/article/modify-computer/nix-trigonometric-math-library-from-zero.lantian/">Nix Trigonometric Math Library from Ground Zero</a> </li><li> 05-29  <a href="/en/article/random-notes/pipewire-sigkill-fix.lantian/">Preventing Pipewire from being SIGKILLed</a> </li><li> 05-12  <a href="/en/article/modify-website/how-to-kill-the-dn42-network.lantian/">How to Kill the DN42 Network (Updated 2023-05-12)</a> </li><li> 05-08  <a href="/en/article/modify-computer/laptop-muxed-nvidia-passthrough.lantian/">NVIDIA GPU Passthrough on an Optimus MUXed Laptop (Updated 2023-05)</a> </li><li> 04-17  <a href="/en/article/random-notes/fix-china-telecom-roaming-no-4g-on-aosp-rom.lantian/">Fix China Telecom 4G Roaming on AOSP ROM by Changing APN</a> </li><li> 03-26  <a href="/en/article/random-notes/old-hp-workstation-as-all-in-one.lantian/">Notes on Setting Up NAS+Router on Old HP Workstation</a> </li><li> 01-14  <a href="/en/article/modify-computer/nixos-impermanence.lantian/">NixOS Series 4: &quot;Stateless&quot; Operating System</a> </li> </ul> </section>  <section class="widget"> <h3>Latest comments</h3> <ul class="list-unstyled" id="recent-comments">  <li><a href="#">Loading...</a></li>  </ul> </section>  <script type="module" src="/assets/WalineRecentComments.astro_astro_type_script_index_0_lang.Cu-GBWyK.js"></script> <section class="widget"> <h3>Others</h3> <ul class="list-unstyled">  <li> <i class="fas fa-fw fa-rss"></i>  <a href="/rss2.xml" target="_blank">RSS Feed</a> |  <a href="/feed.xml" target="_blank">Atom</a> |  <a href="/feed.json" target="_blank">JSON</a> </li> <li> <i class="fas fa-fw fa-globe"></i>  <a href="https://stats.uptimerobot.com/NLYPbrSal6" target="_blank"> Sever Status </a> </li> <li> <i class="fas fa-fw fa-sitemap"></i>  <a href="https://lg.lantian.pub" target="_blank">DN42 Looking Glass</a> </li> <li> <i class="fas fa-fw fa-link"></i>  <a href="gopher://lantian.pub" target="_blank">Access with Gopher protocol</a> </li>  </ul> </section>  <section class="widget"> <h3>Links</h3> <ul class="list-unstyled"> <li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://0x7f.cc"> 0x7f Blog 🐑 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="http://foreverblog.cn"> 10 Year&#39;s Promise (Forever Blog) </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://alanyhq.com"> Alanyhq </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.baoshuo.ren/?utm_source=friends"> Baoshuo&#39;s Blog </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.cas7.moe"> Blog of Moecast </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://jerryxiao.cc"> JerryXiao </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://sangsir.com"> SangSir </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://snli.org"> Shucheng Li </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://yuetau.net"> YuetAu&#39;s Spot </a> </li> </ul> </section>  </aside> </div> <footer class="clearfix" data-astro-cid-w3csb3e3="">  <div id="copyright" class="float-end text-end" data-astro-cid-w3csb3e3=""> <i class="fas fa-copyright" data-astro-cid-w3csb3e3=""></i> 2012-2026 Lan Tian @ Blog<br data-astro-cid-w3csb3e3=""> <small data-astro-cid-w3csb3e3=""> Powered by Astro v5.17.1 @ 2026-02-12 02:27:09 </small> </div> <script type="module" src="/assets/PlausibleAnalytics.astro_astro_type_script_index_0_lang.C6V0cCkY.js"></script> </footer>  </div>  </body> </html>