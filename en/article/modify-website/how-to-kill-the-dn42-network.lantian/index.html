<!DOCTYPE html><html lang="en-US" itemscope="" itemtype="https://schema.org/Article" data-astro-cid-porej7z2=""> <head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>How to Kill the DN42 Network (Updated 2023-05-12) - Lan Tian @ Blog</title><script>
  ;(() => {
    try {
      const mode = localStorage.getItem('user-color-scheme')
      if (mode == 'dark' || mode == 'light') {
        document.documentElement.setAttribute('data-user-color-scheme', mode)
      }
    } catch {
      // Ignore errors
    }
  })()
</script><link rel="stylesheet" href="/assets/index.CUlf1-Vz.css"><style>#post-navi[data-astro-cid-gfbmwgei]{padding:5px;border-top:1px solid var(--lt-border-weak);border-bottom:1px solid var(--lt-border-weak)}
ol[data-astro-cid-nj3qel45]{margin:0;padding:0;line-height:1.5}ol[data-astro-cid-nj3qel45] .toc-item[data-astro-cid-nj3qel45]{list-style:none}ol[data-astro-cid-nj3qel45] .toc-child[data-astro-cid-nj3qel45],ol[data-astro-cid-nj3qel45] .toc[data-astro-cid-nj3qel45]{padding:0}ol[data-astro-cid-nj3qel45] .toc-link[data-astro-cid-nj3qel45]{display:block;margin-left:1em;padding:.25em 0}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;width:1em;padding:.25em 0;float:left;font-style:normal;font-variant:normal;font-weight:900;font-family:Font Awesome\ 6 Free;font-feature-settings:normal;text-align:center}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before{content:""}ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{content:""}.post-info-wrap[data-astro-cid-dckccua4]{-ms-flex:0 0 2.5em;flex:0 0 2.5em;background-color:var(--lt-component-bg-emphasis)}@media(min-width:768px){.post-info[data-astro-cid-dckccua4]{position:sticky;top:0}}@media(max-width:767.98px){.post-info[data-astro-cid-dckccua4]{position:absolute}}
</style><script type="module" src="/assets/PageLayout.astro_astro_type_script_index_0_lang.C1wfUPs6.js"></script><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Referrer-Policy" content="no-referrer, strict-origin-when-cross-origin"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="imagemode" content="force"><meta name="nightmode" content="disable"><meta name="wap-font-scale" content="no"><meta name="title" content="How to Kill the DN42 Network (Updated 2023-05-12) - Lan Tian @ Blog"><meta name="keywords" content=""><meta name="author" content="Lan Tian"><link rel="canonical" href="https://lantian.pub/en/article/modify-website/how-to-kill-the-dn42-network.lantian/"><link rel="alternate" type="application/rss+xml" title="Lan Tian @ Blog" href="https://lantian.pub/rss2.xml"><link rel="alternate" type="application/atom+xml" title="Lan Tian @ Blog" href="https://lantian.pub/feed.xml"><link rel="alternate" href="https://lantian.pub/article/modify-website/how-to-kill-the-dn42-network.lantian/" hreflang="zh"><link rel="alternate" href="https://lantian.pub/en/article/modify-website/how-to-kill-the-dn42-network.lantian/" hreflang="en"><meta name="copyright" content="Copyright 2012-2025 Lan Tian @ Blog"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#03a9f4"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#212121"><meta name="application-name" content="Lan Tian @ Blog"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="apple-touch-icon" sizes="1024x1024" href="/apple-touch-icon-1024x1024.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#03a9f4"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Lan Tian @ Blog"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-640x1136.png"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1136x640.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-750x1334.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1334x750.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1125x2436.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2436x1125.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1170x2532.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2532x1170.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1179x2556.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2556x1179.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-828x1792.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1792x828.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2688.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2688x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2208.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2208x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1284x2778.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2778x1284.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1290x2796.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2796x1290.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1488x2266.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2266x1488.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1536x2048.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2048x1536.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1620x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1620.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1640x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1640.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2388.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2388x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2224.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2224x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-2048x2732.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2732x2048.png"><meta name="msapplication-TileColor" content="#bbdefb"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"><meta property="og:url" content="https://lantian.pub/en/article/modify-website/how-to-kill-the-dn42-network.lantian/"><meta property="og:type" content="website"><meta property="og:title" content="How to Kill the DN42 Network (Updated 2023-05-12) - Lan Tian @ Blog"><meta property="og:image" content="https://lantian.pub/usr/uploads/202008/i-love-niantic-network.png"><meta content="DN42, aka Decentralized Network 42, is a large, decentralized VPN-based network. You can read more about DN42 in this post: DN42 Experimental Network: Intro and Registration DN42 is an experimental network , where everyone helps everyone. Nobody is going to blame you if you screwed up. You may seek help at DN42's IRC channel , mailing list or the unofficial Telegram group . Since DN42 is a network for experimentation, a lot of relatively inexperienced users also participate in it. Therefore, occasionally an inexperienced user may misconfigure his/her system and impact the whole DN42 network or even shut it down. As a more experienced user,..."><meta property="og:site_name" content="Lan Tian @ Blog"><meta property="og:locale" content="en"><meta name="twitter:card" content="summary"><meta name="twitter:url" content="https://lantian.pub/en/article/modify-website/how-to-kill-the-dn42-network.lantian/"><meta name="twitter:title" content="How to Kill the DN42 Network (Updated 2023-05-12) - Lan Tian @ Blog"><meta property="twitter:image" content="https://lantian.pub/usr/uploads/202008/i-love-niantic-network.png"><meta content="DN42, aka Decentralized Network 42, is a large, decentralized VPN-based network. You can read more about DN42 in this post: DN42 Experimental Network: Intro and Registration DN42 is an experimental network , where everyone helps everyone. Nobody is going to blame you if you screwed up. You may seek help at DN42's IRC channel , mailing list or the unofficial Telegram group . Since DN42 is a network for experimentation, a lot of relatively inexperienced users also participate in it. Therefore, occasionally an inexperienced user may misconfigure his/her system and impact the whole DN42 network or even shut it down. As a more experienced user,..."><meta name="twitter:dnt" content="on"><meta itemprop="name" content="How to Kill the DN42 Network (Updated 2023-05-12) - Lan Tian @ Blog"><meta property="image" content="https://lantian.pub/usr/uploads/202008/i-love-niantic-network.png"><meta content="DN42, aka Decentralized Network 42, is a large, decentralized VPN-based network. You can read more about DN42 in this post: DN42 Experimental Network: Intro and Registration DN42 is an experimental network , where everyone helps everyone. Nobody is going to blame you if you screwed up. You may seek help at DN42's IRC channel , mailing list or the unofficial Telegram group . Since DN42 is a network for experimentation, a lot of relatively inexperienced users also participate in it. Therefore, occasionally an inexperienced user may misconfigure his/her system and impact the whole DN42 network or even shut it down. As a more experienced user,..."><meta content="DN42, aka Decentralized Network 42, is a large, decentralized VPN-based network. You can read more about DN42 in this post: DN42 Experimental Network: Intro and Registration DN42 is an experimental network , where everyone helps everyone. Nobody is going to blame you if you screwed up. You may seek help at DN42's IRC channel , mailing list or the unofficial Telegram group . Since DN42 is a network for experimentation, a lot of relatively inexperienced users also participate in it. Therefore, occasionally an inexperienced user may misconfigure his/her system and impact the whole DN42 network or even shut it down. As a more experienced user,..."><link rel="me" href="https://mastodon.social/@lantian"></head> <body data-astro-cid-porej7z2=""> <div id="bg" data-astro-cid-j6vmxtef=""></div>   <div id="container" class="container" data-astro-cid-porej7z2=""> <nav class="lantian navbar navbar-expand-lg" data-astro-cid-wu5dj4rx=""> <div class="container-fluid" data-astro-cid-wu5dj4rx=""> <a class="navbar-brand" href="/en/" data-astro-cid-wu5dj4rx="">Lan Tian @ Blog</a> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#lantian-navbar" aria-controls="lantian-navbar" aria-expanded="false" aria-label="Toggle navigation" data-astro-cid-wu5dj4rx=""> <span class="navbar-toggler-icon" data-astro-cid-wu5dj4rx=""></span> </button> <div class="collapse navbar-collapse" id="lantian-navbar" data-astro-cid-wu5dj4rx=""> <ul class="navbar-nav" data-astro-cid-wu5dj4rx=""> <li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/archive/index.html" data-astro-cid-wu5dj4rx=""> Posts </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> Himawari </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> <li class="nav-item dropdown d-block d-lg-none" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="pages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-file" data-astro-cid-wu5dj4rx=""></i> Page  <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="pages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/archive/index.html" data-astro-cid-wu5dj4rx=""> Posts </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> Himawari </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> </ul> </li> </ul> <ul class="navbar-nav ms-auto" data-astro-cid-wu5dj4rx=""> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="languages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-language" data-astro-cid-wu5dj4rx=""></i> Language <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="languages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/article/modify-website/how-to-kill-the-dn42-network.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-cn" data-astro-cid-wu5dj4rx=""></span> Chinese Simplified / 简体中文 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item active" href="/en/article/modify-website/how-to-kill-the-dn42-network.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-us" data-astro-cid-wu5dj4rx=""></span> English </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">Not all pages have translations.</a> </li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">You may see 404 - this is normal.</a> </li> </ul> </li> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="color-scheme-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> Night Mode </a> <ul class="dropdown-menu" aria-labelledby="color-scheme-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-auto" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> Auto </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-light" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-sun" data-astro-cid-wu5dj4rx=""></i> Light</a> </li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-dark" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-moon" data-astro-cid-wu5dj4rx=""></i> Dark</a> </li> </ul> </li> </ul> </div> </div> </nav> <script type="module">const m="user-color-scheme",s="data-user-color-scheme",u=(e,t)=>{try{localStorage.setItem(e,t)}catch{}},i=e=>{try{return localStorage.getItem(e)}catch{return null}},c=e=>{const t={dark:!0,light:!0,auto:!0},o=e===null||!Object.keys(t).includes(e)?"auto":e;u(m,o);for(const l in t){const n=document.getElementById("color-scheme-"+l);n&&(l==o?n.classList.add("active"):n.classList.remove("active"))}o!="auto"?document.documentElement.setAttribute(s,o):document.documentElement.removeAttribute(s)};c(i(m));const r=document.getElementById("color-scheme-auto");r&&r.addEventListener("click",()=>c("auto"));const a=document.getElementById("color-scheme-light");a&&a.addEventListener("click",()=>c("light"));const d=document.getElementById("color-scheme-dark");d&&d.addEventListener("click",()=>c("dark"));</script>  <div class="d-flex" data-astro-cid-porej7z2=""> <div id="content" data-astro-cid-porej7z2="">  <article> <div class="d-flex"> <div class="post-info-wrap" data-astro-cid-dckccua4=""> <div class="post-info" data-astro-cid-dckccua4=""> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-clock"></span> <br> <small>05-12</small> </p> <div class="post-meta-value"> Published on<span class="badge badge-tag" data-astro-cid-dckccua4=""> 2023-05-12 22:03 </span>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-file-alt"></span> <br> <small>Website and Servers</small> </p> <div class="post-meta-value"> Category <a class="badge badge-tag" href="/en/category/modify-website" data-astro-cid-dckccua4=""> Website and Servers </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-tag"></span> <br> <small>2 tags</small> </p> <div class="post-meta-value"> Tags  <a class="badge badge-tag" href="/en/tag/DN42" data-astro-cid-dckccua4=""> DN42 </a>  <a class="badge badge-tag" href="/en/tag/BGP" data-astro-cid-dckccua4=""> BGP </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-list"></span> <br> <small>ToC</small> </p> <div class="post-meta-value">  <ol data-astro-cid-nj3qel45=""> <li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#changelog" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Changelog</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#ospf-is-fun" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">OSPF is Fun</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#whats-going-on" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">What&#39;s Going On</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#babel-is-fun-too" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Babel is Fun, Too</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#whats-going-on-1" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">What&#39;s Going On</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#correct-way-to-do-this" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Correct Way to Do This</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#defensive-measures" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Defensive Measures</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#route-flapping" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Route Flapping</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#case-review" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Case Review</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#defensive-measures-1" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Defensive Measures</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#how-long-is-that-ip-block" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">How Long is That IP Block?</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#whats-going-on-2" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">What&#39;s Going On</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#and-it-happened-again" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">And It Happened Again</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#correct-way-to-do-this-1" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Correct Way to Do This</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#defensive-measures-2" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Defensive Measures</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#bird-protocol-fights" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Bird Protocol Fights</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#whats-going-on-3" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">What&#39;s Going On</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#correct-way-to-do-this-2" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Correct Way to Do This</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#need-better-glasses" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Need Better Glasses?</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#defensive-measures-3" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Defensive Measures</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#be-careful-of-bgp-local-preferences" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Be Careful of BGP Local Preferences</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#whats-going-on-4" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">What&#39;s Going On</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#correct-way-to-do-this-3" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Correct Way to Do This</span> </a> </li> </ol>   </div> </div> </div> </div>  </div>  <div class="post-wrap"> <div class="post-image-wrap"> <picture> <source srcset="/usr/uploads/202008/i-love-niantic-network.png.thumb.png.webp" type="image/webp"> <source srcset="/usr/uploads/202008/i-love-niantic-network.png.thumb.png.avif" type="image/avif"> <source srcset="/usr/uploads/202008/i-love-niantic-network.png.thumb.png.jxl" type="image/jxl"> <img src="/usr/uploads/202008/i-love-niantic-network.png.thumb.png" alt="Illustration for How to Kill the DN42 Network (Updated 2023-05-12)" width="200" height="150"> </picture> </div> <h1 class="post-title"> <a href="/en/article/modify-website/how-to-kill-the-dn42-network.lantian/" rel="bookmark" title="How to Kill the DN42 Network (Updated 2023-05-12)">How to Kill the DN42 Network (Updated 2023-05-12)</a> </h1> <div class="post-text">   <p>DN42, aka Decentralized Network 42, is a large, decentralized VPN-based network.
You can read more about DN42 in this post:
<a href="/en/article/modify-website/dn42-experimental-network-2020.lantian/">DN42 Experimental Network: Intro and Registration</a></p>
<blockquote>
<p>DN42 is an <strong>experimental network</strong>, where everyone helps everyone. Nobody is
going to blame you if you screwed up. You may seek help at DN42's
<a href="https://wiki.dn42.us/services/IRC" rel="noopener noreferrer" target="_blank">IRC channel</a>,
<a href="https://wiki.dn42.us/contact#contact_mailing-list" rel="noopener noreferrer" target="_blank">mailing list</a> or the
<a href="https://t.me/Dn42Chat" rel="noopener noreferrer" target="_blank">unofficial Telegram group</a>.</p>
</blockquote>
<p>Since DN42 is a network for experimentation, a lot of relatively inexperienced
users also participate in it. Therefore, occasionally an inexperienced user may
misconfigure his/her system and impact the whole DN42 network or even shut it
down.</p>
<p>As a more experienced user, here I will teach new users about some operations
that can kill the network and about defense against such misconfigurations that
everyone can set up against peers.</p>
<blockquote>
<p>WARNING: You should not actually perform these operations in DN42. You should
focus more on protecting yourself against them.</p>
<p>Malicious actions will make you kicked from DN42.</p>
</blockquote>
<p>The stories are based on <strong>real disasters</strong> in the Telegram group and IRC
channel.</p>
<h1 id="changelog">Changelog</h1>
<ul>
<li>2023-05-12: Add contents for a routing loop caused by modifying BGP local
preference.</li>
<li>2020-08-27: Format changes, add full IRC logs, add another netmask error
content, and add content on missing digit in ASN.</li>
<li>2020-07-13: Add an IPv6 netmask error in the registry and Bird's conflicts
between different protocols.</li>
<li>2020-05-30：Initial version, including OSPF, Babel, and route flaps.</li>
</ul>
<h1 id="ospf-is-fun">OSPF is Fun</h1>
<p>You just joined DN42 and plan to connect all of your servers. You've already
peered with a few others on several of your nodes, but you haven't finished on
your internal routing yet.</p>
<p>So you plan to configure OSPF. You opened Bird's configuration file and added a
protocol:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">protocol</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ospf</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  ipv4</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">    import</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> all</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    export</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> all</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  area</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 0.0.0.0</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">    interface</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> zt0</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">      type</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> broadcast</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # Unimportant stuff redacted</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">};</span></span></code></pre>
<p>Satisfied, you copied the config file to every server and ran <code>bird configure</code>.
You checked and confirmed that every server obtained routes from each other via
OSPF.</p>
<p>Suddenly a message box pops up on your IRC client / Telegram. You clicked on it:</p>
<pre><code>&#x3C;mc**> shit.... as424242**** is hijacking my prefixes, for example 172.23.*.*/27
&#x3C;he**> yup, I see some roa fails for them as well
</code></pre>
<p>Congratulations! You've successfully hijacked (part of) DN42.</p>
<h2 id="whats-going-on">What's Going On</h2>
<p>When your server peers with others via BGP protocol, each route contains path
information, including the origin as well as the list of nodes it went through.
For example, the route <code>172.22.76.184/29</code> may have the path information of
<code>4242422547 -> 4242422601 -> 424242****</code>, where <code>4242422547</code> is the origin (me
by the way), and <code>4242422601</code> is your neighbor (Burble here, as an example).</p>
<p>But since your internal networking uses OSPF, which has no idea what BGP paths
are, it doesn't preserve them while passing routes around. Now another node of
yours obtained <code>172.22.76.184/29</code> via OSPF, yet without any path information. It
will then proceed to announce the route with your own ASN to your peers, causing
a hijack.</p>
<p>Here is a graph of what's going on:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[2547] -> [2601] -> [Your Node A] -> [Your Node B] -> [Peer of Node B]</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> 2547</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">      2547</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">      2547</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">             Gone!</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">            Your</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ASN</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (BOOM)</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">           2601</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">      2601</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">                     Your</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ASN</span></span></code></pre>
<h1 id="babel-is-fun-too">Babel is Fun, Too</h1>
<p>Those in the Telegram group are really nice guys. As they help you in fixing the
problem, they also recommended Babel to you:</p>
<ul>
<li>Babel automatically selects the shortest path by latency.</li>
<li>Babel is extremely simple to configure.</li>
</ul>
<p>But they don't recommend Bird's built-in Babel support since it doesn't support
selecting paths by latency.</p>
<p>You are persuaded, removed the OSPF configuration, and installed Babeld. Soon
each of your nodes is getting Babel routes. You waited for a few minutes. No
sign of catastrophe yet.</p>
<p>But you do notice that Bird isn't announcing the routes via BGP. The Telegram
guys instigated you to enable the <code>learn</code> option of Bird's kernel protocol:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">protocol</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> kernel</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> sys_kernel_v4</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  scan</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> time</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 20</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # You're gonna add this line!</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  learn</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Unimportant stuff redacted</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">};</span></span></code></pre>
<p>You do this. A few minutes later, you are called out again by people in IRC and
Telegram. Yes, you hijacked other's networks. Again.</p>
<h2 id="whats-going-on-1">What's Going On</h2>
<p>It is actually the same problem as the OSPF one since Babel also dropped all BGP
path information while passing routes around. However, Bird ignores routing
information installed to the system by other routing software by default, until
you enabled <code>learn</code>.</p>
<h2 id="correct-way-to-do-this">Correct Way to Do This</h2>
<ul>
<li>Always remember: Interior Gateway Protocols, including OSPF, Babel, etc,
should never process BGP routing information. BGP routing should be handled
solely by BGP.
<ul>
<li>There are multiple schemes to configure BGP in a network. You may refer to:
<a href="/en/article/modify-website/bird-confederation.lantian">Bird BGP Confederation: Configuration and Emulation</a>.</li>
</ul>
</li>
<li>Similarly, interior routes should not be passed to BGP, unless you own each
and every IP that you're using internally on DN42.</li>
<li>So you should set BGP's <code>export filter</code> to this in Bird:</li>
</ul>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">export</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> filter</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Only allow announcing STATIC (manually configured) and BGP routes</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">  if</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> source</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ~</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> [RTS_STATIC, </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">RTS_BGP]</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> then</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> accept</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Reject routes from other protocols</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  reject</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<h2 id="defensive-measures">Defensive Measures</h2>
<ul>
<li>The best countermeasure is ROA, or Route Origin Authorization. It restricts
the source ASN of each route.
<ul>
<li>For DN42, ROA configuration is generated automatically based on registry
data. They can be downloaded from
<a href="https://wiki.dn42.us/howto/Bird#route-origin-authorization" rel="noopener noreferrer" target="_blank">DN42 Wiki's Bird Config Page</a>,
and can be automatically updated with a cron job.</li>
</ul>
</li>
<li>If you don't want to configure ROA, you may try to peer with more people.
<ul>
<li>Since BGP chooses the path with the least number of ASes, if you're directly
connected to a lot of people, your network will prefer these direct routes
even if someone is hijacking.</li>
<li>But this <strong>doesn't guarantee</strong> full defense against the problem, for
example:
<ul>
<li>The path from the hijacker to you is shorter than the real AS.</li>
<li>The path from the hijacker and from real AS is of equal length, and your
routing software chooses one randomly.</li>
<li>You have DN42 Community Filter, and for some reason, prefers the
hijacker's route over the real ones.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="route-flapping">Route Flapping</h1>
<p>Route flapping is a whole range of errors that cause one problem: they cause the
BGP routing software to frequently switch (or flap) the best route they chose.
Since the best route gets announced to other nodes via peering, the flapping
sets off a chained reaction, where multiple connected nodes will flap together
for one node's mistake. Eventually, the problem will be distributed to the whole
network.</p>
<p>This process consumes a significant amount of bandwidth or traffic. Since many
people in DN42 use cheap VPSes for nodes, there are only two possible outcomes
eventually:</p>
<ol>
<li>Your peer found out about the abnormal traffic and cut the peering to you.</li>
<li>Your hosting provider (or even your peer's provider) found out of your high
bandwidth consumption (or using up your traffic limit) and shut down the VPS.</li>
</ol>
<p>In addition, route flapping may cause severe impacts:</p>
<ul>
<li>If the problematic AS peered with many other ASes, even if you disconnected
from it, the route flap may still be passed from another AS to your AS again.
<ul>
<li>To fix the problem of one problematic AS, you may have to cut off multiple
ASes.</li>
</ul>
</li>
</ul>
<p>For example, one user in the Telegram group had a misconfiguration while
transitioning from Full-mesh + Direct connections to Multihop.</p>
<p><picture><source srcset="/usr/uploads/202008/i-love-niantic-network.png.webp" type="image/webp"><source srcset="/usr/uploads/202008/i-love-niantic-network.png.avif" type="image/avif"><source srcset="/usr/uploads/202008/i-love-niantic-network.png.jxl" type="image/jxl"><img src="/usr/uploads/202008/i-love-niantic-network.png" alt="I Always Love Niantic Network"></picture></p>
<p>He didn't disconnect BGP in the process, and the Babel configuration error
caused large amounts of routes to be announced and withdrawn.</p>
<p>Because of the chain reaction and the number of peerings the guy has set up,
multiple large ASes had to disconnect from each other to control the problem
(before he woke up).</p>
<blockquote>
<p>By the way, this guy had a number of similar accidents before at a smaller
scale, which this margin is too narrow to contain.</p>
</blockquote>
<h2 id="case-review">Case Review</h2>
<pre><code>&#x3C;bur*> is someone awake who is on telegram ?
&#x3C;bur*> Kio*, sun*, ie**, lantian perhaps ?
&#x3C;Kio*> Kio* is here
&#x3C;fox*> I am in that dn42 telegram chat too but I do not understand moon runes
&#x3C;fox*> also its midnight for china?
&#x3C;bur*> yes, I'm going to be nuking a lot of peerings if they are all asleep
&#x3C;bur*> I think its originating from NIA*, but a lovely multi mb/s flap going on for the past hour
&#x3C;bur*> and its like whack-a-mole, if I disable one peering the traffic just pops up on a different one
&#x3C;fox*> petition for bur* network to stop accepting new peers to help save dn42 network health
&#x3C;Kio*> NIA* is awake now
&#x3C;bur*> NIA* certainly has ipv4 next hop problems, they are advertising routes with next hops in other networks
&#x3C;Kio*> He says he is adjusting his "network from full-mesh to rr and multihops"
&#x3C;bur*> well its not working ;)
&#x3C;stv*> bur*: I also took down our peering
&#x3C;bur*> stv*, too much traffic from the grc?
&#x3C;stv*> I added a new peer around 1hr ago. Just to check that this hasnt be the cause..
&#x3C;stv*> bur*: no the grc is still up and running
&#x3C;bur*> ah, if you are getting a lot of route updates its cos of NIA*
&#x3C;bur*> grc is currently pumping about 4mb/s to downstram peers
&#x3C;sun*> bur*: what happen?
&#x3C;bur*> NIA* is having issues
&#x3C;bur*> sun* anyway, you are up late!
&#x3C;sun*> I just came back from the bar:)
&#x3C;do**> don't drink and root
&#x3C;bur*> nice :)
&#x3C;sun*> l like drink ;)
&#x3C;bur*> ok, I'm bored of this now, if you are currently sending me more than 1mb/s of bgp traffic your peering is about to get disabled.
&#x3C;bur*> Kio*, sun*, Tch*, jrb*, lantian, ie**, so far
&#x3C;Kio*> barely notice any flapping here, is it v4 or v6 ?
&#x3C;bur*> 4 mostly, I think. you got killed on us-nyc1
&#x3C;bur*> Nap*
&#x3C;Nap*> Shut mine down if you need, I can't look into with much detail until tonight
&#x3C;bau*> half of dn42 is about to loose connectivity due to bur* disableing peerings lol
&#x3C;do**> oh yeah, this looks nice
&#x3C;Kio*> thats why everybody should be at least multi homed with two peers
&#x3C;jrb*> bur*: and on which peering?
&#x3C;Kio*> you shouldnt loose connectivity if only one peer drops
&#x3C;bur*> jrb* us-nyc1 and us-lax1 for you so far
&#x3C;jrb*> mapping table says us-3 and us-5, let me check.
&#x3C;Nap*> Do we know what routes are flapping causing the updates?
&#x3C;Kio*> filtering problematic ASN on my us node now
&#x3C;bur*> Nap* its NIA*
&#x3C;bur*> AS42424213**
&#x3C;jrb*> sun*, rou*: disabling my peerings with you for now, there seems to be serious flapping
&#x3C;do**> him again?
&#x3C;sun*> what?
&#x3C;sun*> is me problem?
&#x3C;bur*> sun*, I've killed all of our peerings
&#x3C;sun*> why?
&#x3C;bur*> sun*, you are distributing the problems from NIA*
&#x3C;Nap*> bur*: K, gonna try to filter on ATL/CHI at least.
&#x3C;bur*> thanks Nap*
&#x3C;Kio*> recommend everybody to temporarily enable "bgp_path ~" filter for the problematic ASN
&#x3C;sun*> i disabled NIA*, would fix problem?
&#x3C;do**> bur*: I also peer with NIA* and I don't get any bgp updates from him
&#x3C;do**> ah wait
&#x3C;bur*> sun*, depends if you are also getting the updates from other peers too
&#x3C;do**> now I see it
&#x3C;do**> disabling peering
&#x3C;sun*> if bgp_path ~ [= 42424213** =] then reject;
&#x3C;bur*> ~ [= * 42424213** * =] to reject all paths
&#x3C;sun*> ohh
&#x3C;jrb*> bur*: seems to be mostly rou* from my perspective
&#x3C;Kio*> Should be filtered on my side, if anyone continues to receive those updates please notify
&#x3C;bur*> sun*, I tried re-enabling you on lax1 but you jumped striaght to 1mb/s+ again
&#x3C;bur*> jrb*, re-enabled
&#x3C;sun*> i have disabled NIA*
&#x3C;bur*> Kio*, re-enabled
&#x3C;do**> oh btw, I have notified NIA* about this issue
&#x3C;jrb*> do**: also tell him to notify everybody to get out of the blacklists.
&#x3C;do**> jrb*: will do
&#x3C;Nap*> bur*: I should have it filtered on my ATL (your CHI)
&#x3C;Kio*> wrote NIA* also directly on telegram
&#x3C;sun*> bur*: is it better now?
&#x3C;bur*> for the record, this is the first time that I've mass disabled peerings, but this was causing issues across the board
&#x3C;bur*> sun*, no not really
&#x3C;An**> I've stop importing route from NIA*
&#x3C;stv*> I am also dropping NIA* now
&#x3C;bur*> sun*, thats like 1k updates every few seconds
&#x3C;Nap*> bur*: all host should have it filtered now.
&#x3C;bur*> Nap*, looks to me, thanks
&#x3C;sun*> bur*: seems to have reduced traffic
&#x3C;bur*> sun*, yes that looks better
&#x3C;bur*> sun*, is that now ok across all your nodes ?
&#x3C;sun*> yep
&#x3C;bur*> sun*, ok re-enabled
&#x3C;do**> alright, also filtered 42424213**
&#x3C;tm**> hi, also filtered 42424213**
&#x3C;bur*> I guess they got the message, seems we're back to normal again and everyone I disabled is back again
&#x3C;do**> bur*: I think NIA* is asleep, probably everyone filtered it
&#x3C;do**> or disabled peering
&#x3C;bur*> do**, there is that, but I also renabled NIA* and am not getting the same errors now
&#x3C;do**> oh, interesting
&#x3C;bur*> I might regret doing that by morning, but hey. I do try and keep everything open as best as possible.
&#x3C;do**> bur*: last time when NIA* did that I waited for their response
&#x3C;Kio*> Nope nia* just messaged in Telegram about it
&#x3C;do**> ah
&#x3C;bur*> my peering hasn't re-established, so I guess they hit the big red shutdown button
&#x3C;Kio*> He tried to migrate his network to a full mesh
&#x3C;Kio*> and is now "pulling all the wires"
&#x3C;do**> Kio*: did you message him directly or was that on any of the groups?
&#x3C;Kio*> on the telegram group
&#x3C;do**> bur*: you didn't get that many bgp updates from me?
&#x3C;sun*> NIA* woke up :)
&#x3C;bur*> do**, you went from an average of ~3kbs to ~10kbs+, peaking at 50kbs. In the grand scheme of things that was lost in the noise
&#x3C;do**> interesting
&#x3C;do**> I also peer directly with NIA*
&#x3C;bur*> do**, yes, interesting. Is the link restricted in bandwidth ?
&#x3C;do**> not at all
</code></pre>
<h2 id="defensive-measures-1">Defensive Measures</h2>
<ul>
<li>The best solution is Route Dampening, which restricts the number of routing
updates to be accepted in a time range.
<ul>
<li>But Bird doesn't support this. You'd have to put up with it.</li>
</ul>
</li>
<li>Alternatively, you can monitor your nodes with Prometheus, Grafana, etc., so
you get an alarm that something's off and handle it manually.
<ul>
<li>But obviously, if you aren't online at that time, you may have already used
a few gigs of traffic before you're aware.</li>
</ul>
</li>
<li>Next solution is to rate-limit the peering connection.
<ul>
<li>Since there is almost no application that requires lots of bandwidth in
DN42, this is a viable solution that ensures safety.</li>
<li>But the downside is also obvious: degradation of performance.</li>
</ul>
</li>
<li>If you're rich enough, get a server with uncapped traffic.</li>
</ul>
<h1 id="how-long-is-that-ip-block">How Long is That IP Block?</h1>
<p>Since it's the year 2020, you plan to add an IPv6 block to your network. With
<a href="/en/article/modify-website/dn42-experimental-network-2020.lantian">my DN42 registration guide</a>,
you registered yourself a IPv6 block, which quickly got merged to registry.</p>
<p>From your perspective, everything is normal. Yet on the other side of the
planet, a message pops up on one person's phone/computer that his DN42 ROA
generator is malfunctioning. He opens the registry page, facepalms, and commits
this change:</p>
<p><picture><source srcset="/usr/uploads/202007/dn42-registry-error.png.webp" type="image/webp"><source srcset="/usr/uploads/202007/dn42-registry-error.png.avif" type="image/avif"><source srcset="/usr/uploads/202007/dn42-registry-error.png.jxl" type="image/jxl"><img src="/usr/uploads/202007/dn42-registry-error.png" alt="Errorneous IPv6 Block in DN42 Registry"></picture></p>
<p><a href="https://git.dn42.dev/dn42/registry/commit/9f45ee31cdea4a997d59a262c4a8ac8eb3cbd1f1" rel="noopener noreferrer" target="_blank">https://git.dn42.dev/dn42/registry/commit/9f45ee31cdea4a997d59a262c4a8ac8eb3cbd1f1</a></p>
<h2 id="whats-going-on-2">What's Going On</h2>
<p>This user added a IPv6 block, <code>fd37:03b3:cae6:5158::/48</code>. Since an IPv6 address
consists of 32 hex numbers (128 bits total), and this block defined the first 16
digits (or 64 bits), the corresponding netmask should be <code>/64</code> or higher.</p>
<p>But for some reason, this error wasn't detected by DN42 Registry's schema
checker, nor by the admin who inspected and merged the change, so it
successfully ended up in the registry.</p>
<p>Later, the ROA generator found the erroneous IP block while parsing the registry
and crashed.</p>
<h1 id="and-it-happened-again">And It Happened Again</h1>
<p><picture><source srcset="/usr/uploads/202008/dn42-registry-error.png.webp" type="image/webp"><source srcset="/usr/uploads/202008/dn42-registry-error.png.avif" type="image/avif"><source srcset="/usr/uploads/202008/dn42-registry-error.png.jxl" type="image/jxl"><img src="/usr/uploads/202008/dn42-registry-error.png" alt="Errorneous IPv6 Block Happened Again"></picture></p>
<p><a href="https://git.dn42.dev/dn42/registry/commit/00f90f592a35e325152ce28157f64d3fca7c8d7d" rel="noopener noreferrer" target="_blank">https://git.dn42.dev/dn42/registry/commit/00f90f592a35e325152ce28157f64d3fca7c8d7d</a></p>
<h2 id="correct-way-to-do-this-1">Correct Way to Do This</h2>
<ul>
<li>While registering for an IP block, the user should check the validity of
netmasks and address blocks.</li>
<li>The DN42 Registry schema checker, or the admin performing the merge operation,
should have found out the problem.</li>
<li>ROA generator should skip the problematic record and properly handle the rest
of the data instead of crashing.</li>
</ul>
<p>Fortunately, except that the ROA update was delayed by a few hours, this error
didn't impact the network itself much.</p>
<h2 id="defensive-measures-2">Defensive Measures</h2>
<p>Since the decentralized nature of DN42 as it's born, you can write your own ROA
generator as a backup.</p>
<blockquote>
<p>Although my ROA generator also failed this time...</p>
</blockquote>
<p>The reason is that different implementations may have minor differences even
though they do the same thing. When such a bug on input content arises, some
implementations may survive.</p>
<h1 id="bird-protocol-fights">Bird Protocol Fights</h1>
<p>The story starts with my friend Joe... Fine. The story starts with me.</p>
<p>Since my network is connected to both DN42 and NeoNetwork, as well as my
internal network with a private IP range, to prevent announcing my internal
network to DN42 and NeoNetwork, I did this:</p>
<ul>
<li>All routes from the Kernel protocol (from OS routing table) and the Direct
protocol (from network interface addresses) are labeled with a BGP community.</li>
<li>Routes with the community are filtered in exterior peerings with DN42 and
NeoNetwork.</li>
<li>This way, my internal IPs won't be announced to other networks, but since my
DN42 and NeoNetwork IP blocks are configured in Static protocol, they won't be
impacted.</li>
</ul>
<p>Initially, everything looked normal, until a few days later when some users on
Telegram found that my looking glass bot times out on any IP in DN42.</p>
<h2 id="whats-going-on-3">What's Going On</h2>
<p>Initially, everything is indeed normal, and my IP block <code>172.22.76.184/29</code> is
announced correctly. Until Direct protocol performed a refresh and obtained
<code>172.22.76.184/29</code> from one of the network interfaces, and sent the route to
Bird routing table again.</p>
<p>The new route overwrote the previous route, and since it comes from Direct
protocol, it's labeled with the community and wasn't broadcasted. Static
protocol, on the other hand, is indeed "static", and won't overwrite the route
again.</p>
<p>At this time, I effectively stopped announcing my IP range. No wonder I cannot
receive any packets coming back to my nodes now.</p>
<h2 id="correct-way-to-do-this-2">Correct Way to Do This</h2>
<p>In Bird, you should avoid getting the same route entry from multiple routing
protocols, as they overwrite each other and may cause unexpected behavior.</p>
<p>I finally chose to limit Direct protocol to my internal IP range with a filter,
so it won't overwrite my DN42 ranges again.</p>
<h1 id="need-better-glasses">Need Better Glasses?</h1>
<p>A new user registered an ASN:</p>
<p><picture><source srcset="/usr/uploads/202008/dn42-asn-error.png.webp" type="image/webp"><source srcset="/usr/uploads/202008/dn42-asn-error.png.avif" type="image/avif"><source srcset="/usr/uploads/202008/dn42-asn-error.png.jxl" type="image/jxl"><img src="/usr/uploads/202008/dn42-asn-error.png" alt="Errorneous ASN in DN42 Registry"></picture></p>
<p>This is what happened to DN42:</p>
<ul>
<li>
<p>Telegram Group: (Translation available below the image)</p>
<p><picture><source srcset="/usr/uploads/202008/dn42-asn-error-response.png.webp" type="image/webp"><source srcset="/usr/uploads/202008/dn42-asn-error-response.png.avif" type="image/avif"><source srcset="/usr/uploads/202008/dn42-asn-error-response.png.jxl" type="image/jxl"><img src="/usr/uploads/202008/dn42-asn-error-response.png" alt="Telegram Reactions"></picture></p>
<p>Translation:</p>
<pre><code>&#x3C;lantian> Why someone with an ASN of 424242236 came to peer with me
&#x3C;lantian> Yep, 9 digits
&#x3C;lantian> /whois@lantian_lg_bot 424242236
     &#x3C;lg> (outputs WHOIS information of the AS)
&#x3C;lantian> And it has proper WHOIS information
 &#x3C;KaiKai> https://net-info.nia.ac.cn/#424242236
 &#x3C;KaiKai> Really, it exists
 &#x3C;Pastel> Burble didn't spot the error?
 &#x3C;Pastel> Like the /64, which crashed the ROA generator
</code></pre>
</li>
<li>
<p>IRC：</p>
<pre><code>&#x3C;lantian> Someone successfully registered in DN42 with ASN 424242236 (9 digits)
&#x3C;lantian> Is this expected?
   &#x3C;xu**> doh
   &#x3C;xu**> shouldt have happened
   &#x3C;xu**> probably forgot the extra 2
   &#x3C;xu**> 424242 2236
   &#x3C;Kai*> too late tho. it already has one peer with tech9
   &#x3C;dne*> filtering fail!
   &#x3C;xu**> pomoke?
&#x3C;lantian> yep, doesn't seem to be on irc though
&#x3C;lantian> nor on telegram
   &#x3C;0x7*> so how a 9-digit ASN passed the schema checker...?
&#x3C;lantian> I don't think schema checker checks ASN, or it will block out clearnet ASNs
&#x3C;lantian> But maybe we need a warning?
   &#x3C;xu**> probably a bug in the policy checker
   &#x3C;xu**> i wish we had gone with a prefix that had a visual space
   &#x3C;xu**> like AS424200xxxx
&#x3C;lantian> Well pomoke tried to peer with me via email (but ended in spam folder)
&#x3C;lantian> I'm going to tell him/her to correct the ASN
   &#x3C;Kai*> 9 is a good number tho
   &#x3C;Kai*> once in a blue moon that bur* made mistake
   &#x3C;sun*> westerners love digital 9
   &#x3C;bur*> crap
   &#x3C;bur*> lantian, are you in contact with pomoke? if they can submit a fix quickly
          then I'll merge it. Otherwise I'll need to pull the commit
&#x3C;lantian> bur*: I sent him/her an email, not sure about response time
   &#x3C;bur*> umm, I'm going to have to pull it then
</code></pre>
</li>
<li>
<p>Justice Has Arrived:</p>
<p><picture><source srcset="/usr/uploads/202008/dn42-asn-error-correction.png.webp" type="image/webp"><source srcset="/usr/uploads/202008/dn42-asn-error-correction.png.avif" type="image/avif"><source srcset="/usr/uploads/202008/dn42-asn-error-correction.png.jxl" type="image/jxl"><img src="/usr/uploads/202008/dn42-asn-error-correction.png" alt="Errorneous Commit Reverted"></picture></p>
</li>
</ul>
<h2 id="defensive-measures-3">Defensive Measures</h2>
<ul>
<li>
<p>Just have fun, as this is so rare:</p>
<pre><code>&#x3C;Kai*> once in a blue moon that bur* made mistake
</code></pre>
</li>
<li>
<p>But while having fun, remember to point out the problem on IRC.</p>
</li>
<li>
<p>Double-check your peer's information when peering.</p>
</li>
<li>
<p>Check <a href="https://t.me/DN42new" rel="noopener noreferrer" target="_blank">DN42 New ASN</a>, a Telegram channel that notifies
of new DN42 ASNs, in your free time.</p>
</li>
</ul>
<h1 id="be-careful-of-bgp-local-preferences">Be Careful of BGP Local Preferences</h1>
<p>When I was helping others debugging their network in the DN42 Telegram group, I
suddenly noticed a routing loop between two of my nodes:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">traceroute</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> to</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> fd28:cb8f:4c92:1::1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (fd28:cb8f:4c92:1::1), 30 hops max, 80 byte packets</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> 1</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  us-new-york-city.virmach-ny1g.lantian.dn42</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (fdbc:f9dc:67ad:8::1)  88.023 ms</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> 2</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  lu-bissen.buyvm.lantian.dn42</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (fdbc:f9dc:67ad:2::1)  94.401 ms</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> 3</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  us-new-york-city.virmach-ny1g.lantian.dn42</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (fdbc:f9dc:67ad:8::1)  167.664 ms</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> 4</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  lu-bissen.buyvm.lantian.dn42</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (fdbc:f9dc:67ad:2::1)  174.235 ms</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> 5</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  us-new-york-city.virmach-ny1g.lantian.dn42</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (fdbc:f9dc:67ad:8::1)  247.213 ms</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> 6</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  lu-bissen.buyvm.lantian.dn42</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (fdbc:f9dc:67ad:2::1)  253.499 ms</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> 7</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  us-new-york-city.virmach-ny1g.lantian.dn42</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (fdbc:f9dc:67ad:8::1)  326.690 ms</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> 8</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  lu-bissen.buyvm.lantian.dn42</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (fdbc:f9dc:67ad:2::1)  333.412 ms</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> 9</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  us-new-york-city.virmach-ny1g.lantian.dn42</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (fdbc:f9dc:67ad:8::1)  406.978 ms</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">10</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  lu-bissen.buyvm.lantian.dn42</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (fdbc:f9dc:67ad:2::1)  413.537 ms</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">11</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  us-new-york-city.virmach-ny1g.lantian.dn42</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (fdbc:f9dc:67ad:8::1)  486.762 ms</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">12</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  lu-bissen.buyvm.lantian.dn42</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (fdbc:f9dc:67ad:2::1)  493.147 ms</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">18</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> hops</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> not</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> responding.</span></span></code></pre>
<p>I logged onto these two nodes, and indeed, the VirMach node did choose BuyVM's
route as the preferred path, and the BuyVM node did the same for VirMach's
route.</p>
<p>Isn't BGP supposed to prevent loops? Why are these two nodes choosing the route
from each other?</p>
<h2 id="whats-going-on-4">What's Going On</h2>
<p>The problem involves 4 nodes from 3 ASes:</p>
<p><!--?xml version="1.0" encoding="UTF-8" standalone="no"?--><!-- Generated by graphviz version 14.0.2 (0)
 --><!-- Pages: 1 -->
<svg width="186pt" height="155pt" viewBox="0.00 0.00 186.00 155.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 151)">
<polygon fill="white" stroke="none" points="-4,4 -4,-151 182.08,-151 182.08,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_1</title>
<polygon fill="lightgrey" stroke="lightgrey" points="87.54,-8 87.54,-139 170.08,-139 170.08,-8 87.54,-8"></polygon>
<text xml:space="preserve" text-anchor="middle" x="128.81" y="-122.4" font-family="Times,serif" font-size="14.00">My Nodes</text>
</g><!-- VirMach -->
<g id="node1" class="node">
<title>VirMach</title>
<polygon fill="white" stroke="white" points="162.08,-106 95.54,-106 95.54,-70 162.08,-70 162.08,-106"></polygon>
<text xml:space="preserve" text-anchor="middle" x="128.81" y="-83.8" font-family="Times,serif" font-size="14.00">VirMach</text>
</g><!-- BuyVM -->
<g id="node2" class="node">
<title>BuyVM</title>
<polygon fill="white" stroke="white" points="159.76,-52 97.87,-52 97.87,-16 159.76,-16 159.76,-52"></polygon>
<text xml:space="preserve" text-anchor="middle" x="128.81" y="-29.8" font-family="Times,serif" font-size="14.00">BuyVM</text>
</g><!-- VirMach&#45;&gt;BuyVM -->
<g id="edge2" class="edge">
<title>VirMach->BuyVM</title>
<path fill="none" stroke="black" d="M149.72,-69.51C150.85,-67.43 151.56,-65.35 151.86,-63.27"></path>
<polygon fill="black" stroke="black" points="155.32,-62.69 149.84,-53.62 148.47,-64.13 155.32,-62.69"></polygon>
</g><!-- BuyVM&#45;&gt;VirMach -->
<g id="edge3" class="edge">
<title>BuyVM->VirMach</title>
<path fill="none" stroke="black" d="M108.1,-52.14C106.93,-54.22 106.17,-56.3 105.82,-58.38"></path>
<polygon fill="black" stroke="black" points="102.35,-58.84 107.63,-68.02 109.23,-57.55 102.35,-58.84"></polygon>
</g><!-- KSKB -->
<g id="node3" class="node">
<title>KSKB</title>
<polygon fill="none" stroke="black" points="56.77,-106 2.77,-106 2.77,-70 56.77,-70 56.77,-106"></polygon>
<text xml:space="preserve" text-anchor="middle" x="29.77" y="-83.8" font-family="Times,serif" font-size="14.00">KSKB</text>
</g><!-- KSKB&#45;&gt;VirMach -->
<g id="edge4" class="edge">
<title>KSKB->VirMach</title>
<path fill="none" stroke="black" d="M57.03,-88C65.32,-88 74.72,-88 83.89,-88"></path>
<polygon fill="black" stroke="black" points="83.78,-91.5 93.78,-88 83.78,-84.5 83.78,-91.5"></polygon>
</g><!-- Lutoma -->
<g id="node4" class="node">
<title>Lutoma</title>
<polygon fill="none" stroke="black" points="59.54,-52 0,-52 0,-16 59.54,-16 59.54,-52"></polygon>
<text xml:space="preserve" text-anchor="middle" x="29.77" y="-29.8" font-family="Times,serif" font-size="14.00">Lutoma</text>
</g><!-- KSKB&#45;&gt;Lutoma -->
<g id="edge1" class="edge">
<title>KSKB->Lutoma</title>
<path fill="none" stroke="black" d="M29.77,-69.51C29.77,-67.52 29.77,-65.53 29.77,-63.54"></path>
<polygon fill="black" stroke="black" points="33.27,-63.65 29.77,-53.65 26.27,-63.65 33.27,-63.65"></polygon>
</g><!-- Lutoma&#45;&gt;BuyVM -->
<g id="edge5" class="edge">
<title>Lutoma->BuyVM</title>
<path fill="none" stroke="black" d="M59.89,-34C68.12,-34 77.24,-34 86.06,-34"></path>
<polygon fill="black" stroke="black" points="85.86,-37.5 95.86,-34 85.86,-30.5 85.86,-37.5"></polygon>
</g>
</g>
</svg>
</p>
<p>KSKB is the source for the route <code>fd28:cb8f:4c92::/48</code>. He broadcasted the route
to Lutoma, as well as my VirMach node. Lutoma then broadcased the route to my
BuyVM node.</p>
<p><strong>All my nodes have <code>add path yes;</code> option turned on</strong>, which means my nodes
will exchange all received routes, rather than only the preferred ones written
into kernel routing table. Therefore, as far as the BuyVM node concerns, it can
choose from two paths to the source:</p>
<p><!--?xml version="1.0" encoding="UTF-8" standalone="no"?--><!-- Generated by graphviz version 14.0.2 (0)
 --><!-- Pages: 1 -->
<svg width="186pt" height="155pt" viewBox="0.00 0.00 186.00 155.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 151)">
<polygon fill="white" stroke="none" points="-4,4 -4,-151 182.08,-151 182.08,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_1</title>
<polygon fill="lightgrey" stroke="lightgrey" points="8,-8 8,-139 90.54,-139 90.54,-8 8,-8"></polygon>
<text xml:space="preserve" text-anchor="middle" x="49.27" y="-122.4" font-family="Times,serif" font-size="14.00">My Nodes</text>
</g><!-- VirMach -->
<g id="node1" class="node">
<title>VirMach</title>
<polygon fill="white" stroke="white" points="82.54,-52 16,-52 16,-16 82.54,-16 82.54,-52"></polygon>
<text xml:space="preserve" text-anchor="middle" x="49.27" y="-29.8" font-family="Times,serif" font-size="14.00">VirMach</text>
</g><!-- KSKB -->
<g id="node3" class="node">
<title>KSKB</title>
<polygon fill="none" stroke="black" points="175.31,-52 121.31,-52 121.31,-16 175.31,-16 175.31,-52"></polygon>
<text xml:space="preserve" text-anchor="middle" x="148.31" y="-29.8" font-family="Times,serif" font-size="14.00">KSKB</text>
</g><!-- VirMach&#45;&gt;KSKB -->
<g id="edge2" class="edge">
<title>VirMach->KSKB</title>
<path fill="none" stroke="black" d="M82.85,-34C91.5,-34 100.92,-34 109.81,-34"></path>
<polygon fill="black" stroke="black" points="109.58,-37.5 119.58,-34 109.58,-30.5 109.58,-37.5"></polygon>
</g><!-- BuyVM -->
<g id="node2" class="node">
<title>BuyVM</title>
<polygon fill="white" stroke="white" points="80.22,-106 18.32,-106 18.32,-70 80.22,-70 80.22,-106"></polygon>
<text xml:space="preserve" text-anchor="middle" x="49.27" y="-83.8" font-family="Times,serif" font-size="14.00">BuyVM</text>
</g><!-- BuyVM&#45;&gt;VirMach -->
<g id="edge1" class="edge">
<title>BuyVM->VirMach</title>
<path fill="none" stroke="black" d="M49.27,-69.51C49.27,-67.52 49.27,-65.53 49.27,-63.54"></path>
<polygon fill="black" stroke="black" points="52.77,-63.65 49.27,-53.65 45.77,-63.65 52.77,-63.65"></polygon>
</g><!-- Lutoma -->
<g id="node4" class="node">
<title>Lutoma</title>
<polygon fill="none" stroke="black" points="178.08,-106 118.54,-106 118.54,-70 178.08,-70 178.08,-106"></polygon>
<text xml:space="preserve" text-anchor="middle" x="148.31" y="-83.8" font-family="Times,serif" font-size="14.00">Lutoma</text>
</g><!-- BuyVM&#45;&gt;Lutoma -->
<g id="edge3" class="edge">
<title>BuyVM->Lutoma</title>
<path fill="none" stroke="black" d="M80.71,-88C89.06,-88 98.24,-88 107.04,-88"></path>
<polygon fill="black" stroke="black" points="106.79,-91.5 116.79,-88 106.79,-84.5 106.79,-91.5"></polygon>
</g><!-- Lutoma&#45;&gt;KSKB -->
<g id="edge4" class="edge">
<title>Lutoma->KSKB</title>
<path fill="none" stroke="black" d="M148.31,-69.51C148.31,-67.52 148.31,-65.53 148.31,-63.54"></path>
<polygon fill="black" stroke="black" points="151.81,-63.65 148.31,-53.65 144.81,-63.65 151.81,-63.65"></polygon>
</g>
</g>
</svg>
</p>
<p>The same applies for my VirMach node:</p>
<p><!--?xml version="1.0" encoding="UTF-8" standalone="no"?--><!-- Generated by graphviz version 14.0.2 (0)
 --><!-- Pages: 1 -->
<svg width="186pt" height="155pt" viewBox="0.00 0.00 186.00 155.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 151)">
<polygon fill="white" stroke="none" points="-4,4 -4,-151 182.08,-151 182.08,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_1</title>
<polygon fill="lightgrey" stroke="lightgrey" points="8,-8 8,-139 90.54,-139 90.54,-8 8,-8"></polygon>
<text xml:space="preserve" text-anchor="middle" x="49.27" y="-122.4" font-family="Times,serif" font-size="14.00">My Nodes</text>
</g><!-- VirMach -->
<g id="node1" class="node">
<title>VirMach</title>
<polygon fill="white" stroke="white" points="82.54,-52 16,-52 16,-16 82.54,-16 82.54,-52"></polygon>
<text xml:space="preserve" text-anchor="middle" x="49.27" y="-29.8" font-family="Times,serif" font-size="14.00">VirMach</text>
</g><!-- BuyVM -->
<g id="node2" class="node">
<title>BuyVM</title>
<polygon fill="white" stroke="white" points="80.22,-106 18.32,-106 18.32,-70 80.22,-70 80.22,-106"></polygon>
<text xml:space="preserve" text-anchor="middle" x="49.27" y="-83.8" font-family="Times,serif" font-size="14.00">BuyVM</text>
</g><!-- VirMach&#45;&gt;BuyVM -->
<g id="edge2" class="edge">
<title>VirMach->BuyVM</title>
<path fill="none" stroke="black" d="M49.27,-52.14C49.27,-54.13 49.27,-56.12 49.27,-58.11"></path>
<polygon fill="black" stroke="black" points="45.77,-58 49.27,-68 52.77,-58 45.77,-58"></polygon>
</g><!-- KSKB -->
<g id="node3" class="node">
<title>KSKB</title>
<polygon fill="none" stroke="black" points="175.31,-52 121.31,-52 121.31,-16 175.31,-16 175.31,-52"></polygon>
<text xml:space="preserve" text-anchor="middle" x="148.31" y="-29.8" font-family="Times,serif" font-size="14.00">KSKB</text>
</g><!-- VirMach&#45;&gt;KSKB -->
<g id="edge1" class="edge">
<title>VirMach->KSKB</title>
<path fill="none" stroke="black" d="M82.85,-34C91.5,-34 100.92,-34 109.81,-34"></path>
<polygon fill="black" stroke="black" points="109.58,-37.5 119.58,-34 109.58,-30.5 109.58,-37.5"></polygon>
</g><!-- Lutoma -->
<g id="node4" class="node">
<title>Lutoma</title>
<polygon fill="none" stroke="black" points="178.08,-106 118.54,-106 118.54,-70 178.08,-70 178.08,-106"></polygon>
<text xml:space="preserve" text-anchor="middle" x="148.31" y="-83.8" font-family="Times,serif" font-size="14.00">Lutoma</text>
</g><!-- BuyVM&#45;&gt;Lutoma -->
<g id="edge3" class="edge">
<title>BuyVM->Lutoma</title>
<path fill="none" stroke="black" d="M80.71,-88C89.06,-88 98.24,-88 107.04,-88"></path>
<polygon fill="black" stroke="black" points="106.79,-91.5 116.79,-88 106.79,-84.5 106.79,-91.5"></polygon>
</g><!-- Lutoma&#45;&gt;KSKB -->
<g id="edge4" class="edge">
<title>Lutoma->KSKB</title>
<path fill="none" stroke="black" d="M148.31,-69.51C148.31,-67.52 148.31,-65.53 148.31,-63.54"></path>
<polygon fill="black" stroke="black" points="151.81,-63.65 148.31,-53.65 144.81,-63.65 151.81,-63.65"></polygon>
</g>
</g>
</svg>
</p>
<p>Generally speaking, the VirMach node should prefer the direct route to KSKB,
instead of the path through my BuyVM node and Lutoma's node, for a total of 2
hops (hops aren't counted for iBGP within the same AS). Now regardless of the
next hop BuyVM node prefers, either Lutoma's node or my VirMach node, it will
have a reachable path rather than a routing loop.</p>
<p>The problem is that <strong>I manually adjusted route preferences with a BIRD
filter</strong>.
<a href="https://wiki.dn42.dev/howto/Bird-communities" rel="noopener noreferrer" target="_blank">DN42 has a standard set of BGP communities to mark the source region of each route.</a>
To reduce network latency, I used the following algorithm (simplified) to adjust
my route preferences:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Preference</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> =</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 200</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> -</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 10</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> *</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (Hop </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">count</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">If</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> the</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> current</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> node</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> is</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> in</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> the</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> same</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> region</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> as</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> the</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> route</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> source:</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  Preference</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> +=</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 100</span></span></code></pre>
<p>When the problem happened, the original route from KSKB don't have source region
community set up. <strong>However, Lutoma's network was set up incorrectly, and added
source region community to KSKB's route as well</strong>, and with the same region as
my VirMach node. (According to the standard of DN42, networks should only add
source region communities to their own routes, not to routes received from other
networks.)</p>
<p>Now my BuyVM node calculated the following route preferences, and chose the
route through my VirMach node:</p>
<p><!--?xml version="1.0" encoding="UTF-8" standalone="no"?--><!-- Generated by graphviz version 14.0.2 (0)
 --><!-- Pages: 1 -->
<svg width="290pt" height="173pt" viewBox="0.00 0.00 290.00 173.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 169)">
<polygon fill="white" stroke="none" points="-4,4 -4,-169 285.64,-169 285.64,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_1</title>
<polygon fill="lightgrey" stroke="lightgrey" points="8,-8 8,-157 90.54,-157 90.54,-8 8,-8"></polygon>
<text xml:space="preserve" text-anchor="middle" x="49.27" y="-140.4" font-family="Times,serif" font-size="14.00">My Nodes</text>
</g><!-- VirMach -->
<g id="node1" class="node">
<title>VirMach</title>
<polygon fill="white" stroke="white" points="82.54,-52 16,-52 16,-16 82.54,-16 82.54,-52"></polygon>
<text xml:space="preserve" text-anchor="middle" x="49.27" y="-29.8" font-family="Times,serif" font-size="14.00">VirMach</text>
</g><!-- KSKB -->
<g id="node3" class="node">
<title>KSKB</title>
<polygon fill="none" stroke="black" points="278.87,-52 224.87,-52 224.87,-16 278.87,-16 278.87,-52"></polygon>
<text xml:space="preserve" text-anchor="middle" x="251.87" y="-29.8" font-family="Times,serif" font-size="14.00">KSKB</text>
</g><!-- VirMach&#45;&gt;KSKB -->
<g id="edge2" class="edge">
<title>VirMach->KSKB</title>
<path fill="none" stroke="red" d="M82.95,-34C118.61,-34 175.62,-34 213.16,-34"></path>
<polygon fill="red" stroke="red" points="213.09,-37.5 223.09,-34 213.09,-30.5 213.09,-37.5"></polygon>
</g><!-- BuyVM -->
<g id="node2" class="node">
<title>BuyVM</title>
<polygon fill="white" stroke="white" points="80.22,-124 18.32,-124 18.32,-88 80.22,-88 80.22,-124"></polygon>
<text xml:space="preserve" text-anchor="middle" x="49.27" y="-101.8" font-family="Times,serif" font-size="14.00">BuyVM</text>
</g><!-- BuyVM&#45;&gt;VirMach -->
<g id="edge1" class="edge">
<title>BuyVM->VirMach</title>
<path fill="none" stroke="red" d="M49.27,-87.59C49.27,-80.28 49.27,-71.69 49.27,-63.56"></path>
<polygon fill="red" stroke="red" points="52.77,-63.68 49.27,-53.68 45.77,-63.68 52.77,-63.68"></polygon>
<text xml:space="preserve" text-anchor="middle" x="37.87" y="-65.8" font-family="Times,serif" font-size="14.00">200 - 10 * 1 = 190</text>
</g><!-- Lutoma -->
<g id="node4" class="node">
<title>Lutoma</title>
<polygon fill="none" stroke="black" points="281.64,-124 222.1,-124 222.1,-88 281.64,-88 281.64,-124"></polygon>
<text xml:space="preserve" text-anchor="middle" x="251.87" y="-101.8" font-family="Times,serif" font-size="14.00">Lutoma</text>
</g><!-- BuyVM&#45;&gt;Lutoma -->
<g id="edge3" class="edge">
<title>BuyVM->Lutoma</title>
<path fill="none" stroke="black" d="M80.3,-106C114.87,-106 171.82,-106 210.3,-106"></path>
<polygon fill="black" stroke="black" points="210.1,-109.5 220.1,-106 210.1,-102.5 210.1,-109.5"></polygon>
<text xml:space="preserve" text-anchor="middle" x="152.32" y="-110.2" font-family="Times,serif" font-size="14.00">200 - 10 * 2 = 180</text>
</g><!-- Lutoma&#45;&gt;KSKB -->
<g id="edge4" class="edge">
<title>Lutoma->KSKB</title>
<path fill="none" stroke="black" d="M251.87,-87.53C251.87,-79.55 251.87,-71.56 251.87,-63.57"></path>
<polygon fill="black" stroke="black" points="255.37,-63.79 251.87,-53.79 248.37,-63.79 255.37,-63.79"></polygon>
</g>
</g>
</svg>
</p>
<p>Yet my VirMach node chose the route through BuyVM:</p>
<p><!--?xml version="1.0" encoding="UTF-8" standalone="no"?--><!-- Generated by graphviz version 14.0.2 (0)
 --><!-- Pages: 1 -->
<svg width="290pt" height="189pt" viewBox="0.00 0.00 290.00 189.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 185)">
<polygon fill="white" stroke="none" points="-4,4 -4,-185 285.64,-185 285.64,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_1</title>
<polygon fill="lightgrey" stroke="lightgrey" points="8,-8 8,-173 90.54,-173 90.54,-8 8,-8"></polygon>
<text xml:space="preserve" text-anchor="middle" x="49.27" y="-156.4" font-family="Times,serif" font-size="14.00">My Nodes</text>
</g><!-- VirMach -->
<g id="node1" class="node">
<title>VirMach</title>
<polygon fill="white" stroke="white" points="82.54,-52 16,-52 16,-16 82.54,-16 82.54,-52"></polygon>
<text xml:space="preserve" text-anchor="middle" x="49.27" y="-29.8" font-family="Times,serif" font-size="14.00">VirMach</text>
</g><!-- BuyVM -->
<g id="node2" class="node">
<title>BuyVM</title>
<polygon fill="white" stroke="white" points="80.22,-140 18.32,-140 18.32,-104 80.22,-104 80.22,-140"></polygon>
<text xml:space="preserve" text-anchor="middle" x="49.27" y="-117.8" font-family="Times,serif" font-size="14.00">BuyVM</text>
</g><!-- VirMach&#45;&gt;BuyVM -->
<g id="edge2" class="edge">
<title>VirMach->BuyVM</title>
<path fill="none" stroke="red" d="M49.27,-52.23C49.27,-63.8 49.27,-79.03 49.27,-92.3"></path>
<polygon fill="red" stroke="red" points="45.77,-92.28 49.27,-102.28 52.77,-92.28 45.77,-92.28"></polygon>
<text xml:space="preserve" text-anchor="middle" x="29.47" y="-82.2" font-family="Times,serif" font-size="14.00">200 - 10 * 2 + 100 = 280</text>
<text xml:space="preserve" text-anchor="middle" x="29.47" y="-65.4" font-family="Times,serif" font-size="14.00">(Same region)</text>
</g><!-- KSKB -->
<g id="node3" class="node">
<title>KSKB</title>
<polygon fill="none" stroke="black" points="278.87,-64 224.87,-64 224.87,-28 278.87,-28 278.87,-64"></polygon>
<text xml:space="preserve" text-anchor="middle" x="251.87" y="-41.8" font-family="Times,serif" font-size="14.00">KSKB</text>
</g><!-- VirMach&#45;&gt;KSKB -->
<g id="edge1" class="edge">
<title>VirMach->KSKB</title>
<path fill="none" stroke="black" d="M82.95,-35.95C118.61,-38.09 175.62,-41.5 213.16,-43.74"></path>
<polygon fill="black" stroke="black" points="212.91,-47.24 223.1,-44.34 213.32,-40.25 212.91,-47.24"></polygon>
<text xml:space="preserve" text-anchor="middle" x="152.32" y="-64.1" font-family="Times,serif" font-size="14.00">200 - 10 * 1 = 190</text>
<text xml:space="preserve" text-anchor="middle" x="152.32" y="-47.3" font-family="Times,serif" font-size="14.00">(No region info)</text>
</g><!-- Lutoma -->
<g id="node4" class="node">
<title>Lutoma</title>
<polygon fill="none" stroke="black" points="281.64,-138 222.1,-138 222.1,-102 281.64,-102 281.64,-138"></polygon>
<text xml:space="preserve" text-anchor="middle" x="251.87" y="-115.8" font-family="Times,serif" font-size="14.00">Lutoma</text>
</g><!-- BuyVM&#45;&gt;Lutoma -->
<g id="edge3" class="edge">
<title>BuyVM->Lutoma</title>
<path fill="none" stroke="red" d="M80.3,-121.7C114.87,-121.36 171.82,-120.79 210.3,-120.4"></path>
<polygon fill="red" stroke="red" points="210.13,-123.91 220.1,-120.31 210.06,-116.91 210.13,-123.91"></polygon>
</g><!-- Lutoma&#45;&gt;KSKB -->
<g id="edge4" class="edge">
<title>Lutoma->KSKB</title>
<path fill="none" stroke="red" d="M251.87,-101.79C251.87,-93.15 251.87,-84.5 251.87,-75.86"></path>
<polygon fill="red" stroke="red" points="255.37,-76.01 251.87,-66.01 248.37,-76.01 255.37,-76.01"></polygon>
</g>
</g>
</svg>
</p>
<p>And now we have a routing loop.</p>
<h2 id="correct-way-to-do-this-3">Correct Way to Do This</h2>
<p>For this problem to appear, all three requirements must be met:</p>
<ol>
<li><strong><code>add paths yes;</code> option is turned on</strong>, so that secondary routes are sent
to other nodes as well. If this option wasn't turned on, as soon as the BuyVM
node choose the VirMach node as the next hop, it won't broadcast its route
through Lutoma to the VirMach node. Then, the VirMach node will only have the
option of sending traffic directly to KSKB.</li>
<li>Route preference algorithm <strong>preferring secondary routes over primary routes
from other nodes</strong>. Therefore, if we want to keep <code>add paths yes;</code> option on,
while designing the iBGP route preference algorithm, we need to guarantee
that routes from the same node <strong>have their priorities in the same order as
that node</strong>, so that the primary routes will always be used over secondary
routes.</li>
<li>Routes passing Lutoma's network were incorrectly updated with the new BGP
community, causing the change of route priority orders.</li>
</ol>
<p>My solution to the problem is to no longer recalculate route priority for those
received from iBGP. Instead, I will always use the priority value calculated by
the edge node receiving the route, and passed over along with the route
announcement over iBGP, to guarantee that the order of primary and secondary
routes never change.</p>  </div>  <div class="clearfix" id="post-navi" data-astro-cid-gfbmwgei=""> <div class="float-end text-end" data-astro-cid-gfbmwgei=""> <a href="/en/article/modify-computer/laptop-muxed-nvidia-passthrough.lantian/" title="NVIDIA GPU Passthrough on an Optimus MUXed Laptop (Updated 2023-05)" data-astro-cid-gfbmwgei=""> NVIDIA GPU Passthrough on an Optimus MUXed Laptop (Updated 2023-05) </a> <br data-astro-cid-gfbmwgei=""> Next post »
</div> <div class="float-start text-start position-absolute" data-astro-cid-gfbmwgei="">
« Previous post <br data-astro-cid-gfbmwgei=""> <a href="/en/article/random-notes/pipewire-sigkill-fix.lantian/" title="Preventing Pipewire from being SIGKILLed" data-astro-cid-gfbmwgei=""> Preventing Pipewire from being SIGKILLed </a> </div> </div>  <div id="waline" data-waline-language="en-US" data-waline-path="/en/article/modify-website/how-to-kill-the-dn42-network.lantian"></div> <script type="module" src="/assets/WalineComment.astro_astro_type_script_index_0_lang.Dqib3X1E.js"></script>  </div> </div> </article>  </div> <aside class="d-none d-xl-block"> <section class="widget"> <h3>Latest posts</h3> <ul class="list-unstyled"> <li> 07-20  <a href="/en/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/">Legal LTE Network at Home with Open5GS</a> </li><li> 06-27  <a href="/en/article/modify-computer/sidestore-without-stosvpn-across-lan.lantian/">Using SideStore without StosVPN across your LAN</a> </li><li> 05-19  <a href="/en/article/modify-computer/nix-logarithmetic-math-library-from-zero.lantian/">Nix Logarithmic Math Library from Ground Zero</a> </li><li> 04-06  <a href="/en/article/modify-computer/legal-lte-network-at-home-for-100-bucks.lantian/">Legal LTE Network at Home for $100</a> </li><li> 02-10  <a href="/en/article/modify-computer/build-custom-android-kernel-with-nix.lantian/">Building Custom Android Kernel with Nix</a> </li><li> 04-20  <a href="/en/article/modify-website/migrate-blog-to-astro-js.lantian/">Migrating My Blog to Astro.js</a> </li><li> 12-16  <a href="/en/article/modify-computer/nixos-low-ram-vps.lantian/">NixOS Series 5: Creating Disk Image for Low RAM VPS</a> </li><li> 09-20  <a href="/en/article/modify-computer/nix-trigonometric-math-library-from-zero.lantian/">Nix Trigonometric Math Library from Ground Zero</a> </li><li> 05-29  <a href="/en/article/random-notes/pipewire-sigkill-fix.lantian/">Preventing Pipewire from being SIGKILLed</a> </li><li> 05-12  <a href="/en/article/modify-website/how-to-kill-the-dn42-network.lantian/">How to Kill the DN42 Network (Updated 2023-05-12)</a> </li><li> 05-08  <a href="/en/article/modify-computer/laptop-muxed-nvidia-passthrough.lantian/">NVIDIA GPU Passthrough on an Optimus MUXed Laptop (Updated 2023-05)</a> </li><li> 04-17  <a href="/en/article/random-notes/fix-china-telecom-roaming-no-4g-on-aosp-rom.lantian/">Fix China Telecom 4G Roaming on AOSP ROM by Changing APN</a> </li><li> 03-26  <a href="/en/article/random-notes/old-hp-workstation-as-all-in-one.lantian/">Notes on Setting Up NAS+Router on Old HP Workstation</a> </li><li> 01-14  <a href="/en/article/modify-computer/nixos-impermanence.lantian/">NixOS Series 4: &quot;Stateless&quot; Operating System</a> </li><li> 06-21  <a href="/en/article/modify-computer/nixos-packaging.lantian/">NixOS Series 3: Software Packaging 101</a> </li> </ul> </section> <section class="widget"> <h3>Latest comments</h3> <ul class="list-unstyled" id="recent-comments">  <li><a href="#">Loading...</a></li>  </ul> </section> <script type="module">const i=window.location.hostname=="localhost"?"https://comments.lantian.pub":window.location.origin;fetch(`${i}/api/comment?type=recent&count=10`).then(t=>{if(t.status!==200)throw new Error(`Server returned bad HTTP status ${t.status}`);return t.json()}).then(t=>{const e=document.getElementById("recent-comments");e&&(e.innerHTML=t.data.map(n=>{const o=n.comment.replace(/(<([^>]+)>)/gi,"");return"<li>"+n.nick+' <a href="'+n.url+'">'+o+"</a></li>"}).join(""))});</script> <section class="widget"> <h3>Others</h3> <ul class="list-unstyled">  <li> <i class="fas fa-fw fa-rss"></i>  <a href="/rss2.xml" target="_blank">RSS Feed</a> |  <a href="/feed.xml" target="_blank">Atom</a> |  <a href="/feed.json" target="_blank">JSON</a> </li> <li> <i class="fas fa-fw fa-globe"></i>  <a href="https://stats.uptimerobot.com/BLK6VsRkR" target="_blank"> Sever Status </a> </li> <li> <i class="fas fa-fw fa-sitemap"></i>  <a href="https://lg.lantian.pub" target="_blank">DN42 Looking Glass</a> </li> <li> <i class="fas fa-fw fa-link"></i>  <a href="gopher://lantian.pub" target="_blank">Access with Gopher protocol</a> </li>  </ul> </section> <section class="widget"> <h3>Links</h3> <ul class="list-unstyled"> <li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://0x7f.cc"> 0x7f Blog 🐑 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="http://foreverblog.cn"> 10 Year&#39;s Promise (Forever Blog) </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://alanyhq.com"> Alanyhq </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.baoshuo.ren/?utm_source=friends"> Baoshuo&#39;s Blog </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.cas7.moe"> Blog of Moecast </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://jerryxiao.cc"> JerryXiao </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://sangsir.com"> SangSir </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://snli.org"> Shucheng Li </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://yuetau.net"> YuetAu&#39;s Spot </a> </li> </ul> </section> </aside> </div> <footer class="lantian clearfix" data-astro-cid-w3csb3e3="">  <div id="copyright" class="float-end text-end" data-astro-cid-w3csb3e3=""> <i class="fas fa-copyright" data-astro-cid-w3csb3e3=""></i> 2012-2025 Lan Tian @ Blog<br data-astro-cid-w3csb3e3=""> <small data-astro-cid-w3csb3e3=""> Powered by Astro v5.15.1 @ 2025-10-25 23:46:37 </small> </div> <script type="module">function v(c,o,r){const h=/^localhost$|^127(?:\.[0-9]+){0,2}\.[0-9]+$|^(?:0*:)*?:?0*1$/.test(location.hostname)||location.protocol==="file:";if(!o.trackLocalhost&&h)return console.warn("[Plausible] Ignoring event because website is running locally");try{if(window.localStorage.plausible_ignore==="true")return console.warn('[Plausible] Ignoring event because "plausible_ignore" is set to "true" in localStorage')}catch{}const p={n:c,u:o.url,d:o.domain,r:o.referrer,w:o.deviceWidth,h:o.hashMode?1:0,p:r&&r.props?JSON.stringify(r.props):void 0},s=new XMLHttpRequest;s.open("POST",`${o.apiHost}/api/event`,!0),s.setRequestHeader("Content-Type","text/plain"),s.send(JSON.stringify(p)),s.onreadystatechange=()=>{s.readyState===4&&r&&r.callback&&r.callback()}}function b(c){const o=()=>({hashMode:!1,trackLocalhost:!1,url:location.href,domain:location.hostname,referrer:document.referrer||null,deviceWidth:window.innerWidth,apiHost:"https://plausible.io",...c}),r=(t,n,i)=>{v(t,{...o(),...i},n)},h=(t,n)=>{r("pageview",n,t)};return{trackEvent:r,trackPageview:h,enableAutoPageviews:()=>{const t=()=>h(),n=history.pushState;return n&&(history.pushState=function(i,l,u){n.apply(this,[i,l,u]),t()},addEventListener("popstate",t)),c&&c.hashMode&&addEventListener("hashchange",t),h(),function(){n&&(history.pushState=n,removeEventListener("popstate",t)),c&&c.hashMode&&removeEventListener("hashchange",t)}},enableAutoOutboundTracking:(t=document,n={subtree:!0,childList:!0,attributes:!0,attributeFilter:["href"]})=>{function i(e){r("Outbound Link: Click",{props:{url:this.href}}),typeof process<"u"&&process,setTimeout(()=>{location.href=this.href},150),e.preventDefault()}const l=new Set;function u(e){e instanceof HTMLAnchorElement?e.host!==location.host&&(e.addEventListener("click",i),l.add(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(u)}function f(e){e instanceof HTMLAnchorElement?(e.removeEventListener("click",i),l.delete(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(f)}const d=new MutationObserver(e=>{e.forEach(a=>{a.type==="attributes"?(f(a.target),u(a.target)):a.type==="childList"&&(a.addedNodes.forEach(u),a.removedNodes.forEach(f))})});return t.querySelectorAll("a").forEach(u),d.observe(t,n),function(){l.forEach(a=>{a.removeEventListener("click",i)}),l.clear(),d.disconnect()}}}}const g=b({domain:"lantian.pub",trackLocalhost:!0,apiHost:""});g.trackPageview();</script> </footer>  </div>  </body> </html>