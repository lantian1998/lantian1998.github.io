<!DOCTYPE html><html lang="en-US" itemscope="" itemtype="https://schema.org/Article" data-astro-cid-porej7z2=""> <head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Building GeoDNS with PowerDNS Lua Functionality for Regional DNS Resolution - Lan Tian @ Blog</title><script>
  ;(() => {
    try {
      const mode = localStorage.getItem('user-color-scheme')
      if (mode == 'dark' || mode == 'light') {
        document.documentElement.setAttribute('data-user-color-scheme', mode)
      }
    } catch {
      // Ignore errors
    }
  })()
</script><link rel="stylesheet" href="/assets/index.CUlf1-Vz.css"><style>#post-navi[data-astro-cid-gfbmwgei]{padding:5px;border-top:1px solid var(--lt-border-weak);border-bottom:1px solid var(--lt-border-weak)}
ol[data-astro-cid-nj3qel45]{margin:0;padding:0;line-height:1.5}ol[data-astro-cid-nj3qel45] .toc-item[data-astro-cid-nj3qel45]{list-style:none}ol[data-astro-cid-nj3qel45] .toc-child[data-astro-cid-nj3qel45],ol[data-astro-cid-nj3qel45] .toc[data-astro-cid-nj3qel45]{padding:0}ol[data-astro-cid-nj3qel45] .toc-link[data-astro-cid-nj3qel45]{display:block;margin-left:1em;padding:.25em 0}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;width:1em;padding:.25em 0;float:left;font-style:normal;font-variant:normal;font-weight:900;font-family:Font Awesome\ 6 Free;font-feature-settings:normal;text-align:center}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before{content:""}ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{content:""}.post-info-wrap[data-astro-cid-dckccua4]{-ms-flex:0 0 2.5em;flex:0 0 2.5em;background-color:var(--lt-component-bg-emphasis)}@media(min-width:768px){.post-info[data-astro-cid-dckccua4]{position:sticky;top:0}}@media(max-width:767.98px){.post-info[data-astro-cid-dckccua4]{position:absolute}}
</style><script type="module" src="/assets/PageLayout.astro_astro_type_script_index_0_lang.C1wfUPs6.js"></script><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Referrer-Policy" content="no-referrer, strict-origin-when-cross-origin"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="imagemode" content="force"><meta name="nightmode" content="disable"><meta name="wap-font-scale" content="no"><meta name="title" content="Building GeoDNS with PowerDNS Lua Functionality for Regional DNS Resolution - Lan Tian @ Blog"><meta name="keywords" content=""><meta name="author" content="Lan Tian"><link rel="canonical" href="https://lantian.pub/en/article/modify-website/powerdns-lua-diy-geodns.lantian/"><link rel="alternate" type="application/rss+xml" title="Lan Tian @ Blog" href="https://lantian.pub/rss2.xml"><link rel="alternate" type="application/atom+xml" title="Lan Tian @ Blog" href="https://lantian.pub/feed.xml"><link rel="alternate" href="https://lantian.pub/article/modify-website/powerdns-lua-diy-geodns.lantian/" hreflang="zh"><link rel="alternate" href="https://lantian.pub/en/article/modify-website/powerdns-lua-diy-geodns.lantian/" hreflang="en"><meta name="copyright" content="Copyright 2012-2025 Lan Tian @ Blog"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#03a9f4"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#212121"><meta name="application-name" content="Lan Tian @ Blog"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="apple-touch-icon" sizes="1024x1024" href="/apple-touch-icon-1024x1024.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#03a9f4"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Lan Tian @ Blog"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-640x1136.png"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1136x640.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-750x1334.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1334x750.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1125x2436.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2436x1125.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1170x2532.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2532x1170.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1179x2556.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2556x1179.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-828x1792.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1792x828.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2688.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2688x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2208.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2208x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1284x2778.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2778x1284.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1290x2796.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2796x1290.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1488x2266.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2266x1488.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1536x2048.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2048x1536.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1620x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1620.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1640x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1640.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2388.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2388x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2224.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2224x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-2048x2732.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2732x2048.png"><meta name="msapplication-TileColor" content="#bbdefb"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"><meta property="og:url" content="https://lantian.pub/en/article/modify-website/powerdns-lua-diy-geodns.lantian/"><meta property="og:type" content="website"><meta property="og:title" content="Building GeoDNS with PowerDNS Lua Functionality for Regional DNS Resolution - Lan Tian @ Blog"><meta property="og:image" content="https://lantian.pub/usr/uploads/202001/geodns-global-ping.png"><meta content="Previously, if you wanted to build your own authoritative DNS system for a website, the (almost) only option was PowerDNS with its GeoIP backend. However, the GeoIP backend uses YAML configuration files and cannot work with databases like MySQL. This meant having to manually set up a cross-server file synchronization system instead of using more mature database synchronization technologies. Fortunately, PowerDNS added support for Lua records in its latest 4.2 version. Lua is a programming language specifically designed for &#34;embedding functionality into other programs,&#34; which you may have encountered in nginx (as a plugin). Lua record support enables PowerDNS to return different responses based on user query requests, thus implementing GeoDNS functionality for regional resolution...."><meta property="og:site_name" content="Lan Tian @ Blog"><meta property="og:locale" content="en"><meta name="twitter:card" content="summary"><meta name="twitter:url" content="https://lantian.pub/en/article/modify-website/powerdns-lua-diy-geodns.lantian/"><meta name="twitter:title" content="Building GeoDNS with PowerDNS Lua Functionality for Regional DNS Resolution - Lan Tian @ Blog"><meta property="twitter:image" content="https://lantian.pub/usr/uploads/202001/geodns-global-ping.png"><meta content="Previously, if you wanted to build your own authoritative DNS system for a website, the (almost) only option was PowerDNS with its GeoIP backend. However, the GeoIP backend uses YAML configuration files and cannot work with databases like MySQL. This meant having to manually set up a cross-server file synchronization system instead of using more mature database synchronization technologies. Fortunately, PowerDNS added support for Lua records in its latest 4.2 version. Lua is a programming language specifically designed for &#34;embedding functionality into other programs,&#34; which you may have encountered in nginx (as a plugin). Lua record support enables PowerDNS to return different responses based on user query requests, thus implementing GeoDNS functionality for regional resolution...."><meta name="twitter:dnt" content="on"><meta itemprop="name" content="Building GeoDNS with PowerDNS Lua Functionality for Regional DNS Resolution - Lan Tian @ Blog"><meta property="image" content="https://lantian.pub/usr/uploads/202001/geodns-global-ping.png"><meta content="Previously, if you wanted to build your own authoritative DNS system for a website, the (almost) only option was PowerDNS with its GeoIP backend. However, the GeoIP backend uses YAML configuration files and cannot work with databases like MySQL. This meant having to manually set up a cross-server file synchronization system instead of using more mature database synchronization technologies. Fortunately, PowerDNS added support for Lua records in its latest 4.2 version. Lua is a programming language specifically designed for &#34;embedding functionality into other programs,&#34; which you may have encountered in nginx (as a plugin). Lua record support enables PowerDNS to return different responses based on user query requests, thus implementing GeoDNS functionality for regional resolution...."><meta content="Previously, if you wanted to build your own authoritative DNS system for a website, the (almost) only option was PowerDNS with its GeoIP backend. However, the GeoIP backend uses YAML configuration files and cannot work with databases like MySQL. This meant having to manually set up a cross-server file synchronization system instead of using more mature database synchronization technologies. Fortunately, PowerDNS added support for Lua records in its latest 4.2 version. Lua is a programming language specifically designed for &#34;embedding functionality into other programs,&#34; which you may have encountered in nginx (as a plugin). Lua record support enables PowerDNS to return different responses based on user query requests, thus implementing GeoDNS functionality for regional resolution...."><link rel="me" href="https://mastodon.social/@lantian"></head> <body data-astro-cid-porej7z2=""> <div id="bg" data-astro-cid-j6vmxtef=""></div>   <div id="container" class="container" data-astro-cid-porej7z2=""> <nav class="lantian navbar navbar-expand-lg" data-astro-cid-wu5dj4rx=""> <div class="container-fluid" data-astro-cid-wu5dj4rx=""> <a class="navbar-brand" href="/en/" data-astro-cid-wu5dj4rx="">Lan Tian @ Blog</a> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#lantian-navbar" aria-controls="lantian-navbar" aria-expanded="false" aria-label="Toggle navigation" data-astro-cid-wu5dj4rx=""> <span class="navbar-toggler-icon" data-astro-cid-wu5dj4rx=""></span> </button> <div class="collapse navbar-collapse" id="lantian-navbar" data-astro-cid-wu5dj4rx=""> <ul class="navbar-nav" data-astro-cid-wu5dj4rx=""> <li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/archive/index.html" data-astro-cid-wu5dj4rx=""> Posts </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> Himawari </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> <li class="nav-item dropdown d-block d-lg-none" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="pages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-file" data-astro-cid-wu5dj4rx=""></i> Page  <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="pages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/archive/index.html" data-astro-cid-wu5dj4rx=""> Posts </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> Himawari </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> </ul> </li> </ul> <ul class="navbar-nav ms-auto" data-astro-cid-wu5dj4rx=""> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="languages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-language" data-astro-cid-wu5dj4rx=""></i> Language <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="languages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/article/modify-website/powerdns-lua-diy-geodns.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-cn" data-astro-cid-wu5dj4rx=""></span> Chinese Simplified / 简体中文 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item active" href="/en/article/modify-website/powerdns-lua-diy-geodns.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-us" data-astro-cid-wu5dj4rx=""></span> English </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">Not all pages have translations.</a> </li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">You may see 404 - this is normal.</a> </li> </ul> </li> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="color-scheme-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> Night Mode </a> <ul class="dropdown-menu" aria-labelledby="color-scheme-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-auto" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> Auto </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-light" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-sun" data-astro-cid-wu5dj4rx=""></i> Light</a> </li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-dark" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-moon" data-astro-cid-wu5dj4rx=""></i> Dark</a> </li> </ul> </li> </ul> </div> </div> </nav> <script type="module">const m="user-color-scheme",s="data-user-color-scheme",u=(e,t)=>{try{localStorage.setItem(e,t)}catch{}},i=e=>{try{return localStorage.getItem(e)}catch{return null}},c=e=>{const t={dark:!0,light:!0,auto:!0},o=e===null||!Object.keys(t).includes(e)?"auto":e;u(m,o);for(const l in t){const n=document.getElementById("color-scheme-"+l);n&&(l==o?n.classList.add("active"):n.classList.remove("active"))}o!="auto"?document.documentElement.setAttribute(s,o):document.documentElement.removeAttribute(s)};c(i(m));const r=document.getElementById("color-scheme-auto");r&&r.addEventListener("click",()=>c("auto"));const a=document.getElementById("color-scheme-light");a&&a.addEventListener("click",()=>c("light"));const d=document.getElementById("color-scheme-dark");d&&d.addEventListener("click",()=>c("dark"));</script>  <div class="d-flex" data-astro-cid-porej7z2=""> <div id="content" data-astro-cid-porej7z2="">  <article> <div class="d-flex"> <div class="post-info-wrap" data-astro-cid-dckccua4=""> <div class="post-info" data-astro-cid-dckccua4=""> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-clock"></span> <br> <small>01-17</small> </p> <div class="post-meta-value"> Published on<span class="badge badge-tag" data-astro-cid-dckccua4=""> 2020-01-17 23:45 </span>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-file-alt"></span> <br> <small>Website and Servers</small> </p> <div class="post-meta-value"> Category <a class="badge badge-tag" href="/en/category/modify-website" data-astro-cid-dckccua4=""> Website and Servers </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-tag"></span> <br> <small>3 tags</small> </p> <div class="post-meta-value"> Tags  <a class="badge badge-tag" href="/en/tag/PowerDNS" data-astro-cid-dckccua4=""> PowerDNS </a>  <a class="badge badge-tag" href="/en/tag/GeoDNS" data-astro-cid-dckccua4=""> GeoDNS </a>  <a class="badge badge-tag" href="/en/tag/Lua" data-astro-cid-dckccua4=""> Lua </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-list"></span> <br> <small>ToC</small> </p> <div class="post-meta-value">  <ol data-astro-cid-nj3qel45=""> <li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#updating-powerdns" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Updating PowerDNS</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#configuring-the-geoip-database" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Configuring the GeoIP Database</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#configuring-and-starting-powerdns" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Configuring and Starting PowerDNS</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#adding-lua-resolution-records" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Adding Lua Resolution Records</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#configuring-geodns" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Configuring GeoDNS</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#country-based-resolution" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Country-Based Resolution</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#references" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">References</span> </a> </li> </ol>   </div> </div> </div> </div>  </div>  <div class="post-wrap"> <div class="post-image-wrap"> <picture> <source srcset="/usr/uploads/202001/geodns-global-ping.png.thumb.png.webp" type="image/webp"> <source srcset="/usr/uploads/202001/geodns-global-ping.png.thumb.png.avif" type="image/avif"> <source srcset="/usr/uploads/202001/geodns-global-ping.png.thumb.png.jxl" type="image/jxl"> <img src="/usr/uploads/202001/geodns-global-ping.png.thumb.png" alt="Illustration for Building GeoDNS with PowerDNS Lua Functionality for Regional DNS Resolution" width="200" height="150"> </picture> </div> <h1 class="post-title"> <a href="/en/article/modify-website/powerdns-lua-diy-geodns.lantian/" rel="bookmark" title="Building GeoDNS with PowerDNS Lua Functionality for Regional DNS Resolution">Building GeoDNS with PowerDNS Lua Functionality for Regional DNS Resolution</a> </h1> <div class="post-text">   <blockquote> <p>
This post is automatically translated with LLM. The translation content has
    NOT been reviewed and may contain errors.
</p> </blockquote><p>Previously, if you wanted to build your own authoritative DNS system for a website, the (almost) only option was PowerDNS with its GeoIP backend. However, the GeoIP backend uses YAML configuration files and cannot work with databases like MySQL. This meant having to manually set up a cross-server file synchronization system instead of using more mature database synchronization technologies.</p>
<p>Fortunately, PowerDNS added support for Lua records in its latest 4.2 version. Lua is a programming language specifically designed for "embedding functionality into other programs," which you may have encountered in nginx (as a plugin). Lua record support enables PowerDNS to return different responses based on user query requests, thus implementing GeoDNS functionality for regional resolution.</p>
<h2 id="updating-powerdns">Updating PowerDNS</h2>
<p>The latest PowerDNS 4.2 version isn't included in the Debian 10 software repository. You'll need to download it from the Debian Unstable repository. However, since PowerDNS depends on numerous new library files—including essential system libraries—installing via commands like <code>apt-get install -t unstable pdns-server</code> would upgrade some core system files to Unstable versions.</p>
<p>In this situation, Docker is the best solution. Since we only need to download PowerDNS from the Debian repository without compiling it ourselves, we can create the image with just a few lines:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">FROM</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> amd64/debian:sid</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">RUN</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> apt-get -qq update \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; DEBIAN_FRONTEND=noninteractive apt-get -qq install -y tini pdns-server pdns-tools pdns-backend-</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">\*</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; apt-get clean</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">ENTRYPOINT</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> [</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"/usr/bin/tini"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"-g"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"--"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"/usr/sbin/pdns_server"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">]</span></span></code></pre>
<p>The final Dockerfile I used (partial) can be found on <a href="https://github.com/xddxdd/dockerfiles/blob/53295f2641dce30072f0f2ac5dd631e1f0b35687/dockerfiles/powerdns-bird/template.Dockerfile" rel="noopener noreferrer" target="_blank">my GitHub</a>. Note that this Dockerfile includes Bird BGP and requires GPP processing to generate the complete version (details can be found in <a href="/en/article/modify-website/gpp-preprocess-dockerfile-include-if.lantian/">this article</a>).</p>
<h2 id="configuring-the-geoip-database">Configuring the GeoIP Database</h2>
<p>PowerDNS uses the MaxMind GeoIP database for IP geographical information. Although MaxMind provides a free, lower-precision IP geolocation database (GeoLite) for personal use, starting December 30, 2019, MaxMind began requiring GeoLite users to register an account and obtain a license key to download the database. The steps are as follows:</p>
<ol>
<li>Go to the <a href="https://dev.maxmind.com/geoip/geoip2/geolite2/" rel="noopener noreferrer" target="_blank">GeoLite 2 Databases page</a>, click the yellow button at the bottom to register. This process requires email verification and cannot be done through a proxy (since that's what they specialize in).</li>
<li>In the account details page, click <code>My License Key</code> on the left to manage license keys.</li>
<li>Click <code>Generate License Key</code> to create a new key.</li>
<li>Fill in a key description and select the key version as shown in the image, then confirm with the blue button:
<ul>
<li><picture><source srcset="/usr/uploads/202001/maxmind-license-version.png.webp" type="image/webp"><source srcset="/usr/uploads/202001/maxmind-license-version.png.avif" type="image/avif"><source srcset="/usr/uploads/202001/maxmind-license-version.png.jxl" type="image/jxl"><img src="/usr/uploads/202001/maxmind-license-version.png" alt="License version selection"></picture></li>
</ul>
</li>
<li>After submission, note two important pieces of information to fill in the configuration file later:
<ul>
<li><code>Account/User ID</code></li>
<li><code>License Key</code></li>
</ul>
</li>
</ol>
<p>Next, you can use MaxMind's official <code>geoipupdate</code> tool to automatically update the database. First, install it on Debian:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">apt-get</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> install</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> geoipupdate</span></span></code></pre>
<p>Then create the folder <code>/etc/geoip</code> and modify <code>/etc/GeoIP.conf</code> (note capitalization) with the following content:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">AccountID</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> [Account </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">ID]</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">LicenseKey</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> [License </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">Key]</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">EditionIDs</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> GeoLite2-ASN</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> GeoLite2-City</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> GeoLite2-Country</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">DatabaseDirectory</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /etc/geoip</span></span></code></pre>
<p>Run <code>geoipupdate</code> to update the database automatically, with files stored in <code>/etc/geoip</code>. Set up automatic updates via Cron:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">crontab</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -e</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Add this line:</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">0</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 0</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> *</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> *</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 0</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /usr/bin/geoipupdate</span></span></code></pre>
<h2 id="configuring-and-starting-powerdns">Configuring and Starting PowerDNS</h2>
<p>To enable GeoIP functionality, modify PowerDNS's configuration file. Open <code>pdns.conf</code> and make the following changes based on your existing working PowerDNS configuration:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Enable Lua records</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">enable-lua-records</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">=yes</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Add geoip after your current database backend</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">launch</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">=gmysql,geoip</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Specify the database file path, using the highest-precision city-level database</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">geoip-database-files</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">=/etc/geoip/GeoLite2-City.mmdb</span></span></code></pre>
<p>Then start PowerDNS. If your host system is Debian Unstable, simply run:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">systemctl</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> start</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> pdns</span></span></code></pre>
<p>For Docker users, here's a reference for <code>docker-compose.yml</code>:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">powerdns</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: [</span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">Your custom Docker image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">]</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  container_name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">powerdns</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  restart</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">always</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  volumes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'./conf/powerdns/pdns.conf:/etc/powerdns/pdns.conf:ro'</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'/etc/geoip:/etc/geoip:ro'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  ports</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'53:53'</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'53:53/udp'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  depends_on</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">mysql</span></span></code></pre>
<h2 id="adding-lua-resolution-records">Adding Lua Resolution Records</h2>
<p>In modern DNS resolution systems, DNS servers typically inform upstream servers of the user's IP step by step (known as EDNS), allowing servers to assign the nearest server address based on the user's IP.</p>
<p>In PowerDNS Lua, the user's IP address is available as the variable <code>bestwho</code>. However, if the user's DNS server doesn't inform upstream servers of the user's address, <code>bestwho</code> will point to the DNS server's address.</p>
<p>First, let's demonstrate how to use <code>bestwho</code>. Create a record of type <code>LUA</code> with the following content:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">A</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ";if(bestwho:isIPv4()) then return bestwho:toString() else return '0.0.0.0' end"</span></span></code></pre>
<p>The initial <code>A</code> indicates the record type to return. The following string is a small Lua program: if the source IP is IPv4, it returns the user's IP; otherwise, it returns <code>0.0.0.0</code> to indicate failure.</p>
<p>Similarly, we can create an IPv6 version. Create another record with the same name and type <code>LUA</code>:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">AAAA</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ";if(bestwho:isIPv6()) then return bestwho:toString() else return '::' end"</span></span></code></pre>
<p>Or use a TXT record to return connection information with port numbers:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">TXT</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "bestwho:toStringWithPort()"</span></span></code></pre>
<p>Or use a LOC record to return the geographical location inferred by GeoIP:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">LOC</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "latlonloc()"</span></span></code></pre>
<p>All these features can be seen at <code>whoami.lantian.pub</code>:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">$</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> dig</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> +short</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> @1.1.1.1</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> whoami.lantian.pub</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">108.162.214.17</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">$</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> dig</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> +short</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> @1.1.1.1</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> AAAA</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> whoami.lantian.pub</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">2400:cb00:12:1024::6ca2:d619</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">$</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> dig</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> +short</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> @1.1.1.1</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> TXT</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> whoami.lantian.pub</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">"[2400:cb00:12:1024::6ca2:d626]:16668"</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">$</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> dig</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> +short</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> @1.1.1.1</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> LOC</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> whoami.lantian.pub</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">34</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 3</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 15.840</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> N</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 118</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 14</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 38.400</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> W</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> 0.00m</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> 1m</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> 10000m</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> 10m</span></span></code></pre>
<p>(Note: Cloudflare's 1.1.1.1 server intentionally disables EDNS, so it displays Cloudflare's server address here)</p>
<h2 id="configuring-geodns">Configuring GeoDNS</h2>
<p>Now that we understand how PowerDNS Lua works, we can configure regional resolution records. PowerDNS provides a convenient function <code>pickclosest</code> that automatically selects the nearest server from an IP list for the user. For example, the current A record for <code>lantian.pub</code> is:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">A</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "pickclosest({'103.42.215.193','185.186.147.110','107.172.134.89','195.154.221.59'})"</span></span></code></pre>
<p><code>pickclosest</code> also works for AAAA records:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">AAAA</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "pickclosest({'2001:470:19:10bb::1','2001:470:d:46e::1','2001:470:1f07:54d::1','2001:470:1f13:28::1'})"</span></span></code></pre>
<p>(The above servers are located in: Hong Kong, Los Angeles, New York, and France respectively)</p>
<p>This way, users from different regions get different resolution results:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Mainland China</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">$</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> dig</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> +short</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> lantian.pub</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">103.42.215.193</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Los Angeles, USA</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">$</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> dig</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> +short</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> lantian.pub</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">185.186.147.110</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># France</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">$</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> dig</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> +short</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> lantian.pub</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">195.154.221.59</span></span></code></pre>
<p>Global ping latency also improves significantly. Achieving sub-100ms latency worldwide with a single server would be impossible:</p>
<p><picture><source srcset="/usr/uploads/202001/geodns-global-ping.png.webp" type="image/webp"><source srcset="/usr/uploads/202001/geodns-global-ping.png.avif" type="image/avif"><source srcset="/usr/uploads/202001/geodns-global-ping.png.jxl" type="image/jxl"><img src="/usr/uploads/202001/geodns-global-ping.png" alt="KeyCDN Global Ping Tool Results"></picture></p>
<h2 id="country-based-resolution">Country-Based Resolution</h2>
<p>Instead of selecting the nearest server based on geographical location, a better approach is country-based resolution—for example, the common setup of direct connections within China and using Cloudflare abroad. PowerDNS provides a useful function for this: <code>country</code>:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">TXT</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ";if(country('CN')) then return 'YES' else return 'NO' end"</span></span></code></pre>
<p>Test from inside and outside China:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Mainland China</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">$</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> dig</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> +short</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> @103.42.215.193</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> TXT</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> is-china.lantian.pub</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">"YES"</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Los Angeles, USA</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">$</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> dig</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> +short</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> @103.42.215.193</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> TXT</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> is-china.lantian.pub</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">"NO"</span></span></code></pre>
<p>Slightly modifying this code allows distributing traffic between China and overseas to different servers for A, AAAA, CNAME, etc.:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">CNAME</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ";if(country('CN')) then return 'cdn-china.lantian.pub' else return 'cdn-overseas.lantian.pub' end"</span></span></code></pre>
<h2 id="references">References</h2>
<p>Find more functions in PowerDNS's official documentation:</p>
<p><a href="https://doc.powerdns.com/authoritative/lua-records/index.html" rel="noopener noreferrer" target="_blank">Lua Records - PowerDNS Authoritative Server Documentation</a></p>
<pre><code></code></pre>  </div>  <div class="clearfix" id="post-navi" data-astro-cid-gfbmwgei=""> <div class="float-end text-end" data-astro-cid-gfbmwgei=""> <a href="/en/article/modify-website/cheap-vlan-for-high-speed-transfer-in-school-managed-network.lantian/" title="Building a VLAN in School Network: Low-Cost High-Speed Private Intranet" data-astro-cid-gfbmwgei=""> Building a VLAN in School Network: Low-Cost High-Speed Private Intranet </a> <br data-astro-cid-gfbmwgei=""> Next post »
</div> <div class="float-start text-start position-absolute" data-astro-cid-gfbmwgei="">
« Previous post <br data-astro-cid-gfbmwgei=""> <a href="/en/article/modify-computer/modern-format-photo-video-archiving-almost-intact-h265-heif.lantian/" title="(Almost) Lossless Archival with Modern Formats - H265 and HEIF" data-astro-cid-gfbmwgei=""> (Almost) Lossless Archival with Modern Formats - H265 and HEIF </a> </div> </div>  <div id="waline" data-waline-language="en-US" data-waline-path="/en/article/modify-website/powerdns-lua-diy-geodns.lantian"></div> <script type="module" src="/assets/WalineComment.astro_astro_type_script_index_0_lang.Dqib3X1E.js"></script>  </div> </div> </article>  </div> <aside class="d-none d-xl-block"> <section class="widget"> <h3>Latest posts</h3> <ul class="list-unstyled"> <li> 07-20  <a href="/en/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/">Legal LTE Network at Home with Open5GS</a> </li><li> 06-27  <a href="/en/article/modify-computer/sidestore-without-stosvpn-across-lan.lantian/">Using SideStore without StosVPN across your LAN</a> </li><li> 05-19  <a href="/en/article/modify-computer/nix-logarithmetic-math-library-from-zero.lantian/">Nix Logarithmic Math Library from Ground Zero</a> </li><li> 04-06  <a href="/en/article/modify-computer/legal-lte-network-at-home-for-100-bucks.lantian/">Legal LTE Network at Home for $100</a> </li><li> 02-10  <a href="/en/article/modify-computer/build-custom-android-kernel-with-nix.lantian/">Building Custom Android Kernel with Nix</a> </li><li> 04-20  <a href="/en/article/modify-website/migrate-blog-to-astro-js.lantian/">Migrating My Blog to Astro.js</a> </li><li> 12-16  <a href="/en/article/modify-computer/nixos-low-ram-vps.lantian/">NixOS Series 5: Creating Disk Image for Low RAM VPS</a> </li><li> 09-20  <a href="/en/article/modify-computer/nix-trigonometric-math-library-from-zero.lantian/">Nix Trigonometric Math Library from Ground Zero</a> </li><li> 05-29  <a href="/en/article/random-notes/pipewire-sigkill-fix.lantian/">Preventing Pipewire from being SIGKILLed</a> </li><li> 05-12  <a href="/en/article/modify-website/how-to-kill-the-dn42-network.lantian/">How to Kill the DN42 Network (Updated 2023-05-12)</a> </li><li> 05-08  <a href="/en/article/modify-computer/laptop-muxed-nvidia-passthrough.lantian/">NVIDIA GPU Passthrough on an Optimus MUXed Laptop (Updated 2023-05)</a> </li><li> 04-17  <a href="/en/article/random-notes/fix-china-telecom-roaming-no-4g-on-aosp-rom.lantian/">Fix China Telecom 4G Roaming on AOSP ROM by Changing APN</a> </li><li> 03-26  <a href="/en/article/random-notes/old-hp-workstation-as-all-in-one.lantian/">Notes on Setting Up NAS+Router on Old HP Workstation</a> </li><li> 01-14  <a href="/en/article/modify-computer/nixos-impermanence.lantian/">NixOS Series 4: &quot;Stateless&quot; Operating System</a> </li><li> 06-21  <a href="/en/article/modify-computer/nixos-packaging.lantian/">NixOS Series 3: Software Packaging 101</a> </li> </ul> </section> <section class="widget"> <h3>Latest comments</h3> <ul class="list-unstyled" id="recent-comments">  <li><a href="#">Loading...</a></li>  </ul> </section> <script type="module">const i=window.location.hostname=="localhost"?"https://comments.lantian.pub":window.location.origin;fetch(`${i}/api/comment?type=recent&count=10`).then(t=>{if(t.status!==200)throw new Error(`Server returned bad HTTP status ${t.status}`);return t.json()}).then(t=>{const e=document.getElementById("recent-comments");e&&(e.innerHTML=t.data.map(n=>{const o=n.comment.replace(/(<([^>]+)>)/gi,"");return"<li>"+n.nick+' <a href="'+n.url+'">'+o+"</a></li>"}).join(""))});</script> <section class="widget"> <h3>Others</h3> <ul class="list-unstyled">  <li> <i class="fas fa-fw fa-rss"></i>  <a href="/rss2.xml" target="_blank">RSS Feed</a> |  <a href="/feed.xml" target="_blank">Atom</a> |  <a href="/feed.json" target="_blank">JSON</a> </li> <li> <i class="fas fa-fw fa-globe"></i>  <a href="https://stats.uptimerobot.com/BLK6VsRkR" target="_blank"> Sever Status </a> </li> <li> <i class="fas fa-fw fa-sitemap"></i>  <a href="https://lg.lantian.pub" target="_blank">DN42 Looking Glass</a> </li> <li> <i class="fas fa-fw fa-link"></i>  <a href="gopher://lantian.pub" target="_blank">Access with Gopher protocol</a> </li>  </ul> </section> <section class="widget"> <h3>Links</h3> <ul class="list-unstyled"> <li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://0x7f.cc"> 0x7f Blog 🐑 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="http://foreverblog.cn"> 10 Year&#39;s Promise (Forever Blog) </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://alanyhq.com"> Alanyhq </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.baoshuo.ren/?utm_source=friends"> Baoshuo&#39;s Blog </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.cas7.moe"> Blog of Moecast </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://jerryxiao.cc"> JerryXiao </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://sangsir.com"> SangSir </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://snli.org"> Shucheng Li </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://yuetau.net"> YuetAu&#39;s Spot </a> </li> </ul> </section> </aside> </div> <footer class="lantian clearfix" data-astro-cid-w3csb3e3="">  <div id="copyright" class="float-end text-end" data-astro-cid-w3csb3e3=""> <i class="fas fa-copyright" data-astro-cid-w3csb3e3=""></i> 2012-2025 Lan Tian @ Blog<br data-astro-cid-w3csb3e3=""> <small data-astro-cid-w3csb3e3=""> Powered by Astro v5.15.1 @ 2025-10-25 23:46:39 </small> </div> <script type="module">function v(c,o,r){const h=/^localhost$|^127(?:\.[0-9]+){0,2}\.[0-9]+$|^(?:0*:)*?:?0*1$/.test(location.hostname)||location.protocol==="file:";if(!o.trackLocalhost&&h)return console.warn("[Plausible] Ignoring event because website is running locally");try{if(window.localStorage.plausible_ignore==="true")return console.warn('[Plausible] Ignoring event because "plausible_ignore" is set to "true" in localStorage')}catch{}const p={n:c,u:o.url,d:o.domain,r:o.referrer,w:o.deviceWidth,h:o.hashMode?1:0,p:r&&r.props?JSON.stringify(r.props):void 0},s=new XMLHttpRequest;s.open("POST",`${o.apiHost}/api/event`,!0),s.setRequestHeader("Content-Type","text/plain"),s.send(JSON.stringify(p)),s.onreadystatechange=()=>{s.readyState===4&&r&&r.callback&&r.callback()}}function b(c){const o=()=>({hashMode:!1,trackLocalhost:!1,url:location.href,domain:location.hostname,referrer:document.referrer||null,deviceWidth:window.innerWidth,apiHost:"https://plausible.io",...c}),r=(t,n,i)=>{v(t,{...o(),...i},n)},h=(t,n)=>{r("pageview",n,t)};return{trackEvent:r,trackPageview:h,enableAutoPageviews:()=>{const t=()=>h(),n=history.pushState;return n&&(history.pushState=function(i,l,u){n.apply(this,[i,l,u]),t()},addEventListener("popstate",t)),c&&c.hashMode&&addEventListener("hashchange",t),h(),function(){n&&(history.pushState=n,removeEventListener("popstate",t)),c&&c.hashMode&&removeEventListener("hashchange",t)}},enableAutoOutboundTracking:(t=document,n={subtree:!0,childList:!0,attributes:!0,attributeFilter:["href"]})=>{function i(e){r("Outbound Link: Click",{props:{url:this.href}}),typeof process<"u"&&process,setTimeout(()=>{location.href=this.href},150),e.preventDefault()}const l=new Set;function u(e){e instanceof HTMLAnchorElement?e.host!==location.host&&(e.addEventListener("click",i),l.add(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(u)}function f(e){e instanceof HTMLAnchorElement?(e.removeEventListener("click",i),l.delete(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(f)}const d=new MutationObserver(e=>{e.forEach(a=>{a.type==="attributes"?(f(a.target),u(a.target)):a.type==="childList"&&(a.addedNodes.forEach(u),a.removedNodes.forEach(f))})});return t.querySelectorAll("a").forEach(u),d.observe(t,n),function(){l.forEach(a=>{a.removeEventListener("click",i)}),l.clear(),d.disconnect()}}}}const g=b({domain:"lantian.pub",trackLocalhost:!0,apiHost:""});g.trackPageview();</script> </footer>  </div>  </body> </html>