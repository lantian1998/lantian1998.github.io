<!DOCTYPE html><html lang="en-US" itemscope="" itemtype="https://schema.org/Article" data-astro-cid-porej7z2=""> <head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Lookup Any Public WHOIS with this nginx-based Server - Lan Tian @ Blog</title><script>
  ;(() => {
    try {
      const mode = localStorage.getItem('user-color-scheme')
      if (mode == 'dark' || mode == 'light') {
        document.documentElement.setAttribute('data-user-color-scheme', mode)
      }
    } catch {
      // Ignore errors
    }
  })()
</script><link rel="stylesheet" href="/assets/index.CUlf1-Vz.css"><style>#post-navi[data-astro-cid-gfbmwgei]{padding:5px;border-top:1px solid var(--lt-border-weak);border-bottom:1px solid var(--lt-border-weak)}
ol[data-astro-cid-nj3qel45]{margin:0;padding:0;line-height:1.5}ol[data-astro-cid-nj3qel45] .toc-item[data-astro-cid-nj3qel45]{list-style:none}ol[data-astro-cid-nj3qel45] .toc-child[data-astro-cid-nj3qel45],ol[data-astro-cid-nj3qel45] .toc[data-astro-cid-nj3qel45]{padding:0}ol[data-astro-cid-nj3qel45] .toc-link[data-astro-cid-nj3qel45]{display:block;margin-left:1em;padding:.25em 0}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;width:1em;padding:.25em 0;float:left;font-style:normal;font-variant:normal;font-weight:900;font-family:Font Awesome\ 6 Free;font-feature-settings:normal;text-align:center}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before{content:""}ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{content:""}.post-info-wrap[data-astro-cid-dckccua4]{-ms-flex:0 0 2.5em;flex:0 0 2.5em;background-color:var(--lt-component-bg-emphasis)}@media(min-width:768px){.post-info[data-astro-cid-dckccua4]{position:sticky;top:0}}@media(max-width:767.98px){.post-info[data-astro-cid-dckccua4]{position:absolute}}
</style><script type="module" src="/assets/PageLayout.astro_astro_type_script_index_0_lang.C1wfUPs6.js"></script><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Referrer-Policy" content="no-referrer, strict-origin-when-cross-origin"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="imagemode" content="force"><meta name="nightmode" content="disable"><meta name="wap-font-scale" content="no"><meta name="title" content="Lookup Any Public WHOIS with this nginx-based Server - Lan Tian @ Blog"><meta name="keywords" content=""><meta name="author" content="Lan Tian"><link rel="canonical" href="https://lantian.pub/en/article/modify-website/lookup-any-whois-with-nginx.lantian/"><link rel="alternate" type="application/rss+xml" title="Lan Tian @ Blog" href="https://lantian.pub/rss2.xml"><link rel="alternate" type="application/atom+xml" title="Lan Tian @ Blog" href="https://lantian.pub/feed.xml"><link rel="alternate" href="https://lantian.pub/article/modify-website/lookup-any-whois-with-nginx.lantian/" hreflang="zh"><link rel="alternate" href="https://lantian.pub/en/article/modify-website/lookup-any-whois-with-nginx.lantian/" hreflang="en"><meta name="copyright" content="Copyright 2012-2025 Lan Tian @ Blog"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#03a9f4"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#212121"><meta name="application-name" content="Lan Tian @ Blog"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="apple-touch-icon" sizes="1024x1024" href="/apple-touch-icon-1024x1024.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#03a9f4"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Lan Tian @ Blog"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-640x1136.png"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1136x640.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-750x1334.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1334x750.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1125x2436.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2436x1125.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1170x2532.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2532x1170.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1179x2556.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2556x1179.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-828x1792.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1792x828.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2688.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2688x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2208.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2208x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1284x2778.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2778x1284.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1290x2796.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2796x1290.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1488x2266.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2266x1488.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1536x2048.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2048x1536.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1620x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1620.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1640x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1640.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2388.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2388x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2224.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2224x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-2048x2732.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2732x2048.png"><meta name="msapplication-TileColor" content="#bbdefb"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"><meta property="og:url" content="https://lantian.pub/en/article/modify-website/lookup-any-whois-with-nginx.lantian/"><meta property="og:type" content="website"><meta property="og:title" content="Lookup Any Public WHOIS with this nginx-based Server - Lan Tian @ Blog"><meta property="og:image" content="https://lantian.pub/apple-touch-icon.png"><meta content="After I set up a DN42 WHOIS server with Nginx , I configured my DN42 Looking Glass to use this service. As my Looking Glass is capable of running as a Telegram bot, fellow group members are looking up WHOIS information of IPs and domains with it. But soon we noticed a problem. A significant part of members have applied for ASNs and IP ranges on the public Internet after they're familiar enough with DN42, and they're peering at Internet Exchange Points. Therefore, they often need to lookup some public Internet IPs, ASNs, and domains, yet none of the Telegram bots in our group can do so. It would be quite helpful for us if there exists a WHOIS server that proxies lookups to relevant registries. Proxying is exactly what Nginx is good at. With some modifications to Nginx,..."><meta property="og:site_name" content="Lan Tian @ Blog"><meta property="og:locale" content="en"><meta name="twitter:card" content="summary"><meta name="twitter:url" content="https://lantian.pub/en/article/modify-website/lookup-any-whois-with-nginx.lantian/"><meta name="twitter:title" content="Lookup Any Public WHOIS with this nginx-based Server - Lan Tian @ Blog"><meta property="twitter:image" content="https://lantian.pub/apple-touch-icon.png"><meta content="After I set up a DN42 WHOIS server with Nginx , I configured my DN42 Looking Glass to use this service. As my Looking Glass is capable of running as a Telegram bot, fellow group members are looking up WHOIS information of IPs and domains with it. But soon we noticed a problem. A significant part of members have applied for ASNs and IP ranges on the public Internet after they're familiar enough with DN42, and they're peering at Internet Exchange Points. Therefore, they often need to lookup some public Internet IPs, ASNs, and domains, yet none of the Telegram bots in our group can do so. It would be quite helpful for us if there exists a WHOIS server that proxies lookups to relevant registries. Proxying is exactly what Nginx is good at. With some modifications to Nginx,..."><meta name="twitter:dnt" content="on"><meta itemprop="name" content="Lookup Any Public WHOIS with this nginx-based Server - Lan Tian @ Blog"><meta property="image" content="https://lantian.pub/apple-touch-icon.png"><meta content="After I set up a DN42 WHOIS server with Nginx , I configured my DN42 Looking Glass to use this service. As my Looking Glass is capable of running as a Telegram bot, fellow group members are looking up WHOIS information of IPs and domains with it. But soon we noticed a problem. A significant part of members have applied for ASNs and IP ranges on the public Internet after they're familiar enough with DN42, and they're peering at Internet Exchange Points. Therefore, they often need to lookup some public Internet IPs, ASNs, and domains, yet none of the Telegram bots in our group can do so. It would be quite helpful for us if there exists a WHOIS server that proxies lookups to relevant registries. Proxying is exactly what Nginx is good at. With some modifications to Nginx,..."><meta content="After I set up a DN42 WHOIS server with Nginx , I configured my DN42 Looking Glass to use this service. As my Looking Glass is capable of running as a Telegram bot, fellow group members are looking up WHOIS information of IPs and domains with it. But soon we noticed a problem. A significant part of members have applied for ASNs and IP ranges on the public Internet after they're familiar enough with DN42, and they're peering at Internet Exchange Points. Therefore, they often need to lookup some public Internet IPs, ASNs, and domains, yet none of the Telegram bots in our group can do so. It would be quite helpful for us if there exists a WHOIS server that proxies lookups to relevant registries. Proxying is exactly what Nginx is good at. With some modifications to Nginx,..."><link rel="me" href="https://mastodon.social/@lantian"></head> <body data-astro-cid-porej7z2=""> <div id="bg" data-astro-cid-j6vmxtef=""></div>   <div id="container" class="container" data-astro-cid-porej7z2=""> <nav class="lantian navbar navbar-expand-lg" data-astro-cid-wu5dj4rx=""> <div class="container-fluid" data-astro-cid-wu5dj4rx=""> <a class="navbar-brand" href="/en/" data-astro-cid-wu5dj4rx="">Lan Tian @ Blog</a> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#lantian-navbar" aria-controls="lantian-navbar" aria-expanded="false" aria-label="Toggle navigation" data-astro-cid-wu5dj4rx=""> <span class="navbar-toggler-icon" data-astro-cid-wu5dj4rx=""></span> </button> <div class="collapse navbar-collapse" id="lantian-navbar" data-astro-cid-wu5dj4rx=""> <ul class="navbar-nav" data-astro-cid-wu5dj4rx=""> <li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/archive/index.html" data-astro-cid-wu5dj4rx=""> Posts </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> Himawari </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> <li class="nav-item dropdown d-block d-lg-none" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="pages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-file" data-astro-cid-wu5dj4rx=""></i> Page  <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="pages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/archive/index.html" data-astro-cid-wu5dj4rx=""> Posts </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> Himawari </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> </ul> </li> </ul> <ul class="navbar-nav ms-auto" data-astro-cid-wu5dj4rx=""> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="languages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-language" data-astro-cid-wu5dj4rx=""></i> Language <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="languages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/article/modify-website/lookup-any-whois-with-nginx.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-cn" data-astro-cid-wu5dj4rx=""></span> Chinese Simplified / 简体中文 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item active" href="/en/article/modify-website/lookup-any-whois-with-nginx.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-us" data-astro-cid-wu5dj4rx=""></span> English </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">Not all pages have translations.</a> </li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">You may see 404 - this is normal.</a> </li> </ul> </li> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="color-scheme-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> Night Mode </a> <ul class="dropdown-menu" aria-labelledby="color-scheme-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-auto" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> Auto </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-light" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-sun" data-astro-cid-wu5dj4rx=""></i> Light</a> </li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-dark" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-moon" data-astro-cid-wu5dj4rx=""></i> Dark</a> </li> </ul> </li> </ul> </div> </div> </nav> <script type="module">const m="user-color-scheme",s="data-user-color-scheme",u=(e,t)=>{try{localStorage.setItem(e,t)}catch{}},i=e=>{try{return localStorage.getItem(e)}catch{return null}},c=e=>{const t={dark:!0,light:!0,auto:!0},o=e===null||!Object.keys(t).includes(e)?"auto":e;u(m,o);for(const l in t){const n=document.getElementById("color-scheme-"+l);n&&(l==o?n.classList.add("active"):n.classList.remove("active"))}o!="auto"?document.documentElement.setAttribute(s,o):document.documentElement.removeAttribute(s)};c(i(m));const r=document.getElementById("color-scheme-auto");r&&r.addEventListener("click",()=>c("auto"));const a=document.getElementById("color-scheme-light");a&&a.addEventListener("click",()=>c("light"));const d=document.getElementById("color-scheme-dark");d&&d.addEventListener("click",()=>c("dark"));</script>  <div class="d-flex" data-astro-cid-porej7z2=""> <div id="content" data-astro-cid-porej7z2="">  <article> <div class="d-flex"> <div class="post-info-wrap" data-astro-cid-dckccua4=""> <div class="post-info" data-astro-cid-dckccua4=""> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-clock"></span> <br> <small>07-18</small> </p> <div class="post-meta-value"> Published on<span class="badge badge-tag" data-astro-cid-dckccua4=""> 2021-07-18 01:52 </span>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-file-alt"></span> <br> <small>Website and Servers</small> </p> <div class="post-meta-value"> Category <a class="badge badge-tag" href="/en/category/modify-website" data-astro-cid-dckccua4=""> Website and Servers </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-tag"></span> <br> <small>2 tags</small> </p> <div class="post-meta-value"> Tags  <a class="badge badge-tag" href="/en/tag/nginx" data-astro-cid-dckccua4=""> nginx </a>  <a class="badge badge-tag" href="/en/tag/WHOIS" data-astro-cid-dckccua4=""> WHOIS </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-list"></span> <br> <small>ToC</small> </p> <div class="post-meta-value">  <ol data-astro-cid-nj3qel45=""> <li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#modifying-nginx-proxy-logic" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Modifying Nginx Proxy Logic</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#find-relevant-whois-server" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Find Relevant WHOIS Server</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#writing-nginx-rules-regex" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Writing Nginx Rules (Regex)</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#writing-nginx-rules-library" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Writing Nginx Rules (Library)</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#conclusion" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Conclusion</span> </a> </li> </ol>   </div> </div> </div> </div>  </div>  <div class="post-wrap">  <h1 class="post-title"> <a href="/en/article/modify-website/lookup-any-whois-with-nginx.lantian/" rel="bookmark" title="Lookup Any Public WHOIS with this nginx-based Server">Lookup Any Public WHOIS with this nginx-based Server</a> </h1> <div class="post-text">   <p>After I
<a href="/en/article/modify-website/serve-dn42-whois-with-nginx.lantian/">set up a DN42 WHOIS server with Nginx</a>,
I configured my DN42 Looking Glass to use this service. As my Looking Glass is
capable of running as a Telegram bot, fellow group members are looking up WHOIS
information of IPs and domains with it.</p>
<p>But soon we noticed a problem. A significant part of members have applied for
ASNs and IP ranges on the public Internet after they're familiar enough with
DN42, and they're peering at Internet Exchange Points. Therefore, they often
need to lookup some public Internet IPs, ASNs, and domains, yet none of the
Telegram bots in our group can do so. It would be quite helpful for us if there
exists a WHOIS server that proxies lookups to relevant registries.</p>
<p>Proxying is exactly what Nginx is good at. With some modifications to Nginx, so
it speaks the "one-request-one-response" protocol to its upstream, and the help
of Lua scripting in OpenResty, we can have a WHOIS proxy in a fairly short time.</p>
<h2 id="modifying-nginx-proxy-logic">Modifying Nginx Proxy Logic</h2>
<p>Nginx calls the function <code>ngx_http_proxy_create_request</code> to create the request
header, specifically the <code>GET /url HTTP/1.1</code> part, when it wants to send one to
the upstream.</p>
<p>The logic behind that function can be abstracted as:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">def</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> ngx_http_proxy_create_request</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">():</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Join the first line of request (GET xxx)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    header = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'GET'</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    header += url</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    if</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> http_version == </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'1.1'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        header += </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'HTTP/1.1'</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    else</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        header += </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'HTTP/1.0'</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Add other request headers</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    for</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> key, value </span><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">in</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> request_headers:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        header += key + </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">': '</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + value</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Send the request to upstream</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    send(header)</span></span></code></pre>
<p>Nginx itself already supports selecting HTTP version for proxy requests, but the
only options are HTTP/1.0 (the default) and HTTP/1.1. We simply need to add a
"one-request-one-response" mode (called <code>plain</code> mode), where it disables
everything but putting in the URL:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">def</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> ngx_http_proxy_create_request</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">():</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Join the first line of request (GET xxx)</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    if</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> http_version != </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'plain'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        header = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'GET'</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    header += url</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    if</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> http_version == </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'1.1'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        header += </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'HTTP/1.1'</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    else</span><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB"> if</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> http_version == </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'1.0'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        header += </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'HTTP/1.0'</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    else</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">        pass</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Add other request headers</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    if</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> http_version != </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">'plain'</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">        for</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> key, value </span><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">in</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> request_headers:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">            header += key + </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">': '</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + value</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Send the request to upstream</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    send(header)</span></span></code></pre>
<p>The actual patch is available at
<a href="https://gist.github.com/xddxdd/fed23d2fe5afa00bb609166886e3d206" rel="noopener noreferrer" target="_blank">https://gist.github.com/xddxdd/fed23d2fe5afa00bb609166886e3d206</a>. Specify
<code>proxy_http_version plain;</code> to send a <code>plain</code> request to the upstream WHOIS
server.</p>
<blockquote>
<p>A Gopher server can be proxied in the same way since Gopher is also a
one-request-one-response protocol.</p>
</blockquote>
<h2 id="find-relevant-whois-server">Find Relevant WHOIS Server</h2>
<p>The Internet is split and managed by many different organizations. For example,
ASNs and IPs are managed by
<a href="https://en.wikipedia.org/wiki/Regional_Internet_registry" rel="noopener noreferrer" target="_blank">APNIC, AfriNIC, RIPE, ARIN, and LACNIC, the 5 RIRs</a>,
whose regions are divided by continents. Domains are managed by even more
organizations, such as global top-level domains (<code>.com</code>, <code>.net</code>, etc.),
country/region domains (<code>.us</code>, <code>.cn</code>), and new gTLDs by corporations or
individual organizations (<code>.ovh</code>, <code>.google</code>, etc.). Needless to say, each
organization runs its own WHOIS server.</p>
<p>Good news is that the common <code>whois</code> command has lists builtin to find the
relevant WHOIS server, including
<a href="https://github.com/rfc1036/whois/blob/next/as_del_list" rel="noopener noreferrer" target="_blank">16 bit ASN list</a>,
<a href="https://github.com/rfc1036/whois/blob/next/as32_del_list" rel="noopener noreferrer" target="_blank">32 bit ASN list</a>,
<a href="https://github.com/rfc1036/whois/blob/next/ip_del_list" rel="noopener noreferrer" target="_blank">IPv4 list</a>,
<a href="https://github.com/rfc1036/whois/blob/next/ip6_del_list" rel="noopener noreferrer" target="_blank">IPv6 list</a>,
<a href="https://github.com/rfc1036/whois/blob/next/tld_serv_list" rel="noopener noreferrer" target="_blank">Traditional TLD list</a>,
<a href="https://github.com/rfc1036/whois/blob/next/new_gtlds_list" rel="noopener noreferrer" target="_blank">New gTLD list</a> and
<a href="https://github.com/rfc1036/whois/blob/next/nic_handles_list" rel="noopener noreferrer" target="_blank">NIC Handle (Registration info at RIRs) list</a>,
and we can simply take them for our own use. All the information is collected
from the website of
<a href="https://en.wikipedia.org/wiki/Internet_Assigned_Numbers_Authority" rel="noopener noreferrer" target="_blank">IANA (Internet Assigned Numbers Authority)</a>.</p>
<h2 id="writing-nginx-rules-regex">Writing Nginx Rules (Regex)</h2>
<p>With the lookup information available, we can write nginx matching rules for
them. Thanks to Nginx's regular expressions, we can tell different kinds of
lookups apart and lookup corresponding lists.</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># ASN Lookup</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">location</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ~* </span><span style="--shiki-dark:#D16969;--shiki-light:#811F3F">"^/[Aa][Ss]([0-9]+)$" </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    set </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">asn</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> $</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    set_by_lua_block</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> $</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">backend</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        local</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> asn = tonumber(ngx.var.asn);</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        if</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> asn >= </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">248</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> and asn &#x3C;= </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">251</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> then return </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"whois.ripe.net"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> end</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        if</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> asn >= </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">306</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> and asn &#x3C;= </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">371</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> then return </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"whois.nic.mil"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> end</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        -- </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">Skipped</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> over a lot of rules</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        -- </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">Fallback</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> to ARIN by default</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">        return</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "whois.arin.net"</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    proxy_pass http://$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">backend</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:43/AS$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    proxy_http_version </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">plain;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># NIC Handle lookup, take ARIN and RIPE for example</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">location</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ~* </span><span style="--shiki-dark:#D16969;--shiki-light:#811F3F">"^/(.*)(-[Aa][Rr][Ii][Nn])$" </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    set_by_lua</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> $</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">query_upper</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "return ngx.var.uri:upper():sub(2)"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    proxy_pass </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">http://whois.arin.net:43/$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">query_upper</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    proxy_http_version </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">plain;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">location</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ~* </span><span style="--shiki-dark:#D16969;--shiki-light:#811F3F">"^/(.*)(-[Rr][Ii][Pp][Ee])$" </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    set_by_lua</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> $</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">query_upper</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "return ngx.var.uri:upper():sub(2)"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    proxy_pass </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">http://whois.ripe.net:43/$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">query_upper</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    proxy_http_version </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">plain;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Domain lookup, take .com for example</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">location</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ~* </span><span style="--shiki-dark:#D16969;--shiki-light:#811F3F">"^/(.*)(\.[Cc][Oo][Mm])$" </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    set_by_lua</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> $</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">query_lower</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "return ngx.var.uri:lower():sub(2)"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    proxy_pass </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">http://whois.verisign-grs.com:43/$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">query_lower</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    proxy_http_version </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">plain;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># IP Lookup...?</span></span></code></pre>
<p>With the rules configured and
<a href="/en/article/modify-website/serve-dn42-whois-with-nginx.lantian/">nginx listening on port 43 in plain mode</a>,
we can lookup ASNs, NIC Handles and domains.</p>
<p>But one important piece is missing: IP lookups. Lua language that came with
OpenResty doesn't have an IP parsing function built-in, nor does it provide any
functionality to tell if an IP is within a range. That means we need to craft
our own code, which is both troublesome and error-prone. In addition, with one
regular expression for each type of domain and NIC Handle, the memory
consumption of each nginx worker rise from 30MB to a whopping 100MB, which made
the life of tiny VPSes even harder.</p>
<p>But at least Lua is good at calling functions in shared libraries (<code>.so</code>
libraries on Linux), and we can rewrite the logic in C.</p>
<h2 id="writing-nginx-rules-library">Writing Nginx Rules (Library)</h2>
<p>And here, I created a simple shared library, which provides a few lookup
functions to convert IP, ASN, domain, or NIC Handle to their WHOIS server
address.</p>
<p>The library uses libc functions to parse IPs, use
<a href="https://github.com/rmind/liblpm" rel="noopener noreferrer" target="_blank">a third party LPM (Longest Prefix Matching) library called liblpm</a>
to lookup WHOIS server efficiently, and simply scan through lookup list
sequentially for ASN, domain, and NIC Handle since we don't need THAT much
performance anyway. The library only uses a tiny amount of memory, much better
than a bunch of regular expressions in Nginx.</p>
<p>The library is available at <a href="https://github.com/xddxdd/libltnginx" rel="noopener noreferrer" target="_blank">https://github.com/xddxdd/libltnginx</a>, providing 4
lookup functions:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">char</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">* </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">whois_ip_lookup</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">char</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">* </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">cidr</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">);</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">const</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> char</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">* </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">whois_nic_handle_lookup</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">char</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">* </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">);</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">const</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> char</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">* </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">whois_domain_lookup</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">char</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">* </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">);</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">const</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> char</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">* </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">whois_asn_lookup</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">uint32_t</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> asn</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">);</span></span></code></pre>
<p>They can be easily called from Lua:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">local</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> ffi</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">       = </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">require</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "ffi"</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">local</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> ltnginx</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">   = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">ffi</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">load</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"path/to/libltnginx.so"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">ffi</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">cdef</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">[[</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    char</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">*</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> whois_ip_lookup</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000FF">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">char</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">*</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> cidr</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000FF">);</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    const</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> char</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">*</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> whois_nic_handle_lookup</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000FF">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">char</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">*</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000FF">);</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    const</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> char</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">*</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> whois_domain_lookup</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000FF">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">char</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">*</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000FF">);</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    const</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> char</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">*</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> whois_asn_lookup</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000FF">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">uint32_t</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> asn</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000FF">);</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">]]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">local</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> lantian_nginx</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">function</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> lantian_nginx</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">whois_ip_lookup</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">target</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    local</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> c_str</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">ffi</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">new</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"char[?]"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, #</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">target</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    ffi</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">copy</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">c_str</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">target</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    return</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> ffi</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">string</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">ltnginx</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">whois_ip_lookup</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">c_str</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">))</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">function</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> lantian_nginx</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">whois_nic_handle_lookup</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">target</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    local</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> c_str</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">ffi</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">new</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"char[?]"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, #</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">target</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    ffi</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">copy</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">c_str</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">target</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    return</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> ffi</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">string</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">ltnginx</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">whois_nic_handle_lookup</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">c_str</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">))</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">function</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> lantian_nginx</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">whois_domain_lookup</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">target</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    local</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> c_str</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">ffi</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">new</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"char[?]"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, #</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">target</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    ffi</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">copy</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">c_str</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">target</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    return</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> ffi</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">string</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">ltnginx</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">whois_domain_lookup</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">c_str</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">))</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">function</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> lantian_nginx</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">whois_asn_lookup</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">target</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    return</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> ffi</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">string</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">ltnginx</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">whois_asn_lookup</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">tonumber</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">target</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)))</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">return</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> lantian_nginx</span></span></code></pre>
<p>And the configuration of nginx can be greatly simplified:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">server</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    listen </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">43</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> plain;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    listen </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[::]:43 plain;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    location</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> / {</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([0-9]+)$"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> /AS$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">1</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([0-9]+)\.([0-9]+)\.([0-9]+)\.([0-9]+)$"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> /$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">3</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">4</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">/32 </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([0-9a-fA-F:]+)$"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> /$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">/128 </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">        return</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 200</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "% Lan Tian Nginx-based WHOIS Server</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\n</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">% GET $</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">request_uri</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">:</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\n</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">% 404 Not Found</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\n</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    location</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ~* </span><span style="--shiki-dark:#D16969;--shiki-light:#811F3F">"^/[Aa][Ss]([0-9]+)$" </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        set </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">asn</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> $</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        set_by_lua_block</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> $</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">backend</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">            local</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> lantian_nginx = require </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"lantian_nginx"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">            return</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> lantian_nginx.whois_asn_lookup(ngx.var.asn);</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        proxy_pass </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">http://$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">backend</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:43/AS$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        proxy_http_version </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">plain;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    location</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ~* </span><span style="--shiki-dark:#D16969;--shiki-light:#811F3F">"^/([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)/([0-9]+)$" </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        set </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">ip</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> $</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        set_by_lua_block</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> $</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">backend</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">            local</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> lantian_nginx = require </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"lantian_nginx"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">            return</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> lantian_nginx.whois_ip_lookup(ngx.var.ip);</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        proxy_pass </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">http://$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">backend</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:43/$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">ip</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        proxy_http_version </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">plain;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    location</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ~* </span><span style="--shiki-dark:#D16969;--shiki-light:#811F3F">"^/([0-9a-fA-F:]+)/([0-9]+)$" </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        set </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">ip</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> $</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        set_by_lua_block</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> $</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">backend</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">            local</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> lantian_nginx = require </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"lantian_nginx"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">            return</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> lantian_nginx.whois_ip_lookup(ngx.var.ip);</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        proxy_pass </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">http://$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">backend</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:43/$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">ip</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        proxy_http_version </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">plain;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    location</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ~* </span><span style="--shiki-dark:#D16969;--shiki-light:#811F3F">"^/(.*)-([a-zA-Z0-9]+)$" </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        set_by_lua</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> $</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">query_upper</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "return ngx.var.uri:upper():sub(2)"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        set_by_lua_block</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> $</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">backend</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">            local</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> lantian_nginx = require </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"lantian_nginx"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">            return</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> lantian_nginx.whois_nic_handle_lookup(ngx.var.query_upper);</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        proxy_pass </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">http://$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">backend</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:43/$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">query_upper</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        proxy_http_version </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">plain;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    location</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ~* </span><span style="--shiki-dark:#D16969;--shiki-light:#811F3F">"^/(.*)\.([a-zA-Z0-9]+)$" </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        set_by_lua</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> $</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">query_lower</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "return ngx.var.uri:lower():sub(2)"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        set_by_lua_block</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> $</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">backend</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">            local</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> lantian_nginx = require </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"lantian_nginx"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">            return</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> lantian_nginx.whois_domain_lookup(ngx.var.query_lower);</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        proxy_pass </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">http://$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">backend</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:43/$</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">query_lower</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        proxy_http_version </span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">plain;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    }</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>Without all the regular expressions and the small memory requirement for the
library, the memory usage of a worker went back to the normal value of 30MB.</p>
<h2 id="conclusion">Conclusion</h2>
<p>With simple modifications, Nginx can be converted to a WHOIS proxy that allows
looking up literally anything.</p>
<p>The WHOIS proxy service is running on this site; run
<code>whois -h lantian.pub google.com</code> to try it out.</p>  </div>  <div class="clearfix" id="post-navi" data-astro-cid-gfbmwgei=""> <div class="float-end text-end" data-astro-cid-gfbmwgei=""> <a href="/en/article/modify-website/dn42-experimental-network-2020.lantian/" title="DN42 Experimental Network: Intro and Registration (Updated 2022-12)" data-astro-cid-gfbmwgei=""> DN42 Experimental Network: Intro and Registration (Updated 2022-12) </a> <br data-astro-cid-gfbmwgei=""> Next post »
</div> <div class="float-start text-start position-absolute" data-astro-cid-gfbmwgei="">
« Previous post <br data-astro-cid-gfbmwgei=""> <a href="/en/article/modify-website/replace-jenkins-with-drone-ci.lantian/" title="Replace Jenkins with Drone CI" data-astro-cid-gfbmwgei=""> Replace Jenkins with Drone CI </a> </div> </div>  <div id="waline" data-waline-language="en-US" data-waline-path="/en/article/modify-website/lookup-any-whois-with-nginx.lantian"></div> <script type="module" src="/assets/WalineComment.astro_astro_type_script_index_0_lang.Dqib3X1E.js"></script>  </div> </div> </article>  </div> <aside class="d-none d-xl-block"> <section class="widget"> <h3>Latest posts</h3> <ul class="list-unstyled"> <li> 07-20  <a href="/en/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/">Legal LTE Network at Home with Open5GS</a> </li><li> 06-27  <a href="/en/article/modify-computer/sidestore-without-stosvpn-across-lan.lantian/">Using SideStore without StosVPN across your LAN</a> </li><li> 05-19  <a href="/en/article/modify-computer/nix-logarithmetic-math-library-from-zero.lantian/">Nix Logarithmic Math Library from Ground Zero</a> </li><li> 04-06  <a href="/en/article/modify-computer/legal-lte-network-at-home-for-100-bucks.lantian/">Legal LTE Network at Home for $100</a> </li><li> 02-10  <a href="/en/article/modify-computer/build-custom-android-kernel-with-nix.lantian/">Building Custom Android Kernel with Nix</a> </li><li> 04-20  <a href="/en/article/modify-website/migrate-blog-to-astro-js.lantian/">Migrating My Blog to Astro.js</a> </li><li> 12-16  <a href="/en/article/modify-computer/nixos-low-ram-vps.lantian/">NixOS Series 5: Creating Disk Image for Low RAM VPS</a> </li><li> 09-20  <a href="/en/article/modify-computer/nix-trigonometric-math-library-from-zero.lantian/">Nix Trigonometric Math Library from Ground Zero</a> </li><li> 05-29  <a href="/en/article/random-notes/pipewire-sigkill-fix.lantian/">Preventing Pipewire from being SIGKILLed</a> </li><li> 05-12  <a href="/en/article/modify-website/how-to-kill-the-dn42-network.lantian/">How to Kill the DN42 Network (Updated 2023-05-12)</a> </li><li> 05-08  <a href="/en/article/modify-computer/laptop-muxed-nvidia-passthrough.lantian/">NVIDIA GPU Passthrough on an Optimus MUXed Laptop (Updated 2023-05)</a> </li><li> 04-17  <a href="/en/article/random-notes/fix-china-telecom-roaming-no-4g-on-aosp-rom.lantian/">Fix China Telecom 4G Roaming on AOSP ROM by Changing APN</a> </li><li> 03-26  <a href="/en/article/random-notes/old-hp-workstation-as-all-in-one.lantian/">Notes on Setting Up NAS+Router on Old HP Workstation</a> </li><li> 01-14  <a href="/en/article/modify-computer/nixos-impermanence.lantian/">NixOS Series 4: &quot;Stateless&quot; Operating System</a> </li><li> 06-21  <a href="/en/article/modify-computer/nixos-packaging.lantian/">NixOS Series 3: Software Packaging 101</a> </li> </ul> </section> <section class="widget"> <h3>Latest comments</h3> <ul class="list-unstyled" id="recent-comments">  <li><a href="#">Loading...</a></li>  </ul> </section> <script type="module">const i=window.location.hostname=="localhost"?"https://comments.lantian.pub":window.location.origin;fetch(`${i}/api/comment?type=recent&count=10`).then(t=>{if(t.status!==200)throw new Error(`Server returned bad HTTP status ${t.status}`);return t.json()}).then(t=>{const e=document.getElementById("recent-comments");e&&(e.innerHTML=t.data.map(n=>{const o=n.comment.replace(/(<([^>]+)>)/gi,"");return"<li>"+n.nick+' <a href="'+n.url+'">'+o+"</a></li>"}).join(""))});</script> <section class="widget"> <h3>Others</h3> <ul class="list-unstyled">  <li> <i class="fas fa-fw fa-rss"></i>  <a href="/rss2.xml" target="_blank">RSS Feed</a> |  <a href="/feed.xml" target="_blank">Atom</a> |  <a href="/feed.json" target="_blank">JSON</a> </li> <li> <i class="fas fa-fw fa-globe"></i>  <a href="https://stats.uptimerobot.com/BLK6VsRkR" target="_blank"> Sever Status </a> </li> <li> <i class="fas fa-fw fa-sitemap"></i>  <a href="https://lg.lantian.pub" target="_blank">DN42 Looking Glass</a> </li> <li> <i class="fas fa-fw fa-link"></i>  <a href="gopher://lantian.pub" target="_blank">Access with Gopher protocol</a> </li>  </ul> </section> <section class="widget"> <h3>Links</h3> <ul class="list-unstyled"> <li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://0x7f.cc"> 0x7f Blog 🐑 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="http://foreverblog.cn"> 10 Year&#39;s Promise (Forever Blog) </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://alanyhq.com"> Alanyhq </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.baoshuo.ren/?utm_source=friends"> Baoshuo&#39;s Blog </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.cas7.moe"> Blog of Moecast </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://jerryxiao.cc"> JerryXiao </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://sangsir.com"> SangSir </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://snli.org"> Shucheng Li </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://yuetau.net"> YuetAu&#39;s Spot </a> </li> </ul> </section> </aside> </div> <footer class="lantian clearfix" data-astro-cid-w3csb3e3="">  <div id="copyright" class="float-end text-end" data-astro-cid-w3csb3e3=""> <i class="fas fa-copyright" data-astro-cid-w3csb3e3=""></i> 2012-2025 Lan Tian @ Blog<br data-astro-cid-w3csb3e3=""> <small data-astro-cid-w3csb3e3=""> Powered by Astro v5.15.1 @ 2025-10-25 23:46:38 </small> </div> <script type="module">function v(c,o,r){const h=/^localhost$|^127(?:\.[0-9]+){0,2}\.[0-9]+$|^(?:0*:)*?:?0*1$/.test(location.hostname)||location.protocol==="file:";if(!o.trackLocalhost&&h)return console.warn("[Plausible] Ignoring event because website is running locally");try{if(window.localStorage.plausible_ignore==="true")return console.warn('[Plausible] Ignoring event because "plausible_ignore" is set to "true" in localStorage')}catch{}const p={n:c,u:o.url,d:o.domain,r:o.referrer,w:o.deviceWidth,h:o.hashMode?1:0,p:r&&r.props?JSON.stringify(r.props):void 0},s=new XMLHttpRequest;s.open("POST",`${o.apiHost}/api/event`,!0),s.setRequestHeader("Content-Type","text/plain"),s.send(JSON.stringify(p)),s.onreadystatechange=()=>{s.readyState===4&&r&&r.callback&&r.callback()}}function b(c){const o=()=>({hashMode:!1,trackLocalhost:!1,url:location.href,domain:location.hostname,referrer:document.referrer||null,deviceWidth:window.innerWidth,apiHost:"https://plausible.io",...c}),r=(t,n,i)=>{v(t,{...o(),...i},n)},h=(t,n)=>{r("pageview",n,t)};return{trackEvent:r,trackPageview:h,enableAutoPageviews:()=>{const t=()=>h(),n=history.pushState;return n&&(history.pushState=function(i,l,u){n.apply(this,[i,l,u]),t()},addEventListener("popstate",t)),c&&c.hashMode&&addEventListener("hashchange",t),h(),function(){n&&(history.pushState=n,removeEventListener("popstate",t)),c&&c.hashMode&&removeEventListener("hashchange",t)}},enableAutoOutboundTracking:(t=document,n={subtree:!0,childList:!0,attributes:!0,attributeFilter:["href"]})=>{function i(e){r("Outbound Link: Click",{props:{url:this.href}}),typeof process<"u"&&process,setTimeout(()=>{location.href=this.href},150),e.preventDefault()}const l=new Set;function u(e){e instanceof HTMLAnchorElement?e.host!==location.host&&(e.addEventListener("click",i),l.add(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(u)}function f(e){e instanceof HTMLAnchorElement?(e.removeEventListener("click",i),l.delete(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(f)}const d=new MutationObserver(e=>{e.forEach(a=>{a.type==="attributes"?(f(a.target),u(a.target)):a.type==="childList"&&(a.addedNodes.forEach(u),a.removedNodes.forEach(f))})});return t.querySelectorAll("a").forEach(u),d.observe(t,n),function(){l.forEach(a=>{a.removeEventListener("click",i)}),l.clear(),d.disconnect()}}}}const g=b({domain:"lantian.pub",trackLocalhost:!0,apiHost:""});g.trackPageview();</script> </footer>  </div>  </body> </html>