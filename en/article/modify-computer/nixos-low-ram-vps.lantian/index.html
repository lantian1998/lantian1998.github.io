<!DOCTYPE html><html lang="en-US" itemscope="" itemtype="https://schema.org/Article" data-astro-cid-porej7z2=""> <head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>NixOS Series 5: Creating Disk Image for Low RAM VPS - Lan Tian @ Blog</title><script>
  ;(() => {
    try {
      const mode = localStorage.getItem('user-color-scheme')
      if (mode == 'dark' || mode == 'light') {
        document.documentElement.setAttribute('data-user-color-scheme', mode)
      }
    } catch {
      // Ignore errors
    }
  })()
  ;(() => {
    window.lantianImageFallback = (img, src) => {
      img.onerror = null
      img.srcset = src
      img.src = src
      if (img.parentNode.nodeName.toLowerCase() === 'picture') {
        const picture = img.parentNode
        picture.innerHTML = ''
        picture.appendChild(img)
      }
    }
  })()
</script><link rel="stylesheet" href="/assets/index.CN3CN3hr.css"><style>.post-image-wrap[data-astro-cid-potdituc]{margin:0 -5px}.post-image-wrap[data-astro-cid-potdituc] img[data-astro-cid-potdituc]{height:150px;-o-object-fit:cover;object-fit:cover;-o-object-position:center;object-position:center}@media(min-width:768px){.post-image-wrap[data-astro-cid-potdituc]{padding:5px;float:right}.post-image-wrap[data-astro-cid-potdituc] img[data-astro-cid-potdituc]{max-width:200px}}@media(max-width:767.98px){.post-image-wrap[data-astro-cid-potdituc]{text-align:center}.post-image-wrap[data-astro-cid-potdituc] img[data-astro-cid-potdituc]{max-width:100%}}#post-navi[data-astro-cid-gfbmwgei]{padding:5px;border-top:1px solid var(--lt-border-weak);border-bottom:1px solid var(--lt-border-weak)}
</style><link rel="stylesheet" href="/assets/index.DC6W6NZY.css"><script type="module" src="/assets/PageLayout.astro_astro_type_script_index_0_lang.Co1i7321.js"></script><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Referrer-Policy" content="no-referrer, strict-origin-when-cross-origin"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="imagemode" content="force"><meta name="nightmode" content="disable"><meta name="wap-font-scale" content="no"><meta name="title" content="NixOS Series 5: Creating Disk Image for Low RAM VPS - Lan Tian @ Blog"><meta name="keywords" content=""><meta name="author" content="Lan Tian"><link rel="canonical" href="https://lantian.pub/en/article/modify-computer/nixos-low-ram-vps.lantian/"><link rel="alternate" type="application/rss+xml" title="Lan Tian @ Blog" href="https://lantian.pub/rss2.xml"><link rel="alternate" type="application/atom+xml" title="Lan Tian @ Blog" href="https://lantian.pub/feed.xml"><link rel="alternate" href="https://lantian.pub/article/modify-computer/nixos-low-ram-vps.lantian/" hreflang="zh"><link rel="alternate" href="https://lantian.pub/en/article/modify-computer/nixos-low-ram-vps.lantian/" hreflang="en"><meta name="copyright" content="Copyright 2012-2026 Lan Tian @ Blog"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#03a9f4"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#212121"><meta name="application-name" content="Lan Tian @ Blog"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="apple-touch-icon" sizes="1024x1024" href="/apple-touch-icon-1024x1024.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#03a9f4"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Lan Tian @ Blog"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-640x1136.png"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1136x640.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-750x1334.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1334x750.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1125x2436.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2436x1125.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1170x2532.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2532x1170.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1179x2556.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2556x1179.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-828x1792.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1792x828.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2688.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2688x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2208.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2208x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1284x2778.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2778x1284.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1290x2796.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2796x1290.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1488x2266.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2266x1488.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1536x2048.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2048x1536.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1620x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1620.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1640x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1640.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2388.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2388x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2224.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2224x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-2048x2732.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2732x2048.png"><meta name="msapplication-TileColor" content="#bbdefb"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"><meta property="og:url" content="https://lantian.pub/en/article/modify-computer/nixos-low-ram-vps.lantian/"><meta property="og:type" content="website"><meta property="og:title" content="NixOS Series 5: Creating Disk Image for Low RAM VPS - Lan Tian @ Blog"><meta property="og:image" content="https://lantian.pub/usr/uploads/202110/nixos-social-preview.png"><meta content="Black friday has passed. Some readers, I believe, have perchased some VPSes or cloud servers on sale, and want to install NixOS on them. However, since NixOS is nowhere as famous as popular Linux distros, such as CentOS, Debian and Ubuntu, almost no VPS provider will offer a disk image preinstalled with NixOS. This lefts the user one of the following options to perform the installation manually: Mounting NixOS&#38;#39;s installer ISO, and then partition and install manually. Since you can operate on the VPS&#38;#39;s hard drive as you wish in NixOS&#38;#39;s installation media, repartitioning the drive and specifying file system types, this approach offers the maximum freedom. However, before you can use this approach, your provider must satisfy one of the three prerequisites:..."><meta property="og:site_name" content="Lan Tian @ Blog"><meta property="og:locale" content="en"><meta name="twitter:card" content="summary"><meta name="twitter:url" content="https://lantian.pub/en/article/modify-computer/nixos-low-ram-vps.lantian/"><meta name="twitter:title" content="NixOS Series 5: Creating Disk Image for Low RAM VPS - Lan Tian @ Blog"><meta property="twitter:image" content="https://lantian.pub/usr/uploads/202110/nixos-social-preview.png"><meta content="Black friday has passed. Some readers, I believe, have perchased some VPSes or cloud servers on sale, and want to install NixOS on them. However, since NixOS is nowhere as famous as popular Linux distros, such as CentOS, Debian and Ubuntu, almost no VPS provider will offer a disk image preinstalled with NixOS. This lefts the user one of the following options to perform the installation manually: Mounting NixOS&#38;#39;s installer ISO, and then partition and install manually. Since you can operate on the VPS&#38;#39;s hard drive as you wish in NixOS&#38;#39;s installation media, repartitioning the drive and specifying file system types, this approach offers the maximum freedom. However, before you can use this approach, your provider must satisfy one of the three prerequisites:..."><meta name="twitter:dnt" content="on"><meta itemprop="name" content="NixOS Series 5: Creating Disk Image for Low RAM VPS - Lan Tian @ Blog"><meta property="image" content="https://lantian.pub/usr/uploads/202110/nixos-social-preview.png"><meta content="Black friday has passed. Some readers, I believe, have perchased some VPSes or cloud servers on sale, and want to install NixOS on them. However, since NixOS is nowhere as famous as popular Linux distros, such as CentOS, Debian and Ubuntu, almost no VPS provider will offer a disk image preinstalled with NixOS. This lefts the user one of the following options to perform the installation manually: Mounting NixOS&#38;#39;s installer ISO, and then partition and install manually. Since you can operate on the VPS&#38;#39;s hard drive as you wish in NixOS&#38;#39;s installation media, repartitioning the drive and specifying file system types, this approach offers the maximum freedom. However, before you can use this approach, your provider must satisfy one of the three prerequisites:..."><meta content="Black friday has passed. Some readers, I believe, have perchased some VPSes or cloud servers on sale, and want to install NixOS on them. However, since NixOS is nowhere as famous as popular Linux distros, such as CentOS, Debian and Ubuntu, almost no VPS provider will offer a disk image preinstalled with NixOS. This lefts the user one of the following options to perform the installation manually: Mounting NixOS&#38;#39;s installer ISO, and then partition and install manually. Since you can operate on the VPS&#38;#39;s hard drive as you wish in NixOS&#38;#39;s installation media, repartitioning the drive and specifying file system types, this approach offers the maximum freedom. However, before you can use this approach, your provider must satisfy one of the three prerequisites:..."><link rel="me" href="https://mastodon.social/@lantian"></head> <body data-astro-cid-porej7z2=""> <div id="bg" data-astro-cid-j6vmxtef=""></div>   <div id="container" class="container" data-astro-cid-porej7z2=""> <nav class="lantian navbar navbar-expand-lg" data-astro-cid-wu5dj4rx=""> <div class="container-fluid" data-astro-cid-wu5dj4rx=""> <a class="navbar-brand" href="/en/" data-astro-cid-wu5dj4rx="">Lan Tian @ Blog</a> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#lantian-navbar" aria-controls="lantian-navbar" aria-expanded="false" aria-label="Toggle navigation" data-astro-cid-wu5dj4rx=""> <span class="navbar-toggler-icon" data-astro-cid-wu5dj4rx=""></span> </button> <div class="collapse navbar-collapse" id="lantian-navbar" data-astro-cid-wu5dj4rx=""> <ul class="navbar-nav" data-astro-cid-wu5dj4rx=""> <li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/archive/index.html" data-astro-cid-wu5dj4rx=""> Posts </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> Himawari </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> <li class="nav-item dropdown d-block d-lg-none" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="pages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-file" data-astro-cid-wu5dj4rx=""></i> Page  <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="pages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/archive/index.html" data-astro-cid-wu5dj4rx=""> Posts </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> Himawari </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> </ul> </li> </ul> <ul class="navbar-nav ms-auto" data-astro-cid-wu5dj4rx=""> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="languages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-language" data-astro-cid-wu5dj4rx=""></i> Language <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="languages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/article/modify-computer/nixos-low-ram-vps.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-cn" data-astro-cid-wu5dj4rx=""></span> Chinese Simplified / 简体中文 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item active" href="/en/article/modify-computer/nixos-low-ram-vps.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-us" data-astro-cid-wu5dj4rx=""></span> English </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">Not all pages have translations.</a> </li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">You may see 404 - this is normal.</a> </li> </ul> </li> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="color-scheme-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> Night Mode </a> <ul class="dropdown-menu" aria-labelledby="color-scheme-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-auto" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> Auto </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-light" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-sun" data-astro-cid-wu5dj4rx=""></i> Light</a> </li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-dark" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-moon" data-astro-cid-wu5dj4rx=""></i> Dark</a> </li> </ul> </li> </ul> </div> </div> </nav> <script type="module">const m="user-color-scheme",s="data-user-color-scheme",u=(e,t)=>{try{localStorage.setItem(e,t)}catch{}},i=e=>{try{return localStorage.getItem(e)}catch{return null}},c=e=>{const t={dark:!0,light:!0,auto:!0},o=e===null||!Object.keys(t).includes(e)?"auto":e;u(m,o);for(const l in t){const n=document.getElementById("color-scheme-"+l);n&&(l==o?n.classList.add("active"):n.classList.remove("active"))}o!="auto"?document.documentElement.setAttribute(s,o):document.documentElement.removeAttribute(s)};c(i(m));const r=document.getElementById("color-scheme-auto");r&&r.addEventListener("click",()=>c("auto"));const a=document.getElementById("color-scheme-light");a&&a.addEventListener("click",()=>c("light"));const d=document.getElementById("color-scheme-dark");d&&d.addEventListener("click",()=>c("dark"));</script>  <div class="d-flex" data-astro-cid-porej7z2=""> <div id="content" data-astro-cid-porej7z2="">  <article> <div class="d-flex"> <div class="post-info-wrap" data-astro-cid-dckccua4=""> <div class="post-info" data-astro-cid-dckccua4=""> <div class="post-meta-wrap" data-astro-cid-tde7heiu=""> <div class="post-meta" data-astro-cid-tde7heiu=""> <p data-astro-cid-tde7heiu=""> <span class="fas fa-clock" data-astro-cid-tde7heiu=""></span> <br data-astro-cid-tde7heiu=""> <small data-astro-cid-tde7heiu="">12-16</small> </p> <div class="post-meta-value" data-astro-cid-tde7heiu=""> Published on<span class="badge badge-tag" data-astro-cid-dckccua4=""> 2023-12-16 02:30 </span>  </div> </div> </div>   <div class="post-meta-wrap" data-astro-cid-tde7heiu=""> <div class="post-meta" data-astro-cid-tde7heiu=""> <p data-astro-cid-tde7heiu=""> <span class="fas fa-file-alt" data-astro-cid-tde7heiu=""></span> <br data-astro-cid-tde7heiu=""> <small data-astro-cid-tde7heiu="">Computers and Clients</small> </p> <div class="post-meta-value" data-astro-cid-tde7heiu=""> Category <a class="badge badge-tag" href="/en/category/modify-computer" data-astro-cid-dckccua4=""> Computers and Clients </a>  </div> </div> </div>   <div class="post-meta-wrap" data-astro-cid-tde7heiu=""> <div class="post-meta" data-astro-cid-tde7heiu=""> <p data-astro-cid-tde7heiu=""> <span class="fas fa-tag" data-astro-cid-tde7heiu=""></span> <br data-astro-cid-tde7heiu=""> <small data-astro-cid-tde7heiu="">1 tags</small> </p> <div class="post-meta-value" data-astro-cid-tde7heiu=""> Tags  <a class="badge badge-tag" href="/en/tag/NixOS" data-astro-cid-dckccua4=""> NixOS </a>  </div> </div> </div>   <div class="post-meta-wrap" data-astro-cid-tde7heiu=""> <div class="post-meta" data-astro-cid-tde7heiu=""> <p data-astro-cid-tde7heiu=""> <span class="fas fa-list" data-astro-cid-tde7heiu=""></span> <br data-astro-cid-tde7heiu=""> <small data-astro-cid-tde7heiu="">ToC</small> </p> <div class="post-meta-value" data-astro-cid-tde7heiu="">  <ol data-astro-cid-nj3qel45=""> <li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#prepare-nixos-configuration" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Prepare NixOS Configuration</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#partitioning-disk-image-with-impermanence" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Partitioning Disk Image (with Impermanence)</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#partitioning-disk-image-regular-install" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Partitioning Disk Image (Regular Install)</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#generate-disk-image" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Generate Disk Image</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#upload-disk-image-to-vps" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Upload Disk Image to VPS</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#expand-partition-size" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Expand Partition Size</span> </a> </li> </ol>   </div> </div> </div>   </div>  </div>  <div class="post-wrap"> <div class="post-image-wrap" data-astro-cid-potdituc=""><picture data-astro-cid-potdituc=""><source srcset="/usr/uploads/202110/nixos-social-preview.png.thumb.png.webp" type="image/webp" data-astro-cid-potdituc=""><source srcset="/usr/uploads/202110/nixos-social-preview.png.thumb.png.avif" type="image/avif" data-astro-cid-potdituc=""><source srcset="/usr/uploads/202110/nixos-social-preview.png.thumb.png.jxl" type="image/jxl" data-astro-cid-potdituc=""><img src="/usr/uploads/202110/nixos-social-preview.png.thumb.png" alt="Illustration for NixOS Series 5: Creating Disk Image for Low RAM VPS" height="150" onerror="window.lantianImageFallback(this, '/usr/uploads/202110/nixos-social-preview.png.thumb.png')" data-astro-cid-potdituc=""></picture></div> <h1 class="post-title"> <a href="/en/article/modify-computer/nixos-low-ram-vps.lantian/" rel="bookmark" title="NixOS Series 5: Creating Disk Image for Low RAM VPS">NixOS Series 5: Creating Disk Image for Low RAM VPS</a> </h1> <div class="post-text">  <blockquote><p>List of NixOS series posts:</p><ul><li><a href="/en/article/modify-website/nixos-why.lantian/">NixOS Series 1: Why I fell in love</a> </li><li><a href="/en/article/modify-website/nixos-initial-config-flake-deploy.lantian/">NixOS Series 2: Basic Config, Nix Flake &amp; Batch Deploy</a> </li><li><a href="/en/article/modify-computer/nixos-packaging.lantian/">NixOS Series 3: Software Packaging 101</a> </li><li><a href="/en/article/modify-computer/nixos-impermanence.lantian/">NixOS Series 4: &quot;Stateless&quot; Operating System</a> </li><li><a href="/en/article/modify-computer/nixos-low-ram-vps.lantian/">NixOS Series 5: Creating Disk Image for Low RAM VPS</a> (current post)</li></ul></blockquote> <p>Black friday has passed. Some readers, I believe, have perchased some VPSes or
cloud servers on sale, and want to install NixOS on them. However, since NixOS
is nowhere as famous as popular Linux distros, such as CentOS, Debian and
Ubuntu, almost no VPS provider will offer a disk image preinstalled with NixOS.
This lefts the user one of the following options to perform the installation
manually:</p>
<ul>
<li>Mounting NixOS&#39;s installer ISO, and then partition and install manually.</li>
</ul>
<p>Since you can operate on the VPS&#39;s hard drive as you wish in NixOS&#39;s
installation media, repartitioning the drive and specifying file system types,
this approach offers the maximum freedom. However, before you can use this
approach, your provider must satisfy one of the three prerequisites:</p>
<ol>
<li>Provider provides a NixOS ISO (even if an older version) and allows you to
mount it;</li>
<li>Provider allows user to upload custom ISO images, with which you can upload a
copy of NixOS installation media;</li>
<li>Provider supports booting to <a href="https://netboot.xyz/" rel="noopener noreferrer" target="_blank">netboot.xyz</a> (an utility
to install various Linux distros over the Internet), and your VPS has more
than 1GB RAM, so that netboot.xyz has enough space to extract NixOS&#39;s
installation image into RAM.</li>
</ol>
<p>In my case, I purchased a VPS with exactly 1GB of RAM, not enough for extracting
the image of NixOS 23.05. Therefore, I cannot boot into NixOS installation
environment with netboot.xyz. In addition, my provider doesn&#39;t support custom
ISOs, so I cannot boot into NixOS installer with that either.</p>
<ul>
<li>Replace the running operating system on VPS with
<a href="https://github.com/elitak/nixos-infect" rel="noopener noreferrer" target="_blank">NixOS-Infect</a> or
<a href="https://github.com/nix-community/nixos-anywhere" rel="noopener noreferrer" target="_blank">NixOS-Anywhere</a>, etc.</li>
</ul>
<p>NixOS-Infect works by installating a Nix daemon on the local OS, build a
complete NixOS installation on it, and finally replace the bootloader entries
with those for NixOS. Since this approach doesn&#39;t require extracting the full
installer image, it is more suitable for VPSes with low RAM. The downside of
this approach though, is that you cannot customize partitions and filesystem
types. You are left with the default partition schemes and filesystems
configured by the provider. For users who depends on non-standard partition or
filesystem schemes, including Btrfs/ZFS or
<a href="/en/article/modify-computer/nixos-impermanence.lantian/">Impermanence</a>, this
approach is not suitable.</p>
<p>NixOS-Anywhere, on the other hand, works by replacing the current running kernel
with <code>kexec</code>, and booting straight into NixOS installation image stored in RAM.
Since it works in almost the same way as netboot.xyz, it also requires a large
chunk of RAM, just like netboot.xyz.</p>
<ul>
<li>Use NixOS-Infect first, and then manually adjust partitions in rescue
environment</li>
</ul>
<p>I used to setup similar low RAM VPSes by setting up a normal NixOS with
NixOS-Infect first, and then deploy a configuration with Btrfs and Impermanence
enabled, reboot into rescue environment, and finally adjust partitions and
convert filesystems. It works, but takes many steps to complete. In addition, if
I did any of the steps incorrectly, I&#39;m left with an unfixable system, and will
need to start over.</p>
<ul>
<li>...Any other possibilities?</li>
</ul>
<p>Recently, the NixOS community released a tool,
<a href="https://github.com/nix-community/disko" rel="noopener noreferrer" target="_blank">Disko</a>. It is originally used for
automatically partitioning hard drives in the NixOS installation environment, so
that user can declaratively partition the drive with a Nix config file. However,
the tool also supports generating a disk image based on a given partition table
and NixOS config. Therefore, we can set up Btrfs/ZFS/Impermanence, generate the
corresponding disk image, and <code>dd</code> the image into the VPS&#39;s hard drive, to
easily install NixOS on there.</p>
<p>Since this method requires next to nothing for the rescue environment on VPS (as
long as there is network and <code>dd</code> command), we can boot into Alpine Linux, a
distro known for minimal RAM usage, and transfer the disk image over the
Internet into the hard drive of VPS.</p>
<h2 id="prepare-nixos-configuration">Prepare NixOS Configuration</h2>
<p>Before using this method, we need to prepare a simple NixOS configuration,
including the basic config for bootloader, networking, root password and SSH
keys, so that you can deploy the full configuration later. Of course, you can
simply use your full NixOS configuration, at the cost of larger disk image.</p>
<p>Here is the configuration file I prepared, stored as <code>configuration.nix</code>:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  config</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}: {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Kernel parameters I use</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  boot</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">kernelParams</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Disable auditing</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &quot;audit=0&quot;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Do not generate NIC names based on PCIe addresses (e.g. enp1s0, useless for VPS)</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Generate names based on orders (e.g. eth0)</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &quot;net.ifnames=0&quot;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # My Initrd config, enable ZSTD compression and use systemd-based stage 1 boot</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  boot</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">initrd</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    compressor</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;zstd&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    compressorArgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;-19&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;-T0&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    systemd</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">enable</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Install Grub</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  boot</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">loader</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">grub</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    enable</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = !</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">config</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">boot</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">isContainer</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    default</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;saved&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    devices</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;/dev/vda&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Timezone, change based on your location</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  time</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">timeZone</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;America/Los_Angeles&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Root password and SSH keys. If network config is incorrect, use this password</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # to manually adjust network config on serial console/VNC.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  users</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">mutableUsers</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  users</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">users</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">root</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    hashedPassword</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;$6$9iybgF./X/RNsRrQ$h7Zlk//loJDPg7yCCPT/9jVU0Tvep6vEA1FvPBT.kqJUA5qlzhDJEYnBFlpBZmTXuUXjF0qgmDWmGkXIMC9JD/&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    openssh</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">authorizedKeys</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">keys</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      &quot;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMcWoEQ4Mh27AV3ixcn9CMaUK/R+y4y5TqHmn2wJoN6i lantian@lantian-lenovo-archlinux&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      &quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCulLscvKjEeroKdPE207W10MbZ3+ZYzWn34EnVeIG0GzfZ3zkjQJVfXFahu97P68Tw++N6zIk7htGic9SouQuAH8+8kzTB8/55Yjwp7W3bmqL7heTmznRmKehtKg6RVgcpvFfciyxQXV/bzOkyO+xKdmEw+fs92JLUFjd/rbUfVnhJKmrfnohdvKBfgA27szHOzLlESeOJf3PuXV7BLge1B+cO8TJMJXv8iG8P5Uu8UCr857HnfDyrJS82K541Scph3j+NXFBcELb2JSZcWeNJRVacIH3RzgLvp5NuWPBCt6KET1CCJZLsrcajyonkA5TqNhzumIYtUimEnAPoH51hoUD1BaL4wh2DRxqCWOoXn0HMrRmwx65nvWae6+C/7l1rFkWLBir4ABQiKoUb/MrNvoXb+Qw/ZRo6hVCL5rvlvFd35UF0/9wNu1nzZRSs9os2WLBMt00A4qgaU2/ux7G6KApb7shz1TXxkN1k+/EKkxPj/sQuXNvO6Bfxww1xEWFywMNZ8nswpSq/4Ml6nniS2OpkZVM2SQV1q/VdLEKYPrObtp2NgneQ4lzHmAa5MGnUCckES+qOrXFZAcpI126nv1uDXqA2aytN6WHGfN50K05MZ+jA8OM9CWFWIcglnT+rr3l+TI/FLAjE13t6fMTYlBH0C8q+RnQDiIncNwyidQ== lantian@LandeMacBook-Pro.local&quot;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    ];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Manage networking with systemd-networkd</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  systemd</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">network</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">enable</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">resolved</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">enable</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Configure network IP and DNS</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  systemd</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">network</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">networks</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">eth0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    address</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;123.45.678.90/24&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    gateway</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;123.45.678.1&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    matchConfig</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">Name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;eth0&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  networking</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">nameservers</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &quot;8.8.8.8&quot;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Enable SSH server and listen on port 2222</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">openssh</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    enable</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    ports</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">2222</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    settings</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      PasswordAuthentication</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      PermitRootLogin</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mkForce</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;prohibit-password&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Disable NixOS&#39;s builtin firewall</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  networking</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">firewall</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">enable</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Disable DHCP and configure IP manually</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  networking</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">useDHCP</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Hostname, can be set as you wish</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  networking</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">hostName</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;bootstrap&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Latest NixOS version on your first install. Used to prevent backward</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # incompatibilities on major upgrades</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  system</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">stateVersion</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;23.05&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Kernel modules required by QEMU (KVM) virtual machine</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  boot</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">initrd</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">postDeviceCommands</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mkIf</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (!</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">config</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">boot</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">initrd</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">systemd</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">enable</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # Set the system time from the hardware clock to work around a</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # bug in qemu-kvm &gt; 1.5.2 (where the VM clock is initialised</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # to the *boot time* of the host).</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    hwclock -s</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  boot</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">initrd</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">availableKernelModules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &quot;virtio_net&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &quot;virtio_pci&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &quot;virtio_mmio&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &quot;virtio_blk&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &quot;virtio_scsi&quot;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  boot</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">initrd</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">kernelModules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &quot;virtio_balloon&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &quot;virtio_console&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &quot;virtio_rng&quot;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>Then, prepare <code>flake.nix</code> to manage nixpkgs versions in the Flake way, as well
as introduce other modules I use, such as Impermanence:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  description</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;Lan Tian&#39;s NixOS Flake&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">url</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;github:NixOS/nixpkgs/nixos-unstable&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    impermanence</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">url</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;github:nix-community/impermanence&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  outputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    self</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  } @ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">let</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">  in</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> rec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    nixosConfigurations</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">bootstrap</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixosSystem</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      system</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;x86_64-linux&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      modules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">        inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">impermanence</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixosModules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">impermanence</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        ./configuration.nix</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      ];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>Right now, this system config will not build, as we haven&#39;t configured
filesystems yet. If you try to build it with
<code>nixos-rebuild build --flake .#bootstrap</code> now, you will see the following
errors:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">error:</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Failed</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> assertions:</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">-</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> The</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> 『fileSystems』</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> option</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> does</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> not</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> specify</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> your</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> root</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> file</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> system.</span></span></code></pre>
<p>Therefore, our next step is adding the Disko module, and the configuration for
partition tables and filesystems.</p>
<h2 id="partitioning-disk-image-with-impermanence">Partitioning Disk Image (with Impermanence)</h2>
<blockquote>
<p>If you don&#39;t use Impermanence, or other mechanisms that use tmpfs as the root
partition, please skip to the next section.</p>
</blockquote>
<p>Change your <code>flake.nix</code> to add the Disko module:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  description</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;Lan Tian&#39;s NixOS Flake&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">url</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;github:NixOS/nixpkgs/nixos-unstable&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    impermanence</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">url</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;github:nix-community/impermanence&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Add the following lines</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    disko</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      url</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;github:nix-community/disko&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">follows</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;nixpkgs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  outputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    self</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  } @ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">let</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">  in</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> rec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    nixosConfigurations</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">bootstrap</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixosSystem</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      system</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;x86_64-linux&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      modules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">        inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">impermanence</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixosModules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">impermanence</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">        # Add the next line</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">        inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">disko</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixosModules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">disko</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        ./configuration.nix</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      ];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>Then, we need to set up partitioning in the disk image with options provided by
Disko. Modify <code>configuration.nix</code> and add the following config:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  config</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}: {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Other configurations omitted</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  disko</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Do not let Disko manage fileSystems.* config for NixOS.</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Reason is that Disko mounts partitions by GPT partition names, which are</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # easily overwritten with tools like fdisk. When you fail to deploy a new</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # config in this case, the old config that comes with the disk image will</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # not boot either.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    enableConfig</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    devices</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # Define a disk</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      disk</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">main</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">        # Size for generated disk image. 2GB is enough for me. Adjust per your need.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">        imageSize</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;2G&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">        # Path to disk. When Disko generates disk images, it actually runs a QEMU</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">        # virtual machine and runs the installation steps. Whether your VPS</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">        # recognizes its hard disk as &quot;sda&quot; or &quot;vda&quot; doesn&#39;t matter. We abide to</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">        # Disko&#39;s QEMU VM and use &quot;vda&quot; here.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">        device</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;/dev/vda&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">        type</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;disk&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">        # Parititon table for this disk</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">        content</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">          # Use GPT partition table. There seems to be some issues with MBR support</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">          # from Disko.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">          type</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;gpt&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">          # Partition list</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">          partitions</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">            # Compared to MBR, GPT partition table doesn&#39;t reserve space for MBR</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">            # boot record. We need to reserve the first 1MB for MBR boot record,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">            # so Grub can be installed here.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">            boot</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">              size</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;1M&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">              type</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;EF02&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">; </span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># for grub MBR</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">              # Use the highest priority to ensure it&#39;s at the beginning</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">              priority</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">            };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">            # ESP partition, or &quot;boot&quot; partition as you may call it. In theory,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">            # this config will support VPSes with both EFI and BIOS boot modes.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">            ESP</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">              name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;ESP&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">              # Reserve 512MB of space per my own need. If you use more/less</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">              # on your boot partition, adjust accordingly.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">              size</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;512M&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">              type</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;EF00&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">              # Use the second highest priority so it&#39;s before the remaining space</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">              priority</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">              # Format as FAT32</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">              content</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">                type</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;filesystem&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">                format</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;vfat&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">                # Use as boot partition. Disko use the information here to mount</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">                # partitions on disk image generation. Use the same settings as</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">                # fileSystems.*</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">                mountpoint</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;/boot&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">                mountOptions</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;fmask=0077&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;dmask=0077&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">              };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">            };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">            # Parition to store the NixOS system, use all remaining space.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">            nix</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">              size</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;100%&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">              # Format as Btrfs. Change per your needs.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">              content</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">                type</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;filesystem&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">                format</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;btrfs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">                # Use as the Nix partition. Disko use the information here to mount</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">                # partitions on disk image generation. Use the same settings as</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">                # fileSystems.*</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">                mountpoint</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;/nix&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">                mountOptions</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;compress-force=zstd&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;nosuid&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;nodev&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">              };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">            };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">          };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # Since I enabled Impermanence, I need to declare the root partition as tmpfs,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # so Disko can mount the partitions when generating disk images</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      nodev</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;/&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">        fsType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;tmpfs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">        mountOptions</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;relatime&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;mode=755&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;nosuid&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;nodev&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Since we aren&#39;t letting Disko manage fileSystems.*, we need to configure it ourselves</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Root partition, is tmpfs because I enabled impermanence.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  fileSystems</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;/&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    device</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;tmpfs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    fsType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;tmpfs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    options</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;relatime&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;mode=755&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;nosuid&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;nodev&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # /nix partition, third partition on the disk image. Since my VPS recognizes</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # hard drive as &quot;sda&quot;, I specify &quot;sda3&quot; here. If your VPS recognizes the drive</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # differently, change accordingly</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  fileSystems</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;/nix&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    device</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;/dev/sda3&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    fsType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;btrfs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    options</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;compress-force=zstd&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;nosuid&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;nodev&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # /boot partition, second partition on the disk image. Since my VPS recognizes</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # hard drive as &quot;sda&quot;, I specify &quot;sda2&quot; here. If your VPS recognizes the drive</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # differently, change accordingly</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  fileSystems</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;/boot&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    device</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;/dev/sda2&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    fsType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;vfat&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    options</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;fmask=0077&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;dmask=0077&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<h2 id="partitioning-disk-image-regular-install">Partitioning Disk Image (Regular Install)</h2>
<blockquote>
<p>If you use Impermanence, or other mechanisms that use tmpfs as the root
partition, read the last section and skip this section.</p>
</blockquote>
<p>Same as the last section, change your <code>flake.nix</code> to add the Disko module:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  description</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;Lan Tian&#39;s NixOS Flake&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">url</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;github:NixOS/nixpkgs/nixos-unstable&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    impermanence</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">url</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;github:nix-community/impermanence&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Add the following lines</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    disko</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      url</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;github:nix-community/disko&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">follows</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;nixpkgs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  outputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    self</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  } @ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">let</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">  in</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> rec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    nixosConfigurations</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">bootstrap</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixosSystem</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      system</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;x86_64-linux&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      modules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">        inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">impermanence</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixosModules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">impermanence</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">        # Add the next line</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">        inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">disko</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixosModules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">disko</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        ./configuration.nix</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      ];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>Then, we need to set up partitioning in the disk image with options provided by
Disko. Modify <code>configuration.nix</code> and add the following config:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  config</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}: {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Other configurations omitted</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  disko</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Do not let Disko manage fileSystems.* config for NixOS.</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Reason is that Disko mounts partitions by GPT partition names, which are</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # easily overwritten with tools like fdisk. When you fail to deploy a new</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # config in this case, the old config that comes with the disk image will</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # not boot either.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    enableConfig</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    devices</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # Define a disk</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      disk</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">main</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">        # Size for generated disk image. 2GB is enough for me. Adjust per your need.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">        imageSize</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;2G&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">        # Path to disk. When Disko generates disk images, it actually runs a QEMU</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">        # virtual machine and runs the installation steps. Whether your VPS</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">        # recognizes its hard disk as &quot;sda&quot; or &quot;vda&quot; doesn&#39;t matter. We abide to</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">        # Disko&#39;s QEMU VM and use &quot;vda&quot; here.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">        device</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;/dev/vda&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">        type</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;disk&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">        # Parititon table for this disk</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">        content</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">          # Use GPT partition table. There seems to be some issues with MBR support</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">          # from Disko.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">          type</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;gpt&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">          # Partition list</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">          partitions</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">            # Compared to MBR, GPT partition table doesn&#39;t reserve space for MBR</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">            # boot record. We need to reserve the first 1MB for MBR boot record,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">            # so Grub can be installed here.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">            boot</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">              size</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;1M&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">              type</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;EF02&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">; </span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># for grub MBR</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">              # Use the highest priority to ensure it&#39;s at the beginning</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">              priority</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">            };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">            # ESP partition, or &quot;boot&quot; partition as you may call it. In theory,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">            # this config will support VPSes with both EFI and BIOS boot modes.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">            ESP</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">              name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;ESP&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">              # Reserve 512MB of space per my own need. If you use more/less</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">              # on your boot partition, adjust accordingly.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">              size</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;512M&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">              type</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;EF00&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">              # Use the second highest priority so it&#39;s before the remaining space</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">              priority</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">              # Format as FAT32</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">              content</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">                type</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;filesystem&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">                format</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;vfat&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">                # Use as boot partition. Disko use the information here to mount</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">                # partitions on disk image generation. Use the same settings as</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">                # fileSystems.*</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">                mountpoint</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;/boot&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">                mountOptions</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;fmask=0077&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;dmask=0077&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">              };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">            };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">            # Parition to store the NixOS system, use all remaining space.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">            nix</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">              size</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;100%&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">              # Format as Btrfs. Change per your needs.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">              content</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">                type</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;filesystem&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">                format</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;btrfs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">                # Use as the root partition. Disko use the information here to mount</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">                # partitions on disk image generation. Use the same settings as</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">                # fileSystems.*</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">                mountpoint</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;/&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">                mountOptions</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;compress-force=zstd&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;nosuid&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;nodev&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">              };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">            };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">          };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Since we aren&#39;t letting Disko manage fileSystems.*, we need to configure it ourselves</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Root partition, third partition on the disk image. Since my VPS recognizes</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # hard drive as &quot;sda&quot;, I specify &quot;sda3&quot; here. If your VPS recognizes the drive</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # differently, change accordingly</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  fileSystems</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;/&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    device</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;/dev/sda3&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    fsType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;btrfs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    options</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;compress-force=zstd&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;nosuid&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;nodev&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # /boot partition, second partition on the disk image. Since my VPS recognizes</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # hard drive as &quot;sda&quot;, I specify &quot;sda2&quot; here. If your VPS recognizes the drive</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # differently, change accordingly</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  fileSystems</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;/boot&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    device</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;/dev/sda2&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    fsType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;vfat&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    options</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;fmask=0077&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;dmask=0077&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<h2 id="generate-disk-image">Generate Disk Image</h2>
<p>Change <code>flake.nix</code> to add a &quot;package&quot; that calls the generate disk image
function from Disko:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  description</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;Lan Tian&#39;s NixOS Flake&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">url</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;github:NixOS/nixpkgs/nixos-unstable&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    impermanence</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">url</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;github:nix-community/impermanence&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    disko</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      url</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;github:nix-community/disko&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">follows</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;nixpkgs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  outputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    self</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  } @ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">let</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">  in</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> rec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    nixosConfigurations</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">bootstrap</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixosSystem</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      system</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;x86_64-linux&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      modules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">        inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">impermanence</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixosModules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">impermanence</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">        inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">disko</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixosModules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">disko</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        ./configuration.nix</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      ];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Add the following lines</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    packages</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">x86_64-linux</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">self</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixosConfigurations</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">bootstrap</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">config</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">system</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">build</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">diskoImages</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>Finally, run <code>nix build .#image</code>. After a short while, you will see the
generated disk image at <code>result/main.raw</code>.</p>
<h2 id="upload-disk-image-to-vps">Upload Disk Image to VPS</h2>
<p>Boot into rescue environment, or a lightweight Linux distro like Alpine Linux,
on your VPS.</p>
<p>If your rescue environment has a SSH server, use the following command to upload
your image:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Change to sda/vda based on how your VPS recognizes its hard drive</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">cat</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> result/main.raw</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> | </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">ssh</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> root@123.45.678.90</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;dd of=/dev/sda&quot;</span></span></code></pre>
<p>If your rescue environment doesn&#39;t have SSH, use the following command:
<strong>(ATTENTION: NO ENCRYPTION!)</strong></p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Change to sda/vda based on how your VPS recognizes its hard drive</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Run this on VPS</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">nc</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -l</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 1234</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> | </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">dd</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> of=/dev/sda</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Run this on local computer</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">cat</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> result/main.raw</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> | </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">nc</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 123.45.678.89</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 1234</span></span></code></pre>
<p>Reboot your VPS after the command finishes. Now you should be booting into the
freshly installed NixOS.</p>
<h2 id="expand-partition-size">Expand Partition Size</h2>
<p>Since the disk image we created is only 2GB large, the image written into VPS&#39;s
hard drive doesn&#39;t consume all spaces on the hard drive. You will need to
manually expand the partition.</p>
<p>Run <code>fdisk /dev/sda</code>, remove the third partition for <code>/nix</code> (or <code>/</code>), and
recreate the partition with the same start position, and extend the end position
to the end of the hard drive. Do not erase the filesystem header when prompted!</p>
<p>Finally, run the filesystem resize command for your filesystem. For ext4
partitions, use <code>resize2fs /dev/sda3</code>. For Btrfs, use
<code>btrfs filesystem resize max /nix</code> (or &#39;/&#39;).</p>  </div>  <script type="module" src="/assets/WalineComment.astro_astro_type_script_index_0_lang.Cd-Au78J.js"></script> <div class="clearfix" id="post-navi" data-astro-cid-gfbmwgei=""> <div class="float-end text-end" data-astro-cid-gfbmwgei=""> <a href="/en/article/modify-computer/nix-trigonometric-math-library-from-zero.lantian/" title="Nix Trigonometric Math Library from Ground Zero" data-astro-cid-gfbmwgei=""> Nix Trigonometric Math Library from Ground Zero </a> <br data-astro-cid-gfbmwgei=""> Next post »
</div> <div class="float-start text-start position-absolute" data-astro-cid-gfbmwgei="">
« Previous post <br data-astro-cid-gfbmwgei=""> <a href="/en/article/modify-website/migrate-blog-to-astro-js.lantian/" title="Migrating My Blog to Astro.js" data-astro-cid-gfbmwgei=""> Migrating My Blog to Astro.js </a> </div> </div>  <div id="waline" data-waline-language="en-US" data-waline-path="/en/article/modify-computer/nixos-low-ram-vps.lantian"></div>   </div> </div> </article>  </div> <aside class="d-none d-xl-block" data-astro-cid-porej7z2=""> <section class="widget"> <h3>Latest posts</h3> <ul class="list-unstyled"> <li> 12-07  <a href="/en/article/modify-website/dn42-flapalerted-reduce-flapping.lantian/">Using FlapAlerted to Suppress flapping in DN42</a> </li><li> 07-20  <a href="/en/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/">Legal LTE Network at Home with Open5GS</a> </li><li> 06-27  <a href="/en/article/modify-computer/sidestore-without-stosvpn-across-lan.lantian/">Using SideStore without StosVPN across your LAN</a> </li><li> 05-19  <a href="/en/article/modify-computer/nix-logarithmetic-math-library-from-zero.lantian/">Nix Logarithmic Math Library from Ground Zero</a> </li><li> 04-06  <a href="/en/article/modify-computer/legal-lte-network-at-home-for-100-bucks.lantian/">Legal LTE Network at Home for $100</a> </li><li> 02-10  <a href="/en/article/modify-computer/build-custom-android-kernel-with-nix.lantian/">Building Custom Android Kernel with Nix</a> </li><li> 04-20  <a href="/en/article/modify-website/migrate-blog-to-astro-js.lantian/">Migrating My Blog to Astro.js</a> </li><li> 12-16  <a href="/en/article/modify-computer/nixos-low-ram-vps.lantian/">NixOS Series 5: Creating Disk Image for Low RAM VPS</a> </li><li> 09-20  <a href="/en/article/modify-computer/nix-trigonometric-math-library-from-zero.lantian/">Nix Trigonometric Math Library from Ground Zero</a> </li><li> 05-29  <a href="/en/article/random-notes/pipewire-sigkill-fix.lantian/">Preventing Pipewire from being SIGKILLed</a> </li><li> 05-12  <a href="/en/article/modify-website/how-to-kill-the-dn42-network.lantian/">How to Kill the DN42 Network (Updated 2023-05-12)</a> </li><li> 05-08  <a href="/en/article/modify-computer/laptop-muxed-nvidia-passthrough.lantian/">NVIDIA GPU Passthrough on an Optimus MUXed Laptop (Updated 2023-05)</a> </li><li> 04-17  <a href="/en/article/random-notes/fix-china-telecom-roaming-no-4g-on-aosp-rom.lantian/">Fix China Telecom 4G Roaming on AOSP ROM by Changing APN</a> </li><li> 03-26  <a href="/en/article/random-notes/old-hp-workstation-as-all-in-one.lantian/">Notes on Setting Up NAS+Router on Old HP Workstation</a> </li><li> 01-14  <a href="/en/article/modify-computer/nixos-impermanence.lantian/">NixOS Series 4: &quot;Stateless&quot; Operating System</a> </li> </ul> </section>  <section class="widget"> <h3>Latest comments</h3> <ul class="list-unstyled" id="recent-comments">  <li><a href="#">Loading...</a></li>  </ul> </section>  <script type="module" src="/assets/WalineRecentComments.astro_astro_type_script_index_0_lang.Cu-GBWyK.js"></script> <section class="widget"> <h3>Others</h3> <ul class="list-unstyled">  <li> <i class="fas fa-fw fa-rss"></i>  <a href="/rss2.xml" target="_blank">RSS Feed</a> |  <a href="/feed.xml" target="_blank">Atom</a> |  <a href="/feed.json" target="_blank">JSON</a> </li> <li> <i class="fas fa-fw fa-globe"></i>  <a href="https://stats.uptimerobot.com/NLYPbrSal6" target="_blank"> Sever Status </a> </li> <li> <i class="fas fa-fw fa-sitemap"></i>  <a href="https://lg.lantian.pub" target="_blank">DN42 Looking Glass</a> </li> <li> <i class="fas fa-fw fa-link"></i>  <a href="gopher://lantian.pub" target="_blank">Access with Gopher protocol</a> </li>  </ul> </section>  <section class="widget"> <h3>Links</h3> <ul class="list-unstyled"> <li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://0x7f.cc"> 0x7f Blog 🐑 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="http://foreverblog.cn"> 10 Year&#39;s Promise (Forever Blog) </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://alanyhq.com"> Alanyhq </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.baoshuo.ren/?utm_source=friends"> Baoshuo&#39;s Blog </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.cas7.moe"> Blog of Moecast </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://jerryxiao.cc"> JerryXiao </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://sangsir.com"> SangSir </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://snli.org"> Shucheng Li </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://yuetau.net"> YuetAu&#39;s Spot </a> </li> </ul> </section>  </aside> </div> <footer class="clearfix" data-astro-cid-w3csb3e3="">  <div id="copyright" class="float-end text-end" data-astro-cid-w3csb3e3=""> <i class="fas fa-copyright" data-astro-cid-w3csb3e3=""></i> 2012-2026 Lan Tian @ Blog<br data-astro-cid-w3csb3e3=""> <small data-astro-cid-w3csb3e3=""> Powered by Astro v5.17.1 @ 2026-02-12 02:27:08 </small> </div> <script type="module" src="/assets/PlausibleAnalytics.astro_astro_type_script_index_0_lang.C6V0cCkY.js"></script> </footer>  </div>  </body> </html>