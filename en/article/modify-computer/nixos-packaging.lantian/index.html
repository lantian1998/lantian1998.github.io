<!DOCTYPE html><html lang="en-US" itemscope="" itemtype="https://schema.org/Article" data-astro-cid-porej7z2=""> <head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>NixOS Series 3: Software Packaging 101 - Lan Tian @ Blog</title><script>
  ;(() => {
    try {
      const mode = localStorage.getItem('user-color-scheme')
      if (mode == 'dark' || mode == 'light') {
        document.documentElement.setAttribute('data-user-color-scheme', mode)
      }
    } catch {
      // Ignore errors
    }
  })()
</script><link rel="stylesheet" href="/assets/index.CUlf1-Vz.css"><style>#post-navi[data-astro-cid-gfbmwgei]{padding:5px;border-top:1px solid var(--lt-border-weak);border-bottom:1px solid var(--lt-border-weak)}
ol[data-astro-cid-nj3qel45]{margin:0;padding:0;line-height:1.5}ol[data-astro-cid-nj3qel45] .toc-item[data-astro-cid-nj3qel45]{list-style:none}ol[data-astro-cid-nj3qel45] .toc-child[data-astro-cid-nj3qel45],ol[data-astro-cid-nj3qel45] .toc[data-astro-cid-nj3qel45]{padding:0}ol[data-astro-cid-nj3qel45] .toc-link[data-astro-cid-nj3qel45]{display:block;margin-left:1em;padding:.25em 0}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;width:1em;padding:.25em 0;float:left;font-style:normal;font-variant:normal;font-weight:900;font-family:Font Awesome\ 6 Free;font-feature-settings:normal;text-align:center}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before{content:""}ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{content:""}.post-info-wrap[data-astro-cid-dckccua4]{-ms-flex:0 0 2.5em;flex:0 0 2.5em;background-color:var(--lt-component-bg-emphasis)}@media(min-width:768px){.post-info[data-astro-cid-dckccua4]{position:sticky;top:0}}@media(max-width:767.98px){.post-info[data-astro-cid-dckccua4]{position:absolute}}
</style><script type="module" src="/assets/PageLayout.astro_astro_type_script_index_0_lang.C1wfUPs6.js"></script><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Referrer-Policy" content="no-referrer, strict-origin-when-cross-origin"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="imagemode" content="force"><meta name="nightmode" content="disable"><meta name="wap-font-scale" content="no"><meta name="title" content="NixOS Series 3: Software Packaging 101 - Lan Tian @ Blog"><meta name="keywords" content=""><meta name="author" content="Lan Tian"><link rel="canonical" href="https://lantian.pub/en/article/modify-computer/nixos-packaging.lantian/"><link rel="alternate" type="application/rss+xml" title="Lan Tian @ Blog" href="https://lantian.pub/rss2.xml"><link rel="alternate" type="application/atom+xml" title="Lan Tian @ Blog" href="https://lantian.pub/feed.xml"><link rel="alternate" href="https://lantian.pub/article/modify-computer/nixos-packaging.lantian/" hreflang="zh"><link rel="alternate" href="https://lantian.pub/en/article/modify-computer/nixos-packaging.lantian/" hreflang="en"><meta name="copyright" content="Copyright 2012-2025 Lan Tian @ Blog"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#03a9f4"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#212121"><meta name="application-name" content="Lan Tian @ Blog"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="apple-touch-icon" sizes="1024x1024" href="/apple-touch-icon-1024x1024.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#03a9f4"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Lan Tian @ Blog"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-640x1136.png"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1136x640.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-750x1334.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1334x750.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1125x2436.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2436x1125.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1170x2532.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2532x1170.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1179x2556.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2556x1179.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-828x1792.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1792x828.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2688.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2688x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2208.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2208x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1284x2778.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2778x1284.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1290x2796.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2796x1290.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1488x2266.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2266x1488.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1536x2048.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2048x1536.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1620x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1620.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1640x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1640.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2388.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2388x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2224.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2224x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-2048x2732.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2732x2048.png"><meta name="msapplication-TileColor" content="#bbdefb"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"><meta property="og:url" content="https://lantian.pub/en/article/modify-computer/nixos-packaging.lantian/"><meta property="og:type" content="website"><meta property="og:title" content="NixOS Series 3: Software Packaging 101 - Lan Tian @ Blog"><meta property="og:image" content="https://lantian.pub/usr/uploads/202110/nixos-social-preview.png"><meta content="One characteristic of NixOS is that all binary applications and libraries are stored in /nix/store directory and managed by Nix package manager. This means that NixOS doesn&#38;#39;t conform to the FHS standard of Linux , and there&#38;#39;s not even a dynamic library loader like ld-linux-x86-64.so.2 in /lib or /lib64 , let alone other shared libraries like libc.so . Therefore, unless the program is statically linked, binaries compiled for other Linux distros will not run on NixOS at all. Therefore, to use a program not packaged in Nixpkgs yet on NixOS, the best way is to package it yourself by writing a packaging script in Nix, and add the package definition to configuration.nix , in order to install it to the system. There are three good news and two bad news when it comes to NixOS packaging...."><meta property="og:site_name" content="Lan Tian @ Blog"><meta property="og:locale" content="en"><meta name="twitter:card" content="summary"><meta name="twitter:url" content="https://lantian.pub/en/article/modify-computer/nixos-packaging.lantian/"><meta name="twitter:title" content="NixOS Series 3: Software Packaging 101 - Lan Tian @ Blog"><meta property="twitter:image" content="https://lantian.pub/usr/uploads/202110/nixos-social-preview.png"><meta content="One characteristic of NixOS is that all binary applications and libraries are stored in /nix/store directory and managed by Nix package manager. This means that NixOS doesn&#38;#39;t conform to the FHS standard of Linux , and there&#38;#39;s not even a dynamic library loader like ld-linux-x86-64.so.2 in /lib or /lib64 , let alone other shared libraries like libc.so . Therefore, unless the program is statically linked, binaries compiled for other Linux distros will not run on NixOS at all. Therefore, to use a program not packaged in Nixpkgs yet on NixOS, the best way is to package it yourself by writing a packaging script in Nix, and add the package definition to configuration.nix , in order to install it to the system. There are three good news and two bad news when it comes to NixOS packaging...."><meta name="twitter:dnt" content="on"><meta itemprop="name" content="NixOS Series 3: Software Packaging 101 - Lan Tian @ Blog"><meta property="image" content="https://lantian.pub/usr/uploads/202110/nixos-social-preview.png"><meta content="One characteristic of NixOS is that all binary applications and libraries are stored in /nix/store directory and managed by Nix package manager. This means that NixOS doesn&#38;#39;t conform to the FHS standard of Linux , and there&#38;#39;s not even a dynamic library loader like ld-linux-x86-64.so.2 in /lib or /lib64 , let alone other shared libraries like libc.so . Therefore, unless the program is statically linked, binaries compiled for other Linux distros will not run on NixOS at all. Therefore, to use a program not packaged in Nixpkgs yet on NixOS, the best way is to package it yourself by writing a packaging script in Nix, and add the package definition to configuration.nix , in order to install it to the system. There are three good news and two bad news when it comes to NixOS packaging...."><meta content="One characteristic of NixOS is that all binary applications and libraries are stored in /nix/store directory and managed by Nix package manager. This means that NixOS doesn&#38;#39;t conform to the FHS standard of Linux , and there&#38;#39;s not even a dynamic library loader like ld-linux-x86-64.so.2 in /lib or /lib64 , let alone other shared libraries like libc.so . Therefore, unless the program is statically linked, binaries compiled for other Linux distros will not run on NixOS at all. Therefore, to use a program not packaged in Nixpkgs yet on NixOS, the best way is to package it yourself by writing a packaging script in Nix, and add the package definition to configuration.nix , in order to install it to the system. There are three good news and two bad news when it comes to NixOS packaging...."><link rel="me" href="https://mastodon.social/@lantian"></head> <body data-astro-cid-porej7z2=""> <div id="bg" data-astro-cid-j6vmxtef=""></div>   <div id="container" class="container" data-astro-cid-porej7z2=""> <nav class="lantian navbar navbar-expand-lg" data-astro-cid-wu5dj4rx=""> <div class="container-fluid" data-astro-cid-wu5dj4rx=""> <a class="navbar-brand" href="/en/" data-astro-cid-wu5dj4rx="">Lan Tian @ Blog</a> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#lantian-navbar" aria-controls="lantian-navbar" aria-expanded="false" aria-label="Toggle navigation" data-astro-cid-wu5dj4rx=""> <span class="navbar-toggler-icon" data-astro-cid-wu5dj4rx=""></span> </button> <div class="collapse navbar-collapse" id="lantian-navbar" data-astro-cid-wu5dj4rx=""> <ul class="navbar-nav" data-astro-cid-wu5dj4rx=""> <li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/archive/index.html" data-astro-cid-wu5dj4rx=""> Posts </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> Himawari </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/en/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> <li class="nav-item dropdown d-block d-lg-none" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="pages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-file" data-astro-cid-wu5dj4rx=""></i> Page  <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="pages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/archive/index.html" data-astro-cid-wu5dj4rx=""> Posts </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> Himawari </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> </ul> </li> </ul> <ul class="navbar-nav ms-auto" data-astro-cid-wu5dj4rx=""> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="languages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-language" data-astro-cid-wu5dj4rx=""></i> Language <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="languages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/article/modify-computer/nixos-packaging.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-cn" data-astro-cid-wu5dj4rx=""></span> Chinese Simplified / 简体中文 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item active" href="/en/article/modify-computer/nixos-packaging.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-us" data-astro-cid-wu5dj4rx=""></span> English </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">Not all pages have translations.</a> </li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">You may see 404 - this is normal.</a> </li> </ul> </li> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="color-scheme-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> Night Mode </a> <ul class="dropdown-menu" aria-labelledby="color-scheme-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-auto" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> Auto </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-light" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-sun" data-astro-cid-wu5dj4rx=""></i> Light</a> </li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-dark" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-moon" data-astro-cid-wu5dj4rx=""></i> Dark</a> </li> </ul> </li> </ul> </div> </div> </nav> <script type="module">const m="user-color-scheme",s="data-user-color-scheme",u=(e,t)=>{try{localStorage.setItem(e,t)}catch{}},i=e=>{try{return localStorage.getItem(e)}catch{return null}},c=e=>{const t={dark:!0,light:!0,auto:!0},o=e===null||!Object.keys(t).includes(e)?"auto":e;u(m,o);for(const l in t){const n=document.getElementById("color-scheme-"+l);n&&(l==o?n.classList.add("active"):n.classList.remove("active"))}o!="auto"?document.documentElement.setAttribute(s,o):document.documentElement.removeAttribute(s)};c(i(m));const r=document.getElementById("color-scheme-auto");r&&r.addEventListener("click",()=>c("auto"));const a=document.getElementById("color-scheme-light");a&&a.addEventListener("click",()=>c("light"));const d=document.getElementById("color-scheme-dark");d&&d.addEventListener("click",()=>c("dark"));</script>  <div class="d-flex" data-astro-cid-porej7z2=""> <div id="content" data-astro-cid-porej7z2="">  <article> <div class="d-flex"> <div class="post-info-wrap" data-astro-cid-dckccua4=""> <div class="post-info" data-astro-cid-dckccua4=""> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-clock"></span> <br> <small>06-21</small> </p> <div class="post-meta-value"> Published on<span class="badge badge-tag" data-astro-cid-dckccua4=""> 2022-06-21 23:42 </span>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-file-alt"></span> <br> <small>Computers and Clients</small> </p> <div class="post-meta-value"> Category <a class="badge badge-tag" href="/en/category/modify-computer" data-astro-cid-dckccua4=""> Computers and Clients </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-tag"></span> <br> <small>1 tags</small> </p> <div class="post-meta-value"> Tags  <a class="badge badge-tag" href="/en/tag/NixOS" data-astro-cid-dckccua4=""> NixOS </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-list"></span> <br> <small>ToC</small> </p> <div class="post-meta-value">  <ol data-astro-cid-nj3qel45=""> <li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#preparation" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Preparation</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#using-packaging-template-from-nur" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Using Packaging Template from NUR</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#add-packages-straight-to-nixos-config" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Add Packages Straight to NixOS Config</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#phases-in-packaging" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Phases in Packaging</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#examples-open-source-software" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Examples: Open Source Software</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#easy-liboqs-c-cmake-automated" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Easy: LibOQS (C++, CMake, Automated)</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#medium-openssl-oqs-provider-c-has-dependencies" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Medium: OpenSSL OQS Provider (C, Has Dependencies)</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#hard-osdlyrics-python--c-two-stage-build" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Hard: OSDLyrics (Python &amp; C++, Two-Stage Build)</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#examples-closed-source-software--binary-distributed-ones" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Examples: Closed Source Software (&amp; Binary Distributed Ones)</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#easy-bilibili-linux-unpack-deb-electron" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Easy: Bilibili-linux (Unpack DEB, Electron)</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#medium-dingtalk-auto-patch-binaries-finding-dependencies" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Medium: DingTalk (Auto Patch Binaries, Finding Dependencies)</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#hard-svp-integrity-check-bubblewrap" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Hard: SVP (Integrity Check, Bubblewrap)</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#hard-wechat-uos-environment-check-steam-run" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Hard: WeChat-UOS (Environment Check, Steam-run)</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#examples-special-packages" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Examples: Special Packages</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#font-hoyo-glyphs" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Font: Hoyo-Glyphs</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#go-package-konnect" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Go Package: Konnect</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#kernel-linux-xanmod-lantian" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Kernel: linux-xanmod-lantian</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#conclusion" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Conclusion</span> </a> </li> </ol>   </div> </div> </div> </div>  </div>  <div class="post-wrap"> <div class="post-image-wrap"> <picture> <source srcset="/usr/uploads/202110/nixos-social-preview.png.thumb.png.webp" type="image/webp"> <source srcset="/usr/uploads/202110/nixos-social-preview.png.thumb.png.avif" type="image/avif"> <source srcset="/usr/uploads/202110/nixos-social-preview.png.thumb.png.jxl" type="image/jxl"> <img src="/usr/uploads/202110/nixos-social-preview.png.thumb.png" alt="Illustration for NixOS Series 3: Software Packaging 101" width="200" height="150"> </picture> </div> <h1 class="post-title"> <a href="/en/article/modify-computer/nixos-packaging.lantian/" rel="bookmark" title="NixOS Series 3: Software Packaging 101">NixOS Series 3: Software Packaging 101</a> </h1> <div class="post-text">  <blockquote><p>List of NixOS series posts:</p><ul><li><a href="/en/article/modify-website/nixos-why.lantian/">NixOS Series 1: Why I fell in love</a> </li><li><a href="/en/article/modify-website/nixos-initial-config-flake-deploy.lantian/">NixOS Series 2: Basic Config, Nix Flake &amp; Batch Deploy</a> </li><li><a href="/en/article/modify-computer/nixos-packaging.lantian/">NixOS Series 3: Software Packaging 101</a> (current post)</li><li><a href="/en/article/modify-computer/nixos-impermanence.lantian/">NixOS Series 4: &quot;Stateless&quot; Operating System</a> </li><li><a href="/en/article/modify-computer/nixos-low-ram-vps.lantian/">NixOS Series 5: Creating Disk Image for Low RAM VPS</a> </li></ul></blockquote> <p>One characteristic of NixOS is that all binary applications and libraries are
stored in <code>/nix/store</code> directory and managed by Nix package manager. This means
that NixOS doesn&#39;t conform to
<a href="https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard" rel="noopener noreferrer" target="_blank">the FHS standard of Linux</a>,
and there&#39;s not even a dynamic library loader like <code>ld-linux-x86-64.so.2</code> in
<code>/lib</code> or <code>/lib64</code>, let alone other shared libraries like <code>libc.so</code>. Therefore,
unless the program is statically linked, binaries compiled for other Linux
distros will not run on NixOS at all.</p>
<p>Therefore, to use a program not packaged in Nixpkgs yet on NixOS, the best way
is to package it yourself by writing a packaging script in Nix, and add the
package definition to <code>configuration.nix</code>, in order to install it to the system.</p>
<p>There are three good news and two bad news when it comes to NixOS packaging. The
good news are:</p>
<ol>
<li>Nixpkgs, ot the software repository for NixOS, provides a ton of functions
for automation. For many open source softwares written in popular programming
languages (including C/C++, Python, Go, Node.js, Rust, etc., but not Java),
you only need to call an existing function and specify the download source of
the source code. Nixpkgs will automatically detect the packaging system, pass
in correct parameters, and package it for you.</li>
<li>Nixpkgs also provides existing automated solutions for binary distributed
software (commonly seen in closed-source software):
<ul>
<li>One is Autopatchelf, which automatically modifies the library paths in the
binary, and points them to <code>/nix/store</code>.</li>
<li>The other is Bubblewrap, or <code>steam-run</code> based on Bubblewrap, that can
emulate an FHS-compliant environment. As the name suggests, <code>steam-run</code>
mainly focuses on the Steam gaming platform and the games on it, but it can
also be used for other closed-source software.</li>
</ul>
</li>
<li>Nix package manager run the packaging process in an isolated environment. You
can think of it as a Docker container, with no networking access, no
escalated privileges, and no access to filesystem except a few designated
ones. All attempts to access external paths or Internet will fail; the
compilation can only proceed with explicitly specified dependencies in the
Nix packaging script. Therefore, the packaged program is guaranteed to have
no dependency on external files.</li>
</ol>
<p>And the bad news are:</p>
<ol>
<li>
<p>Software developers may not know Linux better than packagers. Developers may
hardcode paths in codes and compilation scripts, and make assumptions that
are only true in FHS compliant environments. When this happens, you need to
write patches and fix the paths yourself, so the program can correctly
compile and run on NixOS.</p>
</li>
<li>
<p>When, for some reason, you cannot use an existing function, you need to
prepare yourself for a long debugging journey:</p>
<ul>
<li>Developer organized the source code in a strange way (like <code>osdlyrics</code>), or
used a non-standard compilation procedure</li>
<li>Program actively detects its execution environment (like WeChat for UOS)</li>
<li>Program actively detects changes to itself (like SVP video interpolation
software)</li>
</ul>
</li>
</ol>
<p>A few months ago, I replaced my daily driver distro from Arch Linux to NixOS,
and I&#39;ve packaged quite a few programs on NixOS. This post will explain the
packaging procedures in NixOS as well as frequent problems and solutions,
starting from the easier ones.</p>
<h1 id="preparation">Preparation</h1>
<p>First, I strongly recommend you to install NixOS and only package on NixOS.</p>
<ul>
<li>Although you can package software with Nix on non-NixOS operating systems, the
produced software may still have runtime dependencies on the FHS structure,
causing incompatibilities on NixOS. Of course, if you&#39;re only packaging for
yourself, and have no plan to share the packages, you can safely ignore this.</li>
<li>In addition, you need to use
<a href="https://github.com/nix-community/home-manager" rel="noopener noreferrer" target="_blank">Home-Manager</a>, a program that
manages config files in your Home directory with a Nix-language config file,
to install Nix-packaged software on a non-NixOS system. You need to do your
own research on how to use this program.</li>
</ul>
<h2 id="using-packaging-template-from-nur">Using Packaging Template from NUR</h2>
<p>NUR is a Nix software repository managed by individual users, similar to AUR of
Arch Linux. NUR provides a ready-to-use template that can be used to centrally
manage your packages.</p>
<p>Go to
<a href="https://github.com/nix-community/nur-packages-template" rel="noopener noreferrer" target="_blank">nur-packages-template</a>
on GitHub, click &quot;Use this template&quot; and create a repository. You will store all
your custom packages in that new repository.</p>
<blockquote>
<p>If you want to publish your packages to NUR, you need to send a Pull Request
to <a href="https://github.com/nix-community/NUR" rel="noopener noreferrer" target="_blank">NUR&#39;s main repository</a> and add the
URL to your own repository. However, even if you don&#39;t do that, you can still
use your own repository.</p>
</blockquote>
<p>Then, clone your repository.</p>
<ul>
<li>
<p>If you don&#39;t use Nix Flake, you can run the following command to build the
example package from the template:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">nix-build</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -A</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> example-package</span></span></code></pre>
</li>
<li>
<p>If you use Flake, you can run the following commands:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">nix</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> flake</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> update</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # Optional, update repositories in flake.lock to latest version</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">nix</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> build</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;.#example-package&quot;</span></span></code></pre>
</li>
</ul>
<p>Then, add your own repository in your NixOS config.</p>
<ul>
<li>
<p>If you don&#39;t use Nix Flake, add the following definitions to
<code>configuration.nix</code>:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">config</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">packageOverrides</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131"> =</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  myRepo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">import</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">builtins</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchTarball</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;https://github.com/nix-community/nur-packages-template/archive/master.tar.gz&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) {</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    inherit</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000"> pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">;</span></span></code></pre>
<p>Replace <code>https://github.com/nix-community/nur-packages-template</code> with your
repository URL.</p>
<p>Now you can use your own packages in the form of
<code>pkgs.myRepo.example-package</code>.</p>
</li>
<li>
<p>If you use Nix Flake, add the following definitions to the <code>inputs</code> section in
<code>flake.nix</code>:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">inputs</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131"> =</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # ...</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  myRepo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    url</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;github:nix-community/nur-packages-template&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">follows</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;nixpkgs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">;</span></span></code></pre>
<p>Replace <code>nix-community/nur-packages-template</code> with your repository URL.</p>
<p>Then, in the <code>output</code> section in <code>flake.nix</code>, for each of your
<code>nixosConfigurations</code> definition, add a module for the systems:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">outputs</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131"> =</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> { </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">self</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ... }@</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  nixosConfigurations</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;nixos&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixosSystem</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    system</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;x86_64-linux&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    modules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # Add the following lines at the beginning of modules</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      ({</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">        nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">overlays</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">          (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">final</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">prev</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">            myRepo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">myRepo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">packages</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">prev</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">system</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">          })</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        ];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      })</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # Add the preceding lines at the beginning of modules</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      ./configuration.nix</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    ];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">;</span></span></code></pre>
<p>Now you can use your own packages in the form of
<code>pkgs.myRepo.example-package</code>.</p>
</li>
</ul>
<h2 id="add-packages-straight-to-nixos-config">Add Packages Straight to NixOS Config</h2>
<p>Of course, instead of using the template from NUR, you can put your package
definitions along with your NixOS config files.</p>
<p>Assuming you have this packaging definition as <code>example-package.nix</code>: (From
<a href="https://github.com/nix-community/nur-packages-template/blob/master/pkgs/example-package/default.nix" rel="noopener noreferrer" target="_blank">https://github.com/nix-community/nur-packages-template/blob/master/pkgs/example-package/default.nix</a>)</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> }:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mkDerivation</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> rec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;example-package-</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">version</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;1.0&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  src</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">./.</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  buildPhase</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;echo echo Hello World &gt; example&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  installPhase</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;install -Dm755 example $out&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>You can use the <code>pkgs.callPackage</code> function to use it in <code>configuration.nix</code>:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">config</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ... }:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Use this package directly</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  environment</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">systemPackages</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">callPackage</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ./example-package.nix</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> { })</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Or define a constant for the package first</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  environment</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">systemPackages</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">let</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    examplePackage</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">callPackage</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ./example-package.nix</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> { };</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">  in</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> [</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    examplePackage</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>If you want to build just this package, you can use the following command:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">nix-build</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -E</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &#39;with import &lt;nixpkgs&gt; {}; callPackage ./example-package.nix {}&#39;</span></span></code></pre>
<h1 id="phases-in-packaging">Phases in Packaging</h1>
<p>Although you can
<a href="https://scrive.github.io/nix-workshop/04-derivations/04-raw-derivation.html" rel="noopener noreferrer" target="_blank">package directly with Nix package manager&#39;s <code>builtins.derivation</code> function</a>,
we usually use the <code>stdenv.mkDerivation</code> function to generate a Nix package
definition, since it&#39;s much easier. Contrary to <code>builtins.derivation</code>,
<code>stdenv.mkDerivation</code> splits the packaging process to 7 phases:</p>
<ol>
<li>
<p>Unpack phase</p>
<ul>
<li>
<p>In this step, <code>stdenv.mkDerivation</code> automatically unpacks the source code
archive specified by <code>src</code>. For example, if your archive is in <code>.tar.gz</code>
format, it automatically runs <code>tar xf</code>.</p>
</li>
<li>
<p>But <code>stdenv.mkDerivation</code> doesn&#39;t recognize all archive types, for example
<code>.zip</code>. In this case, you need to specify the unpack command yourself:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nativeBuildInputs</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131"> =</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> [ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">unzip</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ]</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">unpackPhase</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131"> =</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  unzip $src</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">;</span></span></code></pre>
</li>
<li>
<p><code>stdenv.mkDerivation</code> requires that the source code resides in a top-level
folder in the archive. It automatically <code>cd</code>s into that folder after
unpack.</p>
</li>
</ul>
</li>
<li>
<p>Patch phase</p>
<ul>
<li>In this step, <code>stdenv.mkDerivation</code> applies all <code>patches</code> in sequential
order. This can be used to fix the incompatibilities between some programs
and NixOS.</li>
</ul>
</li>
<li>
<p>Configure phase</p>
<ul>
<li>This is equivalent to running <code>./configure</code> or <code>cmake</code>.
<code>stdenv.mkDerivation</code> automatically detects the packaging system and calls
the appropriate commands, or, when no relevant config files exist,
automatically skips the phase.</li>
<li>It&#39;s worth noting that, to use <code>cmake</code>, you need to add an additional line
of <code>nativeBuildInputs = [ cmake ];</code> to add CMake into the packaging
environment.</li>
<li>You can add configuration parameters with <code>configureFlags</code> or <code>cmakeFlags</code>,
to enable or disable functionalities of the program.</li>
</ul>
</li>
<li>
<p>Build phase</p>
<ul>
<li>This is equivalent to running <code>make</code>. You can specify the arguments to
<code>make</code> with <code>makeFlags</code>.</li>
</ul>
</li>
<li>
<p>Check phase</p>
<ul>
<li>This phase executes the unit tests in the source directory, to ensure that
the program functions correctly.</li>
<li>You can skip this step with <code>doCheck = false;</code>.</li>
</ul>
</li>
<li>
<p>Install phase</p>
<ul>
<li>This is equivalent to running <code>make install</code>, which copies the compilation
results to the relevant folder in Nix store.</li>
<li>The whole building process happens in a temporary folder, rather than in
Nix store. Therefore, such a copy is necessary.</li>
<li>When you specify the installation commands yourself, the target path is
stored in variable <code>$out</code>. <code>$out</code> can be either a directory containing
files, or simply a file.</li>
</ul>
</li>
<li>
<p>Fixup phase</p>
<ul>
<li>This step cleans up the results in Nix store by, for example, stripping
debug symbols.</li>
<li>Autopatchelf Hook, a hook that automatically replaces <code>.so</code> paths for
closed-source programs, is executed in this step.</li>
<li>You can disable this step with <code>dontFixup = true;</code>.</li>
</ul>
</li>
</ol>
<p>For each phase, the command to be executed, or the pre/post command hooks, can
be specified. Take the install phase for example:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">preInstall</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131"> =</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  echo Here are the commands executed before installPhase</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">installPhase</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131"> =</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  # Run preInstall commands. Included in the default installPhase, but not in your specified one. You need to add this yourself, or preInstall won&#39;t run</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  runHook preInstall</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  echo Here are the commands for installPhase</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  # Run postInstall commands, same as above</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  runHook postInstall</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">postInstall</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131"> =</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  echo Here are the commands executed after installPhase</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span><span style="--shiki-dark:#F44747;--shiki-light:#CD3131">;</span></span></code></pre>
<p>It might be hard to understand the steps just by reading their definitions, so I
will give a few examples with detailed explanations. In addition, I will also
show a few specific functions for popular programming languages, like
<code>buildPythonPackage</code> for Python and <code>buildGoModule</code> for Go. All the examples are
from <a href="https://github.com/xddxdd/nur-packages" rel="noopener noreferrer" target="_blank">my NUR repository</a>.</p>
<h1 id="examples-open-source-software">Examples: Open Source Software</h1>
<p>Packaging open source software tends to be easy, since in the process, Nix
package manager will adjust the environment variables so that the compiler can
find the libraries in other directories in Nix store. Therefore, all generated
binary files are linked to libraries in Nix store, rather than ones in <code>/usr</code> or
similar paths, so they can be used directly on NixOS. In addition, even if a
hardcoded path appears in the open source software, you can change the path by
creating a patch in the packaging process, to make it work on NixOS.</p>
<h2 id="easy-liboqs-c-cmake-automated">Easy: LibOQS (C++, CMake, Automated)</h2>
<p>Let&#39;s take a look at the most simple one: LibOQS.
<a href="https://github.com/open-quantum-safe/liboqs" rel="noopener noreferrer" target="_blank">LibOQS provides implementations for various post-quantum cryptography, and can be used for post-quantum support for OpenSSL or BoringSSL</a>.</p>
<p>Since LibOQS is built by CMake and has no dependencies itself, almost all the
work can be automatically done by <code>stdenv.mkDerivations</code>. All we need to do is
to specify a few extra arguments for CMake:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># When you use pkgs.callPackage, parameters here will be filled with packages from Nixpkgs (if there&#39;s a match)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchFromGitHub</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">cmake</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">} @ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">args</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mkDerivation</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> rec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Specify package name and version</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  pname</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;liboqs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;0.7.1&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Download source code from GitHub</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  src</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchFromGitHub</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ({</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    owner</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;open-quantum-safe&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    repo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;liboqs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Commit or tag, note that fetchFromGitHub cannot follow a branch!</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    rev</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;0.7.1&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Download git submodules, most packages don&#39;t need this</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    fetchSubmodules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Don&#39;t know how to calculate the SHA256 here? Comment it out and build the package</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Nix will raise an error and show the correct hash</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    sha256</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;sha256-m20M4+3zsH40hTpMJG9cyIjXp0xcCUBS+cCiRVLXFqM=&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Parallel building, drastically speeds up packaging, enabled by default.</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # You only want to turn this off for one of the rare packages that fails with this.</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  enableParallelBuilding</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # If you encounter some weird error when packaging CMake-based software, try enabling this</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # This disables some automatic fixes applied to CMake-based software</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  dontFixCmake</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Add CMake to the building environment, to generate Makefile with it</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  nativeBuildInputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">cmake</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Arguments to CMake that controls functionalities of liboqs</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  cmakeFlags</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &quot;-DBUILD_SHARED_LIBS=ON&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &quot;-DOQS_BUILD_ONLY_LIB=1&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &quot;-DOQS_USE_OPENSSL=OFF&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &quot;-DOQS_DIST_BUILD=ON&quot;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # stdenv.mkDerivation automatically does the rest for you</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>Then run the following command. Nix package manager will build the package
automatically, and link the output to <code>results</code> in the current directory.</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">nix-build</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -E</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &#39;with import &lt;nixpkgs&gt; {}; callPackage ./liboqs.nix {}&#39;</span></span></code></pre>
<h2 id="medium-openssl-oqs-provider-c-has-dependencies">Medium: OpenSSL OQS Provider (C, Has Dependencies)</h2>
<p>With LibOQS ready, we can package
<a href="https://github.com/open-quantum-safe/oqs-provider" rel="noopener noreferrer" target="_blank">OpenSSL OQS Provider, an encryption/decryption engine for OpenSSL 3.0 that adds post-quantum cryptography</a>.</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchFromGitHub</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">cmake</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">liboqs</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">openssl_3_0</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">python3</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">} @ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">args</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mkDerivation</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> rec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  pname</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;openssl-oqs-provider&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;ec60cde5cc894814016f821a1162fe1a4b888a75&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  src</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchFromGitHub</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ({</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    owner</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;open-quantum-safe&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    repo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;oqs-provider&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    rev</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;ec60cde5cc894814016f821a1162fe1a4b888a75&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    fetchSubmodules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    sha256</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;sha256-NyT5CpQeclSJ0b4Qr4McAJXwKgy6SWiUijkAgu6TTNM=&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  enableParallelBuilding</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  dontFixCmake</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # nativeBuildInputs specifies packages used only during packaging rather than execution</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Like CMake for generating Makefile, and Python for generating config files</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  nativeBuildInputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    cmake</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Add Python and a few packages, to be used by preConfigure</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">python3</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">withPackages</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">p</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">with</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> p</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">; [ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">jinja2</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> pyyaml</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> tabulate</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ]))</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # buildInputs specifies packages used during execution</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  buildInputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    liboqs</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    openssl_3_0</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Commands run before the configure phase, enable all post-quantum algorithms</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  preConfigure</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    cp </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">sources</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">openssl-oqs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">src</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/oqs-template/generate.yml oqs-template/generate.yml</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    sed -i &quot;s/enable: false/enable: true/g&quot; oqs-template/generate.yml</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    LIBOQS_SRC_DIR=</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">sources</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">liboqs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">src</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> python oqs-template/generate.py</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  cmakeFlags</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [ </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;-DCMAKE_BUILD_TYPE=Release&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Manually specified installation commands, copy oqsprovider.so to $out/lib</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Usually executables reside in $out/bin, libraries in $out/lib, and application menus in $out/share</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # That&#39;s not a requirement. You can put them wherever you want in $out</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # But it could be more difficult to use them from other places</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  installPhase</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    mkdir -p $out/lib</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    install -m755 oqsprov/oqsprovider.so &quot;$out/lib&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>This package mainly demonstrates the difference between <code>nativeBuildInputs</code> and
<code>buildInputs</code>:</p>
<ul>
<li><code>nativeBuildInputs</code> are only used during packaging. They&#39;re usually used to
generate config files or compilation scripts. During cross compilation
(compiling for a device of another architecture), <code>nativeBuildInputs</code> will
have the same architecture as the device running the build, rather than the
target device. For example, if you&#39;re building for ARM Raspberry Pi on a x86
PC, <code>nativeBuildInputs</code> will have architecture x86.</li>
<li><code>buildInputs</code> are used both in packaging and in program execution. All
dependent libraries go in here. These dependencies have the same architecture
as the target device. As an example, <code>liboqs</code> required by
<code>openssl-oqs-provider</code> must have the same architecture (both x86 or both ARM).</li>
</ul>
<h2 id="hard-osdlyrics-python--c-two-stage-build">Hard: OSDLyrics (Python &amp; C++, Two-Stage Build)</h2>
<p>Next, let&#39;s take a look at
<a href="https://github.com/osdlyrics/osdlyrics" rel="noopener noreferrer" target="_blank">OSDLyrics, a desktop lyrics software</a>.
On the first glance, this software is easy to package, as the official
installation instruction is only four lines:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">./autogen.sh</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">./configure</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> --prefix=/usr</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> PYTHON=/usr/bin/python3</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">make</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sudo</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> make</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> install</span></span></code></pre>
<p>However, things become more difficult as Python is involved in compilation.
OSDLyrics consists of two parts, Python and C++, and the C++ part will call the
Python libraries. As the result, the official installation script will copy the
Python module to Python&#39;s <code>site-packages</code> directory. But since Python&#39;s
installation directory is read only for OSDLyrics on Nix, the installation
cannot proceed.</p>
<p>Therefore, we need to package the Python module independently:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">python3Packages</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchFromGitHub</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">writeText</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">python3Packages</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">buildPythonPackage</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> rec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  pname</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;osdlyrics&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;0.5.10&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  src</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchFromGitHub</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ({</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    owner</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;osdlyrics&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    repo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;osdlyrics&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    rev</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;0.5.10&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    fetchSubmodules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    sha256</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;sha256-x9gIT1JkfPIc4RmmQJLv9rOG2WqAftoTK5uiRlS65zU=&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  configurePhase</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> =</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    let</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # The original Python module doesn&#39;t comply with PIP&#39;s packaging standards</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # Need to add these two config files</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      setupPy</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">writeText</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;setup.py&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        from setuptools import setup, find_packages</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        setup(</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">          name=&#39;</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pname</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;,</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">          version=&#39;</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">version</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;,</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">          packages=[&#39;osdlyrics&#39;, &#39;osdlyrics/dbusext&#39;],</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        )</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      initPy</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">writeText</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;__init__.py&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        PROGRAM_NAME = &#39;OSD Lyrics&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        PACKAGE_NAME = &#39;</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pname</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        PACKAGE_VERSION = &#39;</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">version</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    in</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Rename the Python module folder &amp; add configs to adhere to standards</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      ln -s </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">setupPy</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> setup.py</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      mv python osdlyrics</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      ln -s </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">initPy</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> osdlyrics/__init__.py</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Disable tests, there aren&#39;t any in the source code</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  doCheck</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>Then add the module to the Python environment used by OSDLyrics:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">python3Packages</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchFromGitHub</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">writeText</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">python3</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">let</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  osdlyricsPython</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">python3Packages</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">buildPythonPackage</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> rec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # These packages are needed by OSDLyrics</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  python</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">python3</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">withPackages</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">p</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">with</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> p</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">; [</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    chardet</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    dbus-python</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    future</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    mpd2</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    osdlyricsPython</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    pycurl</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    pygobject3</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ]);</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">in</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># ...</span></span></code></pre>
<p>Finally, package its C++ part:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ ... }:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">let</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># ...</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">in</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mkDerivation</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> rec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  pname</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;osdlyrics&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;0.5.10&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  src</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchFromGitHub</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ({</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    owner</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;osdlyrics&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    repo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;osdlyrics&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    rev</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;0.5.10&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    fetchSubmodules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    sha256</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;sha256-x9gIT1JkfPIc4RmmQJLv9rOG2WqAftoTK5uiRlS65zU=&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  nativeBuildInputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Automatically run autoconf, same as autogen.sh</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    autoreconfHook</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Tool to generate language files</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    intltool</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # pkgconfig, used by autoconf scripts to search for dependencies</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    pkg-config</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Dependencies of C++ part</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  buildInputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    dbus-glib</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    gtk2</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    libnotify</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Note that this Python is the one defined above, with a few extra modules</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    python</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Fix some compilation errors</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  postPatch</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    sed -i &#39;s/-Werror//g&#39; configure.ac</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # autoreconfHook adds an autoreconf phase to packaging, with its own pre/post hooks</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  preAutoreconf</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    export AUTOPOINT=intltoolize</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Use the Python with extra modules</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  makeFlags</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [ </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;PYTHON=</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">python</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/bin/python&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Remove Python modules from output (already packaged)</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  postInstall</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    rm -rf $out/lib/python*</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>The final complete definition is:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchFromGitHub</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">writeText</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">python3Packages</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # nativeBuildInputs</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">autoreconfHook</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">intltool</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkg-config</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # buildInputs</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">dbus-glib</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gtk2</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libnotify</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">python3</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">} @ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">args</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">let</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  pname</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;osdlyrics&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;0.5.10&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  src</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchFromGitHub</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ({</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    owner</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;osdlyrics&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    repo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;osdlyrics&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    rev</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;0.5.10&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    fetchSubmodules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    sha256</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;sha256-x9gIT1JkfPIc4RmmQJLv9rOG2WqAftoTK5uiRlS65zU=&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  osdlyricsPython</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">python3Packages</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">buildPythonPackage</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> rec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    inherit</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000"> pname</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000"> version</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000"> src</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    configurePhase</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> =</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">      let</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">        setupPy</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">writeText</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;setup.py&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">          from setuptools import setup, find_packages</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">          setup(</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">            name=&#39;</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pname</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;,</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">            version=&#39;</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">version</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;,</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">            packages=[&#39;osdlyrics&#39;, &#39;osdlyrics/dbusext&#39;],</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">          )</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">        initPy</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">writeText</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;__init__.py&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">          PROGRAM_NAME = &#39;OSD Lyrics&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">          PACKAGE_NAME = &#39;</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pname</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">          PACKAGE_VERSION = &#39;</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">version</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">      in</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      &#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        ln -s </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">setupPy</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> setup.py</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        mv python osdlyrics</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        ln -s </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">initPy</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> osdlyrics/__init__.py</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    doCheck</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  python</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">python3</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">withPackages</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">p</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">with</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> p</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">; [</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    chardet</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    dbus-python</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    future</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    mpd2</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    osdlyricsPython</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    pycurl</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    pygobject3</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ]);</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">in</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mkDerivation</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> rec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">  inherit</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000"> pname</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000"> version</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000"> src</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  nativeBuildInputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    autoreconfHook</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    intltool</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    pkg-config</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  buildInputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    dbus-glib</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    gtk2</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    libnotify</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    python</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  postPatch</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    sed -i &#39;s/-Werror//g&#39; configure.ac</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  preAutoreconf</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    export AUTOPOINT=intltoolize</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  makeFlags</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [ </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;PYTHON=</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">python</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/bin/python&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  postInstall</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    rm -rf $out/lib/python*</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<h1 id="examples-closed-source-software--binary-distributed-ones">Examples: Closed Source Software (&amp; Binary Distributed Ones)</h1>
<p>Compared to open source software, packaging closed source ones tend to be more
difficult. These closed source software usually distribute only the binary
files, which are compiled for those traditional Linux distros adhering to FHS
standard directory structures, like CentOS, Debian, Ubuntu, etc. As we don&#39;t
have the source code, we can only modify the binary files, replacing all the FHS
standard paths with ones from Nix store.</p>
<p>Fortunately, Nixpkgs provides a number of schemes for different scenarios, and
many closed source software can be packaged successfully.</p>
<h2 id="easy-bilibili-linux-unpack-deb-electron">Easy: Bilibili-linux (Unpack DEB, Electron)</h2>
<p>Let&#39;s take a look at an easy scenario: Electron based software. Here I use the
example of
<a href="https://github.com/msojocs/bilibili-linux" rel="noopener noreferrer" target="_blank">Bilibili-linux, the official Bilibili Windows desktop client ported to Linux</a>.</p>
<p>Although compared to traditional GTK or Qt programs, Electron programs consume
more power and disk space, and install dozens of Chromiums in each and every PC,
resulting in a market share of over 1000%, their ease of porting should not be
ignored. The Bilibili-linux client is implemented in pure Javascript, and
there&#39;s no binary files in the package, except for Electron. Therefore, we can
take its Javascript code, and simply run it with the system-wide Electron.</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchurl</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">electron</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">makeWrapper</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">} @ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">args</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">################################################################################</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Mostly based on bilibili-bin package from AUR:</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># https://aur.archlinux.org/packages/bilibili-bin</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">################################################################################</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mkDerivation</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> rec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  pname</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;bilibili&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;1.2.1-1&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  src</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchurl</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    url</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;https://github.com/msojocs/bilibili-linux/releases/download/v1.2.1-1/io.github.msojocs.bilibili_1.2.1-1_amd64.deb&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    sha256</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;sha256-t/igezm0ipkOkKION8qTYGK9f6qI3c4iPuS/wWrMywQ=&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Unpack DEB package</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  unpackPhase</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    ar x </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">src</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    tar xf data.tar.xz</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # makeWrapper generates a command that calls another command (aka wrapper),</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # that modifies parameters and environment variables based on the original ones</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  buildInputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">makeWrapper</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  installPhase</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    mkdir -p $out/bin</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # Replace paths in application menu (desktop files)</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    cp -r usr/share $out/share</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    sed -i &quot;s|Exec=.*|Exec=$out/bin/bilibili|&quot; $out/share/applications/*.desktop</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # Copy out the client&#39;s Javascript parts and ignore the rest</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    cp -r opt/apps/io.github.msojocs.bilibili/files/bin/app $out/opt</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # Creates bilibili command that loads the client&#39;s Javascript package with electron ($out/opt/app.asar)</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    makeWrapper </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">electron</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/bin/electron $out/bin/bilibili \</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      --argv0 &quot;bilibili&quot; \</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      --add-flags &quot;$out/opt/app.asar&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<h2 id="medium-dingtalk-auto-patch-binaries-finding-dependencies">Medium: DingTalk (Auto Patch Binaries, Finding Dependencies)</h2>
<p>Of course, not all closed source software are built with Electron. For the ones
with binary files, we need to modify them by changing all the dependent library
paths to ones in Nix store. Nixpkgs offers an easy-to-use tool called
<code>autoPatchelfHook</code>, that searches for all the binaries in the package, modifies
them all. It will error out when a dependency isn&#39;t met, which is useful for
debugging.</p>
<p>Our example this time will be the Linux client for DingTalk. It uses GTK as its
UI framework. Since we have no idea of its dependencies, we first create a
packaging template:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchurl</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">autoPatchelfHook</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">makeWrapper</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">callPackage</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">} @ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">args</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">################################################################################</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Mostly based on dingtalk-bin package from AUR:</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># https://aur.archlinux.org/packages/dingtalk-bin</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">################################################################################</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mkDerivation</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> rec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  pname</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;dingtalk&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;1.4.0.20425&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  src</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchurl</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    url</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;https://dtapp-pub.dingtalk.com/dingtalk-desktop/xc_dingtalk_update/linux_deb/Release/com.alibabainc.dingtalk_</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">version</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">_amd64.deb&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    sha256</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;sha256-UKkFuuFK/Ae+XIWbPYYsqwS/FOJfOqm9e1i18JB8UfA=&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # autoPatchelfHook automatically patches binaries</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  nativeBuildInputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">autoPatchelfHook</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> makeWrapper</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  unpackPhase</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    ar x </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">src</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    tar xf data.tar.xz</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    mv opt/apps/com.alibabainc.dingtalk/files/version version</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    mv opt/apps/com.alibabainc.dingtalk/files/*-Release.* release</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # Remove libraries that can be replaced with system ones, and useless EXEs</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    rm -rf release/Resources/{i18n/tool/*.exe,qss/mac}</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    rm -f release/{*.a,*.la,*.prl}</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    rm -f release/dingtalk_updater</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    rm -f release/libgtk-x11-2.0.so.*</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    rm -f release/libm.so.*</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  installPhase</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    mkdir -p $out</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    mv version $out/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # Some libraries must be the same ones from the package</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    mv release $out/lib</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # The desktop file and icon is obtained from AUR</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    mkdir -p $out/share/applications $out/share/pixmaps</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    ln -s </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">./dingtalk.desktop</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> $out/share/applications/dingtalk.desktop</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    ln -s </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">./dingtalk.png</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> $out/share/pixmaps/dingtalk.png</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>Then we try to build the package. It fails, as expected:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">&gt; auto-patchelf failed to find all the required dependencies.</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">&gt; Add the missing dependencies to --libs or use </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">`</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">--ignore-missing</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">=</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;foo.so.1 bar.so etc.so&quot;`</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">.</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">For</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> full</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> logs,</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> run</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &#39;nix log /nix/store/gm3d0jm6l19ypcz6vfmv5hmx8d9iygr1-dingtalk-1.4.0.20425.drv&#39;.</span></span></code></pre>
<p>Let&#39;s run the command above to see the complete log:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># ...</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">error:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> auto-patchelf</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> could</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> not</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> satisfy</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> dependency</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> libX11.so.6</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> wanted</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> by</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /nix/store/w179pb9w545rwnhvv0kkcjvra0gv82sp-dingtalk-1.4.0.20425/lib/cefclient</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">error:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> auto-patchelf</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> could</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> not</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> satisfy</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> dependency</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> libgtk-x11-2.0.so.0</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> wanted</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> by</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /nix/store/w179pb9w545rwnhvv0kkcjvra0gv82sp-dingtalk-1.4.0.20425/lib/cefclie</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">nt</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">error:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> auto-patchelf</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> could</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> not</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> satisfy</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> dependency</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> libgdk_pixbuf-2.0.so.0</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> wanted</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> by</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /nix/store/w179pb9w545rwnhvv0kkcjvra0gv82sp-dingtalk-1.4.0.20425/lib/cefc</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">lient</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">error:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> auto-patchelf</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> could</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> not</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> satisfy</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> dependency</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> libgobject-2.0.so.0</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> wanted</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> by</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /nix/store/w179pb9w545rwnhvv0kkcjvra0gv82sp-dingtalk-1.4.0.20425/lib/cefclie</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">nt</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">error:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> auto-patchelf</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> could</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> not</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> satisfy</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> dependency</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> libglib-2.0.so.0</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> wanted</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> by</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /nix/store/w179pb9w545rwnhvv0kkcjvra0gv82sp-dingtalk-1.4.0.20425/lib/cefclient</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># ...</span></span></code></pre>
<p><code>autoPatchelf</code> already listed all missing libraries, and we need to find the
relevant packages one by one, and add them to the <code>buildInputs</code> of the package.
You can search for packages on <a href="https://search.nixos.org/packages" rel="noopener noreferrer" target="_blank">NixOS Search</a>
based on your experience, or use
<a href="https://github.com/bennofs/nix-index" rel="noopener noreferrer" target="_blank">nix-index, a tool to search for packages with filenames</a>,
to speed up the process.</p>
<p>After all dependencies are met, the definition for DingTalk looks like:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchurl</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">autoPatchelfHook</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">makeWrapper</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">callPackage</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # DingTalk dependencies</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">alsa-lib</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">at-spi2-atk</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">at-spi2-core</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">cairo</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">cups</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">dbus</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">e2fsprogs</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gdk-pixbuf</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">glib</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gnutls</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">graphite2</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gtk2</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">krb5</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libdrm</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libgcrypt</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libGLU</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libpulseaudio</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libthai</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libxkbcommon</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mesa_drivers</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nspr</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nss</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">rtmpdump</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">udev</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">util-linux</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">xorg</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">} @ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">args</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">################################################################################</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Mostly based on dingtalk-bin package from AUR:</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># https://aur.archlinux.org/packages/dingtalk-bin</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">################################################################################</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">let</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;1.4.0.20425&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Dingtalk relies on an older version of OpenLDAP</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # openldap-2_4.nix can be found in my NUR</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  openldap</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">callPackage</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ./openldap-2_4.nix</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> { };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  libraries</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    alsa-lib</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    at-spi2-atk</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    at-spi2-core</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    cairo</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    cups</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    dbus</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    e2fsprogs</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    gdk-pixbuf</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    glib</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    gnutls</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    graphite2</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    gtk2</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    krb5</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    libdrm</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    libgcrypt</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    libGLU</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    libpulseaudio</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    libthai</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    libxkbcommon</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    mesa_drivers</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    nspr</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    nss</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    openldap</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    rtmpdump</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    udev</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    util-linux</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    xorg</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libICE</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    xorg</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libSM</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    xorg</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libX11</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    xorg</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libxcb</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    xorg</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libXcomposite</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    xorg</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libXcursor</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    xorg</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libXdamage</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    xorg</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libXext</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    xorg</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libXfixes</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    xorg</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libXi</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    xorg</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libXinerama</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    xorg</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libXmu</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    xorg</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libXrandr</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    xorg</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libXrender</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    xorg</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libXScrnSaver</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    xorg</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libXt</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    xorg</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libXtst</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">in</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mkDerivation</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> rec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  pname</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;dingtalk&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">  inherit</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000"> version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  src</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchurl</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    url</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;https://dtapp-pub.dingtalk.com/dingtalk-desktop/xc_dingtalk_update/linux_deb/Release/com.alibabainc.dingtalk_</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">version</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">_amd64.deb&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    sha256</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;sha256-UKkFuuFK/Ae+XIWbPYYsqwS/FOJfOqm9e1i18JB8UfA=&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  nativeBuildInputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">autoPatchelfHook</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> makeWrapper</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  buildInputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libraries</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  unpackPhase</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    ar x </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">src</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    tar xf data.tar.xz</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    mv opt/apps/com.alibabainc.dingtalk/files/version version</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    mv opt/apps/com.alibabainc.dingtalk/files/*-Release.* release</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # Cleanup</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    rm -rf release/Resources/{i18n/tool/*.exe,qss/mac}</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    rm -f release/{*.a,*.la,*.prl}</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    rm -f release/dingtalk_updater</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    rm -f release/libgtk-x11-2.0.so.*</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    rm -f release/libm.so.*</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  installPhase</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    mkdir -p $out</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    mv version $out/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # Move libraries</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # DingTalk relies on (some of) the exact libraries it ships with</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    mv release $out/lib</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # Entrypoint</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    mkdir -p $out/bin</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # Dingtalk dynamically loads libraries during execution, so all dependencies</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # should be listed on LD_LIBRARY_PATH so they can be found</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    makeWrapper $out/lib/com.alibabainc.dingtalk $out/bin/dingtalk \</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      --argv0 &quot;com.alibabainc.dingtalk&quot; \</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      --prefix LD_LIBRARY_PATH : &quot;</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">makeLibraryPath</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> libraries</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # App Menu</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    mkdir -p $out/share/applications $out/share/pixmaps</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    ln -s </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">./dingtalk.desktop</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> $out/share/applications/dingtalk.desktop</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    ln -s </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">./dingtalk.png</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> $out/share/pixmaps/dingtalk.png</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<h2 id="hard-svp-integrity-check-bubblewrap">Hard: SVP (Integrity Check, Bubblewrap)</h2>
<p>Although some closed source software like dingtalk are troublesome to package,
requiring manually searching for all dependencies and repeated testing, the
software itself will not create more obstacles for you. Other closed source
ones, to avoid being cracked, will check their own integrities, and refuse to
start if their binary files are ever changed.
<a href="https://www.svp-team.com/get/" rel="noopener noreferrer" target="_blank">SVP video interpolation software</a>, for example,
is one of them.</p>
<p><code>autoPatchelfHook</code> is a no-no for such software. We have to switch to another
way, by creating a FHS-compliant virtual environment, placing all libraries in
the correct paths, and starting the program in this environment. The most
commonly used software for this purpose is
<a href="https://github.com/containers/bubblewrap" rel="noopener noreferrer" target="_blank">Bubblewrap</a>. It&#39;s originally designed
to sandbox programs from sensitive data, but that sandbox can be the virtual
environment we need today.</p>
<p>Let&#39;s get straight to the packaging definition of SVP:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">bubblewrap</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchurl</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # All dependencies of SVP</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">ffmpeg</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">glibc</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">gnome</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libmediainfo</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libsForQt5</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libusb1</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lsof</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">makeWrapper</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mpv-unwrapped</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # NVIDIA driver, SVP needs a library to support accelerated Optical Flow</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Users need to override this to their driver version on systems with NVIDIA</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # or set it to null on systems without NVIDIA</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nvidia_x11</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ? </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">null</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">ocl-icd</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">p7zip</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">patchelf</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">vapoursynth</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">wrapMpv</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">writeShellScript</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">writeText</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">xdg-utils</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">xorg</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">################################################################################</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Based on svp package from AUR:</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># https://aur.archlinux.org/packages/svp</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">################################################################################</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">let</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Package a MPV with NVIDIA Optical Flow and Vapoursynth video processing engine</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  mpvForSVP</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">wrapMpv</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mpv-unwrapped</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">override</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      vapoursynthSupport</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    })</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      extraMakeWrapperArgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">optionals</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nvidia_x11</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> != </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">null</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        &quot;--prefix&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        &quot;LD_LIBRARY_PATH&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        &quot;:&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        &quot;</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">makeLibraryPath</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000FF"> [ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nvidia_x11</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000FF"> ]</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      ];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Dependencies of the main SVP program</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  libPath</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">makeLibraryPath</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> [</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    libsForQt5</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">qtbase</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    libsForQt5</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">qtdeclarative</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    libsForQt5</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">qtscript</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    libsForQt5</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">qtsvg</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    libmediainfo</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    libusb1</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    xorg</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libX11</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    stdenv</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">cc</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">cc</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    ocl-icd</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    vapoursynth</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # SVP&#39;s executable lookup paths (aka PATH environment variable)</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  execPath</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">makeBinPath</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> [</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    ffmpeg</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">bin</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    gnome</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">zenity</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    lsof</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    xdg-utils</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  svp-dist</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mkDerivation</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> rec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    pname</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;svp-dist&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;4.5.210&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    src</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchurl</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      url</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;https://www.svp-team.com/files/svp4-linux.</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">version</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">-1.tar.bz2&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      sha256</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;10q8r401wg81vanwxd7v07qrh3w70gdhgv5vmvymai0flndm63cl&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    nativeBuildInputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">p7zip</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> patchelf</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Disable fixup phase, it modifies SVP binary and breaks integrity check</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    dontFixup</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Decompression and installation steps from AUR: https://aur.archlinux.org/packages/svp-bin</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    unpackPhase</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      tar xf </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">src</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    buildPhase</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      mkdir installer</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      LANG=C grep --only-matching --byte-offset --binary --text  $&#39;7z\xBC\xAF\x27\x1C&#39; &quot;svp4-linux-64.run&quot; |</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        cut -f1 -d: |</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        while read ofs; do dd if=&quot;svp4-linux-64.run&quot; bs=1M iflag=skip_bytes status=none skip=$ofs of=&quot;installer/bin-$ofs.7z&quot;; done</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    installPhase</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      mkdir -p $out/opt</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      for f in &quot;installer/&quot;*.7z; do</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        7z -bd -bb0 -y x -o&quot;$out/opt/&quot; &quot;$f&quot; || true</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      done</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      for SIZE in 32 48 64 128; do</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        mkdir -p &quot;$out/share/icons/hicolor/</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">&#39;&#39;$</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">{SIZE}x</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">&#39;&#39;$</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">{SIZE}/apps&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        mv &quot;$out/opt/svp-manager4-</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">&#39;&#39;$</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">{SIZE}.png&quot; &quot;$out/share/icons/hicolor/</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">&#39;&#39;$</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">{SIZE}x</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">&#39;&#39;$</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">{SIZE}/apps/svp-manager4.png&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      done</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      rm -f $out/opt/{add,remove}-menuitem.sh</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Create a startup script with Bubblewrap</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  startScript</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">writeShellScript</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;SVPManager&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # Map all paths under root to the virtual environment except these paths</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # They&#39;re still mapped, but with finer granularity rules</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    blacklist=(/nix /dev /usr /lib /lib64 /proc)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    declare -a auto_mounts</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # loop through all directories in the root</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    for dir in /*; do</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      # if it is a directory and it is not in the blacklist</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      if [[ -d &quot;$dir&quot; ]] &amp;&amp; [[ ! &quot;</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">&#39;&#39;$</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">{blacklist[@]}&quot; =~ &quot;$dir&quot; ]]; then</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        # add it to the mount list</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        auto_mounts+=(--bind &quot;$dir&quot; &quot;$dir&quot;)</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      fi</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    done</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # Bubblewrap startup scripts</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    cmd=(</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">      ${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">bubblewrap</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/bin/bwrap</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      # /dev must be mapped with special parameters</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      --dev-bind /dev /dev</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      # Switch to the current directory in the virtual environment</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      --chdir &quot;$(pwd)&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      # Kill all processes in virtual environment when Bubblewrap exits</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      --die-with-parent</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      # /nix is mapped read-only</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      --ro-bind /nix /nix</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      # /proc must be mapped with special parameters</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      --proc /proc</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      # Put Glibc to /lib &amp; /lib64 so SVP can load them</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      --bind </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">glibc</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/lib /lib</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      --bind </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">glibc</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/lib /lib64</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      # Commands used by SVP, path hardcoded to /usr/bin in SVP</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      --bind /usr/bin/env /usr/bin/env</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      --bind </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">ffmpeg</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">bin</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/bin/ffmpeg /usr/bin/ffmpeg</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      --bind </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lsof</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/bin/lsof /usr/bin/lsof</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      # Setup environment variables, including executable and library search paths</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      --setenv PATH &quot;</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">execPath</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">:</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">&#39;&#39;$</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">{PATH}&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      --setenv LD_LIBRARY_PATH &quot;</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">libPath</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">:</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">&#39;&#39;$</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">{LD_LIBRARY_PATH}&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      # Map the MPV player packaged for SVP</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      --symlink </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mpvForSVP</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/bin/mpv /usr/bin/mpv</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      # Map other paths under root</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      &quot;</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">&#39;&#39;$</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">{auto_mounts[@]}&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      # Run main SVP program once virtual environment starts</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">      ${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">svp-dist</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/opt/SVPManager &quot;$@&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    )</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    exec &quot;</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">&#39;&#39;$</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">{cmd[@]}&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # SVP application menu item</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  desktopFile</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">writeText</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;svp-manager4.desktop&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    [Desktop Entry]</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    Version=1.0</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    Encoding=UTF-8</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    Name=SVP 4 Linux</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    GenericName=Real time frame interpolation</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    Type=Application</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    Categories=Multimedia;AudioVideo;Player;Video;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    MimeType=video/x-msvideo;video/x-matroska;video/webm;video/mpeg;video/mp4;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    Terminal=false</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    StartupNotify=true</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    Exec=</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">startScript</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> %f</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    Icon=svp-manager4.png</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">in</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Create a simple package with only startup script and menu item</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mkDerivation</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  pname</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;svp&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">  inherit</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">svp-dist</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  phases</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [ </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;installPhase&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  installPhase</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    mkdir -p $out/bin $out/share/applications</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    ln -s </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">startScript</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> $out/bin/SVPManager</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    ln -s </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">desktopFile</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> $out/share/applications/svp-manager4.desktop</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    ln -s </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">svp-dist</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/share/icons $out/share/icons</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<h2 id="hard-wechat-uos-environment-check-steam-run">Hard: WeChat-UOS (Environment Check, Steam-run)</h2>
<p>Another program that checks its execution environment is WeChat client for UOS.
Although it&#39;s just an Electron app and should be easy to package, it comes with
a library that checks UOS license files. If the check fails, you won&#39;t be able
to login. Therefore, we still need to create a virtual environment and put the
license files in the correct locations, so that we can use WeChat.</p>
<p>Here I demonstrate another simple packaging tool: <code>steam-run</code>. <code>steam-run</code> calls
Bubblewrap internally, but as its name suggests, it&#39;s originally built for the
Steam client and all the games on Steam, so it includes quite a few commonly
used libraries in its default environment, and therefore can run many closed
source programs.</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchurl</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">writeShellScript</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">electron</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">steam</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">scrot</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">} @ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">args</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">################################################################################</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Mostly based on wechat-uos package from AUR:</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># https://aur.archlinux.org/packages/wechat-uos</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">################################################################################</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">let</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;2.1.4&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # UOS license files obtained from AUR: https://aur.archlinux.org/packages/wechat-uos</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  license</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mkDerivation</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> rec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    pname</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;wechat-uos-license&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;0.0.1&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    src</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">./license.tar.gz</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    installPhase</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      mkdir -p $out</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      cp -r etc var $out/</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # WeChat package, only keep Javascript and necessary libraries just like Bilibili client</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  resource</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mkDerivation</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> rec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    pname</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;wechat-uos-resource&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    inherit</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000"> version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    src</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchurl</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      url</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;https://home-store-packages.uniontech.com/appstore/pool/appstore/c/com.tencent.weixin/com.tencent.weixin_</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">version</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">_amd64.deb&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      sha256</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;sha256-V74m+dFK9/f0QoHfvIjk7hyIil6FpV9HGkPqwJLvQhM=&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    unpackPhase</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      ar x </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">src</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    installPhase</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      mkdir -p $out</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      tar xf data.tar.xz -C $out</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      mv $out/usr/* $out/</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      mv $out/opt/apps/com.tencent.weixin/files/weixin/resources/app $out/lib/wechat-uos</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      chmod 0644 $out/lib/license/libuosdevicea.so</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      rm -rf $out/opt $out/usr</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      # use system scrot</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      pushd $out/lib/wechat-uos/packages/main/dist/</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      sed -i &#39;s|__dirname,&quot;bin&quot;,&quot;scrot&quot;|&quot;</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">scrot</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/bin/&quot;|g&#39; index.js</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      popd</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Create a Steam-run environment with UOS license files and WeChat package</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  steam-run</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">steam</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">override</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    extraPkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">p</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: [ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">license</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> resource</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    runtimeOnly</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  }).</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">run</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # WeChat startup script</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  startScript</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">writeShellScript</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;wechat-uos&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # Currently WeChat cannot display tray icon on NixOS, so when you close the window,</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # you never get it back. Kill WeChat if it&#39;s running so it can be restarted</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    wechat_pid=`pidof wechat-uos`</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    if test $wechat_pid; then</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        kill -9 $wechat_pid</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    # Start WeChat in virtual environment with Steam-run</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    ${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">steam-run</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/bin/steam-run \</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">      ${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">electron</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/bin/electron \</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">      ${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">resource</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/lib/wechat-uos</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">in</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># Create a simple package with only startup script and menu item</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mkDerivation</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  pname</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;wechat-uos&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">  inherit</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000"> version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  phases</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [ </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;installPhase&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  installPhase</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    mkdir -p $out/bin $out/share/applications</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    ln -s </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">startScript</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> $out/bin/wechat-uos</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    ln -s </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">./wechat-uos.desktop</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> $out/share/applications/wechat-uos.desktop</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    ln -s </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">resource</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/share/icons $out/share/icons</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>While <code>steam-run</code> is handy, it includes a lot of libraries to support the vast
number of Steam games. Using <code>steam-run</code> for simple programs is putting fine
timber to petty use. I recommend you to package simple programs with Bubblewrap,
and only handle the larger, complicated ones with <code>steam-run</code>.</p>
<h1 id="examples-special-packages">Examples: Special Packages</h1>
<p>Here close to the end, I will demonstrate packaging some special stuff.</p>
<h2 id="font-hoyo-glyphs">Font: Hoyo-Glyphs</h2>
<p>Fonts are packages in NixOS. You just need to place the TTF files in the
package&#39;s <code>$out/share/fonts/opentype</code> folder.</p>
<p>Here I use Hoyo-Glyphs for demonstration.
<a href="https://github.com/SpeedyOrc-C/Hoyo-Glyphs" rel="noopener noreferrer" target="_blank">It&#39;s a font project created by miHoYo game lovers, that imitates the constructed scripts in miHoYo games, including Genshin Impact, Star Rail, and ZZZ</a>.</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenvNoCC</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchFromGitHub</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">} @ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">args</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># stdenvNoCC is a packaging environment without compilers; we don&#39;t need them for fonts</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenvNoCC</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mkDerivation</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> rec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  pname</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;hoyo-glyphs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;b2bf17cd3d9637fbf55c23bf46fe380e4f7e0739&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  src</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchFromGitHub</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ({</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    owner</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;SpeedyOrc-C&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    repo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;Hoyo-Glyphs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    rev</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;b2bf17cd3d9637fbf55c23bf46fe380e4f7e0739&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    fetchSubmodules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    sha256</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;sha256-7Jx/7z3QxAi7lsV3JFwUDWJUpaKOmfZyGKL3MUrUopw=&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Find all OTF font files and copy them to $out/share/fonts/opentype</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # We do this because fonts are scattered in directories in hoyo-glyphs</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  installPhase</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    mkdir -p $out/share/fonts/opentype/</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    cp font/**/*.otf $out/share/fonts/opentype/</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>Finally, add the package to the font configuration of NixOS to use them:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">let</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  hoyo-glyphs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">callPackage</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ./hoyo-glyphs.nix</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> { };</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">in</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  fonts</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">fonts</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    hoyo-glyphs</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<h2 id="go-package-konnect">Go Package: Konnect</h2>
<p>The next thing I&#39;ll demonstrate is packaging Go programs. Nixpkgs provides a
<code>buildGoModule</code> function that packages Go programs almost completely
automatically. However, there remains one issue with <code>buildGoModule</code>: since Go
building process involves downloading dependencies in <code>vendor</code> directory from
the Internet, <code>buildGoModule</code> will calculate the hash of the whole <code>vendor</code>
directory, which must be specified on packaging.</p>
<p>Don&#39;t know how to calculate the hash here? Comment it out (or change a few
characters) and build the package, and Nix will raise an error and show the
correct hash.</p>
<p>Here I&#39;m demonstrating with
<a href="https://github.com/Kopano-dev/konnect" rel="noopener noreferrer" target="_blank">Konnect, an OpenID SSO service with LDAP backend support</a>.</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchFromGitHub</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">buildGoModule</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">buildGoModule</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> rec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  pname</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;konnect&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;v0.34.0&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  src</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchFromGitHub</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ({</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    owner</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;Kopano-dev&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    repo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;konnect&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    rev</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;v0.34.0&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    fetchSubmodules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    sha256</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;sha256-y7SD+czD/jK/m0LbFq7qGjwJgBIXfTNrdsA3pzgD2xE=&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  });</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  vendorSha256</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;sha256-ZrwFUZDTbJx5qvloVOa5qK1ykKNkUn1hjfz0xf+8sWk=&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>You don&#39;t need to specify any compilation commands, as <code>buildGoModule</code> does
everything for you.</p>
<p>Similarly, many popular languages like Python, NodeJS and Rust have their own
packaging functions, <a href="https://nixos.wiki/" rel="noopener noreferrer" target="_blank">which can be found on NixOS Wiki</a>.</p>
<blockquote>
<p>One notable exception is Java, since the popular Maven build system doesn&#39;t
support pinning dependencies to a specific version. Dependencies may change
between two builds, which violates the requirements of Nix.</p>
</blockquote>
<h2 id="kernel-linux-xanmod-lantian">Kernel: linux-xanmod-lantian</h2>
<p>Finally, I&#39;ll show you the steps of customizing the Linux kernel. As usual,
Nixpkgs provides a convenience function called <code>buildLinux</code>:</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchFromGitHub</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">buildLinux</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">} @ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">args</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">let</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;5.17.14&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  release</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;1&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">in</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">buildLinux</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">  inherit</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000"> stdenv</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000"> lib</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000"> version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  src</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">fetchFromGitHub</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    owner</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;xanmod&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    repo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;linux&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    rev</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">version</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">-xanmod</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">release</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    sha256</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;sha256-OutD9Z/4LMT1cNmpq5fHaJZzU6iMDoj2N8GXFvXkECY=&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Specify the name of the kernel module directory</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # I changed this following modification to CONFIG_LOCALVERSION</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  modDirVersion</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">version</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">-xanmod</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">release</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">-lantian&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Load config from config.nix</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  structuredExtraConfig</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">import</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ./config.nix</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> args</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Patches applied to kernel. Here I include two patches from Nixpkgs,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # and all patches in the patches directory (auto detected)</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  kernelPatches</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">kernelPatches</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">bridge_stp_helper</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">kernelPatches</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">request_key_helper</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ] ++ (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">builtins</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">map</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: {</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">      inherit</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000"> name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      patch</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">./patches</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">name</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    })</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">builtins</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">attrNames</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">builtins</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">readDir</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ./patches</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Only allow building for x86_64</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  extraMeta</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">broken</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = !</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">stdenv</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">hostPlatform</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">isx86_64</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p><code>config.nix</code> stores your custom kernel configs. Nixpkgs will apply your changes
on top of
<a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/os-specific/linux/kernel/common-config.nix" rel="noopener noreferrer" target="_blank">the default kernel config of NixOS</a>.</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ... }:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">with</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">kernel</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Specify a string: use freeform</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  LOCALVERSION</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">freeform</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;-lantian&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Specify a number: also use freeform, and write number as string</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  LOG_BUF_SHIFT</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">freeform</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;12&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Compile to module: use module</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # If your settings conflict with default config, use lib.mkForce to override</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  TCP_CONG_CUBIC</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mkForce</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> module</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Compile into kernel: use yes</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  TCP_CONG_BBR</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">yes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # Disable: use no</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  CRYPTO_842</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">no</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<h1 id="conclusion">Conclusion</h1>
<p>Software packaging has always been difficult. In the packaging process, you
often need to consider all dependencies of the software, and try repeatedly
whilst adjusting parameters. Compared to other distros, packaging in NixOS (and
Nixpkgs) may seem complicated at first, but is actually easy:</p>
<ul>
<li>Many repetitive work are automated with functions;</li>
<li>Packaging is isolated from the main OS, no worries of package breaking for
others because of residuals or missing dependencies.</li>
</ul>
<p>In this post, I demonstrated a few common packaging scenarios, including open
source and closed source ones. But since I only shown a limited number of
examples, they certainly do not cover all scenarios you may run into, so you&#39;re
likely required to do your own research:</p>
<ul>
<li><a href="https://nixos.wiki/" rel="noopener noreferrer" target="_blank">NixOS Wiki</a> provides packaging guides for many popular
programming languages, as well as special cases (like Qt).</li>
<li><a href="https://github.com/NixOS/nixpkgs" rel="noopener noreferrer" target="_blank">Nixpkgs</a> itself is a large package
repository with definitions for over 80,000 packages, which serves as a
reference.</li>
<li><a href="https://nur.nix-community.org/" rel="noopener noreferrer" target="_blank">NUR</a> is package repositories managed by Nix
users, similar to AUR.</li>
</ul>
<p>All packaging examples in this post are from
<a href="https://github.com/xddxdd/nur-packages" rel="noopener noreferrer" target="_blank">my NUR repository</a>.</p>  </div>  <div class="clearfix" id="post-navi" data-astro-cid-gfbmwgei=""> <div class="float-end text-end" data-astro-cid-gfbmwgei=""> <a href="/en/article/modify-computer/reverse-engineered-linux-driver-for-hp-omen-macro-keys.lantian/" title="Reverse Engineered Linux Driver for HP OMEN Macro Keys" data-astro-cid-gfbmwgei=""> Reverse Engineered Linux Driver for HP OMEN Macro Keys </a> <br data-astro-cid-gfbmwgei=""> Next post »
</div> <div class="float-start text-start position-absolute" data-astro-cid-gfbmwgei="">
« Previous post <br data-astro-cid-gfbmwgei=""> <a href="/en/article/modify-computer/nixos-impermanence.lantian/" title="NixOS Series 4: &#34;Stateless&#34; Operating System" data-astro-cid-gfbmwgei=""> NixOS Series 4: &quot;Stateless&quot; Operating System </a> </div> </div>  <div id="waline" data-waline-language="en-US" data-waline-path="/en/article/modify-computer/nixos-packaging.lantian"></div> <script type="module" src="/assets/WalineComment.astro_astro_type_script_index_0_lang.Dqib3X1E.js"></script>  </div> </div> </article>  </div> <aside class="d-none d-xl-block"> <section class="widget"> <h3>Latest posts</h3> <ul class="list-unstyled"> <li> 07-20  <a href="/en/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/">Legal LTE Network at Home with Open5GS</a> </li><li> 06-27  <a href="/en/article/modify-computer/sidestore-without-stosvpn-across-lan.lantian/">Using SideStore without StosVPN across your LAN</a> </li><li> 05-19  <a href="/en/article/modify-computer/nix-logarithmetic-math-library-from-zero.lantian/">Nix Logarithmic Math Library from Ground Zero</a> </li><li> 04-06  <a href="/en/article/modify-computer/legal-lte-network-at-home-for-100-bucks.lantian/">Legal LTE Network at Home for $100</a> </li><li> 02-10  <a href="/en/article/modify-computer/build-custom-android-kernel-with-nix.lantian/">Building Custom Android Kernel with Nix</a> </li><li> 04-20  <a href="/en/article/modify-website/migrate-blog-to-astro-js.lantian/">Migrating My Blog to Astro.js</a> </li><li> 12-16  <a href="/en/article/modify-computer/nixos-low-ram-vps.lantian/">NixOS Series 5: Creating Disk Image for Low RAM VPS</a> </li><li> 09-20  <a href="/en/article/modify-computer/nix-trigonometric-math-library-from-zero.lantian/">Nix Trigonometric Math Library from Ground Zero</a> </li><li> 05-29  <a href="/en/article/random-notes/pipewire-sigkill-fix.lantian/">Preventing Pipewire from being SIGKILLed</a> </li><li> 05-12  <a href="/en/article/modify-website/how-to-kill-the-dn42-network.lantian/">How to Kill the DN42 Network (Updated 2023-05-12)</a> </li><li> 05-08  <a href="/en/article/modify-computer/laptop-muxed-nvidia-passthrough.lantian/">NVIDIA GPU Passthrough on an Optimus MUXed Laptop (Updated 2023-05)</a> </li><li> 04-17  <a href="/en/article/random-notes/fix-china-telecom-roaming-no-4g-on-aosp-rom.lantian/">Fix China Telecom 4G Roaming on AOSP ROM by Changing APN</a> </li><li> 03-26  <a href="/en/article/random-notes/old-hp-workstation-as-all-in-one.lantian/">Notes on Setting Up NAS+Router on Old HP Workstation</a> </li><li> 01-14  <a href="/en/article/modify-computer/nixos-impermanence.lantian/">NixOS Series 4: &quot;Stateless&quot; Operating System</a> </li><li> 06-21  <a href="/en/article/modify-computer/nixos-packaging.lantian/">NixOS Series 3: Software Packaging 101</a> </li> </ul> </section> <section class="widget"> <h3>Latest comments</h3> <ul class="list-unstyled" id="recent-comments">  <li><a href="#">Loading...</a></li>  </ul> </section> <script type="module">const i=window.location.hostname=="localhost"?"https://comments.lantian.pub":window.location.origin;fetch(`${i}/api/comment?type=recent&count=10`).then(t=>{if(t.status!==200)throw new Error(`Server returned bad HTTP status ${t.status}`);return t.json()}).then(t=>{const e=document.getElementById("recent-comments");e&&(e.innerHTML=t.data.map(n=>{const o=n.comment.replace(/(<([^>]+)>)/gi,"");return"<li>"+n.nick+' <a href="'+n.url+'">'+o+"</a></li>"}).join(""))});</script> <section class="widget"> <h3>Others</h3> <ul class="list-unstyled">  <li> <i class="fas fa-fw fa-rss"></i>  <a href="/rss2.xml" target="_blank">RSS Feed</a> |  <a href="/feed.xml" target="_blank">Atom</a> |  <a href="/feed.json" target="_blank">JSON</a> </li> <li> <i class="fas fa-fw fa-globe"></i>  <a href="https://stats.uptimerobot.com/BLK6VsRkR" target="_blank"> Sever Status </a> </li> <li> <i class="fas fa-fw fa-sitemap"></i>  <a href="https://lg.lantian.pub" target="_blank">DN42 Looking Glass</a> </li> <li> <i class="fas fa-fw fa-link"></i>  <a href="gopher://lantian.pub" target="_blank">Access with Gopher protocol</a> </li>  </ul> </section> <section class="widget"> <h3>Links</h3> <ul class="list-unstyled"> <li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://0x7f.cc"> 0x7f Blog 🐑 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="http://foreverblog.cn"> 10 Year&#39;s Promise (Forever Blog) </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://alanyhq.com"> Alanyhq </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.baoshuo.ren/?utm_source=friends"> Baoshuo&#39;s Blog </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.cas7.moe"> Blog of Moecast </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://jerryxiao.cc"> JerryXiao </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://sangsir.com"> SangSir </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://snli.org"> Shucheng Li </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://yuetau.net"> YuetAu&#39;s Spot </a> </li> </ul> </section> </aside> </div> <footer class="lantian clearfix" data-astro-cid-w3csb3e3="">  <div id="copyright" class="float-end text-end" data-astro-cid-w3csb3e3=""> <i class="fas fa-copyright" data-astro-cid-w3csb3e3=""></i> 2012-2025 Lan Tian @ Blog<br data-astro-cid-w3csb3e3=""> <small data-astro-cid-w3csb3e3=""> Powered by Astro v5.15.1 @ 2025-10-25 23:46:38 </small> </div> <script type="module">function v(c,o,r){const h=/^localhost$|^127(?:\.[0-9]+){0,2}\.[0-9]+$|^(?:0*:)*?:?0*1$/.test(location.hostname)||location.protocol==="file:";if(!o.trackLocalhost&&h)return console.warn("[Plausible] Ignoring event because website is running locally");try{if(window.localStorage.plausible_ignore==="true")return console.warn('[Plausible] Ignoring event because "plausible_ignore" is set to "true" in localStorage')}catch{}const p={n:c,u:o.url,d:o.domain,r:o.referrer,w:o.deviceWidth,h:o.hashMode?1:0,p:r&&r.props?JSON.stringify(r.props):void 0},s=new XMLHttpRequest;s.open("POST",`${o.apiHost}/api/event`,!0),s.setRequestHeader("Content-Type","text/plain"),s.send(JSON.stringify(p)),s.onreadystatechange=()=>{s.readyState===4&&r&&r.callback&&r.callback()}}function b(c){const o=()=>({hashMode:!1,trackLocalhost:!1,url:location.href,domain:location.hostname,referrer:document.referrer||null,deviceWidth:window.innerWidth,apiHost:"https://plausible.io",...c}),r=(t,n,i)=>{v(t,{...o(),...i},n)},h=(t,n)=>{r("pageview",n,t)};return{trackEvent:r,trackPageview:h,enableAutoPageviews:()=>{const t=()=>h(),n=history.pushState;return n&&(history.pushState=function(i,l,u){n.apply(this,[i,l,u]),t()},addEventListener("popstate",t)),c&&c.hashMode&&addEventListener("hashchange",t),h(),function(){n&&(history.pushState=n,removeEventListener("popstate",t)),c&&c.hashMode&&removeEventListener("hashchange",t)}},enableAutoOutboundTracking:(t=document,n={subtree:!0,childList:!0,attributes:!0,attributeFilter:["href"]})=>{function i(e){r("Outbound Link: Click",{props:{url:this.href}}),typeof process<"u"&&process,setTimeout(()=>{location.href=this.href},150),e.preventDefault()}const l=new Set;function u(e){e instanceof HTMLAnchorElement?e.host!==location.host&&(e.addEventListener("click",i),l.add(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(u)}function f(e){e instanceof HTMLAnchorElement?(e.removeEventListener("click",i),l.delete(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(f)}const d=new MutationObserver(e=>{e.forEach(a=>{a.type==="attributes"?(f(a.target),u(a.target)):a.type==="childList"&&(a.addedNodes.forEach(u),a.removedNodes.forEach(f))})});return t.querySelectorAll("a").forEach(u),d.observe(t,n),function(){l.forEach(a=>{a.removeEventListener("click",i)}),l.clear(),d.disconnect()}}}}const g=b({domain:"lantian.pub",trackLocalhost:!0,apiHost:""});g.trackPageview();</script> </footer>  </div>  </body> </html>