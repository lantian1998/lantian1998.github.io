<!DOCTYPE html><html lang="zh-CN" itemscope="" itemtype="https://schema.org/Article" data-astro-cid-porej7z2=""> <head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>用 Open5GS 搭建合法的 LTE 网络 - Lan Tian @ Blog</title><script>
  ;(() => {
    try {
      const mode = localStorage.getItem('user-color-scheme')
      if (mode == 'dark' || mode == 'light') {
        document.documentElement.setAttribute('data-user-color-scheme', mode)
      }
    } catch {
      // Ignore errors
    }
  })()
</script><link rel="stylesheet" href="/assets/index.CUlf1-Vz.css"><style>#post-navi[data-astro-cid-gfbmwgei]{padding:5px;border-top:1px solid var(--lt-border-weak);border-bottom:1px solid var(--lt-border-weak)}
ol[data-astro-cid-nj3qel45]{margin:0;padding:0;line-height:1.5}ol[data-astro-cid-nj3qel45] .toc-item[data-astro-cid-nj3qel45]{list-style:none}ol[data-astro-cid-nj3qel45] .toc-child[data-astro-cid-nj3qel45],ol[data-astro-cid-nj3qel45] .toc[data-astro-cid-nj3qel45]{padding:0}ol[data-astro-cid-nj3qel45] .toc-link[data-astro-cid-nj3qel45]{display:block;margin-left:1em;padding:.25em 0}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;width:1em;padding:.25em 0;float:left;font-style:normal;font-variant:normal;font-weight:900;font-family:Font Awesome\ 6 Free;font-feature-settings:normal;text-align:center}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before{content:""}ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{content:""}.post-info-wrap[data-astro-cid-dckccua4]{-ms-flex:0 0 2.5em;flex:0 0 2.5em;background-color:var(--lt-component-bg-emphasis)}@media(min-width:768px){.post-info[data-astro-cid-dckccua4]{position:sticky;top:0}}@media(max-width:767.98px){.post-info[data-astro-cid-dckccua4]{position:absolute}}
</style><script type="module" src="/assets/PageLayout.astro_astro_type_script_index_0_lang.C1wfUPs6.js"></script><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Referrer-Policy" content="no-referrer, strict-origin-when-cross-origin"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="imagemode" content="force"><meta name="nightmode" content="disable"><meta name="wap-font-scale" content="no"><meta name="title" content="用 Open5GS 搭建合法的 LTE 网络 - Lan Tian @ Blog"><meta name="keywords" content=""><meta name="author" content="Lan Tian"><link rel="canonical" href="https://lantian.pub/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/"><link rel="alternate" type="application/rss+xml" title="Lan Tian @ Blog" href="https://lantian.pub/rss2.xml"><link rel="alternate" type="application/atom+xml" title="Lan Tian @ Blog" href="https://lantian.pub/feed.xml"><link rel="alternate" href="https://lantian.pub/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/" hreflang="zh"><link rel="alternate" href="https://lantian.pub/en/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/" hreflang="en"><meta name="copyright" content="Copyright 2012-2025 Lan Tian @ Blog"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#03a9f4"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#212121"><meta name="application-name" content="Lan Tian @ Blog"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="apple-touch-icon" sizes="1024x1024" href="/apple-touch-icon-1024x1024.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#03a9f4"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Lan Tian @ Blog"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-640x1136.png"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1136x640.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-750x1334.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1334x750.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1125x2436.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2436x1125.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1170x2532.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2532x1170.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1179x2556.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2556x1179.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-828x1792.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1792x828.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2688.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2688x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2208.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2208x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1284x2778.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2778x1284.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1290x2796.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2796x1290.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1488x2266.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2266x1488.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1536x2048.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2048x1536.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1620x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1620.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1640x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1640.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2388.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2388x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2224.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2224x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-2048x2732.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2732x2048.png"><meta name="msapplication-TileColor" content="#bbdefb"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"><meta property="og:url" content="https://lantian.pub/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/"><meta property="og:type" content="website"><meta property="og:title" content="用 Open5GS 搭建合法的 LTE 网络 - Lan Tian @ Blog"><meta property="og:image" content="https://lantian.pub/apple-touch-icon.png"><meta content="在上一篇文章中 ，我用美国的 CBRS 频段和 Magma LTE 核心网软件 搭建了一套合法的 LTE 网络。 关于「合法」：我不是律师或者无线电专家。根据我对相关政策法规的研究，我的整套配置应当是合法的。但如果你按照本文操作后遇到了法律问题，我不负任何责任。 我当时选择 Magma，是因为我买的 CBRS LTE 基站原本用于 Helium Mobile 网络，而 Nova Labs/Helium Mobile 使用的 CBRS 核心网就是 Magma 。这保证了 Magma 一定兼容我手上的基站。但是，从在 Homelab 里自建核心网的角度来考虑，Magma 存在这些问题： Magma 的核心网依赖 Docker 或者 Kubernetes 进行部署，难以用常规的方式（例如 systemd 服务）在容器外部署。而我是 NixOS 用户，希望尽量避免臃肿的 Docker 容器，而是用 systemd 服务管理系统上的服务。 Magma 的访问网关（Access Gateway）只能安装在 Ubuntu 20.04 系统上，系统管理方式与我常用的 NixOS 完全不同。..."><meta property="og:site_name" content="Lan Tian @ Blog"><meta property="og:locale" content="zh"><meta name="twitter:card" content="summary"><meta name="twitter:url" content="https://lantian.pub/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/"><meta name="twitter:title" content="用 Open5GS 搭建合法的 LTE 网络 - Lan Tian @ Blog"><meta property="twitter:image" content="https://lantian.pub/apple-touch-icon.png"><meta content="在上一篇文章中 ，我用美国的 CBRS 频段和 Magma LTE 核心网软件 搭建了一套合法的 LTE 网络。 关于「合法」：我不是律师或者无线电专家。根据我对相关政策法规的研究，我的整套配置应当是合法的。但如果你按照本文操作后遇到了法律问题，我不负任何责任。 我当时选择 Magma，是因为我买的 CBRS LTE 基站原本用于 Helium Mobile 网络，而 Nova Labs/Helium Mobile 使用的 CBRS 核心网就是 Magma 。这保证了 Magma 一定兼容我手上的基站。但是，从在 Homelab 里自建核心网的角度来考虑，Magma 存在这些问题： Magma 的核心网依赖 Docker 或者 Kubernetes 进行部署，难以用常规的方式（例如 systemd 服务）在容器外部署。而我是 NixOS 用户，希望尽量避免臃肿的 Docker 容器，而是用 systemd 服务管理系统上的服务。 Magma 的访问网关（Access Gateway）只能安装在 Ubuntu 20.04 系统上，系统管理方式与我常用的 NixOS 完全不同。..."><meta name="twitter:dnt" content="on"><meta itemprop="name" content="用 Open5GS 搭建合法的 LTE 网络 - Lan Tian @ Blog"><meta property="image" content="https://lantian.pub/apple-touch-icon.png"><meta content="在上一篇文章中 ，我用美国的 CBRS 频段和 Magma LTE 核心网软件 搭建了一套合法的 LTE 网络。 关于「合法」：我不是律师或者无线电专家。根据我对相关政策法规的研究，我的整套配置应当是合法的。但如果你按照本文操作后遇到了法律问题，我不负任何责任。 我当时选择 Magma，是因为我买的 CBRS LTE 基站原本用于 Helium Mobile 网络，而 Nova Labs/Helium Mobile 使用的 CBRS 核心网就是 Magma 。这保证了 Magma 一定兼容我手上的基站。但是，从在 Homelab 里自建核心网的角度来考虑，Magma 存在这些问题： Magma 的核心网依赖 Docker 或者 Kubernetes 进行部署，难以用常规的方式（例如 systemd 服务）在容器外部署。而我是 NixOS 用户，希望尽量避免臃肿的 Docker 容器，而是用 systemd 服务管理系统上的服务。 Magma 的访问网关（Access Gateway）只能安装在 Ubuntu 20.04 系统上，系统管理方式与我常用的 NixOS 完全不同。..."><meta content="在上一篇文章中 ，我用美国的 CBRS 频段和 Magma LTE 核心网软件 搭建了一套合法的 LTE 网络。 关于「合法」：我不是律师或者无线电专家。根据我对相关政策法规的研究，我的整套配置应当是合法的。但如果你按照本文操作后遇到了法律问题，我不负任何责任。 我当时选择 Magma，是因为我买的 CBRS LTE 基站原本用于 Helium Mobile 网络，而 Nova Labs/Helium Mobile 使用的 CBRS 核心网就是 Magma 。这保证了 Magma 一定兼容我手上的基站。但是，从在 Homelab 里自建核心网的角度来考虑，Magma 存在这些问题： Magma 的核心网依赖 Docker 或者 Kubernetes 进行部署，难以用常规的方式（例如 systemd 服务）在容器外部署。而我是 NixOS 用户，希望尽量避免臃肿的 Docker 容器，而是用 systemd 服务管理系统上的服务。 Magma 的访问网关（Access Gateway）只能安装在 Ubuntu 20.04 系统上，系统管理方式与我常用的 NixOS 完全不同。..."><link rel="me" href="https://mastodon.social/@lantian"></head> <body data-astro-cid-porej7z2=""> <div id="bg" data-astro-cid-j6vmxtef=""></div>   <div id="container" class="container" data-astro-cid-porej7z2=""> <nav class="lantian navbar navbar-expand-lg" data-astro-cid-wu5dj4rx=""> <div class="container-fluid" data-astro-cid-wu5dj4rx=""> <a class="navbar-brand" href="/" data-astro-cid-wu5dj4rx="">Lan Tian @ Blog</a> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#lantian-navbar" aria-controls="lantian-navbar" aria-expanded="false" aria-label="Toggle navigation" data-astro-cid-wu5dj4rx=""> <span class="navbar-toggler-icon" data-astro-cid-wu5dj4rx=""></span> </button> <div class="collapse navbar-collapse" id="lantian-navbar" data-astro-cid-wu5dj4rx=""> <ul class="navbar-nav" data-astro-cid-wu5dj4rx=""> <li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/page/archive/index.html" data-astro-cid-wu5dj4rx=""> 文章们 </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> 俯瞰地球 </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> <li class="nav-item dropdown d-block d-lg-none" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="pages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-file" data-astro-cid-wu5dj4rx=""></i> 页面  <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="pages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/page/archive/index.html" data-astro-cid-wu5dj4rx=""> 文章们 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> 俯瞰地球 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> </ul> </li> </ul> <ul class="navbar-nav ms-auto" data-astro-cid-wu5dj4rx=""> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="languages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-language" data-astro-cid-wu5dj4rx=""></i> Language <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="languages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item active" href="/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-cn" data-astro-cid-wu5dj4rx=""></span> Chinese Simplified / 简体中文 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-us" data-astro-cid-wu5dj4rx=""></span> English </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">Not all pages have translations.</a> </li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">You may see 404 - this is normal.</a> </li> </ul> </li> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="color-scheme-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> 夜间模式 </a> <ul class="dropdown-menu" aria-labelledby="color-scheme-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-auto" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> 自动 </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-light" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-sun" data-astro-cid-wu5dj4rx=""></i> 浅色</a> </li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-dark" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-moon" data-astro-cid-wu5dj4rx=""></i> 深色</a> </li> </ul> </li> </ul> </div> </div> </nav> <script type="module">const m="user-color-scheme",s="data-user-color-scheme",u=(e,t)=>{try{localStorage.setItem(e,t)}catch{}},i=e=>{try{return localStorage.getItem(e)}catch{return null}},c=e=>{const t={dark:!0,light:!0,auto:!0},o=e===null||!Object.keys(t).includes(e)?"auto":e;u(m,o);for(const l in t){const n=document.getElementById("color-scheme-"+l);n&&(l==o?n.classList.add("active"):n.classList.remove("active"))}o!="auto"?document.documentElement.setAttribute(s,o):document.documentElement.removeAttribute(s)};c(i(m));const r=document.getElementById("color-scheme-auto");r&&r.addEventListener("click",()=>c("auto"));const a=document.getElementById("color-scheme-light");a&&a.addEventListener("click",()=>c("light"));const d=document.getElementById("color-scheme-dark");d&&d.addEventListener("click",()=>c("dark"));</script>  <div class="d-flex" data-astro-cid-porej7z2=""> <div id="content" data-astro-cid-porej7z2="">  <article> <div class="d-flex"> <div class="post-info-wrap" data-astro-cid-dckccua4=""> <div class="post-info" data-astro-cid-dckccua4=""> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-clock"></span> <br> <small>07-20</small> </p> <div class="post-meta-value"> 发布于<span class="badge badge-tag" data-astro-cid-dckccua4=""> 2025-07-20 12:38 </span>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-file-alt"></span> <br> <small>计算机与客户端</small> </p> <div class="post-meta-value"> 分类 <a class="badge badge-tag" href="/category/modify-computer" data-astro-cid-dckccua4=""> 计算机与客户端 </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-tag"></span> <br> <small>4 标签</small> </p> <div class="post-meta-value"> 标签  <a class="badge badge-tag" href="/tag/LTE" data-astro-cid-dckccua4=""> LTE </a>  <a class="badge badge-tag" href="/tag/4G" data-astro-cid-dckccua4=""> 4G </a>  <a class="badge badge-tag" href="/tag/CBRS" data-astro-cid-dckccua4=""> CBRS </a>  <a class="badge badge-tag" href="/tag/Open5GS" data-astro-cid-dckccua4=""> Open5GS </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-list"></span> <br> <small>目录</small> </p> <div class="post-meta-value">  <ol data-astro-cid-nj3qel45=""> <li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#安装-open5gs" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">安装 Open5GS</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#准备工作" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">准备工作</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#了解-open5gs-的组件" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">了解 Open5GS 的组件</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#安装-open5gs-软件包" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">安装 Open5GS 软件包</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#创建-open5gs-配置文件" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">创建 Open5GS 配置文件</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#修复-nixos-下-open5gs-配置文件中的路径" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">修复 NixOS 下 Open5GS 配置文件中的路径</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#可选重新生成-diameter-的-tls-证书" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">（可选）重新生成 Diameter 的 TLS 证书</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#安装-open5gs-的-web-管理面板" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">安装 Open5GS 的 Web 管理面板</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#启动-open5gs" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">启动 Open5GS</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#创建管理面板的默认管理员" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">创建管理面板的默认管理员</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#修改-open5gs-的配置文件" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">修改 Open5GS 的配置文件</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#将-freedomfisercomm-基站连上-open5gs" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">将 FreedomFi/Sercomm 基站连上 Open5GS</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#关闭-tr-069-远程管理" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">关闭 TR-069 远程管理</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#修改基站的-cbrs-sas-连接配置" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">修改基站的 CBRS SAS 连接配置</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#修改基站的核心网连接配置" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">修改基站的核心网连接配置</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#将-sim-卡信息注册到-open5gs-上" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">将 SIM 卡信息注册到 Open5GS 上</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#总结" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">总结</span> </a> </li> </ol>   </div> </div> </div> </div>  </div>  <div class="post-wrap">  <h1 class="post-title"> <a href="/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/" rel="bookmark" title="用 Open5GS 搭建合法的 LTE 网络">用 Open5GS 搭建合法的 LTE 网络</a> </h1> <div class="post-text">  <blockquote><p>蓝天移动（自建 LTE 网络） 系列文章目录：</p><ul><li><a href="/article/modify-computer/legal-lte-network-at-home-for-100-bucks.lantian/">$100，DIY 搭建合法的 LTE 网络</a> </li><li><a href="/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/">用 Open5GS 搭建合法的 LTE 网络</a> （当前文章）</li></ul></blockquote> <p><a href="/article/modify-computer/legal-lte-network-at-home-for-100-bucks.lantian/">在上一篇文章中</a>，我用美国的 CBRS 频段和 <a href="https://magmacore.org/" rel="noopener noreferrer" target="_blank">Magma LTE 核心网软件</a>搭建了一套合法的 LTE 网络。</p>
<blockquote>
<p>关于「合法」：我不是律师或者无线电专家。根据我对相关政策法规的研究，我的整套配置应当是合法的。但如果你按照本文操作后遇到了法律问题，我不负任何责任。</p>
</blockquote>
<p>我当时选择 Magma，是因为我买的 CBRS LTE 基站原本用于 Helium Mobile 网络，而 <a href="https://github.com/helium/HIP/blob/main/0139-phase-out-cbrs.md#what-to-do-with-cbrs-radios" rel="noopener noreferrer" target="_blank">Nova Labs/Helium Mobile 使用的 CBRS 核心网就是 Magma</a>。这保证了 Magma 一定兼容我手上的基站。但是，从在 Homelab 里自建核心网的角度来考虑，Magma 存在这些问题：</p>
<ul>
<li>Magma 的核心网依赖 Docker 或者 Kubernetes 进行部署，难以用常规的方式（例如 systemd 服务）在容器外部署。而我是 NixOS 用户，希望尽量避免臃肿的 Docker 容器，而是用 systemd 服务管理系统上的服务。</li>
<li>Magma 的访问网关（Access Gateway）只能安装在 Ubuntu 20.04 系统上，系统管理方式与我常用的 NixOS 完全不同。这意味着我需要手工管理访问网关机器的配置以及系统升级，无法复用我现有的 NixOS 配置。</li>
<li>Magma 有时会出一些奇怪的问题，例如：
<ul>
<li>Android 手机死活连不上基站但 iPhone 没问题；</li>
<li>手机无法正常获取网络名称，网络名称总是显示为 MCC/MNC <code>315 010</code> 而不是我配置的网络名 <code>Lan Tian Mobile</code>；</li>
<li>访问网关明明连上了核心网并且正常同步配置，但核心网管理界面中显示访问网关已经很久没连上了。</li>
</ul>
</li>
</ul>
<p>因此，在上一篇文章完成，确定自建 LTE 网络可行后，我就开始尝试用另一款开源 LTE 核心网软件 <a href="https://open5gs.org/" rel="noopener noreferrer" target="_blank">Open5GS</a> 替换 Magma。</p>
<p>相比 Magma，Open5GS 有这些优点：</p>
<ul>
<li>Open5GS 不区分核心网和访问网关两套组件，只需要一台机器就可以完整部署。</li>
<li>Nixpkgs 中已经有了 Open5GS 软件包（<code>pkgs.open5gs</code>），我不用自己打包就能直接在 NixOS 上安装使用，不需要 Docker 或者 Ubuntu。</li>
<li>Open5GS 没有 Magma 那些奇怪的问题，一旦搭建完成就可以稳定运行。</li>
</ul>
<p>本文记录我在 NixOS 系统上用 Open5GS 搭建核心网，并且用 FreedomFi/Sercomm 的 SCE4255W 基站连接核心网、发射 LTE 信号的过程。</p>
<h1 id="安装-open5gs">安装 Open5GS</h1>
<blockquote>
<p>配置过程参考了以下资料：</p>
<ul>
<li><a href="https://open5gs.org/open5gs/docs/" rel="noopener noreferrer" target="_blank">Open5GS 的官方文档</a></li>
<li>一套打包成开箱即用 Docker 容器的 Open5GS（以及一些附加组件）配置：<a href="https://github.com/herlesupreeth/docker_open5gs" rel="noopener noreferrer" target="_blank">herlesupreeth/docker_open5gs</a></li>
</ul>
</blockquote>
<h2 id="准备工作">准备工作</h2>
<p>本文假定你已经按照我的<a href="/article/modify-computer/legal-lte-network-at-home-for-100-bucks.lantian/">上一篇文章</a>准备好了这些硬件或软件配置。如果你没有完成这些配置，可以参考上一篇文章中的对应教程配置软件或者购买硬件：</p>
<ul>
<li>一台 FreedomFi/Sercomm 的 SCE4255W 基站，已经解锁 Web 管理界面</li>
<li>基站已经注册到 CBRS SAS 上</li>
<li>一张已经写好认证信息（KI，OPC 等值）的 SIM 卡，并且你记录了这些认证信息（以便稍后注册到 Open5GS）</li>
</ul>
<p>本文基于 NixOS 进行所有配置，但也提供了一些 Ubuntu 相关的命令，以便其它 Linux 发行版的用户参考。</p>
<h2 id="了解-open5gs-的组件">了解 Open5GS 的组件</h2>
<p>Open5GS 如其名，是一套主要实现 5G 核心网（但也实现了 LTE 核心网）的软件。由于 5G 时代的核心网协议和结构与 4G 时代相比有了较大不同，尤其是独立组网的 5G SA 网络，因此 Open5GS 大致上可以看作是一套 LTE/5G NSA 核心网软件，加上一套 5G SA 核心网软件，两者之间共享一小部分组件。</p>
<p>Open5GS 的 LTE/5G NSA 部分由如下组件组成：</p>
<ul>
<li>MME - Mobility Management Entity</li>
<li>HSS - Home Subscriber Server</li>
<li>PCRF - Policy and Charging Rules Function</li>
<li>SGWC - Serving Gateway Control Plane</li>
<li>SGWU - Serving Gateway User Plane</li>
<li>SMF - Session Management Function
<ul>
<li>SMF 本身是 5G 核心网的组件，但 Open5GS SMF 也实现了 4G 核心网结构中的 Packet Gateway Control Plane</li>
</ul>
</li>
<li>UPF - User Plane Function
<ul>
<li>UPF 本身是 5G 核心网的组件，但 Open5GS UPF 也实现了 4G 核心网结构中的 Packet Gateway User Plane</li>
</ul>
</li>
<li>NRF - NF Repository Function
<ul>
<li>NRF 本身是 5G 核心网的组件，但是 SCP 依赖它</li>
</ul>
</li>
<li>SCP - <del>Secure, Contain, Protect</del> Service Communication Proxy
<ul>
<li>SCP 本身是 5G 核心网的组件，但是 SMF 依赖它</li>
</ul>
</li>
</ul>
<p>而 5G SA 部分由如下组件组成：</p>
<ul>
<li>NRF - NF Repository Function</li>
<li>SCP - Service Communication Proxy</li>
<li>SEPP - Security Edge Protection Proxy</li>
<li>AMF - Access and Mobility Management Function</li>
<li>SMF - Session Management Function</li>
<li>UPF - User Plane Function</li>
<li>AUSF - Authentication Server Function</li>
<li>UDM - Unified Data Management</li>
<li>UDR - Unified Data Repository</li>
<li>PCF - Policy and Charging Function</li>
<li>NSSF - Network Slice Selection Function</li>
<li>BSF - Binding Support Function</li>
</ul>
<p>这些组件之间以如下的结构互相通信：</p>
<p><picture><source srcset="/usr/uploads/202507/Open5GS_CUPS-01.jpg.webp" type="image/webp"><source srcset="/usr/uploads/202507/Open5GS_CUPS-01.jpg.avif" type="image/avif"><source srcset="/usr/uploads/202507/Open5GS_CUPS-01.jpg.jxl" type="image/jxl"><img src="/usr/uploads/202507/Open5GS_CUPS-01.jpg" alt="Open5GS 组件结构图"></picture></p>
<p>（图源：<a href="https://open5gs.org/open5gs/docs/guide/01-quickstart/" rel="noopener noreferrer" target="_blank">Open5GS 官方文档</a>）</p>
<p>4G/5G 核心网的各个组件之间通信走的是标准化的 <a href="https://en.wikipedia.org/wiki/Diameter_(protocol)" rel="noopener noreferrer" target="_blank">Diameter 协议</a>，它基于 TCP 或者 <a href="https://zh.wikipedia.org/wiki/%E6%B5%81%E6%8E%A7%E5%88%B6%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE" rel="noopener noreferrer" target="_blank">SCTP</a> 协议，在 4G/5G 核心网的各个组件之间交换数据。这也意味着来自不同厂商的软硬件，只要支持 Diameter 协议，就都可以加入同一个核心网中，共同为移动用户提供服务。</p>
<p>但本文中我将全程使用 Open5GS 的组件，暂时不将别的组件加入核心网。</p>
<h2 id="安装-open5gs-软件包">安装 Open5GS 软件包</h2>
<p>如果你用的是 Ubuntu，可以参考 <a href="https://open5gs.org/open5gs/docs/guide/01-quickstart/" rel="noopener noreferrer" target="_blank">Open5GS 的官方安装教程</a>：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 安装 MongoDB</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">curl</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -fsSL</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> https://pgp.mongodb.com/server-8.0.asc</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> | </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sudo</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> gpg</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -o</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /usr/share/keyrings/mongodb-server-8.0.gpg</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> --dearmor</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">echo</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/8.0 multiverse"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> | </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sudo</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> tee</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /etc/apt/sources.list.d/mongodb-org-8.0.list</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sudo</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> apt</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> update</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sudo</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> apt</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> install</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> mongodb-org</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 安装 Open5GS</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sudo</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> add-apt-repository</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ppa:open5gs/latest</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sudo</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> apt</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> update</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sudo</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> apt</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> install</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> open5gs</span></span></code></pre>
<p>这个过程中除了安装了 Open5GS 的二进制文件，还创建了一组 systemd 服务对应 Open5GS 的各个组件，以及将 Open5GS 的默认配置复制到了 <code>/etc</code> 下。</p>
<p>由于 NixOS 中只有 Open5GS 的软件包，没有对应的 NixOS 模块，因此我们需要模仿在 Ubuntu 等其它系统上安装的过程，手动为 Open5GS 创建 systemd 服务：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ... }:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">let</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 由于我们只搭建 4G 核心网，只开启 4G 核心网需要的服务</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "hss"</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "mme"</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "nrf"</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "pcrf"</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "scp"</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "sgwc"</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "sgwu"</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "smf"</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "upf"</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">in</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 开启 MongoDB，HSS、PCF、PCRF 组件需要用 MongoDB 保存配置</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">mongodb</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    enable</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    bind_ip</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"127.0.0.1"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    package</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">mongodb-ce</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 创建 Open5GS 各组件的 systemd 服务</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  systemd</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">builtins</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">listToAttrs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">    builtins</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">map</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">svc</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"open5gs-</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">svc</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">d"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      value</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">        description</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"Open5GS </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">toUpper</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> svc</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Daemon"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">        wantedBy</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [ </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"multi-user.target"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">        after</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">          "network.target"</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">          "mongodb.service"</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        ];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">        requires</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">          "network.target"</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">          "mongodb.service"</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        ];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">        serviceConfig</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">          # 这里指向的 open5gs 文件夹下的配置文件我们下一步再创建</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">          ExecStart</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">open5gs</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/bin/open5gs-</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">svc</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">d -c </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">./open5gs</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">svc</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">.yaml"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">          ExecReload</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">coreutils</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/bin/kill -HUP $MAINPID"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">          LogsDirectory</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"open5gs"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">          User</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"open5gs"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">          Group</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"open5gs"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">          Restart</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"always"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">          RestartSec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"5"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">          RestartPreventExitStatus</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"1"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    }) </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">services</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  );</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 创建一个单独的用户和组给 Open5GS</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  users</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">users</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">open5gs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    group</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"open5gs"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    isSystemUser</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  users</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">groups</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">open5gs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = { };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 创建一个名为 ogstun 的 TUN 接口，用于与 LTE 设备通信</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  systemd</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">network</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">netdevs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">open5gs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    netdevConfig</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      Kind</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"tun"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      Name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"ogstun"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  systemd</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">network</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">networks</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">open5gs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # 这里用的 IP 地址和 Open5GS 默认配置中的相同</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    address</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      "10.45.0.1/16"</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      "2001:db8:cafe::1/48"</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    ];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    linkConfig</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      MTUBytes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">1400</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      RequiredForOnline</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    matchConfig</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">Name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"ogstun"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<h2 id="创建-open5gs-配置文件">创建 Open5GS 配置文件</h2>
<p>如果你用的是 Ubuntu，上面的安装过程应该已经自动将默认配置文件安装到了 <code>/etc/freeDiameter</code> 和 <code>/etc/open5gs</code> 下。但在 NixOS 中，这个过程不会自动完成，我们需要手动复制配置文件，或者手动指定配置文件的路径。</p>
<p>由于 Nixpkgs 的 Open5GS 软件包已经自带了一组默认配置，我们可以直接从这个包里复制默认配置文件。首先构建软件包：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">nix</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> build</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> nixpkgs#open5gs</span></span></code></pre>
<p>不出意外，Nix 会从 Binary Cache 里下载预先编译好的 Open5GS，并且把它软链接到 <code>result</code> 目录下。此时我们在 <code>result/etc</code> 文件夹下就可以看到默认的配置文件了：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">ls</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> result/etc</span></span></code></pre>
<p>然后我们就可以把它们复制到自己的 NixOS 配置中，以便后续修改：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">cp</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -r</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> result/etc/freeDiameter</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /path/to/your/nixos-config/freeDiameter</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">cp</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -r</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> result/etc/open5gs</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /path/to/your/nixos-config/open5gs</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 从 Nix store 中复制出的文件默认是只读的，给它们加上写权限</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">chmod</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -R</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> +w</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /path/to/your/nixos-config/freeDiameter</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /path/to/your/nixos-config/open5gs</span></span></code></pre>
<p>对于 <code>freeDiameter</code> 文件夹中的文件，我们需要把它们放到 <code>/etc/freeDiameter</code> 下：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  environment</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">etc</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"freeDiameter"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">source</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">./freeDiameter</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>对于 <code>open5gs</code> 文件夹中的文件，可以在启动 Open5GS 时使用 <code>-c</code> 参数直接指定配置文件的为止：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  systemd</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # ...</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    ExecStart</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">open5gs</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/bin/open5gs-</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">svc</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">d -c </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">./open5gs</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">svc</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">.yaml"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>不把它们放到 <code>/etc</code> 中，是为了保证修改配置文件后，Open5GS 服务会自动重启。</p>
<h2 id="修复-nixos-下-open5gs-配置文件中的路径">修复 NixOS 下 Open5GS 配置文件中的路径</h2>
<p>由于 Nixpkgs 中打包的 Open5GS 默认安装到 <code>/nix/store</code> 中的一个路径下，因此它的配置文件中也默认包含了很多 <code>/nix/store</code> 下的路径。</p>
<p>首先获取 Open5GS 的实际安装路径：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">nix</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> build</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> nixpkgs#open5gs</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> --print-out-paths</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> --no-link</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 输出类似：</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># /nix/store/vbb0aa2mkjbfay7gdgaw5r23g0ss6kyz-open5gs-v2.7.6/</span></span></code></pre>
<p>然后在复制出来的配置文件中搜索这个路径，可以看到有很多处包含了完整的路径：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">grep</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "/nix/store/vbb0aa2mkjbfay7gdgaw5r23g0ss6kyz-open5gs-v2.7.6/"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> freeDiameter/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">*</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> open5gs/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">*</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># ...</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 引用 Open5GS 构建过程中默认生成的 TLS 证书</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># freeDiameter/hss.conf:TLS_Cred = "/nix/store/vbb0aa2mkjbfay7gdgaw5r23g0ss6kyz-open5gs-v2.7.6/etc/open5gs/tls/hss.crt", "/nix/store/vbb0aa2mkjbfay7gdgaw5r23g0ss6kyz-open5gs-v2.7.6/etc/open5gs/tls/hss.key";</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># ...</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 引用 freeDiameter 的 Extension</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># freeDiameter/hss.conf:LoadExtension = "/nix/store/vbb0aa2mkjbfay7gdgaw5r23g0ss6kyz-open5gs-v2.7.6/lib/freeDiameter/dbg_msg_dumps.fdx" : "0x8888";</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># ...</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 默认日志路径被放到了 Nix store 中</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># open5gs/hss.yaml:    path: /nix/store/vbb0aa2mkjbfay7gdgaw5r23g0ss6kyz-open5gs-v2.7.6/var/log/open5gs/hss.log</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># ...</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># freeDiameter 的配置文件路径被设置到了 Nix store 中</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># open5gs/hss.yaml:  freeDiameter: /nix/store/vbb0aa2mkjbfay7gdgaw5r23g0ss6kyz-open5gs-v2.7.6/etc/freeDiameter/hss.conf</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># ...</span></span></code></pre>
<p>一旦 Open5GS 软件包或者它的依赖更新，Open5GS 在 Nix store 中的路径就会发生变动，导致以绝对路径指定的文件失效，从而导致 Open5GS 无法启动。因此，我们需要让这些路径和 Open5GS 的路径保持同步，或者指向 Nix store 之外，以防止未来出现问题。</p>
<p>我用的方法是，首先把 <code>pkgs.open5gs</code> 软件包链接一份到 <code>/etc</code> 里：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  environment</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">etc</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"open5gs-pkg"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">source</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">open5gs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>然后修改上述路径：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># TLS 证书指向 /etc/open5gs-pkg。虽然这个证书是从 Nixpkgs Binary Cache 下载的，私钥可以视为公开，但我们单机部署，通信不经过外部网络，因此加密无关紧要</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sed</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -i</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "s#/nix/store/vbb0aa2mkjbfay7gdgaw5r23g0ss6kyz-open5gs-v2.7.6/etc/open5gs/tls/#/etc/open5gs-pkg/etc/open5gs/tls/#g"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> freeDiameter/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">*</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> open5gs/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">*</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># freeDiameter Extension 指向 /etc/open5gs-pkg</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sed</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -i</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "s#/nix/store/vbb0aa2mkjbfay7gdgaw5r23g0ss6kyz-open5gs-v2.7.6/lib/freeDiameter/#/etc/open5gs-pkg/lib/freeDiameter/#g"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> freeDiameter/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">*</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> open5gs/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">*</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># /var 中的路径指向实际的 /var</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sed</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -i</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "s#/nix/store/vbb0aa2mkjbfay7gdgaw5r23g0ss6kyz-open5gs-v2.7.6/var/#/var/#g"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> freeDiameter/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">*</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> open5gs/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">*</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># freeDiameter 配置文件指向 /etc/freeDiameter</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sed</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -i</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "s#/nix/store/vbb0aa2mkjbfay7gdgaw5r23g0ss6kyz-open5gs-v2.7.6/etc/freeDiameter/#/etc/freeDiameter/#g"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> freeDiameter/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">*</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> open5gs/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">*</span></span></code></pre>
<p>修改完成后，就可以保证 Open5GS 未来升级时不会出现问题，同时我们放在 <code>/etc</code> 的配置文件可以正常生效。</p>
<h2 id="可选重新生成-diameter-的-tls-证书">（可选）重新生成 Diameter 的 TLS 证书</h2>
<p>Nixpkgs 中打包的 Open5GS 自带了一份在构建过程中生成的 TLS 证书。如果你的 Open5GS 是从 Binary Cache 下载的，而不是本地编译的，那么其他人也可以从 Binary Cache 上下载到同一份密钥。</p>
<p>如果你按照本教程的流程单机部署，因为所有的通信都在本地，不会经过外部网络，所以有没有加密、私钥是否泄露对安全性没什么影响。</p>
<p>但如果你准备将一部分组件放到别的机器上，或者你不想使用这份已经泄露的密钥，你也可以用如下的脚本生成一份新的：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  systemd</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">open5gs-certs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    wantedBy</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [ </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"multi-user.target"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    path</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">with</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">; [ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">openssl</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    script</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">''</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      mkdir -p demoCA</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      if [ ! -f "demoCA/serial" ]; then</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        echo 01 > demoCA/serial</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      fi</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      touch demoCA/index.txt</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      # CA self certificate</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      if [ ! -f "ca.crt" ]; then</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        openssl req -new -x509 -days 3650 -newkey rsa:2048 -nodes -keyout ca.key -out ca.crt \</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">          -subj /CN=ca.epc.mnc010.mcc315.3gppnetwork.org/C=KO/ST=Seoul/O=NeoPlane</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      for i in amf ausf bsf hss mme nrf scp sepp1 sepp2 sepp3 nssf pcf pcrf smf udm udr</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      do</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        if [ ! -f "$i.crt" ]; then</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">          openssl genpkey -algorithm rsa -pkeyopt rsa_keygen_bits:2048 \</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">              -out $i.key</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">          openssl req -new -key $i.key -out $i.csr \</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">              -subj /CN=$i.epc.mnc010.mcc315.3gppnetwork.org/C=KO/ST=Seoul/O=NeoPlane</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">          openssl ca -batch -notext -days 3650 \</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">              -keyfile ca.key -cert ca.crt \</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">              -in $i.csr -out $i.crt -outdir .</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        fi</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      done</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    ''</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    serviceConfig</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      Type</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"oneshot"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      User</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"open5gs"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      Group</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"open5gs"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      StateDirectory</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"open5gs-certs"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      WorkingDirectory</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"/var/lib/open5gs-certs"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>当运行 <code>systemctl start open5gs-certs.service</code> 时，这个服务就会自动在 <code>/var/lib/open5gs-certs</code> 中生成缺失的密钥。</p>
<p>然后你就可以修改 Open5GS 的配置文件，将 TLS 密钥路径指向 <code>/var/lib/open5gs-certs</code>：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 如果你在上一步没有替换 TLS 密钥的路径</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sed</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -i</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "s#/nix/store/vbb0aa2mkjbfay7gdgaw5r23g0ss6kyz-open5gs-v2.7.6/etc/open5gs/tls/#/var/lib/open5gs-certs/#g"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> freeDiameter/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">*</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> open5gs/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">*</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 如果你在上一步已经替换了 TLS 密钥的路径</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sed</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -i</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "s#/etc/open5gs-pkg/etc/open5gs/tls/#/var/lib/open5gs-certs/#g"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> freeDiameter/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">*</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> open5gs/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">*</span></span></code></pre>
<p>你也可以把 <code>open5gs-certs.service</code> 加到 Open5GS 各个 systemd 服务的 <code>After</code> 和 <code>Requires</code> 里，从而保证 Open5GS 启动时密钥已经生成完毕。</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  systemd</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # ...</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    after</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      "network.target"</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      "open5gs-certs.service"</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      "mongodb.service"</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    ];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    requires</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      "network.target"</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      "open5gs-certs.service"</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      "mongodb.service"</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    ];</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<h2 id="安装-open5gs-的-web-管理面板">安装 Open5GS 的 Web 管理面板</h2>
<p>上面的步骤配置了 Open5GS 核心网本身，但我们还需要安装管理面板 WebUI，以管理注册到 Open5GS 的 SIM 卡相关信息。</p>
<p>如果你用的是 Ubuntu，可以使用 Open5GS 官方的一键安装脚本：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 下载 Nodesource 的 GPG 密钥</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sudo</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> apt</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> update</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sudo</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> apt</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> install</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -y</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ca-certificates</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> curl</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> gnupg</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sudo</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> mkdir</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -p</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /etc/apt/keyrings</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">curl</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -fsSL</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> | </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sudo</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> gpg</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> --dearmor</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -o</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /etc/apt/keyrings/nodesource.gpg</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 添加 NodeJS 软件包仓库</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">NODE_MAJOR</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">=</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">20</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">echo</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$NODE_MAJOR</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">.x nodistro main"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> | </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sudo</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> tee</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /etc/apt/sources.list.d/nodesource.list</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 安装 NodeJS</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sudo</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> apt</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> update</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sudo</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> apt</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> install</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> nodejs</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -y</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 安装 Open5GS WebUI</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">curl</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -fsSL</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> https://open5gs.org/open5gs/assets/webui/install</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> | </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sudo</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -E</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> bash</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> -</span></span></code></pre>
<p>如果你用的是 NixOS，可以用以下配置安装：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  config</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  systemd</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">open5gs-webui</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    description</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"Open5GS WebUI"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    wantedBy</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [ </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"multi-user.target"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    after</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      "network.target"</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      "mongodb.service"</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    ];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    requires</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      "network.target"</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      "mongodb.service"</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    ];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    path</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">with</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">; [</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">      bash</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">      nodejs</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">      rsync</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    ];</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    environment</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      HOSTNAME</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"0.0.0.0"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      PORT</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"9999"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    preStart</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">''</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      export HOME=$(pwd)</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      rsync -r --chmod=D755,F755 </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">open5gs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">src</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/webui/ .</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      npm install</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      npm run build</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    ''</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    serviceConfig</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      ExecStart</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">${</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nodejs</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">}</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/bin/npm run start"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      CacheDirectory</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"open5gs"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      WorkingDirectory</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"/var/cache/open5gs"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      User</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"open5gs"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      Group</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"open5gs"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      Restart</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"always"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      RestartSec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"5"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<h2 id="启动-open5gs">启动 Open5GS</h2>
<p>将上面的配置部署到你的 NixOS 机器上，不出意外这些服务都应该正常启动。</p>
<p>如果你用的是 Ubuntu，那么在安装 <code>open5gs</code> 软件包时，4G/5G 的所有服务都应该已经自动启动了。你可以禁用掉我们用不到的 5G SA 相关的服务，也可以不管它们，它们对后续配置没有任何影响。</p>
<h2 id="创建管理面板的默认管理员">创建管理面板的默认管理员</h2>
<p>Open5GS 启动时并不会自动创建默认的管理员用户，所以在配置部署完成，MongoDB 已经启动之后，我们需要手动运行下面的命令来创建管理员：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">cat</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> &#x3C;&#x3C;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">EOF</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> | </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">mongosh</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> open5gs</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">db = db.getSiblingDB('open5gs')</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">cursor = db.accounts.find()</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">if ( cursor.count() == 0 ) {</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    db.accounts.insertOne({ salt: 'f5c15fa72622d62b6b790aa8569b9339729801ab8bda5d13997b5db6bfc1d997', hash: '402223057db5194899d2e082aeb0802f6794622e1cbc47529c419e5a603f2cc592074b4f3323b239ffa594c8b756d5c70a4e1f6ecd3f9f0d2d7328c4cf8b1b766514effff0350a90b89e21eac54cd4497a169c0c7554a0e2cd9b672e5414c323f76b8559bc768cba11cad2ea3ae704fb36abc8abc2619231ff84ded60063c6e1554a9777a4a464ef9cfdfa90ecfdacc9844e0e3b2f91b59d9ff024aec4ea1f51b703a31cda9afb1cc2c719a09cee4f9852ba3cf9f07159b1ccf8133924f74df770b1a391c19e8d67ffdcbbef4084a3277e93f55ac60d80338172b2a7b3f29cfe8a36738681794f7ccbe9bc98f8cdeded02f8a4cd0d4b54e1d6ba3d11792ee0ae8801213691848e9c5338e39485816bb0f734b775ac89f454ef90992003511aa8cceed58a3ac2c3814f14afaaed39cbaf4e2719d7213f81665564eec02f60ede838212555873ef742f6666cc66883dcb8281715d5c762fb236d72b770257e7e8d86c122bb69028a34cf1ed93bb973b440fa89a23604cd3fefe85fbd7f55c9b71acf6ad167228c79513f5cfe899a2e2cc498feb6d2d2f07354a17ba74cecfbda3e87d57b147e17dcc7f4c52b802a8e77f28d255a6712dcdc1519e6ac9ec593270bfcf4c395e2531a271a841b1adefb8516a07136b0de47c7fd534601b16f0f7a98f1dbd31795feb97da59e1d23c08461cf37d6f2877d0f2e437f07e25015960f63', username: 'admin', roles: [ 'admin' ], "__v" : 0})</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">}</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">EOF</span></span></code></pre>
<p>（来源：<a href="https://github.com/open5gs/open5gs/blob/main/docs/assets/webui/mongo-init.js" rel="noopener noreferrer" target="_blank">https://github.com/open5gs/open5gs/blob/main/docs/assets/webui/mongo-init.js</a>）</p>
<p>以上命令会创建一个用户名为 <code>admin</code>，密码为 <code>1423</code> 的管理员用户。</p>
<p>用浏览器打开 <code>http://[Open5GS 机器的 IP 地址]:9999</code>，就可以用上述用户名密码登录管理面板。</p>
<h1 id="修改-open5gs-的配置文件">修改 Open5GS 的配置文件</h1>
<p>Open5GS 安装完成后，就可以修改配置文件，使其符合我们的 CBRS LTE 网络的参数。我们只需要做如下修改：</p>
<ul>
<li>将 MCC/MNC 从默认的 999/70 修改成 CBRS 的 315/010</li>
</ul>
<p>直接全局搜索 <code>mcc: 999</code> 和 <code>mnc: 70</code>，然后将它们替换成 <code>mcc: 315</code> 和 <code>mnc: 010</code> 即可：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sed</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -i</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "s#mcc: 999#mcc: 315#g"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> open5gs/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">*</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sed</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -i</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "s#mnc: 70#mnc: 010#g"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> open5gs/</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">*</span></span></code></pre>
<ul>
<li>让 MME 组件在 <code>eth0</code>（或者你的实际网卡名）接口上监听，而不是 <code>127.0.0.2</code>，否则基站无法连上核心网</li>
</ul>
<p>修改 <code>open5gs/mme.yaml</code>，将 <code>s1ap</code> 下原本的配置：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">mme</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  s1ap</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    server</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#569CD6;--shiki-light:#800000">address</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">127.0.0.2</span></span></code></pre>
<p>修改成：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">mme</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  s1ap</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    server</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#569CD6;--shiki-light:#800000">dev</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">eth0</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 或者你的实际网卡名</span></span></code></pre>
<ul>
<li>（可选）自定义 MME 广播的网络名。</li>
</ul>
<p>修改 <code>open5gs/mme.yaml</code>，找到 <code>network_name</code>：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">network_name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  full</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">Open5GS</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  short</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">Next</span></span></code></pre>
<p>改成你想要的网络名即可，例如：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">network_name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  full</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">Lan Tian Mobile</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  short</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">LTMobile</span></span></code></pre>
<p>最后，重启所有 Open5GS 相关的服务：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">systemctl</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> restart</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> open5gs-</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\*</span></span></code></pre>
<h1 id="将-freedomfisercomm-基站连上-open5gs">将 FreedomFi/Sercomm 基站连上 Open5GS</h1>
<p>首先，请确保你可以通过 IP 地址登录 FreedomFi/Sercomm SCE4255 基站的 Web 管理面板。如果无法访问基站的 Web 管理面板，请参考<a href="/article/modify-computer/legal-lte-network-at-home-for-100-bucks.lantian/#%E8%A7%A3%E9%94%81%E5%AE%A4%E5%86%85%E5%9F%BA%E7%AB%99%E7%9A%84%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2">我的上一篇文章</a>开启管理面板。</p>
<h2 id="关闭-tr-069-远程管理">关闭 TR-069 远程管理</h2>
<p>FreedomFi 出售的 Sercomm 基站默认会连接 <code>acs.freedomfi.com</code> 这个 TR-069 服务器，从 TR-069 服务器自动获取配置。虽然这个远程管理服务器随着 Helium Mobile 停用 CBRS 网络而关闭，但我们的基站仍然会不停尝试连接远程管理。在用 Magma 搭建核心网时，由于 Magma 核心网自带 TR-069 服务器的功能，所以我们可以保持远程管理开启，只需要将远程管理劫持到我们的 TR-069 服务器即可。但 Open5GS 没有 TR-069 的功能，所以我们要关闭基站的 TR-069 远程管理，避免不必要的请求，并防止基站的配置被意外覆盖。</p>
<p>在管理界面的顶部点击 <code>TR098</code>，然后点击 <code>MgntServer</code> 标签页，切换到基站的 TR-069 远程管理设置页面：</p>
<p><picture><source srcset="/usr/uploads/202507/sercomm-tr069.png.webp" type="image/webp"><source srcset="/usr/uploads/202507/sercomm-tr069.png.avif" type="image/avif"><source srcset="/usr/uploads/202507/sercomm-tr069.png.jxl" type="image/jxl"><img src="/usr/uploads/202507/sercomm-tr069.png" alt="Sercomm 基站的 TR-069 设置页面"></picture></p>
<p>取消勾选 <code>EnableCWMP</code>，然后点击 <code>Save</code> 按钮保存设置。</p>
<p>由于 Sercomm 基站管理面板的 Bug 有点多，所以这里建议重启一次基站以保证设置生效。保存设置时基站可能会自动重启，但如果基站没有重启，可以点击管理界面右上角的电源按钮手动重启一次，或者手动断电重启。重启完后请再次回到此页面并保证 <code>EnableCWMP</code> 是关闭状态。</p>
<p>此时，基站的 TR-069 远程管理功能就关闭了，我们就可以随意修改设置，不怕被远程管理覆盖了。</p>
<h2 id="修改基站的-cbrs-sas-连接配置">修改基站的 CBRS SAS 连接配置</h2>
<p>下一步是让基站连接 CBRS SAS 服务器，获取频段分配，从而避免和其它基站或者运营商的信号发生冲突，以及避免 FCC 上门和你玩彩虹六号。在使用 Magma 核心网时，CBRS SAS 的连接配置由 Magma 的 TR-069 服务器自动下发，但由于 Open5GS 没有 TR-069 的功能，这部分就需要我们手动设置了。</p>
<p>首先确保你的基站已经注册到了 SAS 上，可以参考<a href="/article/modify-computer/legal-lte-network-at-home-for-100-bucks.lantian/#%E5%9F%BA%E7%AB%99%E8%BF%9E%E6%8E%A5-sas">我的上一篇文章中，连接 SAS 的部分</a>。</p>
<p>然后，在基站管理界面的顶部点击 <code>Manage</code>，然后点击 <code>SAS Configuration</code> 标签页：</p>
<p><picture><source srcset="/usr/uploads/202507/sercomm-sas.png.webp" type="image/webp"><source srcset="/usr/uploads/202507/sercomm-sas.png.avif" type="image/avif"><source srcset="/usr/uploads/202507/sercomm-sas.png.jxl" type="image/jxl"><img src="/usr/uploads/202507/sercomm-sas.png" alt="Sercomm 基站的 SAS 设置页面"></picture></p>
<ul>
<li><code>Enable</code> 选项打勾。</li>
<li><code>Method</code> 选项输入 0。</li>
<li><code>Server</code> 选择 <code>Commercial-Google</code>，对应 Google SAS。此时 <code>Server Url</code> 应该会自动填充。</li>
<li><code>UserID</code> 输入你的 Google Cloud Project ID，可以在控制台主页看到：<a href="https://console.cloud.google.com" rel="noopener noreferrer" target="_blank">https://console.cloud.google.com</a></li>
<li><code>Category</code> 选择 <code>A</code>，对应室内基站。</li>
<li><code>ChannelType</code> 选择 <code>GAA</code>，对应 CBRS 三类用户中优先级最低的一类。</li>
<li><code>CertSubject</code> 输入 <code>/C=TW/O=Sercomm/OU=WInnForum CBSD Certificate/CN=P27-SCE4255W:%s</code></li>
</ul>
<p><picture><source srcset="/usr/uploads/202507/sercomm-sas-location.png.webp" type="image/webp"><source srcset="/usr/uploads/202507/sercomm-sas-location.png.avif" type="image/avif"><source srcset="/usr/uploads/202507/sercomm-sas-location.png.jxl" type="image/jxl"><img src="/usr/uploads/202507/sercomm-sas-location.png" alt="Sercomm 基站的 SAS 位置设置页面"></picture></p>
<ul>
<li><code>Location</code> 选择 <code>indoor</code>，对应室内部署。</li>
<li>如果你的基站所在位置 GPS 信号良好，<code>Location Source</code> 可以选择 <code>GPS</code>。但如果 GPS 信号差，基站重启后需要等待 GPS 定位完成后才会连接 CBRS SAS 并开始发送信号。此时你可以选择 <code>Manual</code> 并手动输入基站的经纬度。</li>
<li><code>Latitude</code> 是纬度，正数为北纬，负数为南纬。注意 Sercomm 基站的经纬度单位是微度（即百万分之一度），所以如果你要设置北纬 40 度，请输入 <code>40000000</code>.</li>
<li><code>Longitude</code> 是经度，正数为东经，负数为西经。注意 Sercomm 基站的经纬度单位是微度（即百万分之一度），所以如果你要设置西经 80 度，请输入 <code>-80000000</code>.
<ul>
<li>经纬度请用你的手机等设备实际定位得到，基站的位置需要比较精确，否则会影响到 CBRS SAS 的频段分配。同时这个经纬度应该和 CBRS SAS 平台上设置的经纬度一致。</li>
</ul>
</li>
<li><code>HeightType</code> 选择 <code>AMSL</code>，即相对海平面的高度。</li>
<li><code>Elevation</code> 输入基站的海拔高度，单位是毫米，所以如果你要设置海平面以上 40 米，请输入 <code>40000</code>。</li>
</ul>
<p>保存设置。暂时不用重启基站，下一步配置完基站到 Open5GS 核心网的连接后再一起重启。</p>
<h2 id="修改基站的核心网连接配置">修改基站的核心网连接配置</h2>
<p>下一步是让基站连接 Open5GS 核心网，从而传输用户信息和数据流量。</p>
<p>在基站管理界面的顶部点击 <code>Manage</code>，然后点击 <code>LTE Basic Setting</code> 标签页：</p>
<p><picture><source srcset="/usr/uploads/202507/sercomm-sas-location.png.webp" type="image/webp"><source srcset="/usr/uploads/202507/sercomm-sas-location.png.avif" type="image/avif"><source srcset="/usr/uploads/202507/sercomm-sas-location.png.jxl" type="image/jxl"><img src="/usr/uploads/202507/sercomm-sas-location.png" alt="Sercomm 基站的 LTE 设置页面"></picture></p>
<ul>
<li>
<p><code>Cell Configuration</code> 下：</p>
<ul>
<li><code>AdminStats</code> 选项打勾，代表启用信号发射。</li>
<li><code>Carrier Number</code> 选择 1。
<ul>
<li>如果选择 2 并相应调整下面的设置，可以启用载波聚合，让带宽翻倍，但是这种情况下 Sercomm 的 CBRS SAS 实现有点问题，可能会随机导致信号发射中断。</li>
</ul>
</li>
<li><code>Carrier Aggregation</code> 选项不要打勾。
<ul>
<li>如果你想开载波聚合，此处打勾。</li>
</ul>
</li>
<li><code>BandWidth</code> 选择 20，把带宽拉满获得最高速度。</li>
<li><code>CellIDentity</code> 输入 <code>0</code>。如果你有多个基站，可以依次输入 <code>1</code>，<code>2</code> 等等，基站之间不要重复。
<ul>
<li>如果你想开载波聚合，输入 <code>0,1</code>，即逗号分隔的两个不同的 ID。</li>
</ul>
</li>
<li><code>PCI</code> 输入 <code>100</code>。如果你有多个基站，可以依次输入 <code>101</code>，<code>102</code> 等等，基站之间不要重复。
<ul>
<li>如果你想开载波聚合，输入 <code>100,101</code>，即逗号分隔的两个不同的 ID。</li>
</ul>
</li>
<li><code>TxPower</code> 输入 <code>24</code>。</li>
</ul>
</li>
<li>
<p><code>S1 Configuration</code> 下：</p>
<ul>
<li><code>Tunnel Type</code> 选择 IPv4。此时基站到核心网之间的数据是明文传输。
<ul>
<li>由于我们的基站和核心网在同一个局域网下，都由我们物理控制，所以这里的安全风险不大。但如果你的基站需要通过互联网连接到核心网，你应该尝试使用 <code>IPSEC</code> 选项，但相应的你需要额外配置 IPSec 隧道的相关设置。</li>
</ul>
</li>
<li><code>MME IP Address</code> 输入 <code>Open5GS</code> 核心网机器的 IP 地址。
<ul>
<li>如果你的 <code>Open5GS</code> 核心网的不同组件安装在不同机器上，此处输入运行 MME 组件机器的 IP 地址。</li>
</ul>
</li>
<li><code>PLMNID</code> 输入 <code>315010</code>，对应 CBRS 的 MCC/MNC。</li>
<li><code>TAC</code> 输入 <code>1</code>。</li>
</ul>
</li>
<li>
<p>如果你的基站所在位置 GPS 信号良好，<code>Sync Source</code> 可以选择 <code>GPS</code>。但如果 GPS 信号差，基站重启后需要等待 GPS 定位完成后才会开始发送信号。此时你可以选择 <code>FREE_RUNNING</code>。</p>
</li>
</ul>
<p>保存设置，这里建议重启一次基站以保证设置生效。保存设置时基站可能会自动重启，但如果基站没有重启，可以点击管理界面右上角的电源按钮手动重启一次，或者手动断电重启。</p>
<p>重启完成后，稍等片刻，看一下基站的指示灯，最左侧的 LTE 状态指示灯应该是蓝灯常亮，代表此时已经在发射 LTE 信号。到这里，基站的配置就全部完成了。</p>
<p>拿出你的手机，随便选择一张 SIM 卡，关闭「自动选择网络」选项，手机就会自动搜索附近的移动网络。如果你的手机支持 LTE 48 频段，你应该就能看到一个名为 <code>Lan Tian Mobile</code>（或者你自己配置的网络名称）的网络，这就是你的基站发射的信号。</p>
<p>基站管理面板上也应该显示 <code>henb running</code>，代表基站运行正常：</p>
<p><picture><source srcset="/usr/uploads/202507/sercomm-status.png.webp" type="image/webp"><source srcset="/usr/uploads/202507/sercomm-status.png.avif" type="image/avif"><source srcset="/usr/uploads/202507/sercomm-status.png.jxl" type="image/jxl"><img src="/usr/uploads/202507/sercomm-status.png" alt="Sercomm 基站状态页面"></picture></p>
<h1 id="将-sim-卡信息注册到-open5gs-上">将 SIM 卡信息注册到 Open5GS 上</h1>
<p>核心网和基站正常运行后，就可以将 SIM 卡注册到核心网上，让使用这些 SIM 卡的手机等设备连接 LTE 网络了。</p>
<p>准备几张可编程 SIM 卡，按照<a href="/article/modify-computer/legal-lte-network-at-home-for-100-bucks.lantian/#%E5%86%99-sim-%E5%8D%A1">上一篇文章中的写 SIM 卡教程</a>给你的 SIM 卡写入认证信息。记录下 SIM 卡的 IMSI/KI/OPC 信息。</p>
<p>登录 Open5GS 的 Web 管理面板，然后点击 <code>Add a subscriber</code>：</p>
<p><picture><source srcset="/usr/uploads/202507/open5gs-add-subscriber.png.webp" type="image/webp"><source srcset="/usr/uploads/202507/open5gs-add-subscriber.png.avif" type="image/avif"><source srcset="/usr/uploads/202507/open5gs-add-subscriber.png.jxl" type="image/jxl"><img src="/usr/uploads/202507/open5gs-add-subscriber.png" alt="Open5GS 添加 SIM 卡界面"></picture></p>
<ul>
<li><code>IMSI</code> 输入 SIM 卡对应的 IMSI 信息。</li>
<li><code>Subscriber Key</code> 输入 SIM 卡的 <code>KI</code>。</li>
<li><code>Operator Key</code> 输入 SIM 卡的 <code>OPC</code>。</li>
</ul>
<p>其它选项全部保持默认，点击 Save 保存。</p>
<p>把 SIM 卡插到你的手机上，稍等片刻，手机就应该可以连上你的移动网络了。</p>
<h1 id="总结">总结</h1>
<p>本文主要记录搭建 Open5GS 时与 Magma 核心网不同的步骤，以及在 NixOS 上搭建时特有的一些问题。相比 Magma，Open5GS 的安装流程更加简单，而且不依赖 Docker 等容器化管理工具。如果你用的是 Ubuntu，上面的大部分流程其实在 <code>apt install</code> 时就已经自动完成。</p>
<p>从 LTE 终端设备（例如手机）的角度来看，使用这两款核心网软件并没有什么区别，两者的延迟、网络带宽都没有大的差别，主要还是受到 LTE 通信本身的限制。（除了我使用 Magma 时遇到的，Android 手机无法正常认证的奇怪 Bug）</p>
<p>我切换到 Open5GS，也是为了开头提到的管理上的便利。你可以根据自己的喜好，选择 Open5GS 或者 Magma 之一。</p>  </div>  <div class="clearfix" id="post-navi" data-astro-cid-gfbmwgei=""> <div class="float-end text-end" data-astro-cid-gfbmwgei=""> <a href="/article/modify-computer/sidestore-without-stosvpn-across-lan.lantian/" title="在内网中免 StosVPN 使用 SideStore" data-astro-cid-gfbmwgei=""> 在内网中免 StosVPN 使用 SideStore </a> <br data-astro-cid-gfbmwgei=""> 下一篇文章 »
</div> <div class="float-start text-start position-absolute" data-astro-cid-gfbmwgei="">
« 上一篇文章 <br data-astro-cid-gfbmwgei="">   </div> </div>  <div id="waline" data-waline-language="zh-CN" data-waline-path="/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian"></div> <script type="module" src="/assets/WalineComment.astro_astro_type_script_index_0_lang.Dqib3X1E.js"></script>  </div> </div> </article>  </div> <aside class="d-none d-xl-block"> <section class="widget"> <h3>最新文章</h3> <ul class="list-unstyled"> <li> 07-20  <a href="/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/">用 Open5GS 搭建合法的 LTE 网络</a> </li><li> 06-27  <a href="/article/modify-computer/sidestore-without-stosvpn-across-lan.lantian/">在内网中免 StosVPN 使用 SideStore</a> </li><li> 05-19  <a href="/article/modify-computer/nix-logarithmetic-math-library-from-zero.lantian/">从零开始实现 Nix 对数函数库</a> </li><li> 04-06  <a href="/article/modify-computer/legal-lte-network-at-home-for-100-bucks.lantian/">$100，DIY 搭建合法的 LTE 网络</a> </li><li> 02-10  <a href="/article/modify-computer/build-custom-android-kernel-with-nix.lantian/">用 Nix 编译自定义 Android 内核</a> </li><li> 04-20  <a href="/article/modify-website/migrate-blog-to-astro-js.lantian/">使用 Astro.js 重构我的博客</a> </li><li> 12-16  <a href="/article/modify-computer/nixos-low-ram-vps.lantian/">NixOS 系列（五）：制作小内存 VPS 的 DD 磁盘镜像</a> </li><li> 09-20  <a href="/article/modify-computer/nix-trigonometric-math-library-from-zero.lantian/">从零开始实现 Nix 三角函数库</a> </li><li> 05-29  <a href="/article/random-notes/pipewire-sigkill-fix.lantian/">解决 Pipewire 被 SIGKILL 的问题</a> </li><li> 05-12  <a href="/article/modify-website/how-to-kill-the-dn42-network.lantian/">如何引爆 DN42 网络（2023-05-12 更新）</a> </li><li> 05-08  <a href="/article/modify-computer/laptop-muxed-nvidia-passthrough.lantian/">Optimus MUXed 笔记本上的 NVIDIA 虚拟机显卡直通（2023-05 更新）</a> </li><li> 04-17  <a href="/article/random-notes/fix-china-telecom-roaming-no-4g-on-aosp-rom.lantian/">修改 APN 解决 AOSP ROM 上中国电信无法 4G 漫游问题</a> </li><li> 03-26  <a href="/article/random-notes/old-hp-workstation-as-all-in-one.lantian/">老款 HP 工作站配置 NAS+软路由笔记</a> </li><li> 01-14  <a href="/article/modify-computer/nixos-impermanence.lantian/">NixOS 系列（四）：“无状态”操作系统</a> </li><li> 06-21  <a href="/article/modify-computer/nixos-packaging.lantian/">NixOS 系列（三）：软件打包，从入门到放弃</a> </li> </ul> </section> <section class="widget"> <h3>最新评论</h3> <ul class="list-unstyled" id="recent-comments">  <li><a href="#">Loading...</a></li>  </ul> </section> <script type="module">const i=window.location.hostname=="localhost"?"https://comments.lantian.pub":window.location.origin;fetch(`${i}/api/comment?type=recent&count=10`).then(t=>{if(t.status!==200)throw new Error(`Server returned bad HTTP status ${t.status}`);return t.json()}).then(t=>{const e=document.getElementById("recent-comments");e&&(e.innerHTML=t.data.map(n=>{const o=n.comment.replace(/(<([^>]+)>)/gi,"");return"<li>"+n.nick+' <a href="'+n.url+'">'+o+"</a></li>"}).join(""))});</script> <section class="widget"> <h3>其它功能</h3> <ul class="list-unstyled">  <li> <i class="fas fa-fw fa-rss"></i>  <a href="/rss2.xml" target="_blank">RSS 订阅</a> |  <a href="/feed.xml" target="_blank">Atom</a> |  <a href="/feed.json" target="_blank">JSON</a> </li> <li> <i class="fas fa-fw fa-globe"></i>  <a href="https://stats.uptimerobot.com/BLK6VsRkR" target="_blank"> 服务器状态 </a> </li> <li> <i class="fas fa-fw fa-sitemap"></i>  <a href="https://lg.lantian.pub" target="_blank">DN42 节点状态</a> </li> <li> <i class="fas fa-fw fa-link"></i>  <a href="gopher://lantian.pub" target="_blank">使用 Gopher 协议访问</a> </li>  </ul> </section> <section class="widget"> <h3>友情链接</h3> <ul class="list-unstyled"> <li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://0x7f.cc"> 0x7f Blog 🐑 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://alanyhq.com"> Alanyhq </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.cas7.moe"> Blog of Moecast </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://jerryxiao.cc"> JerryXiao </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://snli.org"> Shucheng Li </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://sangsir.com"> SangSir | 艺术界的一朵奇葩 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://yuetau.net"> YuetAu&#39;s Spot </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.baoshuo.ren/?utm_source=friends"> 宝硕博客 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="http://foreverblog.cn"> 十年之约 </a> </li> </ul> </section> </aside> </div> <footer class="lantian clearfix" data-astro-cid-w3csb3e3="">  <div id="copyright" class="float-end text-end" data-astro-cid-w3csb3e3=""> <i class="fas fa-copyright" data-astro-cid-w3csb3e3=""></i> 2012-2025 Lan Tian @ Blog<br data-astro-cid-w3csb3e3=""> <small data-astro-cid-w3csb3e3=""> 基于 Astro v5.15.1 构建 @ 2025-10-25 23:46:32 </small> </div> <script type="module">function v(c,o,r){const h=/^localhost$|^127(?:\.[0-9]+){0,2}\.[0-9]+$|^(?:0*:)*?:?0*1$/.test(location.hostname)||location.protocol==="file:";if(!o.trackLocalhost&&h)return console.warn("[Plausible] Ignoring event because website is running locally");try{if(window.localStorage.plausible_ignore==="true")return console.warn('[Plausible] Ignoring event because "plausible_ignore" is set to "true" in localStorage')}catch{}const p={n:c,u:o.url,d:o.domain,r:o.referrer,w:o.deviceWidth,h:o.hashMode?1:0,p:r&&r.props?JSON.stringify(r.props):void 0},s=new XMLHttpRequest;s.open("POST",`${o.apiHost}/api/event`,!0),s.setRequestHeader("Content-Type","text/plain"),s.send(JSON.stringify(p)),s.onreadystatechange=()=>{s.readyState===4&&r&&r.callback&&r.callback()}}function b(c){const o=()=>({hashMode:!1,trackLocalhost:!1,url:location.href,domain:location.hostname,referrer:document.referrer||null,deviceWidth:window.innerWidth,apiHost:"https://plausible.io",...c}),r=(t,n,i)=>{v(t,{...o(),...i},n)},h=(t,n)=>{r("pageview",n,t)};return{trackEvent:r,trackPageview:h,enableAutoPageviews:()=>{const t=()=>h(),n=history.pushState;return n&&(history.pushState=function(i,l,u){n.apply(this,[i,l,u]),t()},addEventListener("popstate",t)),c&&c.hashMode&&addEventListener("hashchange",t),h(),function(){n&&(history.pushState=n,removeEventListener("popstate",t)),c&&c.hashMode&&removeEventListener("hashchange",t)}},enableAutoOutboundTracking:(t=document,n={subtree:!0,childList:!0,attributes:!0,attributeFilter:["href"]})=>{function i(e){r("Outbound Link: Click",{props:{url:this.href}}),typeof process<"u"&&process,setTimeout(()=>{location.href=this.href},150),e.preventDefault()}const l=new Set;function u(e){e instanceof HTMLAnchorElement?e.host!==location.host&&(e.addEventListener("click",i),l.add(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(u)}function f(e){e instanceof HTMLAnchorElement?(e.removeEventListener("click",i),l.delete(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(f)}const d=new MutationObserver(e=>{e.forEach(a=>{a.type==="attributes"?(f(a.target),u(a.target)):a.type==="childList"&&(a.addedNodes.forEach(u),a.removedNodes.forEach(f))})});return t.querySelectorAll("a").forEach(u),d.observe(t,n),function(){l.forEach(a=>{a.removeEventListener("click",i)}),l.clear(),d.disconnect()}}}}const g=b({domain:"lantian.pub",trackLocalhost:!0,apiHost:""});g.trackPageview();</script> </footer>  </div>  </body> </html>