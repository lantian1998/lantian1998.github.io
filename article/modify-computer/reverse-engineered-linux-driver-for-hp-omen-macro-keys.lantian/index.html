<!DOCTYPE html><html lang="zh-CN" itemscope="" itemtype="https://schema.org/Article" data-astro-cid-porej7z2=""> <head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>用逆向工程方式给惠普暗影精灵宏按键编写 Linux 驱动 - Lan Tian @ Blog</title><script>
  ;(() => {
    try {
      const mode = localStorage.getItem('user-color-scheme')
      if (mode == 'dark' || mode == 'light') {
        document.documentElement.setAttribute('data-user-color-scheme', mode)
      }
    } catch {
      // Ignore errors
    }
  })()
</script><link rel="stylesheet" href="/assets/index.CUlf1-Vz.css"><style>#post-navi[data-astro-cid-gfbmwgei]{padding:5px;border-top:1px solid var(--lt-border-weak);border-bottom:1px solid var(--lt-border-weak)}
ol[data-astro-cid-nj3qel45]{margin:0;padding:0;line-height:1.5}ol[data-astro-cid-nj3qel45] .toc-item[data-astro-cid-nj3qel45]{list-style:none}ol[data-astro-cid-nj3qel45] .toc-child[data-astro-cid-nj3qel45],ol[data-astro-cid-nj3qel45] .toc[data-astro-cid-nj3qel45]{padding:0}ol[data-astro-cid-nj3qel45] .toc-link[data-astro-cid-nj3qel45]{display:block;margin-left:1em;padding:.25em 0}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;width:1em;padding:.25em 0;float:left;font-style:normal;font-variant:normal;font-weight:900;font-family:Font Awesome\ 6 Free;font-feature-settings:normal;text-align:center}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before{content:""}ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{content:""}.post-info-wrap[data-astro-cid-dckccua4]{-ms-flex:0 0 2.5em;flex:0 0 2.5em;background-color:var(--lt-component-bg-emphasis)}@media(min-width:768px){.post-info[data-astro-cid-dckccua4]{position:sticky;top:0}}@media(max-width:767.98px){.post-info[data-astro-cid-dckccua4]{position:absolute}}
</style><script type="module" src="/assets/PageLayout.astro_astro_type_script_index_0_lang.C1wfUPs6.js"></script><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Referrer-Policy" content="no-referrer, strict-origin-when-cross-origin"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="imagemode" content="force"><meta name="nightmode" content="disable"><meta name="wap-font-scale" content="no"><meta name="title" content="用逆向工程方式给惠普暗影精灵宏按键编写 Linux 驱动 - Lan Tian @ Blog"><meta name="keywords" content=""><meta name="author" content="Lan Tian"><link rel="canonical" href="https://lantian.pub/article/modify-computer/reverse-engineered-linux-driver-for-hp-omen-macro-keys.lantian/"><link rel="alternate" type="application/rss+xml" title="Lan Tian @ Blog" href="https://lantian.pub/rss2.xml"><link rel="alternate" type="application/atom+xml" title="Lan Tian @ Blog" href="https://lantian.pub/feed.xml"><link rel="alternate" href="https://lantian.pub/article/modify-computer/reverse-engineered-linux-driver-for-hp-omen-macro-keys.lantian/" hreflang="zh"><link rel="alternate" href="https://lantian.pub/en/article/modify-computer/reverse-engineered-linux-driver-for-hp-omen-macro-keys.lantian/" hreflang="en"><meta name="copyright" content="Copyright 2012-2025 Lan Tian @ Blog"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#03a9f4"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#212121"><meta name="application-name" content="Lan Tian @ Blog"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="apple-touch-icon" sizes="1024x1024" href="/apple-touch-icon-1024x1024.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#03a9f4"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Lan Tian @ Blog"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-640x1136.png"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1136x640.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-750x1334.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1334x750.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1125x2436.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2436x1125.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1170x2532.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2532x1170.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1179x2556.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2556x1179.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-828x1792.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1792x828.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2688.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2688x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2208.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2208x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1284x2778.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2778x1284.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1290x2796.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2796x1290.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1488x2266.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2266x1488.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1536x2048.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2048x1536.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1620x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1620.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1640x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1640.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2388.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2388x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2224.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2224x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-2048x2732.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2732x2048.png"><meta name="msapplication-TileColor" content="#bbdefb"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"><meta property="og:url" content="https://lantian.pub/article/modify-computer/reverse-engineered-linux-driver-for-hp-omen-macro-keys.lantian/"><meta property="og:type" content="website"><meta property="og:title" content="用逆向工程方式给惠普暗影精灵宏按键编写 Linux 驱动 - Lan Tian @ Blog"><meta property="og:image" content="https://lantian.pub/apple-touch-icon.png"><meta content="我前段时间换了台新电脑，惠普的暗影精灵 17t-ck000（美版，应该对应的是国内的暗影精灵 7 Plus）。这台电脑好是好，做工优秀，性能强大，就是有一个问题：它在 Linux 下的驱动支持实在是太烂了。 不支持调节风扇转速，你能看到风扇转速，但仅此而已。再加上惠普的默认风扇策略非常激进，即使我开启了 BIOS 中的低温风扇停转功能，它依然在 CPU 温度只有 40 度、显卡空载的情况下转得非常欢快。 其实可以用 NBFC 直接写 EC 寄存器来控制，但在 某次不幸的事故中 当时的配置方案丢失了。 我配置 NBFC 时正在新电脑试用 NixOS。事故发生时新电脑上的 NixOS 被我删掉了，而且当时的配置没上传 GitHub。 过段时间再重新写一遍（咕咕咕） 不支持调整键盘背光颜色，它们在 Windows 下由 OMEN Command Center 软件控制。有时系统崩溃、我长按电源键断电重启时，BIOS 会将键盘背光恢复成默认的五彩斑斓的颜色，此时我只能回到 Windows 进行调节。..."><meta property="og:site_name" content="Lan Tian @ Blog"><meta property="og:locale" content="zh"><meta name="twitter:card" content="summary"><meta name="twitter:url" content="https://lantian.pub/article/modify-computer/reverse-engineered-linux-driver-for-hp-omen-macro-keys.lantian/"><meta name="twitter:title" content="用逆向工程方式给惠普暗影精灵宏按键编写 Linux 驱动 - Lan Tian @ Blog"><meta property="twitter:image" content="https://lantian.pub/apple-touch-icon.png"><meta content="我前段时间换了台新电脑，惠普的暗影精灵 17t-ck000（美版，应该对应的是国内的暗影精灵 7 Plus）。这台电脑好是好，做工优秀，性能强大，就是有一个问题：它在 Linux 下的驱动支持实在是太烂了。 不支持调节风扇转速，你能看到风扇转速，但仅此而已。再加上惠普的默认风扇策略非常激进，即使我开启了 BIOS 中的低温风扇停转功能，它依然在 CPU 温度只有 40 度、显卡空载的情况下转得非常欢快。 其实可以用 NBFC 直接写 EC 寄存器来控制，但在 某次不幸的事故中 当时的配置方案丢失了。 我配置 NBFC 时正在新电脑试用 NixOS。事故发生时新电脑上的 NixOS 被我删掉了，而且当时的配置没上传 GitHub。 过段时间再重新写一遍（咕咕咕） 不支持调整键盘背光颜色，它们在 Windows 下由 OMEN Command Center 软件控制。有时系统崩溃、我长按电源键断电重启时，BIOS 会将键盘背光恢复成默认的五彩斑斓的颜色，此时我只能回到 Windows 进行调节。..."><meta name="twitter:dnt" content="on"><meta itemprop="name" content="用逆向工程方式给惠普暗影精灵宏按键编写 Linux 驱动 - Lan Tian @ Blog"><meta property="image" content="https://lantian.pub/apple-touch-icon.png"><meta content="我前段时间换了台新电脑，惠普的暗影精灵 17t-ck000（美版，应该对应的是国内的暗影精灵 7 Plus）。这台电脑好是好，做工优秀，性能强大，就是有一个问题：它在 Linux 下的驱动支持实在是太烂了。 不支持调节风扇转速，你能看到风扇转速，但仅此而已。再加上惠普的默认风扇策略非常激进，即使我开启了 BIOS 中的低温风扇停转功能，它依然在 CPU 温度只有 40 度、显卡空载的情况下转得非常欢快。 其实可以用 NBFC 直接写 EC 寄存器来控制，但在 某次不幸的事故中 当时的配置方案丢失了。 我配置 NBFC 时正在新电脑试用 NixOS。事故发生时新电脑上的 NixOS 被我删掉了，而且当时的配置没上传 GitHub。 过段时间再重新写一遍（咕咕咕） 不支持调整键盘背光颜色，它们在 Windows 下由 OMEN Command Center 软件控制。有时系统崩溃、我长按电源键断电重启时，BIOS 会将键盘背光恢复成默认的五彩斑斓的颜色，此时我只能回到 Windows 进行调节。..."><meta content="我前段时间换了台新电脑，惠普的暗影精灵 17t-ck000（美版，应该对应的是国内的暗影精灵 7 Plus）。这台电脑好是好，做工优秀，性能强大，就是有一个问题：它在 Linux 下的驱动支持实在是太烂了。 不支持调节风扇转速，你能看到风扇转速，但仅此而已。再加上惠普的默认风扇策略非常激进，即使我开启了 BIOS 中的低温风扇停转功能，它依然在 CPU 温度只有 40 度、显卡空载的情况下转得非常欢快。 其实可以用 NBFC 直接写 EC 寄存器来控制，但在 某次不幸的事故中 当时的配置方案丢失了。 我配置 NBFC 时正在新电脑试用 NixOS。事故发生时新电脑上的 NixOS 被我删掉了，而且当时的配置没上传 GitHub。 过段时间再重新写一遍（咕咕咕） 不支持调整键盘背光颜色，它们在 Windows 下由 OMEN Command Center 软件控制。有时系统崩溃、我长按电源键断电重启时，BIOS 会将键盘背光恢复成默认的五彩斑斓的颜色，此时我只能回到 Windows 进行调节。..."><link rel="me" href="https://mastodon.social/@lantian"></head> <body data-astro-cid-porej7z2=""> <div id="bg" data-astro-cid-j6vmxtef=""></div>   <div id="container" class="container" data-astro-cid-porej7z2=""> <nav class="lantian navbar navbar-expand-lg" data-astro-cid-wu5dj4rx=""> <div class="container-fluid" data-astro-cid-wu5dj4rx=""> <a class="navbar-brand" href="/" data-astro-cid-wu5dj4rx="">Lan Tian @ Blog</a> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#lantian-navbar" aria-controls="lantian-navbar" aria-expanded="false" aria-label="Toggle navigation" data-astro-cid-wu5dj4rx=""> <span class="navbar-toggler-icon" data-astro-cid-wu5dj4rx=""></span> </button> <div class="collapse navbar-collapse" id="lantian-navbar" data-astro-cid-wu5dj4rx=""> <ul class="navbar-nav" data-astro-cid-wu5dj4rx=""> <li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/page/archive/index.html" data-astro-cid-wu5dj4rx=""> 文章们 </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> 俯瞰地球 </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> <li class="nav-item dropdown d-block d-lg-none" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="pages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-file" data-astro-cid-wu5dj4rx=""></i> 页面  <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="pages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/page/archive/index.html" data-astro-cid-wu5dj4rx=""> 文章们 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> 俯瞰地球 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> </ul> </li> </ul> <ul class="navbar-nav ms-auto" data-astro-cid-wu5dj4rx=""> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="languages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-language" data-astro-cid-wu5dj4rx=""></i> Language <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="languages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item active" href="/article/modify-computer/reverse-engineered-linux-driver-for-hp-omen-macro-keys.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-cn" data-astro-cid-wu5dj4rx=""></span> Chinese Simplified / 简体中文 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/article/modify-computer/reverse-engineered-linux-driver-for-hp-omen-macro-keys.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-us" data-astro-cid-wu5dj4rx=""></span> English </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">Not all pages have translations.</a> </li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">You may see 404 - this is normal.</a> </li> </ul> </li> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="color-scheme-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> 夜间模式 </a> <ul class="dropdown-menu" aria-labelledby="color-scheme-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-auto" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> 自动 </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-light" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-sun" data-astro-cid-wu5dj4rx=""></i> 浅色</a> </li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-dark" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-moon" data-astro-cid-wu5dj4rx=""></i> 深色</a> </li> </ul> </li> </ul> </div> </div> </nav> <script type="module">const m="user-color-scheme",s="data-user-color-scheme",u=(e,t)=>{try{localStorage.setItem(e,t)}catch{}},i=e=>{try{return localStorage.getItem(e)}catch{return null}},c=e=>{const t={dark:!0,light:!0,auto:!0},o=e===null||!Object.keys(t).includes(e)?"auto":e;u(m,o);for(const l in t){const n=document.getElementById("color-scheme-"+l);n&&(l==o?n.classList.add("active"):n.classList.remove("active"))}o!="auto"?document.documentElement.setAttribute(s,o):document.documentElement.removeAttribute(s)};c(i(m));const r=document.getElementById("color-scheme-auto");r&&r.addEventListener("click",()=>c("auto"));const a=document.getElementById("color-scheme-light");a&&a.addEventListener("click",()=>c("light"));const d=document.getElementById("color-scheme-dark");d&&d.addEventListener("click",()=>c("dark"));</script>  <div class="d-flex" data-astro-cid-porej7z2=""> <div id="content" data-astro-cid-porej7z2="">  <article> <div class="d-flex"> <div class="post-info-wrap" data-astro-cid-dckccua4=""> <div class="post-info" data-astro-cid-dckccua4=""> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-clock"></span> <br> <small>04-04</small> </p> <div class="post-meta-value"> 发布于<span class="badge badge-tag" data-astro-cid-dckccua4=""> 2022-04-04 05:16 </span>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-file-alt"></span> <br> <small>计算机与客户端</small> </p> <div class="post-meta-value"> 分类 <a class="badge badge-tag" href="/category/modify-computer" data-astro-cid-dckccua4=""> 计算机与客户端 </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-tag"></span> <br> <small>4 标签</small> </p> <div class="post-meta-value"> 标签  <a class="badge badge-tag" href="/tag/惠普" data-astro-cid-dckccua4=""> 惠普 </a>  <a class="badge badge-tag" href="/tag/暗影精灵" data-astro-cid-dckccua4=""> 暗影精灵 </a>  <a class="badge badge-tag" href="/tag/宏按键" data-astro-cid-dckccua4=""> 宏按键 </a>  <a class="badge badge-tag" href="/tag/Linux" data-astro-cid-dckccua4=""> Linux </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-list"></span> <br> <small>目录</small> </p> <div class="post-meta-value">  <ol data-astro-cid-nj3qel45=""> <li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#逆向之旅" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">逆向之旅</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#编写-linux-驱动" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">编写 Linux 驱动</span> </a> </li><li class="toc-item toc-level-1" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#下载" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">下载</span> </a> </li> </ol>   </div> </div> </div> </div>  </div>  <div class="post-wrap">  <h1 class="post-title"> <a href="/article/modify-computer/reverse-engineered-linux-driver-for-hp-omen-macro-keys.lantian/" rel="bookmark" title="用逆向工程方式给惠普暗影精灵宏按键编写 Linux 驱动">用逆向工程方式给惠普暗影精灵宏按键编写 Linux 驱动</a> </h1> <div class="post-text">   <p>我前段时间换了台新电脑，惠普的暗影精灵 17t-ck000（美版，应该对应的是国内的暗影精灵 7 Plus）。这台电脑好是好，做工优秀，性能强大，就是有一个问题：它在 Linux 下的驱动支持实在是太烂了。</p>
<ol>
<li>
<p>不支持调节风扇转速，你能看到风扇转速，但仅此而已。再加上惠普的默认风扇策略非常激进，即使我开启了 BIOS 中的低温风扇停转功能，它依然在 CPU 温度只有 40 度、显卡空载的情况下转得非常欢快。</p>
<ul>
<li>其实可以用 <a href="https://github.com/hirschmann/nbfc" rel="noopener noreferrer" target="_blank">NBFC</a> 直接写 EC 寄存器来控制，但在<a href="/article/chat/how-i-nuked-my-btrfs-partition.lantian/">某次不幸的事故中</a>当时的配置方案丢失了。</li>
<li>我配置 NBFC 时正在新电脑试用 NixOS。事故发生时新电脑上的 NixOS 被我删掉了，而且当时的配置没上传 GitHub。</li>
<li>过段时间再重新写一遍（咕咕咕）</li>
</ul>
</li>
<li>
<p>不支持调整键盘背光颜色，它们在 Windows 下由 OMEN Command Center 软件控制。有时系统崩溃、我长按电源键断电重启时，BIOS 会将键盘背光恢复成默认的五彩斑斓的颜色，此时我只能回到 Windows 进行调节。</p>
<ul>
<li>好在 GitHub 有一个修改版的 Linux <code>hp_wmi</code> 内核模块，支持了在 Linux 下控制背光颜色。</li>
<li>它是由 James Churchill（pelrun）开发的，可以在
<a href="https://github.com/pelrun/hp-omen-linux-module" rel="noopener noreferrer" target="_blank">https://github.com/pelrun/hp-omen-linux-module</a> 下载。</li>
</ul>
</li>
<li>
<p>键盘左边有一排宏按键 P1-P6。它们在 Windows 下由 OMEN Command Center 软件控制，可以配置宏定义，在按下按键时模拟一段键盘输入。当然，这个功能 Linux 下是用不了的。</p>
<ul>
<li><a href="https://h30434.www3.hp.com/t5/Gaming-Notebooks/HP-Omen-keyboard-control-on-Linux/td-p/4890663" rel="noopener noreferrer" target="_blank">惠普没有开发 Linux 版 OMEN Command Center 的计划</a>。</li>
</ul>
</li>
</ol>
<p>键盘上有几个用不了的按键，这就让人很不爽。虽然我不是重度游戏玩家，用不到宏按键，但即使把它们设置成一些程序的快捷键，用来快速打开浏览器、终端，也是好的。</p>
<p>于是我就开始了对 OMEN Command Center 的逆向之旅。</p>
<h1 id="逆向之旅">逆向之旅</h1>
<p>OMEN Command Center 是一个用微软 .NET 技术写成的软件。这就意味着对它的逆向非常简单。作为 .NET 程序，OMEN Command Center 的每个 DLL 文件都被命名为它的类名，可以直接根据文件名称确定它的作用。另外，用
<a href="https://www.jetbrains.com/decompiler/" rel="noopener noreferrer" target="_blank">JetBrains 的 dotPeek 软件</a>，可以直接把
.NET 程序反编译成带有原始函数变量名的 C# 代码，不用像反编译 C 程序一样读汇编、猜测函数作用。</p>
<p>在用 dotPeek 逐个反编译 DLL 文件的过程中，我注意到了 <code>HP.Omen.MacrosModule.dll</code>
文件，它似乎是键盘宏功能的 DLL 文件。一番查找后，我定位到了
<code>HP.Omen.MacrosModule.Models.MacroModel</code> 这个类，它负责将 OMEN Command Center 的宏定义翻译成 EC 能看懂的二进制表示，并通过
<a href="https://docs.microsoft.com/en-us/samples/microsoft/windows-driver-samples/wmi-acpi-sample/" rel="noopener noreferrer" target="_blank">WMI ACPI</a>
功能写入 EC。</p>
<p>首先来看 <code>OnEditorPageSaveClick</code> 函数：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">private</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> void</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> OnEditorPageSaveClick</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">string</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> obj</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  // 略过了无关部分</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">  switch</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">platformInfo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">Platform</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  {</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    case</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99"> DeviceEnums</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">DeviceType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">Dragons10</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      // 与 Dragons10 设备相关的逻辑</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">      break</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    case</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99"> DeviceEnums</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">DeviceType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">Marlins10</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    case</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99"> DeviceEnums</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">DeviceType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">Marlins11</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      // 与 Marlins 设备相关的逻辑</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">      break</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    default</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">      goto</span><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB"> case</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> DeviceEnums</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">DeviceType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">Marlins10</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  }</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>那么问题来了，我的电脑的版本是 Dragons 还是 Marlins？这里的版本实际上是读取
<code>HP.Omen.DeviceLib</code> 里的 <code>DeviceList.json</code> 设备列表而来的，这份 JSON 中的设备编号对应的是电脑的 PCI Subsystem Device ID。首先确定我的电脑的编号：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># lspci -nnk | grep VGA -A 2</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">0000:00:02.0</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> VGA</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> compatible</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> controller</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> [0300]: Intel Corporation TigerLake-H GT1 [UHD Graphics] [8086:9a60] (</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rev</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 01</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        DeviceName:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">  Onboard</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> IGD</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        Subsystem:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Hewlett-Packard</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Company</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Device</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> [103c:88f7]</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">--</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">0000:01:00.0</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> VGA</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> compatible</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> controller</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> [0300]: NVIDIA Corporation GA104M [GeForce RTX </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">3070</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> Mobile / Max-Q] [10de:249d] (</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rev</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> a1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        DeviceName:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> NVIDIA</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Graphics</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Device</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">        Subsystem:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Hewlett-Packard</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Company</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Device</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> [103c:88f7]</span></span></code></pre>
<p>我的编号是 <code>88f7</code>。再去查询那份 JSON 文件：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">// 略过了无关部分</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">  "Name"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"Cybug"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">  "DisplayName"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"OMEN 17"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">  "ProductNum"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: [</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">      "SSID"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"88F7"</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> // GN20E (E3/E5/E7) non DDS</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    }</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ],</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">  "Feature"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "SystemInfo"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "NetworkBooster"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "FourZone"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "DraxLighting"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "PerformanceControl"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "GraphicsSwitcher"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "Macros"</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ],</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">  "BackgroundFeature"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "NetworkBooster"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "OmenKey"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "FourZone"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "DraxLightingBg"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "PerformanceControl"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "MarlinsMacro"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    "DragonKBMcu"</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ]</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>功能列表里有 <code>MarlinsMacro</code>，看来我的电脑属于 Marlins。继续读 Marlins 相关的逻辑：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">private</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> void</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> OnEditorPageSaveClick</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">string</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> obj</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  // 略过了无关部分</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">  switch</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">platformInfo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">Platform</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  {</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    case</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99"> DeviceEnums</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">DeviceType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">Marlins10</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    case</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99"> DeviceEnums</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">DeviceType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">Marlins11</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      // 只保留了关键逻辑</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">      setValue</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">SetBytesToEC</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">_tmpSeletcItemSrc</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">InputKeysRecordDelay</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">);</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">      ec</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">SetBytesToEC</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">_tmpSeletcItemSrc</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">InputKeysCustomDelay</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">);</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">      break</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  }</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>调用了 <code>SetBytesToEC</code> 函数，它负责将按键序列翻译成 EC 的二进制表示：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">public</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[] </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">SetBytesToEC</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">ObservableCollection</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">&#x3C;</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">InputKeyInfo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">> </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">Items</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">  List</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">&#x3C;</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">> </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">byteList</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">new</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99"> List</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">&#x3C;</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">>();</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  // 如果按键序列为空，直接返回 [1]</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">  if</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">Items</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> == </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">null</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    byteList</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Insert</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">byteList</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">Count</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">));</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    return</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> byteList</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">ToArray</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">();</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  }</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">  for</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">int</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> index</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">; </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">index</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> &#x3C; </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">Items</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">Count</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">; ++</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">index</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    // 如果是特殊功能键（Home，End，Insert，Delete，方向键，Win 键，右 Ctrl 和右 Alt），在前面加一个 0xE0</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    // 这说明这里的按键编码是 PS/2 的 Scan Code Set 1（但不完全是）</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    if</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">ExtensionKeyMap</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">ContainsKey</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">Items</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">index</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">].</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">VKey</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">))</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">      byteList</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Add</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">((</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">224</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">);</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    // 根据按键类型：</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    switch</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">Items</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">index</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">].</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">Type</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    {</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">      case</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99"> KeyInfoType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">DelayTime</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">        // 延迟，等待一段时间再按下一个键</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">        // 格式为 [255, 时间（ms）]</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">        double</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> num</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">        for</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (delayTime = Items[index].DelayTime; </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">delayTime</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> - (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">int</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">MaxValue</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> > </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">; </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">delayTime</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> -= (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">int</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">MaxValue</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">          byteList</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Add</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">MaxValue</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">);</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">          byteList</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Add</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">MaxValue</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">);</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        }</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">        byteList</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Add</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">MaxValue</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">);</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">        byteList</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Add</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">((</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">num</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">);</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">        break</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">      case</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99"> KeyInfoType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">KeyDown</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">      case</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99"> KeyInfoType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">KeyUp</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">        // 按键，直接把 Scan Code 写进去</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">        // 根据 Scan Code Set 1，松开按键的编码 = 按下按键的编码 | 0x80</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">        byteList</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Add</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">GetECScanCode</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">Items</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">index</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">]));</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">        break</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    }</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  }</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  // 在序列开头加上 1 byte 的序列长度（包含长度 byte 本身）</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  byteList</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Insert</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">byteList</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">Count</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">));</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">  return</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> byteList</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">ToArray</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">();</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>根据
<a href="https://wiki.osdev.org/PS/2_Keyboard#Scan_Code_Set_1" rel="noopener noreferrer" target="_blank">PS/2 Scan Code Set 1 的对照表</a>，我们可以简单地编码几份按键序列：</p>
<ol>
<li>按下再松开 A 键：<code>[3, 0x1e, 0x9e]</code></li>
<li>按下 A 键，等 100 毫秒，再松开：<code>[5, 0x1e, 255, 100, 0x9e]</code></li>
<li>按下 A 键，等 300 毫秒，再松开：<code>[7, 0x1e, 255, 255, 255, 45, 0x9e]</code>
<ul>
<li>由于 byte 数据类型限制，每次最多等 255 毫秒，因此等 300 毫秒要分两次完成。</li>
</ul>
</li>
</ol>
<p>继续分析 <code>OnEditorPageSaveClick</code> 的逻辑：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">private</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> void</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> OnEditorPageSaveClick</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">string</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> obj</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  // 略过了无关部分</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">  switch</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">platformInfo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">Platform</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  {</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    case</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99"> DeviceEnums</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">DeviceType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">Marlins10</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    case</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99"> DeviceEnums</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">DeviceType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">Marlins11</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">      this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">SetMacrosToSystemInfoService</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">platformInfo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">Platform</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">);</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">      break</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  }</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p><code>SetMacrosToSystemInfoService</code> 函数负责将按键序列编码写入 EC：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">private</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> void</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> SetMacrosToSystemInfoService</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span></span>
<span class="line"><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">  DeviceEnums</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">DeviceType</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> _pType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">  EnumMacroKeyDragons</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> dKey</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">EnumMacroKeyDragons</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">P1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">  MacroKeyItem</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> iKey</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">null</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  // 略过了无关部分，和不重要的错误检查部分</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">  int</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> index1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">  switch</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">_pType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  {</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    case</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99"> DeviceEnums</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">DeviceType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">Marlins10</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">    case</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99"> DeviceEnums</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">DeviceType</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">Marlins11</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">      foreach</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">EnumMacroKeyMarlins</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> enumMacroKeyMarlins</span><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB"> in</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> Enum</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">GetValues</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">typeof</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">EnumMacroKeyMarlins</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)))</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      {</span></span>
<span class="line"><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">        EnumMacroKeyMarlins</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> enumValue</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">enumMacroKeyMarlins</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">        if</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">enumValue</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> != </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">EnumMacroKeyMarlins</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">FN</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">          // 对每个除 Fn 以外的宏按键：</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">          if</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">macroKeyItem</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> != </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">null</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">          {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">            // 把编码后的按键序列追加到 bMacroKeyRawArray 上</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">            num</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = ((</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99">IEnumerable</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">&#x3C;</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">>) </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">source</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">).</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Count</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">&#x3C;</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">>();</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">            for</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">int</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> index2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">; </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">index2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> &#x3C; </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">num</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">; ++</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">index2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">              this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">platformInfo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">bMacroKeyRawArray</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">index1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">index2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">] = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">source</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">index2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">          }</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">          else</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">          {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">            // 这个按键没有对应序列，直接追加 [1]（就是空按键序列编码后的值）</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">            num</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">            this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">platformInfo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">bMacroKeyRawArray</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">index1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">] = (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">          }</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">          index1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> += </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">num</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        }</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      }</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      // 最后多加一个 1，意义不明</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">      this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">platformInfo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">bMacroKeyRawArray</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">index1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">] = (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      // WMI 写入，其中 HPWMICommand = 0x20008，HPWMICMDTypeSet = 15，MacroKeyBufferSize = 4096</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">      this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">ExcuteBIOSWmiCommandAsync</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">platformInfo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">HPWMICommand</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">platformInfo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">HPWMICMDTypeSet</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">platformInfo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">MacroKeyBufferSize</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">platformInfo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">bMacroKeyRawArray</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">);</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      // WMI 写入，开启宏按键功能（写入 0 是关闭）</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">      this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">ExcuteBIOSWmiCommandAsync</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">this</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">platformInfo</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">HPWMICommand</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">23</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">4</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">new</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">4</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">]</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      {</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        (</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">byte</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">) </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      }, </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">);</span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">      break</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  }</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>这段逻辑就是将所有宏按键的序列编码按顺序合并在一起，最后执行 WMI 命令写入 EC。</p>
<p>按键的顺序在 <code>HP.Omen.MacrosModule.Models.EnumMacroKeyMarlins</code>：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">public</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> enum</span><span style="--shiki-dark:#4EC9B0;--shiki-light:#267F99"> EnumMacroKeyMarlins</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  FN</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  P1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  P2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  P3</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  P4</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  P5</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  P6</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  CTRL_P1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  CTRL_P2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  CTRL_P3</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  CTRL_P4</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  CTRL_P5</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  CTRL_P6</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  ALT_P1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  ALT_P2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  ALT_P3</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  ALT_P4</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  ALT_P5</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  ALT_P6</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  SHIFT_P1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  SHIFT_P2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  SHIFT_P3</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  SHIFT_P4</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  SHIFT_P5</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  SHIFT_P6</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  FN_P1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  FN_P2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  FN_P3</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  FN_P4</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  FN_P5</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">  FN_P6</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>我们要做的事已经很明确了：</p>
<ol>
<li>将每个宏按键的按键序列编码；</li>
<li>将所有按键序列组合到一个 4096 字节大的数组里；</li>
<li>调用 WMI ACPI 命令将数组内容写入 EC。</li>
</ol>
<h1 id="编写-linux-驱动">编写 Linux 驱动</h1>
<p>为了支持调整键盘按键背光，我已经在用一份修改版的 Linux <code>hp_wmi</code> 驱动，因此我选择直接在它的基础上修改。</p>
<p>（修改版驱动地址：<a href="https://github.com/pelrun/hp-omen-linux-module" rel="noopener noreferrer" target="_blank">https://github.com/pelrun/hp-omen-linux-module</a>）</p>
<p>首先是编写一份按键序列。受到惠普的硬件限制，宏按键功能无法发送特殊功能键（例如音量调整，媒体控制等），这也意味着无法将它们映射到一般键盘上没有的键，例如
F13-F24，来避免冲突。由于我的电脑没有小键盘，我选择退而求其次，将宏按键映射到小键盘的按键上：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">#include</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &#x3C;linux/input-event-codes.h></span></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">#define</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> MACRO_KEY_RELEASE </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0x80</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">static</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> u8 </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">macro_profile_bytes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">4096</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">] = {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* P1 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">        0x03</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_KP1, KEY_KP1 | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* P2 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">        0x03</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_KP2, KEY_KP2 | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* P3 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">        0x03</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_KP3, KEY_KP3 | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* P4 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">        0x03</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_KP4, KEY_KP4 | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* P5 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">        0x03</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_KP5, KEY_KP5 | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* P6 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">        0x03</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_KP6, KEY_KP6 | MACRO_KEY_RELEASE,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Ctrl+P1 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">   0x05</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_LEFTCTRL, KEY_KP1, KEY_KP1 | MACRO_KEY_RELEASE, KEY_LEFTCTRL | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Ctrl+P2 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">   0x05</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_LEFTCTRL, KEY_KP2, KEY_KP2 | MACRO_KEY_RELEASE, KEY_LEFTCTRL | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Ctrl+P3 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">   0x05</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_LEFTCTRL, KEY_KP3, KEY_KP3 | MACRO_KEY_RELEASE, KEY_LEFTCTRL | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Ctrl+P4 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">   0x05</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_LEFTCTRL, KEY_KP4, KEY_KP4 | MACRO_KEY_RELEASE, KEY_LEFTCTRL | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Ctrl+P5 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">   0x05</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_LEFTCTRL, KEY_KP5, KEY_KP5 | MACRO_KEY_RELEASE, KEY_LEFTCTRL | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Ctrl+P6 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">   0x05</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_LEFTCTRL, KEY_KP6, KEY_KP6 | MACRO_KEY_RELEASE, KEY_LEFTCTRL | MACRO_KEY_RELEASE,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Alt+P1 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">    0x05</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_LEFTALT, KEY_KP1, KEY_KP1 | MACRO_KEY_RELEASE, KEY_LEFTALT | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Alt+P2 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">    0x05</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_LEFTALT, KEY_KP2, KEY_KP2 | MACRO_KEY_RELEASE, KEY_LEFTALT | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Alt+P3 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">    0x05</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_LEFTALT, KEY_KP3, KEY_KP3 | MACRO_KEY_RELEASE, KEY_LEFTALT | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Alt+P4 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">    0x05</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_LEFTALT, KEY_KP4, KEY_KP4 | MACRO_KEY_RELEASE, KEY_LEFTALT | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Alt+P5 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">    0x05</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_LEFTALT, KEY_KP5, KEY_KP5 | MACRO_KEY_RELEASE, KEY_LEFTALT | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Alt+P6 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">    0x05</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_LEFTALT, KEY_KP6, KEY_KP6 | MACRO_KEY_RELEASE, KEY_LEFTALT | MACRO_KEY_RELEASE,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Shift+P1 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">  0x05</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_LEFTSHIFT, KEY_KP1, KEY_KP1 | MACRO_KEY_RELEASE, KEY_LEFTSHIFT | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Shift+P2 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">  0x05</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_LEFTSHIFT, KEY_KP2, KEY_KP2 | MACRO_KEY_RELEASE, KEY_LEFTSHIFT | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Shift+P3 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">  0x05</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_LEFTSHIFT, KEY_KP3, KEY_KP3 | MACRO_KEY_RELEASE, KEY_LEFTSHIFT | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Shift+P4 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">  0x05</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_LEFTSHIFT, KEY_KP4, KEY_KP4 | MACRO_KEY_RELEASE, KEY_LEFTSHIFT | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Shift+P5 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">  0x05</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_LEFTSHIFT, KEY_KP5, KEY_KP5 | MACRO_KEY_RELEASE, KEY_LEFTSHIFT | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Shift+P6 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">  0x05</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_LEFTSHIFT, KEY_KP6, KEY_KP6 | MACRO_KEY_RELEASE, KEY_LEFTSHIFT | MACRO_KEY_RELEASE,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Fn+P1 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">     0x03</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_KP7, KEY_KP7 | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Fn+P2 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">     0x03</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_KP8, KEY_KP8 | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Fn+P3 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">     0x03</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_KP9, KEY_KP9 | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Fn+P4 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">     0x03</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_KP0, KEY_KP0 | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Fn+P5 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">     0x03</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_KPMINUS, KEY_KPMINUS | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  /* Fn+P6 */</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">     0x03</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, KEY_KPPLUS, KEY_KPPLUS | MACRO_KEY_RELEASE,</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">};</span></span></code></pre>
<blockquote>
<p>目前我的模块固定了一份按键序列。后续我可以暴露一套配置接口，允许用户设置自己的按键序列。</p>
</blockquote>
<p>然后写两个函数，分别用来在模块加载时启用宏按键，和在模块卸载时禁用：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">static</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> int</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> macro_key_setup</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">struct</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> platform_device *</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">dev</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">  int</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ret;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  u32 macro_enable = </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ret = </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">hp_wmi_perform_query</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(HPWMI_MACRO_PROFILE_SET, HPWMI_MACRO,</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">                             macro_profile_bytes, </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">sizeof</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(macro_profile_bytes), </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">);</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  pr_debug</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"macro key setup ret 0x</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">%x</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\n</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ret);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ret = </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">hp_wmi_perform_query</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(HPWMI_MACRO_MODE_SET, HPWMI_MACRO,</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">                             &#x26;macro_enable, </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">sizeof</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(macro_enable), </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">);</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  pr_debug</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"macro key enable ret 0x</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">%x</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\n</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ret);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">  return</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">static</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> int</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26"> macro_key_remove</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">struct</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> platform_device *</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">dev</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">)</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">  int</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ret;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  u32 macro_disable = </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ret = </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">hp_wmi_perform_query</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(HPWMI_MACRO_MODE_SET, HPWMI_MACRO,</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">                             &#x26;macro_disable, </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">sizeof</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(macro_disable), </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">);</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">  pr_debug</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">(</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"macro key disable ret 0x</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">%x</span><span style="--shiki-dark:#D7BA7D;--shiki-light:#EE0000">\n</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ret);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C586C0;--shiki-light:#AF00DB">  return</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 0</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>然后在相应的初始化、卸载函数中调用它们即可。</p>
<h1 id="下载">下载</h1>
<p>我将修改后的模块上传到了 <a href="https://github.com/xddxdd/hp-omen-linux-module" rel="noopener noreferrer" target="_blank">https://github.com/xddxdd/hp-omen-linux-module</a>。其中与本文相关的修改可以在
<a href="https://github.com/xddxdd/hp-omen-linux-module/commit/macro_keys" rel="noopener noreferrer" target="_blank">https://github.com/xddxdd/hp-omen-linux-module/commit/macro_keys</a> 看到。</p>
<p>或者，你也可以直接使用这个内核补丁，将宏按键功能（和键盘背光功能）直接集成到内核中：<a href="https://github.com/xddxdd/nur-packages/blob/master/pkgs/linux-xanmod-lantian/patches/0004-hp-omen-fourzone.patch" rel="noopener noreferrer" target="_blank">https://github.com/xddxdd/nur-packages/blob/master/pkgs/linux-xanmod-lantian/patches/0004-hp-omen-fourzone.patch</a></p>  </div>  <div class="clearfix" id="post-navi" data-astro-cid-gfbmwgei=""> <div class="float-end text-end" data-astro-cid-gfbmwgei=""> <a href="/article/modify-website/ns1-uptimerobot-freshping-geodns.lantian/" title="用 NS1 和 UptimeRobot/Freshping 组建超低价 GeoDNS" data-astro-cid-gfbmwgei=""> 用 NS1 和 UptimeRobot/Freshping 组建超低价 GeoDNS </a> <br data-astro-cid-gfbmwgei=""> 下一篇文章 »
</div> <div class="float-start text-start position-absolute" data-astro-cid-gfbmwgei="">
« 上一篇文章 <br data-astro-cid-gfbmwgei=""> <a href="/article/modify-computer/nixos-packaging.lantian/" title="NixOS 系列（三）：软件打包，从入门到放弃" data-astro-cid-gfbmwgei=""> NixOS 系列（三）：软件打包，从入门到放弃 </a> </div> </div>  <div id="waline" data-waline-language="zh-CN" data-waline-path="/article/modify-computer/reverse-engineered-linux-driver-for-hp-omen-macro-keys.lantian"></div> <script type="module" src="/assets/WalineComment.astro_astro_type_script_index_0_lang.Dqib3X1E.js"></script>  </div> </div> </article>  </div> <aside class="d-none d-xl-block"> <section class="widget"> <h3>最新文章</h3> <ul class="list-unstyled"> <li> 07-20  <a href="/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/">用 Open5GS 搭建合法的 LTE 网络</a> </li><li> 06-27  <a href="/article/modify-computer/sidestore-without-stosvpn-across-lan.lantian/">在内网中免 StosVPN 使用 SideStore</a> </li><li> 05-19  <a href="/article/modify-computer/nix-logarithmetic-math-library-from-zero.lantian/">从零开始实现 Nix 对数函数库</a> </li><li> 04-06  <a href="/article/modify-computer/legal-lte-network-at-home-for-100-bucks.lantian/">$100，DIY 搭建合法的 LTE 网络</a> </li><li> 02-10  <a href="/article/modify-computer/build-custom-android-kernel-with-nix.lantian/">用 Nix 编译自定义 Android 内核</a> </li><li> 04-20  <a href="/article/modify-website/migrate-blog-to-astro-js.lantian/">使用 Astro.js 重构我的博客</a> </li><li> 12-16  <a href="/article/modify-computer/nixos-low-ram-vps.lantian/">NixOS 系列（五）：制作小内存 VPS 的 DD 磁盘镜像</a> </li><li> 09-20  <a href="/article/modify-computer/nix-trigonometric-math-library-from-zero.lantian/">从零开始实现 Nix 三角函数库</a> </li><li> 05-29  <a href="/article/random-notes/pipewire-sigkill-fix.lantian/">解决 Pipewire 被 SIGKILL 的问题</a> </li><li> 05-12  <a href="/article/modify-website/how-to-kill-the-dn42-network.lantian/">如何引爆 DN42 网络（2023-05-12 更新）</a> </li><li> 05-08  <a href="/article/modify-computer/laptop-muxed-nvidia-passthrough.lantian/">Optimus MUXed 笔记本上的 NVIDIA 虚拟机显卡直通（2023-05 更新）</a> </li><li> 04-17  <a href="/article/random-notes/fix-china-telecom-roaming-no-4g-on-aosp-rom.lantian/">修改 APN 解决 AOSP ROM 上中国电信无法 4G 漫游问题</a> </li><li> 03-26  <a href="/article/random-notes/old-hp-workstation-as-all-in-one.lantian/">老款 HP 工作站配置 NAS+软路由笔记</a> </li><li> 01-14  <a href="/article/modify-computer/nixos-impermanence.lantian/">NixOS 系列（四）：“无状态”操作系统</a> </li><li> 06-21  <a href="/article/modify-computer/nixos-packaging.lantian/">NixOS 系列（三）：软件打包，从入门到放弃</a> </li> </ul> </section> <section class="widget"> <h3>最新评论</h3> <ul class="list-unstyled" id="recent-comments">  <li><a href="#">Loading...</a></li>  </ul> </section> <script type="module">const i=window.location.hostname=="localhost"?"https://comments.lantian.pub":window.location.origin;fetch(`${i}/api/comment?type=recent&count=10`).then(t=>{if(t.status!==200)throw new Error(`Server returned bad HTTP status ${t.status}`);return t.json()}).then(t=>{const e=document.getElementById("recent-comments");e&&(e.innerHTML=t.data.map(n=>{const o=n.comment.replace(/(<([^>]+)>)/gi,"");return"<li>"+n.nick+' <a href="'+n.url+'">'+o+"</a></li>"}).join(""))});</script> <section class="widget"> <h3>其它功能</h3> <ul class="list-unstyled">  <li> <i class="fas fa-fw fa-rss"></i>  <a href="/rss2.xml" target="_blank">RSS 订阅</a> |  <a href="/feed.xml" target="_blank">Atom</a> |  <a href="/feed.json" target="_blank">JSON</a> </li> <li> <i class="fas fa-fw fa-globe"></i>  <a href="https://stats.uptimerobot.com/BLK6VsRkR" target="_blank"> 服务器状态 </a> </li> <li> <i class="fas fa-fw fa-sitemap"></i>  <a href="https://lg.lantian.pub" target="_blank">DN42 节点状态</a> </li> <li> <i class="fas fa-fw fa-link"></i>  <a href="gopher://lantian.pub" target="_blank">使用 Gopher 协议访问</a> </li>  </ul> </section> <section class="widget"> <h3>友情链接</h3> <ul class="list-unstyled"> <li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://0x7f.cc"> 0x7f Blog 🐑 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://alanyhq.com"> Alanyhq </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.cas7.moe"> Blog of Moecast </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://jerryxiao.cc"> JerryXiao </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://snli.org"> Shucheng Li </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://sangsir.com"> SangSir | 艺术界的一朵奇葩 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://yuetau.net"> YuetAu&#39;s Spot </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.baoshuo.ren/?utm_source=friends"> 宝硕博客 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="http://foreverblog.cn"> 十年之约 </a> </li> </ul> </section> </aside> </div> <footer class="lantian clearfix" data-astro-cid-w3csb3e3="">  <div id="copyright" class="float-end text-end" data-astro-cid-w3csb3e3=""> <i class="fas fa-copyright" data-astro-cid-w3csb3e3=""></i> 2012-2025 Lan Tian @ Blog<br data-astro-cid-w3csb3e3=""> <small data-astro-cid-w3csb3e3=""> 基于 Astro v5.15.1 构建 @ 2025-10-25 23:46:33 </small> </div> <script type="module">function v(c,o,r){const h=/^localhost$|^127(?:\.[0-9]+){0,2}\.[0-9]+$|^(?:0*:)*?:?0*1$/.test(location.hostname)||location.protocol==="file:";if(!o.trackLocalhost&&h)return console.warn("[Plausible] Ignoring event because website is running locally");try{if(window.localStorage.plausible_ignore==="true")return console.warn('[Plausible] Ignoring event because "plausible_ignore" is set to "true" in localStorage')}catch{}const p={n:c,u:o.url,d:o.domain,r:o.referrer,w:o.deviceWidth,h:o.hashMode?1:0,p:r&&r.props?JSON.stringify(r.props):void 0},s=new XMLHttpRequest;s.open("POST",`${o.apiHost}/api/event`,!0),s.setRequestHeader("Content-Type","text/plain"),s.send(JSON.stringify(p)),s.onreadystatechange=()=>{s.readyState===4&&r&&r.callback&&r.callback()}}function b(c){const o=()=>({hashMode:!1,trackLocalhost:!1,url:location.href,domain:location.hostname,referrer:document.referrer||null,deviceWidth:window.innerWidth,apiHost:"https://plausible.io",...c}),r=(t,n,i)=>{v(t,{...o(),...i},n)},h=(t,n)=>{r("pageview",n,t)};return{trackEvent:r,trackPageview:h,enableAutoPageviews:()=>{const t=()=>h(),n=history.pushState;return n&&(history.pushState=function(i,l,u){n.apply(this,[i,l,u]),t()},addEventListener("popstate",t)),c&&c.hashMode&&addEventListener("hashchange",t),h(),function(){n&&(history.pushState=n,removeEventListener("popstate",t)),c&&c.hashMode&&removeEventListener("hashchange",t)}},enableAutoOutboundTracking:(t=document,n={subtree:!0,childList:!0,attributes:!0,attributeFilter:["href"]})=>{function i(e){r("Outbound Link: Click",{props:{url:this.href}}),typeof process<"u"&&process,setTimeout(()=>{location.href=this.href},150),e.preventDefault()}const l=new Set;function u(e){e instanceof HTMLAnchorElement?e.host!==location.host&&(e.addEventListener("click",i),l.add(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(u)}function f(e){e instanceof HTMLAnchorElement?(e.removeEventListener("click",i),l.delete(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(f)}const d=new MutationObserver(e=>{e.forEach(a=>{a.type==="attributes"?(f(a.target),u(a.target)):a.type==="childList"&&(a.addedNodes.forEach(u),a.removedNodes.forEach(f))})});return t.querySelectorAll("a").forEach(u),d.observe(t,n),function(){l.forEach(a=>{a.removeEventListener("click",i)}),l.clear(),d.disconnect()}}}}const g=b({domain:"lantian.pub",trackLocalhost:!0,apiHost:""});g.trackPageview();</script> </footer>  </div>  </body> </html>