<!DOCTYPE html><html lang="zh-CN" itemscope="" itemtype="https://schema.org/Article" data-astro-cid-porej7z2=""> <head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>NixOS 系列（二）：基础配置，Nix Flake，和批量部署 - Lan Tian @ Blog</title><script>
  ;(() => {
    try {
      const mode = localStorage.getItem('user-color-scheme')
      if (mode == 'dark' || mode == 'light') {
        document.documentElement.setAttribute('data-user-color-scheme', mode)
      }
    } catch {
      // Ignore errors
    }
  })()
</script><link rel="stylesheet" href="/assets/index.CUlf1-Vz.css"><style>#post-navi[data-astro-cid-gfbmwgei]{padding:5px;border-top:1px solid var(--lt-border-weak);border-bottom:1px solid var(--lt-border-weak)}
ol[data-astro-cid-nj3qel45]{margin:0;padding:0;line-height:1.5}ol[data-astro-cid-nj3qel45] .toc-item[data-astro-cid-nj3qel45]{list-style:none}ol[data-astro-cid-nj3qel45] .toc-child[data-astro-cid-nj3qel45],ol[data-astro-cid-nj3qel45] .toc[data-astro-cid-nj3qel45]{padding:0}ol[data-astro-cid-nj3qel45] .toc-link[data-astro-cid-nj3qel45]{display:block;margin-left:1em;padding:.25em 0}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;width:1em;padding:.25em 0;float:left;font-style:normal;font-variant:normal;font-weight:900;font-family:Font Awesome\ 6 Free;font-feature-settings:normal;text-align:center}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before{content:""}ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{content:""}.post-info-wrap[data-astro-cid-dckccua4]{-ms-flex:0 0 2.5em;flex:0 0 2.5em;background-color:var(--lt-component-bg-emphasis)}@media(min-width:768px){.post-info[data-astro-cid-dckccua4]{position:sticky;top:0}}@media(max-width:767.98px){.post-info[data-astro-cid-dckccua4]{position:absolute}}
</style><script type="module" src="/assets/PageLayout.astro_astro_type_script_index_0_lang.C1wfUPs6.js"></script><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Referrer-Policy" content="no-referrer, strict-origin-when-cross-origin"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="imagemode" content="force"><meta name="nightmode" content="disable"><meta name="wap-font-scale" content="no"><meta name="title" content="NixOS 系列（二）：基础配置，Nix Flake，和批量部署 - Lan Tian @ Blog"><meta name="keywords" content=""><meta name="author" content="Lan Tian"><link rel="canonical" href="https://lantian.pub/article/modify-website/nixos-initial-config-flake-deploy.lantian/"><link rel="alternate" type="application/rss+xml" title="Lan Tian @ Blog" href="https://lantian.pub/rss2.xml"><link rel="alternate" type="application/atom+xml" title="Lan Tian @ Blog" href="https://lantian.pub/feed.xml"><link rel="alternate" href="https://lantian.pub/article/modify-website/nixos-initial-config-flake-deploy.lantian/" hreflang="zh"><link rel="alternate" href="https://lantian.pub/en/article/modify-website/nixos-initial-config-flake-deploy.lantian/" hreflang="en"><meta name="copyright" content="Copyright 2012-2025 Lan Tian @ Blog"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#03a9f4"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#212121"><meta name="application-name" content="Lan Tian @ Blog"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="apple-touch-icon" sizes="1024x1024" href="/apple-touch-icon-1024x1024.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#03a9f4"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Lan Tian @ Blog"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-640x1136.png"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1136x640.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-750x1334.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1334x750.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1125x2436.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2436x1125.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1170x2532.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2532x1170.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1179x2556.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2556x1179.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-828x1792.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1792x828.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2688.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2688x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2208.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2208x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1284x2778.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2778x1284.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1290x2796.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2796x1290.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1488x2266.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2266x1488.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1536x2048.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2048x1536.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1620x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1620.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1640x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1640.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2388.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2388x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2224.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2224x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-2048x2732.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2732x2048.png"><meta name="msapplication-TileColor" content="#bbdefb"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"><meta property="og:url" content="https://lantian.pub/article/modify-website/nixos-initial-config-flake-deploy.lantian/"><meta property="og:type" content="website"><meta property="og:title" content="NixOS 系列（二）：基础配置，Nix Flake，和批量部署 - Lan Tian @ Blog"><meta property="og:image" content="https://lantian.pub/usr/uploads/202110/nixos-social-preview.png"><meta content="这是我的 NixOS 系列文章的第二篇，主要介绍以下内容： NixOS 配置文件的基本格式和修改配置的方法 Nix 包管理器的 Flake 功能 Deploy-RS 部署工具 本文假设你已经按照 NixOS 官方安装教程 装好了一个系统。 更新日志 2023-05-10：增加推荐阅读： NixOS 与 Nix Flakes 新手入门 ，作者 Ryan Yin。 2021-12-18：NixOS 21.11 仍没有默认启用 Flake 功能，更新文章中相关说明。 基础配置 在 NixOS 的安装过程中， nixos-generate-config 工具在 /etc/nixos 目录下生成了一份初始配置文件， configuration.nix 和 hardware-configuration.nix 两份文件。我们先不管 hardware-configuration.nix 这份文件，它是根据系统的硬件设备、硬盘分区等自动生成的配置文件。先打开 configuration.nix ： # 为缩短长度，我去掉了配置文件中所有的注释 { config , pkgs , ... }: { imports = [ ./hardware-configuration.nix ]; boot . loader . grub . enable = true ; boot ...."><meta property="og:site_name" content="Lan Tian @ Blog"><meta property="og:locale" content="zh"><meta name="twitter:card" content="summary"><meta name="twitter:url" content="https://lantian.pub/article/modify-website/nixos-initial-config-flake-deploy.lantian/"><meta name="twitter:title" content="NixOS 系列（二）：基础配置，Nix Flake，和批量部署 - Lan Tian @ Blog"><meta property="twitter:image" content="https://lantian.pub/usr/uploads/202110/nixos-social-preview.png"><meta content="这是我的 NixOS 系列文章的第二篇，主要介绍以下内容： NixOS 配置文件的基本格式和修改配置的方法 Nix 包管理器的 Flake 功能 Deploy-RS 部署工具 本文假设你已经按照 NixOS 官方安装教程 装好了一个系统。 更新日志 2023-05-10：增加推荐阅读： NixOS 与 Nix Flakes 新手入门 ，作者 Ryan Yin。 2021-12-18：NixOS 21.11 仍没有默认启用 Flake 功能，更新文章中相关说明。 基础配置 在 NixOS 的安装过程中， nixos-generate-config 工具在 /etc/nixos 目录下生成了一份初始配置文件， configuration.nix 和 hardware-configuration.nix 两份文件。我们先不管 hardware-configuration.nix 这份文件，它是根据系统的硬件设备、硬盘分区等自动生成的配置文件。先打开 configuration.nix ： # 为缩短长度，我去掉了配置文件中所有的注释 { config , pkgs , ... }: { imports = [ ./hardware-configuration.nix ]; boot . loader . grub . enable = true ; boot ...."><meta name="twitter:dnt" content="on"><meta itemprop="name" content="NixOS 系列（二）：基础配置，Nix Flake，和批量部署 - Lan Tian @ Blog"><meta property="image" content="https://lantian.pub/usr/uploads/202110/nixos-social-preview.png"><meta content="这是我的 NixOS 系列文章的第二篇，主要介绍以下内容： NixOS 配置文件的基本格式和修改配置的方法 Nix 包管理器的 Flake 功能 Deploy-RS 部署工具 本文假设你已经按照 NixOS 官方安装教程 装好了一个系统。 更新日志 2023-05-10：增加推荐阅读： NixOS 与 Nix Flakes 新手入门 ，作者 Ryan Yin。 2021-12-18：NixOS 21.11 仍没有默认启用 Flake 功能，更新文章中相关说明。 基础配置 在 NixOS 的安装过程中， nixos-generate-config 工具在 /etc/nixos 目录下生成了一份初始配置文件， configuration.nix 和 hardware-configuration.nix 两份文件。我们先不管 hardware-configuration.nix 这份文件，它是根据系统的硬件设备、硬盘分区等自动生成的配置文件。先打开 configuration.nix ： # 为缩短长度，我去掉了配置文件中所有的注释 { config , pkgs , ... }: { imports = [ ./hardware-configuration.nix ]; boot . loader . grub . enable = true ; boot ...."><meta content="这是我的 NixOS 系列文章的第二篇，主要介绍以下内容： NixOS 配置文件的基本格式和修改配置的方法 Nix 包管理器的 Flake 功能 Deploy-RS 部署工具 本文假设你已经按照 NixOS 官方安装教程 装好了一个系统。 更新日志 2023-05-10：增加推荐阅读： NixOS 与 Nix Flakes 新手入门 ，作者 Ryan Yin。 2021-12-18：NixOS 21.11 仍没有默认启用 Flake 功能，更新文章中相关说明。 基础配置 在 NixOS 的安装过程中， nixos-generate-config 工具在 /etc/nixos 目录下生成了一份初始配置文件， configuration.nix 和 hardware-configuration.nix 两份文件。我们先不管 hardware-configuration.nix 这份文件，它是根据系统的硬件设备、硬盘分区等自动生成的配置文件。先打开 configuration.nix ： # 为缩短长度，我去掉了配置文件中所有的注释 { config , pkgs , ... }: { imports = [ ./hardware-configuration.nix ]; boot . loader . grub . enable = true ; boot ...."><link rel="me" href="https://mastodon.social/@lantian"></head> <body data-astro-cid-porej7z2=""> <div id="bg" data-astro-cid-j6vmxtef=""></div>   <div id="container" class="container" data-astro-cid-porej7z2=""> <nav class="lantian navbar navbar-expand-lg" data-astro-cid-wu5dj4rx=""> <div class="container-fluid" data-astro-cid-wu5dj4rx=""> <a class="navbar-brand" href="/" data-astro-cid-wu5dj4rx="">Lan Tian @ Blog</a> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#lantian-navbar" aria-controls="lantian-navbar" aria-expanded="false" aria-label="Toggle navigation" data-astro-cid-wu5dj4rx=""> <span class="navbar-toggler-icon" data-astro-cid-wu5dj4rx=""></span> </button> <div class="collapse navbar-collapse" id="lantian-navbar" data-astro-cid-wu5dj4rx=""> <ul class="navbar-nav" data-astro-cid-wu5dj4rx=""> <li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/page/archive/index.html" data-astro-cid-wu5dj4rx=""> 文章们 </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> 俯瞰地球 </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> <li class="nav-item dropdown d-block d-lg-none" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="pages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-file" data-astro-cid-wu5dj4rx=""></i> 页面  <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="pages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/page/archive/index.html" data-astro-cid-wu5dj4rx=""> 文章们 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> 俯瞰地球 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> </ul> </li> </ul> <ul class="navbar-nav ms-auto" data-astro-cid-wu5dj4rx=""> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="languages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-language" data-astro-cid-wu5dj4rx=""></i> Language <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="languages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item active" href="/article/modify-website/nixos-initial-config-flake-deploy.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-cn" data-astro-cid-wu5dj4rx=""></span> Chinese Simplified / 简体中文 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/article/modify-website/nixos-initial-config-flake-deploy.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-us" data-astro-cid-wu5dj4rx=""></span> English </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">Not all pages have translations.</a> </li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">You may see 404 - this is normal.</a> </li> </ul> </li> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="color-scheme-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> 夜间模式 </a> <ul class="dropdown-menu" aria-labelledby="color-scheme-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-auto" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> 自动 </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-light" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-sun" data-astro-cid-wu5dj4rx=""></i> 浅色</a> </li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-dark" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-moon" data-astro-cid-wu5dj4rx=""></i> 深色</a> </li> </ul> </li> </ul> </div> </div> </nav> <script type="module">const m="user-color-scheme",s="data-user-color-scheme",u=(e,t)=>{try{localStorage.setItem(e,t)}catch{}},i=e=>{try{return localStorage.getItem(e)}catch{return null}},c=e=>{const t={dark:!0,light:!0,auto:!0},o=e===null||!Object.keys(t).includes(e)?"auto":e;u(m,o);for(const l in t){const n=document.getElementById("color-scheme-"+l);n&&(l==o?n.classList.add("active"):n.classList.remove("active"))}o!="auto"?document.documentElement.setAttribute(s,o):document.documentElement.removeAttribute(s)};c(i(m));const r=document.getElementById("color-scheme-auto");r&&r.addEventListener("click",()=>c("auto"));const a=document.getElementById("color-scheme-light");a&&a.addEventListener("click",()=>c("light"));const d=document.getElementById("color-scheme-dark");d&&d.addEventListener("click",()=>c("dark"));</script>  <div class="d-flex" data-astro-cid-porej7z2=""> <div id="content" data-astro-cid-porej7z2="">  <article> <div class="d-flex"> <div class="post-info-wrap" data-astro-cid-dckccua4=""> <div class="post-info" data-astro-cid-dckccua4=""> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-clock"></span> <br> <small>11-13</small> </p> <div class="post-meta-value"> 发布于<span class="badge badge-tag" data-astro-cid-dckccua4=""> 2021-11-13 00:48 </span>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-file-alt"></span> <br> <small>网站与服务端</small> </p> <div class="post-meta-value"> 分类 <a class="badge badge-tag" href="/category/modify-website" data-astro-cid-dckccua4=""> 网站与服务端 </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-tag"></span> <br> <small>1 标签</small> </p> <div class="post-meta-value"> 标签  <a class="badge badge-tag" href="/tag/NixOS" data-astro-cid-dckccua4=""> NixOS </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-list"></span> <br> <small>目录</small> </p> <div class="post-meta-value">  <ol data-astro-cid-nj3qel45=""> <li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#更新日志" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">更新日志</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#基础配置" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">基础配置</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#配置文件是函数" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">配置文件是函数</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#把配置分割到多个文件" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">把配置分割到多个文件</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#nix-flake" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">Nix Flake</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#使用-deploy-rs-批量部署" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">使用 Deploy-RS 批量部署</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#附录在甲骨文-arm-云服务器上使用-nixos" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">附录：在甲骨文 ARM 云服务器上使用 NixOS</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#附录扩展阅读" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">附录：扩展阅读</span> </a> </li> </ol>   </div> </div> </div> </div>  </div>  <div class="post-wrap"> <div class="post-image-wrap"> <picture> <source srcset="/usr/uploads/202110/nixos-social-preview.png.thumb.png.webp" type="image/webp"> <source srcset="/usr/uploads/202110/nixos-social-preview.png.thumb.png.avif" type="image/avif"> <source srcset="/usr/uploads/202110/nixos-social-preview.png.thumb.png.jxl" type="image/jxl"> <img src="/usr/uploads/202110/nixos-social-preview.png.thumb.png" alt="NixOS 系列（二）：基础配置，Nix Flake，和批量部署 的插图" width="200" height="150"> </picture> </div> <h1 class="post-title"> <a href="/article/modify-website/nixos-initial-config-flake-deploy.lantian/" rel="bookmark" title="NixOS 系列（二）：基础配置，Nix Flake，和批量部署">NixOS 系列（二）：基础配置，Nix Flake，和批量部署</a> </h1> <div class="post-text">  <blockquote><p>NixOS 系列文章目录：</p><ul><li><a href="/article/modify-website/nixos-why.lantian/">NixOS 系列（一）：我为什么心动了</a> </li><li><a href="/article/modify-website/nixos-initial-config-flake-deploy.lantian/">NixOS 系列（二）：基础配置，Nix Flake，和批量部署</a> （当前文章）</li><li><a href="/article/modify-computer/nixos-packaging.lantian/">NixOS 系列（三）：软件打包，从入门到放弃</a> </li><li><a href="/article/modify-computer/nixos-impermanence.lantian/">NixOS 系列（四）：“无状态”操作系统</a> </li><li><a href="/article/modify-computer/nixos-low-ram-vps.lantian/">NixOS 系列（五）：制作小内存 VPS 的 DD 磁盘镜像</a> </li></ul></blockquote> <p>这是我的 NixOS 系列文章的第二篇，主要介绍以下内容：</p>
<ul>
<li>NixOS 配置文件的基本格式和修改配置的方法</li>
<li>Nix 包管理器的 Flake 功能</li>
<li>Deploy-RS 部署工具</li>
</ul>
<p>本文假设你已经按照
<a href="https://nixos.org/manual/nixos/stable/index.html#sec-installation" rel="noopener noreferrer" target="_blank">NixOS 官方安装教程</a>装好了一个系统。</p>
<h2 id="更新日志">更新日志</h2>
<ul>
<li>2023-05-10：增加推荐阅读：<a href="https://thiscute.world/posts/nixos-and-flake-basics/" rel="noopener noreferrer" target="_blank">NixOS 与 Nix Flakes 新手入门</a>，作者 Ryan Yin。</li>
<li>2021-12-18：NixOS 21.11 仍没有默认启用 Flake 功能，更新文章中相关说明。</li>
</ul>
<h2 id="基础配置">基础配置</h2>
<p>在 NixOS 的安装过程中，<code>nixos-generate-config</code> 工具在 <code>/etc/nixos</code> 目录下生成了一份初始配置文件，<code>configuration.nix</code> 和 <code>hardware-configuration.nix</code> 两份文件。我们先不管 <code>hardware-configuration.nix</code> 这份文件，它是根据系统的硬件设备、硬盘分区等自动生成的配置文件。先打开 <code>configuration.nix</code>：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 为缩短长度，我去掉了配置文件中所有的注释</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">config</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ... }:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  imports</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> =</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      ./hardware-configuration.nix</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    ];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  boot</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">loader</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">grub</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">enable</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  boot</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">loader</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">grub</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  boot</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">loader</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">grub</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">device</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;/dev/sda&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  networking</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">useDHCP</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  networking</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">interfaces</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">enp0s3</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">useDHCP</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  networking</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">interfaces</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">enp0s8</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">useDHCP</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  system</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">stateVersion</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;21.05&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>这个文件定义了整个 NixOS 系统，包括安装的软件包和它们的配置。这个文件是 Nix 格式的，也就是 NixOS 的 Nix 包管理器自创的一种「函数式编程」语言。但因为我们只是简单配置，我们还用不到它的编程特性。我们可以先忽略开头的 <code>{ config, pkgs, ... }:</code> 一行，<strong>暂时把剩余部分当 JSON 看待。</strong></p>
<p>Nix 语言同样有着 JSON 的六大数据类型：数字，布尔值，字符串，对象，数组和 null，写法也大体相同。此外，Nix 语言还多了一种「路径」数据类型：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 数字</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  number</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">123456</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 布尔值</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  boolean_value</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 字符串</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  string</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;lantian.pub&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 对象</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  object</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    a</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    b</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 上面的对象也可以写成下面这样，是等价的：</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  object</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">a</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  object</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">b</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 数组</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  array</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &quot;first element&quot;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &quot;second element&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # 数组里也可以放对象：</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    ({</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      a</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      b</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    })</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 路径，和字符串的区别是不加引号</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  #</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 注意：</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  #</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # - 以路径格式指定的文件会在解析配置阶段被复制到 /nix/store 中，然后从那里调用</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  #   路径一般用来指定和配置文件一起管理的文件，例如你手写的某个程序的配置文件</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  #</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # - 而以字符串方式指定的文件不会被复制，但其内容也就不是配置文件的一部分</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  #   它们不受 Nix 管理，内容也无法被 Nix 读取，但路径可以被原样写进配置文件，并被最终执行的程序读取</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  #   一般用来指定独立管理的文件，例如你的网站程序代码</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  file</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">./somefile.txt</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;    </span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 会被复制成 /nix/store/[哈希值]-somefile.txt</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  file2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;./somefile.txt&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">; </span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 不会被 Nix 读取或处理</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>现在如果我们想安装一个 SSH 服务端以便远程登录，就可以添加这两行配置：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">config</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ... }:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 添加这两行</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">openssh</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">enable</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">openssh</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">permitRootLogin</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;yes&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 或者也可以利用 Nix 对象的特性，写成这样</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">openssh</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    enable</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    permitRootLogin</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;yes&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 或者这样</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    openssh</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      enable</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      permitRootLogin</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;yes&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<blockquote>
<p><code>services.openssh.permitRootLogin = &quot;yes&quot;;</code> 这行允许了用密码登录 <code>root</code> 账户。因为我用的是一台不暴露在公网的虚拟机，比起安全我更注重方便。<strong>如果你的机器暴露在公网，不要加这行！</strong></p>
</blockquote>
<p>修改完配置后，运行 <code>nixos-rebuild switch</code> 重新配置系统，NixOS 会读取你的配置文件，自动下载 OpenSSH、生成配置文件并启动，然后你就可以用 SSH 连接 22 端口来登录了。</p>
<p>再举一个例子，如果我想安装 <code>nyancat</code> 命令：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">config</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ... }:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 添加下面这几行</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  environment</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">systemPackages</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # 这是个软件包的定义，不是一个字符串，而是一个对象</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nyancat</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 或者写成这样，with 命令指定直接引用 pkgs 里的内容，如果安装的包很多可以减小配置文件的长度</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  environment</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">systemPackages</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">with</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">; [</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    nyancat</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>运行 <code>nixos-rebuild switch</code>，<code>nyancat</code> 命令就安装好了：</p>
<p><picture><source srcset="/usr/uploads/202111/nixos-nyancat.png.webp" type="image/webp"><source srcset="/usr/uploads/202111/nixos-nyancat.png.avif" type="image/avif"><source srcset="/usr/uploads/202111/nixos-nyancat.png.jxl" type="image/jxl"><img src="/usr/uploads/202111/nixos-nyancat.png" alt="NixOS nyancat 命令"></picture></p>
<p>NixOS 官方的<a href="https://nixos.org/manual/nixos/unstable/options.html" rel="noopener noreferrer" target="_blank">这份文档</a>列出了 <code>configuration.nix</code> 里可以定义的所有配置项。因为是所有配置项，所以这个网页很长，打开网页的时候卡个几十秒也是很正常的事。你也可以用
<a href="https://search.nixos.org/options" rel="noopener noreferrer" target="_blank">NixOS 官方搜索工具的 Options 页面</a>搜索配置项：</p>
<p><picture><source srcset="/usr/uploads/202111/nixos-search-options.png.webp" type="image/webp"><source srcset="/usr/uploads/202111/nixos-search-options.png.avif" type="image/avif"><source srcset="/usr/uploads/202111/nixos-search-options.png.jxl" type="image/jxl"><img src="/usr/uploads/202111/nixos-search-options.png" alt="NixOS 官方搜索 Options 页面"></picture></p>
<p>或者在<a href="https://search.nixos.org/packages" rel="noopener noreferrer" target="_blank">搜索工具的 Packages 页面</a>搜索软件包：</p>
<p><picture><source srcset="/usr/uploads/202111/nixos-search-packages.png.webp" type="image/webp"><source srcset="/usr/uploads/202111/nixos-search-packages.png.avif" type="image/avif"><source srcset="/usr/uploads/202111/nixos-search-packages.png.jxl" type="image/jxl"><img src="/usr/uploads/202111/nixos-search-packages.png" alt="NixOS 官方搜索 Packages 页面"></picture></p>
<h2 id="配置文件是函数">配置文件是函数</h2>
<p>刚才我们一直忽略了配置文件的第一行 <code>{ config, pkgs, ... }:</code>。实际上，整个
<code>configuration.nix</code> 是一个 Nix 函数，这里的 <code>config</code> 和 <code>pkgs</code> 是输入的参数。</p>
<p>NixOS 的函数定义如下所示：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 这是一个函数，输入是一个参数 a，返回值是（a+1）</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">a</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">a</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">+</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 这是一个函数，输入是一个参数 a，返回值是一个对象，对象有两个键值 a 和 b</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 注意 Nix 语言没有变量概念！</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 假设输入 a = 1，那么返回对象为 { a = 2; b = 3; }，而非 { a = 2; b = 4; }</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">a</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  a</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">a</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  b</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">a</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> + </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 这是一个函数，输入是一个对象，拥有键值 a 和 b，返回值是一个对象，拥有键值 a 和 b</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 假设输入 { a = 1; b = 2; }，那么返回对象为 { a = 2; b = 1; }</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">a</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">b</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> }: {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  a</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">b</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  b</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">a</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 这个函数和前一个函数的作用相同，只是参数里多了 ... 代表可以接受（并忽略）它不认识的参数</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 假设输入为 { a = 1; b = 2; c = 3; }</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 前一个函数不认识 c 所以会报错，但这个函数可以忽略 c 并正常工作</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">a</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">b</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ... }: {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  a</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">b</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  b</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">a</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>回头看安装 <code>nyancat</code> 命令的配置：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">config</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ... }:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  environment</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">systemPackages</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">    pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nyancat</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  ];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>它将 <code>pkgs</code> 参数（一个对象）的子对象 <code>nyancat</code> 加入了
<code>environment.systemPackages</code> 的列表中。<code>pkgs</code> 就是 NixOS 软件源中所有软件包的集合，对应 <a href="https://github.com/NixOS/nixpkgs" rel="noopener noreferrer" target="_blank">https://github.com/NixOS/nixpkgs</a> 这个项目。类似的，<code>config</code> 参数是所有系统配置的集合，例如你想要读取安装过的软件包的列表，就可以用 <code>config.environment.systemPackages</code>。</p>
<blockquote>
<p>Nix 语言是惰性求值（Lazy Evaluate）的。最开始加载配置文件后，NixOS 什么都不会做，直到需要用到某个配置项（例如 <code>environment.systemPackages</code>），才会去解析它的值（这个数组，以及其中的对象 <code>pkgs.nyancat</code>）。</p>
<p>顺便说一句，Nix 语言不支持循环引用，也就是类似
<code>{ a = config.b; b = config.a; }</code> 这样的用法是不行的，会报错
<code>infinite recursion encountered</code>（遇到无限循环）。</p>
</blockquote>
<h2 id="把配置分割到多个文件">把配置分割到多个文件</h2>
<p>当你使用了一段时间 NixOS 后，你可能会安装一大堆的软件，导致你的配置文件变得很长，难以阅读。NixOS 支持在一个配置文件内引用（import）其它的配置文件，这样你就可以把一部分配置（例如桌面环境，nginx + PHP + MySQL，等等）单独放到一个文件中，方便后续查找。</p>
<p>假设我想把上面的 SSH 配置单独放到一个文件中。先创建 <code>/etc/nixos/ssh.nix</code>：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">config</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ... }:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">openssh</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">enable</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">openssh</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">permitRootLogin</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;yes&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>然后在 <code>/etc/nixos/configuration.nix</code> 中将 <code>ssh.nix</code> 加到 <code>imports</code> 中，并把原有的 SSH 配置删掉：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">config</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ... }:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # ...</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  imports</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> =</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      ./hardware-configuration.nix</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      ./ssh.nix</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    ];</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>然后运行 <code>nixos-rebuild switch</code>，可以看到这次 rebuild 没有生成新的东西，也没有启动/停止任何服务。这是因为我们只是把 SSH 的配置挪到了新的文件中，实际的配置并没有发生变化。</p>
<p><picture><source srcset="/usr/uploads/202111/nixos-rebuild-noop.png.webp" type="image/webp"><source srcset="/usr/uploads/202111/nixos-rebuild-noop.png.avif" type="image/avif"><source srcset="/usr/uploads/202111/nixos-rebuild-noop.png.jxl" type="image/jxl"><img src="/usr/uploads/202111/nixos-rebuild-noop.png" alt="NixOS Rebuild"></picture></p>
<p>接下来我简单解释一下 <code>imports</code> 的原理。可以看到 <code>configuration.nix</code> 这个函数有参数 <code>config</code>，<code>pkgs</code>，和一些被我们忽略掉的参数（<code>...</code>）。NixOS 会用相同的参数（包括忽略掉的和没忽略的）去调用 <code>imports</code> 里的每个文件，然后把返回的配置和当前配置合并。</p>
<p>回头看 <code>ssh.nix</code>，我们可以发现它并没有用到 <code>config</code> 和 <code>pkgs</code> 两个函数，因此把它们去掉也是可以的：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 可以把 config 和 pkgs 去掉</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ ... }:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">openssh</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">enable</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">openssh</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">permitRootLogin</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;yes&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 甚至直接去掉所有参数也是可以的，imports 比较智能</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">openssh</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">enable</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">true</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">openssh</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">permitRootLogin</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;yes&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<h2 id="nix-flake">Nix Flake</h2>
<p>由于 NixOS 的所有配置都由 <code>configuration.nix</code> 决定，我们可以把这些文件直接复制到另一台机器上，然后运行 <code>nixos-rebuild switch</code>，就可以得到一个一模一样的系统。包括我在<a href="/article/modify-website/nixos-why.lantian/">本系列的第一篇文章</a>中写到：</p>
<blockquote>
<p>(...) NixOS 的一大特点是，用一份 Nix 配置文件管理系统上的所有配置文件和软件包。因此，我们可以用 Ansible，Rsync，甚至是 Git 等任何我们喜欢的工具，来专门管理 <code>/etc/nixos</code> 这里一处的配置文件。由于只有这一处配置文件，我们不需要写一大堆复杂的 Ansible Playbook，或者输入几十行 Rsync 命令，只需要直接覆盖
<code>/etc/nixos</code>，再运行 <code>nixos-rebuild switch</code> 完事。</p>
</blockquote>
<p>但现在我要告诉你，<strong>我刚才说的都是错的。</strong></p>
<p>刚才我介绍了修改系统配置和安装软件包的方法，但唯独没有提到如何升级软件包。这是因为 NixOS 的软件源是由另外一个命令 <code>nix-channel</code> 管理的：</p>
<p><picture><source srcset="/usr/uploads/202111/nixos-channels.png.webp" type="image/webp"><source srcset="/usr/uploads/202111/nixos-channels.png.avif" type="image/avif"><source srcset="/usr/uploads/202111/nixos-channels.png.jxl" type="image/jxl"><img src="/usr/uploads/202111/nixos-channels.png" alt="NixOS nix-channel 命令"></picture></p>
<p>其中 <code>nix-channel --list</code> 命令列出了当前配置的软件源列表，<code>nix-channel --update</code>
用来将软件源更新到最新。但是，<code>nix-channel</code> 的配置不归 <code>configuration.nix</code>
管，<code>configuration.nix</code> 也无法定义软件源的 URL 和版本。也就是说，由于软件源在不断更新，你在一个月前和一个月后用同一份配置文件装出来的系统，可能会有软件版本的差异。这就与 NixOS 一直宣传的「一份配置管天下」冲突了。</p>
<p>为了解决这个问题，Nix 引入了 Flake 功能，它支持了在配置文件中定义软件源 URL 版本的功能。我们先修改 <code>configuration.nix</code> 并 <code>nixos-rebuild switch</code>，将 Nix 包管理器升级到支持 Flake 的测试版：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{ </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">config</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ... }:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # ...</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  nix</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    package</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">pkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixUnstable</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    extraOptions</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&#39;&#39;</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">      experimental-features = nix-command flakes</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">    &#39;&#39;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<blockquote>
<p>本文写成时 NixOS 的最新稳定版本是 21.05，其 Nix 包管理器（2.3 版本）还默认禁用
Flake 功能。 <del>NixOS 21.11 及以后的版本将默认开启 Flake 功能，届时将不需要这里对 <code>configuration.nix</code> 的修改。</del> 由于担心 Nix 2.4 功能变化过大，尤其是会与旧版 Nix 的行为不兼容，NixOS 21.11 仍将使用 Nix 2.3，将默认禁用 Flake 功能。相关讨论在
<a href="https://discourse.nixos.org/t/nix-2-4-and-what-s-next/16257" rel="noopener noreferrer" target="_blank">https://discourse.nixos.org/t/nix-2-4-and-what-s-next/16257</a>
和
<a href="https://github.com/NixOS/nixpkgs/pull/147511" rel="noopener noreferrer" target="_blank">https://github.com/NixOS/nixpkgs/pull/147511</a>。</p>
</blockquote>
<p>然后在 <code>/etc/nixos</code> 里创建一个 <code>flake.nix</code> 文件。这份 <code>flake.nix</code> 定义了一个软件源（<code>input</code>），是
<a href="https://github.com/NixOS/nixpkgs" rel="noopener noreferrer" target="_blank">https://github.com/NixOS/nixpkgs</a> 的
<code>unstable</code> 分支（也就是 <code>master</code> 分支）。</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 文件描述，随便写，或者不写也可以</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  description</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;Lan Tian&#39;s NixOS Flake&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 输入配置，即软件源</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # Nixpkgs，即 NixOS 官方软件源</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">url</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;github:NixOS/nixpkgs/nixos-unstable&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # 输出配置，即 NixOS 系统配置</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  outputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = { </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">self</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ... }@</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # 定义一个名为 nixos 的系统</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    nixosConfigurations</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;nixos&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixosSystem</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      system</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;x86_64-linux&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      modules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        ./configuration.nix</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      ];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # 你也可以在同一份 Flake 中定义好几个系统，NixOS 会根据主机名 Hostname 决定用哪个</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # nixosConfigurations.&quot;nixos2&quot; = nixpkgs.lib.nixosSystem {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    #   system = &quot;x86_64-linux&quot;;</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    #   modules = [</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    #     ./configuration2.nix</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    #   ];</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>然后运行 <code>nix flake update</code>：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">[root@nixos:/etc/nixos]# nix flake update</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">warning:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> creating</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> lock</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> file</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &#39;/etc/nixos/flake.lock&#39;</span></span></code></pre>
<p>生成了一个 <code>flake.lock</code> 文件，是一个 JSON：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">  &quot;nodes&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">    &quot;nixpkgs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">      &quot;locked&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">        &quot;lastModified&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">1636623366</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">        &quot;narHash&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;sha256-jOQMlv9qFSj0U66HB+ujZoapty0UbewmSNbX8+3ujUQ=&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">        &quot;owner&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;NixOS&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">        &quot;repo&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;nixpkgs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">        &quot;rev&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;c5ed8beb478a8ca035f033f659b60c89500a3034&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">        &quot;type&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;github&quot;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      },</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">      &quot;original&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">        &quot;owner&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;NixOS&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">        &quot;ref&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;nixos-unstable&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">        &quot;repo&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;nixpkgs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">        &quot;type&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;github&quot;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      }</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    },</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">    &quot;root&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">      &quot;inputs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">        &quot;nixpkgs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;nixpkgs&quot;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      }</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    }</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  },</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">  &quot;root&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;root&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">,</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#0451A5">  &quot;version&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">7</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p><code>flake.lock</code> 指定了 <code>nixpkgs</code> 的 commit 编号和 SHA256 哈希值，这样即使这份配置文件被复制到其它机器上，其它机器的 Nix 包管理器也会下载这个特定版本的 <code>nixpkgs</code> 软件源，并安装对应版本的软件，真正做到了软件版本一模一样。</p>
<p>最后运行 <code>nixos-rebuild switch</code> 命令，NixOS 会自动优先读取 <code>flake.nix</code> 而非
<code>configuration.nix</code>，把系统里的所有软件包升级（或降级）到这个特定的版本。但因为我们把 <code>configuration.nix</code> 加入了 <code>flake.nix</code> 的 <code>modules</code> 数组，所以系统配置还是保持不变。</p>
<blockquote>
<p>如果你开启了 Flake 功能，并使用 Git 管理你的文件，注意 NixOS 会忽略未被 Git 管理的文件，只会读取已经 Stage 或 Commit 过的文件。如果你新建了一个文件，记得把它 Stage 一下，否则 NixOS 会报找不到文件的错误。</p>
</blockquote>
<h2 id="使用-deploy-rs-批量部署">使用 Deploy-RS 批量部署</h2>
<p>现在我们配置好了一台机器。而我在<a href="/article/modify-website/nixos-why.lantian/">本系列的第一篇文章</a>中提到，我有
10 台机器。我当然可以自己写一个 Ansible 脚本把配置复制到所有机器的 <code>/etc/nixos</code>
文件夹再 <code>nixos-rebuild switch</code>，但是这有几个问题：</p>
<ol>
<li>
<p>如果软件源里的某个软件包没有预编译的二进制文件，我就得在所有机器上编译一遍。但因为我买的都是资源不是很多的便宜 VPS，很容易遇到内存不足或者 CPU 占用过高被主机商关机的问题。</p>
<p>NixOS 的软件源有点类似于 Gentoo。与其它 Linux 发行版不同，一个软件包在 NixOS
软件源里不代表它有二进制文件。NixOS 的「软件包」是一组 Nix 语言的定义，描述了下载、编译、打包一个软件的完整流程。</p>
<p>一般情况下，NixOS 官方会帮我们编译好软件，然后上传到二进制缓存（Binary
Cache）供我们下载。但如果我们自己改了软件包的编译流程（一般是一些编译参数）或者干脆是自己打的包（后面文章中会介绍），就得自己编译了。</p>
</li>
<li>
<p>Nix 包管理器解析配置文件的过程本身就会占用不少的内存和 CPU 资源，尤其是配置较复杂的时候。</p>
</li>
</ol>
<p>理想情况下，可以用一台高性能机器（例如我的个人电脑，或者独立服务器）解析配置文件，下载或编译好所有软件包和配置，再把它们上传到所有机器上启用，这样就不用消耗低性能 VPS 的资源了。而这就是
<a href="https://github.com/serokell/deploy-rs" rel="noopener noreferrer" target="_blank">Deploy-RS 部署工具</a>的功能。</p>
<p>要使用 Deploy-RS，首先我们要找一台装了 Nix 的机器。注意我没有要求你把这台机器重装成 NixOS，因为 Nix 包管理器是可以安装在其它 Linux 发行版上的。例如我用的是运行
Arch Linux 的个人电脑，就可以根据
<a href="https://wiki.archlinux.org/title/Nix_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)" rel="noopener noreferrer" target="_blank">Arch Linux Wiki</a>
上的教程安装。其它发行版可以用 Nix 官方的一键安装脚本：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 复制自 https://nixos.org/download.html</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">curl</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -L</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> https://nixos.org/nix/install</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> | </span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">sudo</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> sh</span></span></code></pre>
<p>然后我们要在这台机器上启用 Nix Flake 功能：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">nix-env</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -iA</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> nixpkgs.nixFlakes</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">echo</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;experimental-features = nix-command flakes&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> &gt;&gt; </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/etc/nix/nix.conf</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">systemctl</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> restart</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> nix-daemon</span></span></code></pre>
<p>回到上一节创建的 <code>flake.nix</code> 文件，我们要添加 Deploy-RS 的软件源，并在 <code>outputs</code>
中添加 SSH 连接的配置：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  description</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;Lan Tian&#39;s NixOS Flake&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">url</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;github:NixOS/nixpkgs/nixos-unstable&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # 新增下面几行</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    deploy-rs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      url</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;github:serokell/deploy-rs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">follows</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;nixpkgs&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  outputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = { </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">self</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ... }@</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    nixosConfigurations</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;nixos&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixosSystem</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      system</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;x86_64-linux&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      modules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        ./configuration.nix</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      ];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">    # 新增下面几行</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    deploy</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      sshUser</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;root&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;           </span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># SSH 登录用户名</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      user</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;root&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;              </span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 远程操作的用户</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      sshOpts</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [ </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;-p&quot;</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> &quot;2222&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> ];  </span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># SSH 参数，这里是指定端口 2222</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # 部署失败自动回滚，建议关闭</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # 因为 NixOS（尤其是 Unstable 分支）部署不太稳定，有时需要部署两次才成功</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # 如果自动回滚了，反而适得其反，导致连续部署失败</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      autoRollback</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # 断网自动回滚，建议关闭</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # 在你配置防火墙或 IP 出错把网络干掉时，自动回滚，这样你就不用去主机商控制面板连 VNC 或 IPMI 了</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # 但如果你就是在调整防火墙或者 IP 配置，会有当时断网、但重启机器就可以应用新配置恢复正常的情况</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">      # 自动回滚反而适得其反，因此建议关闭</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      magicRollback</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">false</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      nodes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        &quot;nixos&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">          # 目标机器的地址，IP 或域名或 .ssh/config 中配置的别名均可</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">          hostname</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;192.168.56.105&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">          profiles</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">system</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = {</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">            # 调用上面的 nixosConfigurations.&quot;nixos&quot;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">            path</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">deploy-rs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">x86_64-linux</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">activate</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixos</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> self</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixosConfigurations</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;nixos&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">          };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">        };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>最后执行 <code>nix run github:serokell/deploy-rs -- -s .</code> 运行 Deploy-RS 即可。</p>
<h2 id="附录在甲骨文-arm-云服务器上使用-nixos">附录：在甲骨文 ARM 云服务器上使用 NixOS</h2>
<p>NixOS 也支持 ARM64v8 架构，也就是甲骨文 ARM 云服务器的架构。因为甲骨文 ARM 云服务器实际上是一个 KVM 虚拟机，没有其它的特殊硬件，所以可以直接用
<a href="https://github.com/elitak/nixos-infect" rel="noopener noreferrer" target="_blank">NixOS-Infect</a> 将现有系统替换成 NixOS。</p>
<p>相比 x86 机器，只需要在 <code>flake.nix</code> 中将对应的 <code>system</code> 改为 <code>aarch64-linux</code>：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">{</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # ...</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">  outputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = { </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">self</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">, ... }@</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">inputs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">    nixosConfigurations</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;oracle-vm-arm&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixpkgs</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">lib</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">nixosSystem</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> {</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      system</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">&quot;aarch64-linux&quot;</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#9CDCFE;--shiki-light:#E50000">      modules</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> = [</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">        ./configuration-oracle-vm-arm.nix</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      ];</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    };</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">  };</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">  # ...</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<p>其它配置都与 x86 机器无异。但是如果你使用 Deploy-RS 想在本地生成配置，会发现 Nix
包管理器报错，显示当前机器不支持 ARM 架构。此时我们可以在本地机器上安装
<code>qemu-user-static</code> 和相应的 <code>binfmt</code> 配置，让本地系统可以用模拟的方式运行 ARM 架构的程序。</p>
<p>对于 Arch Linux，需要从 AUR 安装
<a href="https://aur.archlinux.org/packages/qemu-user-static/" rel="noopener noreferrer" target="_blank">qemu-user-static</a> 和
<a href="https://aur.archlinux.org/packages/binfmt-qemu-static-all-arch/" rel="noopener noreferrer" target="_blank">binfmt-qemu-static-all-arch</a>
两个包。</p>
<p>对于 Debian，需要安装
<a href="https://packages.debian.org/sid/qemu-user-static" rel="noopener noreferrer" target="_blank">qemu-user-static</a> 软件包。</p>
<p>安装完成后还需要修改 <code>/etc/nix/nix.conf</code>，添加这一行配置，告诉 Nix 包管理器当前机器可以运行 ARM 程序：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">extra-platforms</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> =</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> aarch64-linux</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> arm-linux</span></span></code></pre>
<p>然后重启 Nix Daemon <code>systemctl restart nix-daemon</code>，Deploy-RS 就可以使用了。</p>
<h2 id="附录扩展阅读">附录：扩展阅读</h2>
<p>在这篇文章中，我们配置了一个基础的、几乎没有额外软件的 NixOS 系统。关于实际安装、配置软件，我推荐阅读 Ryan Yin 的
<a href="https://thiscute.world/posts/nixos-and-flake-basics/" rel="noopener noreferrer" target="_blank">NixOS 与 Nix Flakes 新手入门</a>。他的文章给出了一些配置常用软件的配置范例。</p>
<p>你也可以阅读以下文档来更深入地了解 NixOS 的配置语法、Flake 功能，以及
Deploy-RS。注意以下文档都是英文的：</p>
<ul>
<li>NixOS 配置语法
<ul>
<li><a href="https://nixos.wiki/wiki/Nix_Expression_Language" rel="noopener noreferrer" target="_blank">NixOS.Wiki: Nix Expression Language</a></li>
<li><a href="https://medium.com/@MrJamesFisher/nix-by-example-a0063a1a4c55" rel="noopener noreferrer" target="_blank">Nix By Example</a></li>
</ul>
</li>
<li>Flake 功能
<ul>
<li><a href="https://nixos.wiki/wiki/Flakes" rel="noopener noreferrer" target="_blank">NixOS.Wiki: Flakes</a></li>
</ul>
</li>
<li>Deploy-RS
<ul>
<li><a href="https://github.com/serokell/deploy-rs" rel="noopener noreferrer" target="_blank">GitHub: Deploy-RS</a></li>
</ul>
</li>
</ul>
<p>你也可以参考我在 GitHub 上发布的配置文件：</p>
<ul>
<li><a href="https://github.com/xddxdd/nixos-config/tree/9ed2eff8e4e6054151558f3d5909f3ef2af9b288" rel="noopener noreferrer" target="_blank">Initial commit</a>
<ul>
<li>完成了基础配置和 Nix Flake 部分。</li>
</ul>
</li>
<li><a href="https://github.com/xddxdd/nixos-config/tree/79c6f5b45d7ff574ecefb594ed76715715906cec" rel="noopener noreferrer" target="_blank">general: add deploy-rs script, change SSH port to 2222</a>
<ul>
<li>完成了 Deploy-RS 的配置。</li>
</ul>
</li>
</ul>  </div>  <div class="clearfix" id="post-navi" data-astro-cid-gfbmwgei=""> <div class="float-end text-end" data-astro-cid-gfbmwgei=""> <a href="/article/modify-website/nixos-why.lantian/" title="NixOS 系列（一）：我为什么心动了" data-astro-cid-gfbmwgei=""> NixOS 系列（一）：我为什么心动了 </a> <br data-astro-cid-gfbmwgei=""> 下一篇文章 »
</div> <div class="float-start text-start position-absolute" data-astro-cid-gfbmwgei="">
« 上一篇文章 <br data-astro-cid-gfbmwgei=""> <a href="/article/chat/how-i-nuked-my-btrfs-partition.lantian/" title="我把硬盘换到了新电脑上，这是 Btrfs 上的数据发生的变化" data-astro-cid-gfbmwgei=""> 我把硬盘换到了新电脑上，这是 Btrfs 上的数据发生的变化 </a> </div> </div>  <div id="waline" data-waline-language="zh-CN" data-waline-path="/article/modify-website/nixos-initial-config-flake-deploy.lantian"></div> <script type="module" src="/assets/WalineComment.astro_astro_type_script_index_0_lang.Dqib3X1E.js"></script>  </div> </div> </article>  </div> <aside class="d-none d-xl-block"> <section class="widget"> <h3>最新文章</h3> <ul class="list-unstyled"> <li> 07-20  <a href="/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/">用 Open5GS 搭建合法的 LTE 网络</a> </li><li> 06-27  <a href="/article/modify-computer/sidestore-without-stosvpn-across-lan.lantian/">在内网中免 StosVPN 使用 SideStore</a> </li><li> 05-19  <a href="/article/modify-computer/nix-logarithmetic-math-library-from-zero.lantian/">从零开始实现 Nix 对数函数库</a> </li><li> 04-06  <a href="/article/modify-computer/legal-lte-network-at-home-for-100-bucks.lantian/">$100，DIY 搭建合法的 LTE 网络</a> </li><li> 02-10  <a href="/article/modify-computer/build-custom-android-kernel-with-nix.lantian/">用 Nix 编译自定义 Android 内核</a> </li><li> 04-20  <a href="/article/modify-website/migrate-blog-to-astro-js.lantian/">使用 Astro.js 重构我的博客</a> </li><li> 12-16  <a href="/article/modify-computer/nixos-low-ram-vps.lantian/">NixOS 系列（五）：制作小内存 VPS 的 DD 磁盘镜像</a> </li><li> 09-20  <a href="/article/modify-computer/nix-trigonometric-math-library-from-zero.lantian/">从零开始实现 Nix 三角函数库</a> </li><li> 05-29  <a href="/article/random-notes/pipewire-sigkill-fix.lantian/">解决 Pipewire 被 SIGKILL 的问题</a> </li><li> 05-12  <a href="/article/modify-website/how-to-kill-the-dn42-network.lantian/">如何引爆 DN42 网络（2023-05-12 更新）</a> </li><li> 05-08  <a href="/article/modify-computer/laptop-muxed-nvidia-passthrough.lantian/">Optimus MUXed 笔记本上的 NVIDIA 虚拟机显卡直通（2023-05 更新）</a> </li><li> 04-17  <a href="/article/random-notes/fix-china-telecom-roaming-no-4g-on-aosp-rom.lantian/">修改 APN 解决 AOSP ROM 上中国电信无法 4G 漫游问题</a> </li><li> 03-26  <a href="/article/random-notes/old-hp-workstation-as-all-in-one.lantian/">老款 HP 工作站配置 NAS+软路由笔记</a> </li><li> 01-14  <a href="/article/modify-computer/nixos-impermanence.lantian/">NixOS 系列（四）：“无状态”操作系统</a> </li><li> 06-21  <a href="/article/modify-computer/nixos-packaging.lantian/">NixOS 系列（三）：软件打包，从入门到放弃</a> </li> </ul> </section> <section class="widget"> <h3>最新评论</h3> <ul class="list-unstyled" id="recent-comments">  <li><a href="#">Loading...</a></li>  </ul> </section> <script type="module">const i=window.location.hostname=="localhost"?"https://comments.lantian.pub":window.location.origin;fetch(`${i}/api/comment?type=recent&count=10`).then(t=>{if(t.status!==200)throw new Error(`Server returned bad HTTP status ${t.status}`);return t.json()}).then(t=>{const e=document.getElementById("recent-comments");e&&(e.innerHTML=t.data.map(n=>{const o=n.comment.replace(/(<([^>]+)>)/gi,"");return"<li>"+n.nick+' <a href="'+n.url+'">'+o+"</a></li>"}).join(""))});</script> <section class="widget"> <h3>其它功能</h3> <ul class="list-unstyled">  <li> <i class="fas fa-fw fa-rss"></i>  <a href="/rss2.xml" target="_blank">RSS 订阅</a> |  <a href="/feed.xml" target="_blank">Atom</a> |  <a href="/feed.json" target="_blank">JSON</a> </li> <li> <i class="fas fa-fw fa-globe"></i>  <a href="https://stats.uptimerobot.com/BLK6VsRkR" target="_blank"> 服务器状态 </a> </li> <li> <i class="fas fa-fw fa-sitemap"></i>  <a href="https://lg.lantian.pub" target="_blank">DN42 节点状态</a> </li> <li> <i class="fas fa-fw fa-link"></i>  <a href="gopher://lantian.pub" target="_blank">使用 Gopher 协议访问</a> </li>  </ul> </section> <section class="widget"> <h3>友情链接</h3> <ul class="list-unstyled"> <li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://0x7f.cc"> 0x7f Blog 🐑 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://alanyhq.com"> Alanyhq </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.cas7.moe"> Blog of Moecast </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://jerryxiao.cc"> JerryXiao </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://snli.org"> Shucheng Li </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://sangsir.com"> SangSir | 艺术界的一朵奇葩 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://yuetau.net"> YuetAu&#39;s Spot </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.baoshuo.ren/?utm_source=friends"> 宝硕博客 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="http://foreverblog.cn"> 十年之约 </a> </li> </ul> </section> </aside> </div> <footer class="lantian clearfix" data-astro-cid-w3csb3e3="">  <div id="copyright" class="float-end text-end" data-astro-cid-w3csb3e3=""> <i class="fas fa-copyright" data-astro-cid-w3csb3e3=""></i> 2012-2025 Lan Tian @ Blog<br data-astro-cid-w3csb3e3=""> <small data-astro-cid-w3csb3e3=""> 基于 Astro v5.15.1 构建 @ 2025-10-25 23:46:33 </small> </div> <script type="module">function v(c,o,r){const h=/^localhost$|^127(?:\.[0-9]+){0,2}\.[0-9]+$|^(?:0*:)*?:?0*1$/.test(location.hostname)||location.protocol==="file:";if(!o.trackLocalhost&&h)return console.warn("[Plausible] Ignoring event because website is running locally");try{if(window.localStorage.plausible_ignore==="true")return console.warn('[Plausible] Ignoring event because "plausible_ignore" is set to "true" in localStorage')}catch{}const p={n:c,u:o.url,d:o.domain,r:o.referrer,w:o.deviceWidth,h:o.hashMode?1:0,p:r&&r.props?JSON.stringify(r.props):void 0},s=new XMLHttpRequest;s.open("POST",`${o.apiHost}/api/event`,!0),s.setRequestHeader("Content-Type","text/plain"),s.send(JSON.stringify(p)),s.onreadystatechange=()=>{s.readyState===4&&r&&r.callback&&r.callback()}}function b(c){const o=()=>({hashMode:!1,trackLocalhost:!1,url:location.href,domain:location.hostname,referrer:document.referrer||null,deviceWidth:window.innerWidth,apiHost:"https://plausible.io",...c}),r=(t,n,i)=>{v(t,{...o(),...i},n)},h=(t,n)=>{r("pageview",n,t)};return{trackEvent:r,trackPageview:h,enableAutoPageviews:()=>{const t=()=>h(),n=history.pushState;return n&&(history.pushState=function(i,l,u){n.apply(this,[i,l,u]),t()},addEventListener("popstate",t)),c&&c.hashMode&&addEventListener("hashchange",t),h(),function(){n&&(history.pushState=n,removeEventListener("popstate",t)),c&&c.hashMode&&removeEventListener("hashchange",t)}},enableAutoOutboundTracking:(t=document,n={subtree:!0,childList:!0,attributes:!0,attributeFilter:["href"]})=>{function i(e){r("Outbound Link: Click",{props:{url:this.href}}),typeof process<"u"&&process,setTimeout(()=>{location.href=this.href},150),e.preventDefault()}const l=new Set;function u(e){e instanceof HTMLAnchorElement?e.host!==location.host&&(e.addEventListener("click",i),l.add(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(u)}function f(e){e instanceof HTMLAnchorElement?(e.removeEventListener("click",i),l.delete(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(f)}const d=new MutationObserver(e=>{e.forEach(a=>{a.type==="attributes"?(f(a.target),u(a.target)):a.type==="childList"&&(a.addedNodes.forEach(u),a.removedNodes.forEach(f))})});return t.querySelectorAll("a").forEach(u),d.observe(t,n),function(){l.forEach(a=>{a.removeEventListener("click",i)}),l.clear(),d.disconnect()}}}}const g=b({domain:"lantian.pub",trackLocalhost:!0,apiHost:""});g.trackPageview();</script> </footer>  </div>  </body> </html>