<!DOCTYPE html><html lang="zh-CN" itemscope="" itemtype="https://schema.org/Article" data-astro-cid-porej7z2=""> <head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>将网站迁移到 Docker - Lan Tian @ Blog</title><script>
  ;(() => {
    try {
      const mode = localStorage.getItem('user-color-scheme')
      if (mode == 'dark' || mode == 'light') {
        document.documentElement.setAttribute('data-user-color-scheme', mode)
      }
    } catch {
      // Ignore errors
    }
  })()
</script><link rel="stylesheet" href="/assets/index.CUlf1-Vz.css"><style>#post-navi[data-astro-cid-gfbmwgei]{padding:5px;border-top:1px solid var(--lt-border-weak);border-bottom:1px solid var(--lt-border-weak)}
ol[data-astro-cid-nj3qel45]{margin:0;padding:0;line-height:1.5}ol[data-astro-cid-nj3qel45] .toc-item[data-astro-cid-nj3qel45]{list-style:none}ol[data-astro-cid-nj3qel45] .toc-child[data-astro-cid-nj3qel45],ol[data-astro-cid-nj3qel45] .toc[data-astro-cid-nj3qel45]{padding:0}ol[data-astro-cid-nj3qel45] .toc-link[data-astro-cid-nj3qel45]{display:block;margin-left:1em;padding:.25em 0}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;width:1em;padding:.25em 0;float:left;font-style:normal;font-variant:normal;font-weight:900;font-family:Font Awesome\ 6 Free;font-feature-settings:normal;text-align:center}ol[data-astro-cid-nj3qel45] .toc-level-1[data-astro-cid-nj3qel45]:before{content:""}ol[data-astro-cid-nj3qel45] .toc-level-2[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-3[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-4[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-5[data-astro-cid-nj3qel45]:before,ol[data-astro-cid-nj3qel45] .toc-level-6[data-astro-cid-nj3qel45]:before{content:""}.post-info-wrap[data-astro-cid-dckccua4]{-ms-flex:0 0 2.5em;flex:0 0 2.5em;background-color:var(--lt-component-bg-emphasis)}@media(min-width:768px){.post-info[data-astro-cid-dckccua4]{position:sticky;top:0}}@media(max-width:767.98px){.post-info[data-astro-cid-dckccua4]{position:absolute}}
</style><script type="module" src="/assets/PageLayout.astro_astro_type_script_index_0_lang.C1wfUPs6.js"></script><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Referrer-Policy" content="no-referrer, strict-origin-when-cross-origin"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="imagemode" content="force"><meta name="nightmode" content="disable"><meta name="wap-font-scale" content="no"><meta name="title" content="将网站迁移到 Docker - Lan Tian @ Blog"><meta name="keywords" content=""><meta name="author" content="Lan Tian"><link rel="canonical" href="https://lantian.pub/article/modify-website/migrate-website-docker.lantian/"><link rel="alternate" type="application/rss+xml" title="Lan Tian @ Blog" href="https://lantian.pub/rss2.xml"><link rel="alternate" type="application/atom+xml" title="Lan Tian @ Blog" href="https://lantian.pub/feed.xml"><link rel="alternate" href="https://lantian.pub/article/modify-website/migrate-website-docker.lantian/" hreflang="zh"><link rel="alternate" href="https://lantian.pub/en/article/modify-website/migrate-website-docker.lantian/" hreflang="en"><meta name="copyright" content="Copyright 2012-2025 Lan Tian @ Blog"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#03a9f4"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#212121"><meta name="application-name" content="Lan Tian @ Blog"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="apple-touch-icon" sizes="1024x1024" href="/apple-touch-icon-1024x1024.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#03a9f4"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Lan Tian @ Blog"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-640x1136.png"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1136x640.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-750x1334.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1334x750.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1125x2436.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2436x1125.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1170x2532.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2532x1170.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1179x2556.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2556x1179.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-828x1792.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1792x828.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2688.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2688x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2208.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2208x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1284x2778.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2778x1284.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1290x2796.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2796x1290.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1488x2266.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2266x1488.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1536x2048.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2048x1536.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1620x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1620.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1640x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1640.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2388.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2388x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2224.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2224x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-2048x2732.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2732x2048.png"><meta name="msapplication-TileColor" content="#bbdefb"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"><meta property="og:url" content="https://lantian.pub/article/modify-website/migrate-website-docker.lantian/"><meta property="og:type" content="website"><meta property="og:title" content="将网站迁移到 Docker - Lan Tian @ Blog"><meta property="og:image" content="https://lantian.pub/apple-touch-icon.png"><meta content="Docker 是一个 Linux 下的容器管理软件。每个容器某种意义上相当于一个 OpenVZ VPS，可以将服务器上的各个应用隔离开来。这种隔离有助于同一软件不同版本，或是互相冲突的软件在同一服务器上运行，比如 MySQL 5.7，MySQL 5.6 和 MariaDB 10.1 可以在同一台服务器上的三个 Docker 容器中运行。 但是 Docker 比 OpenVZ 优秀的地方在于，它对 Linux 内核的版本要求要宽松的多。OpenVZ 的内核至今为止停留在 2.6.32（稳定版）和 3.10（开发版），但是 Docker 可以在 3.10 以上的任何版本 Linux 内核运行。我的服务器现在运行 Linux 4.9 内核（为了 BBR），明显不能运行 OpenVZ，但是可以运行 Docker。 Docker 另一个优点是提供了一套非常完整的镜像仓库和自动化工具。在 OpenVZ 上，我必须分别登录每台 VPS，设置网络， apt-get ，还要定期去每台 VPS 上备份数据。但是在 Docker 上，我可以直接使用现有的软件镜像（不用再 apt-get ），..."><meta property="og:site_name" content="Lan Tian @ Blog"><meta property="og:locale" content="zh"><meta name="twitter:card" content="summary"><meta name="twitter:url" content="https://lantian.pub/article/modify-website/migrate-website-docker.lantian/"><meta name="twitter:title" content="将网站迁移到 Docker - Lan Tian @ Blog"><meta property="twitter:image" content="https://lantian.pub/apple-touch-icon.png"><meta content="Docker 是一个 Linux 下的容器管理软件。每个容器某种意义上相当于一个 OpenVZ VPS，可以将服务器上的各个应用隔离开来。这种隔离有助于同一软件不同版本，或是互相冲突的软件在同一服务器上运行，比如 MySQL 5.7，MySQL 5.6 和 MariaDB 10.1 可以在同一台服务器上的三个 Docker 容器中运行。 但是 Docker 比 OpenVZ 优秀的地方在于，它对 Linux 内核的版本要求要宽松的多。OpenVZ 的内核至今为止停留在 2.6.32（稳定版）和 3.10（开发版），但是 Docker 可以在 3.10 以上的任何版本 Linux 内核运行。我的服务器现在运行 Linux 4.9 内核（为了 BBR），明显不能运行 OpenVZ，但是可以运行 Docker。 Docker 另一个优点是提供了一套非常完整的镜像仓库和自动化工具。在 OpenVZ 上，我必须分别登录每台 VPS，设置网络， apt-get ，还要定期去每台 VPS 上备份数据。但是在 Docker 上，我可以直接使用现有的软件镜像（不用再 apt-get ），..."><meta name="twitter:dnt" content="on"><meta itemprop="name" content="将网站迁移到 Docker - Lan Tian @ Blog"><meta property="image" content="https://lantian.pub/apple-touch-icon.png"><meta content="Docker 是一个 Linux 下的容器管理软件。每个容器某种意义上相当于一个 OpenVZ VPS，可以将服务器上的各个应用隔离开来。这种隔离有助于同一软件不同版本，或是互相冲突的软件在同一服务器上运行，比如 MySQL 5.7，MySQL 5.6 和 MariaDB 10.1 可以在同一台服务器上的三个 Docker 容器中运行。 但是 Docker 比 OpenVZ 优秀的地方在于，它对 Linux 内核的版本要求要宽松的多。OpenVZ 的内核至今为止停留在 2.6.32（稳定版）和 3.10（开发版），但是 Docker 可以在 3.10 以上的任何版本 Linux 内核运行。我的服务器现在运行 Linux 4.9 内核（为了 BBR），明显不能运行 OpenVZ，但是可以运行 Docker。 Docker 另一个优点是提供了一套非常完整的镜像仓库和自动化工具。在 OpenVZ 上，我必须分别登录每台 VPS，设置网络， apt-get ，还要定期去每台 VPS 上备份数据。但是在 Docker 上，我可以直接使用现有的软件镜像（不用再 apt-get ），..."><meta content="Docker 是一个 Linux 下的容器管理软件。每个容器某种意义上相当于一个 OpenVZ VPS，可以将服务器上的各个应用隔离开来。这种隔离有助于同一软件不同版本，或是互相冲突的软件在同一服务器上运行，比如 MySQL 5.7，MySQL 5.6 和 MariaDB 10.1 可以在同一台服务器上的三个 Docker 容器中运行。 但是 Docker 比 OpenVZ 优秀的地方在于，它对 Linux 内核的版本要求要宽松的多。OpenVZ 的内核至今为止停留在 2.6.32（稳定版）和 3.10（开发版），但是 Docker 可以在 3.10 以上的任何版本 Linux 内核运行。我的服务器现在运行 Linux 4.9 内核（为了 BBR），明显不能运行 OpenVZ，但是可以运行 Docker。 Docker 另一个优点是提供了一套非常完整的镜像仓库和自动化工具。在 OpenVZ 上，我必须分别登录每台 VPS，设置网络， apt-get ，还要定期去每台 VPS 上备份数据。但是在 Docker 上，我可以直接使用现有的软件镜像（不用再 apt-get ），..."><link rel="me" href="https://mastodon.social/@lantian"></head> <body data-astro-cid-porej7z2=""> <div id="bg" data-astro-cid-j6vmxtef=""></div>   <div id="container" class="container" data-astro-cid-porej7z2=""> <nav class="lantian navbar navbar-expand-lg" data-astro-cid-wu5dj4rx=""> <div class="container-fluid" data-astro-cid-wu5dj4rx=""> <a class="navbar-brand" href="/" data-astro-cid-wu5dj4rx="">Lan Tian @ Blog</a> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#lantian-navbar" aria-controls="lantian-navbar" aria-expanded="false" aria-label="Toggle navigation" data-astro-cid-wu5dj4rx=""> <span class="navbar-toggler-icon" data-astro-cid-wu5dj4rx=""></span> </button> <div class="collapse navbar-collapse" id="lantian-navbar" data-astro-cid-wu5dj4rx=""> <ul class="navbar-nav" data-astro-cid-wu5dj4rx=""> <li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/page/archive/index.html" data-astro-cid-wu5dj4rx=""> 文章们 </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> 俯瞰地球 </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> <li class="nav-item dropdown d-block d-lg-none" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="pages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-file" data-astro-cid-wu5dj4rx=""></i> 页面  <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="pages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/page/archive/index.html" data-astro-cid-wu5dj4rx=""> 文章们 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> 俯瞰地球 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> </ul> </li> </ul> <ul class="navbar-nav ms-auto" data-astro-cid-wu5dj4rx=""> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="languages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-language" data-astro-cid-wu5dj4rx=""></i> Language <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="languages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item active" href="/article/modify-website/migrate-website-docker.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-cn" data-astro-cid-wu5dj4rx=""></span> Chinese Simplified / 简体中文 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/article/modify-website/migrate-website-docker.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-us" data-astro-cid-wu5dj4rx=""></span> English </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">Not all pages have translations.</a> </li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">You may see 404 - this is normal.</a> </li> </ul> </li> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="color-scheme-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> 夜间模式 </a> <ul class="dropdown-menu" aria-labelledby="color-scheme-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-auto" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> 自动 </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-light" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-sun" data-astro-cid-wu5dj4rx=""></i> 浅色</a> </li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-dark" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-moon" data-astro-cid-wu5dj4rx=""></i> 深色</a> </li> </ul> </li> </ul> </div> </div> </nav> <script type="module">const m="user-color-scheme",s="data-user-color-scheme",u=(e,t)=>{try{localStorage.setItem(e,t)}catch{}},i=e=>{try{return localStorage.getItem(e)}catch{return null}},c=e=>{const t={dark:!0,light:!0,auto:!0},o=e===null||!Object.keys(t).includes(e)?"auto":e;u(m,o);for(const l in t){const n=document.getElementById("color-scheme-"+l);n&&(l==o?n.classList.add("active"):n.classList.remove("active"))}o!="auto"?document.documentElement.setAttribute(s,o):document.documentElement.removeAttribute(s)};c(i(m));const r=document.getElementById("color-scheme-auto");r&&r.addEventListener("click",()=>c("auto"));const a=document.getElementById("color-scheme-light");a&&a.addEventListener("click",()=>c("light"));const d=document.getElementById("color-scheme-dark");d&&d.addEventListener("click",()=>c("dark"));</script>  <div class="d-flex" data-astro-cid-porej7z2=""> <div id="content" data-astro-cid-porej7z2="">  <article> <div class="d-flex"> <div class="post-info-wrap" data-astro-cid-dckccua4=""> <div class="post-info" data-astro-cid-dckccua4=""> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-clock"></span> <br> <small>12-29</small> </p> <div class="post-meta-value"> 发布于<span class="badge badge-tag" data-astro-cid-dckccua4=""> 2016-12-29 13:55 </span>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-file-alt"></span> <br> <small>网站与服务端</small> </p> <div class="post-meta-value"> 分类 <a class="badge badge-tag" href="/category/modify-website" data-astro-cid-dckccua4=""> 网站与服务端 </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-tag"></span> <br> <small>1 标签</small> </p> <div class="post-meta-value"> 标签  <a class="badge badge-tag" href="/tag/Docker" data-astro-cid-dckccua4=""> Docker </a>  </div> </div> </div> <div class="post-meta-wrap"> <div class="post-meta"> <p> <span class="fas fa-list"></span> <br> <small>目录</small> </p> <div class="post-meta-value">  <ol data-astro-cid-nj3qel45=""> <li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#安装-docker-以及-docker-compose" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">安装 Docker 以及 Docker Compose</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#使用现有镜像迁移" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">使用现有镜像迁移</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#从-apt-get-安装软件的镜像" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">从 apt-get 安装软件的镜像</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#自己编译软件镜像" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">自己编译软件镜像</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#结语" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">结语</span> </a> </li> </ol>   </div> </div> </div> </div>  </div>  <div class="post-wrap">  <h1 class="post-title"> <a href="/article/modify-website/migrate-website-docker.lantian/" rel="bookmark" title="将网站迁移到 Docker">将网站迁移到 Docker</a> </h1> <div class="post-text">   <p>Docker 是一个 Linux 下的容器管理软件。每个容器某种意义上相当于一个 OpenVZ VPS，可以将服务器上的各个应用隔离开来。这种隔离有助于同一软件不同版本，或是互相冲突的软件在同一服务器上运行，比如 MySQL 5.7，MySQL 5.6 和 MariaDB 10.1 可以在同一台服务器上的三个 Docker 容器中运行。</p>
<p>但是 Docker 比 OpenVZ 优秀的地方在于，它对 Linux 内核的版本要求要宽松的多。OpenVZ 的内核至今为止停留在 2.6.32（稳定版）和 3.10（开发版），但是 Docker
可以在 3.10 以上的任何版本 Linux 内核运行。我的服务器现在运行 Linux 4.9 内核（为了 BBR），明显不能运行 OpenVZ，但是可以运行 Docker。</p>
<p>Docker 另一个优点是提供了一套非常完整的镜像仓库和自动化工具。在 OpenVZ 上，我必须分别登录每台 VPS，设置网络，<code>apt-get</code>，还要定期去每台 VPS 上备份数据。但是在
Docker 上，我可以直接使用现有的软件镜像（不用再 <code>apt-get</code>），并将数据文件夹直接映射到主机上（不用分别备份）。</p>
<p>Docker 更是提供 Docker Compose，以配置文件的形式设置多个 Docker 容器，并且快速部署、删除。</p>
<h2 id="安装-docker-以及-docker-compose">安装 Docker 以及 Docker Compose</h2>
<p>我个人使用的系统是 Debian 8，可以直接从 Docker 官方的软件源安装。</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">apt-get</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> install</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> apt-transport-https</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ca-certificates</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> gnupg2</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">apt-key</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> adv</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> --keyserver</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> hkp://ha.pool.sks-keyservers.net:80</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> --recv-keys</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> 58118E89F3A912897C070ADBF76221572C52609D</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">echo</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "deb https://apt.dockerproject.org/repo debian-jessie main"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> >> </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">/etc/apt/sources.list</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">apt-get</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> update</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">apt-get</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> install</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> docker-engine</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">curl</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -L</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "https://github.com/docker/compose/releases/download/1.9.0/docker-compose-$(</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">uname</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -s</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">)-$(</span><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">uname</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -m</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">)"</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -o</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /usr/local/bin/docker-compose</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">chmod</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> +x</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /usr/local/bin/docker-compose</span></span></code></pre>
<h2 id="使用现有镜像迁移">使用现有镜像迁移</h2>
<p>我服务器上原来运行的软件是：Nginx，PHP7.0-FPM，MariaDB，Memcached，Redis 和 SS。为了统一管理，我使用 Docker 镜像的方式部署。</p>
<p>我决定把数据全部存在 <code>/srv</code> 文件夹中，因此 cd 进这个文件夹，并创建
docker-compose.yml 文件。这个就是 Docker Compose 的配置文件。其基本格式如下：（#
号后的内容为我添加的注释，在原文件中不存在）</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'2'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  容器 1</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">容器的镜像名称，如果本地没有这个镜像，Docker 会自动去镜像仓库下载</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    container_name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">容器名称</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    environment</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 环境变量</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">环境变量名称=环境变量值</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">PASSWORD=123456</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    restart</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">always</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # 容器崩了就立即重启</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    volumes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 将服务器上的文件夹映射到 Docker 容器中，用于存储和统一管理数据</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'服务器上存储数据的文件夹:Docker 容器中对应的文件夹'</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'/var/lib/mysql:/var/lib/mysql'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    ports</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 端口映射</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'服务器上监听的端口:Docker 容器内的端口'</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # 此例为将端口开放供任何人访问</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'80:80'</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'服务器上监听的地址:服务器上监听的端口:Docker 容器内的端口'</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # 此例为该服务仅允许在服务器上访问</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'127.0.0.1:11211:11211'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  容器2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">...（和容器 1 相同）</span></span></code></pre>
<p>接下来我们就要写一个 docker-compose.yml，运行 MariaDB 的镜像并将数据导入。（#号后的内容为我添加的注释，在原文件中不存在）</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">version</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'2'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">services</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  lantian-mariadb</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">mariadb:latest</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    container_name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">lantian-mariadb</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    restart</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">always</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    volumes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'/srv/mysql:/var/lib/mysql'</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'/etc/timezone:/etc/timezone'</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # 将服务器的时区设置应用到 Docker 容器中</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'/etc/localtime:/etc/localtime'</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">    ports</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'127.0.0.1:3306:3306'</span></span></code></pre>
<p>首先停止原来的 MariaDB：<code>service mysql stop</code>（我不考虑无缝切换问题）</p>
<p>然后把数据文件夹移过来：<code>mv /var/lib/mysql /srv/mysql</code></p>
<p>最后 <code>docker-compose up -d</code> 加载这个配置文件</p>
<p>MariaDB 就在 Docker 里运行起来了！</p>
<p>同理，Redis 和 Memcached 都有现成的镜像，可以如法炮制。</p>
<h2 id="从-apt-get-安装软件的镜像">从 apt-get 安装软件的镜像</h2>
<p>对于 PHP7.0-FPM，问题要复杂一些。镜像仓库里的官方 PHP-FPM 加了奇怪的编译参数，配置文件的放置方式和我从 DotDeb 安装的不同。为了防止以后出现奇怪的问题，我决定做一个简单的 Docker 镜像。</p>
<p>做 Docker 镜像不需要你有什么高深的编程技巧。相反，你只要会基本的 bash 命令就行。</p>
<p>首先新建一个文件夹，cd 进去，创建一个 Dockerfile，这就是你的新镜像的构建配置文件。</p>
<p>Dockerfile 的基本格式如下：(# 号后面的是我自己加的)</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">FROM</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> debian:jessie</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # 引用官方的 Debian 8 镜像，在此基础上执行下面的操作</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">MAINTAINER</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Lan</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Tian</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "lantian@lantian.pub"</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # 说明 Dockerfile 作者，这行删掉没关系</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">ADD</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> somefile.txt</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /somefile.txt</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # 把一个文件添加进镜像，此例将当前文件夹下的 somefile.txt 添加进去。</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">RUN</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> apt-get</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> update</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # 在容器构建时运行一条命令，此例为 apt-get update</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">EXPOSE</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 80</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # 指示这个 Docker 容器要开放某个端口供其它容器访问</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">ENTRYPOINT</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> [</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"php-fpm7.0"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">] </span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 以后启动这个容器执行的命令，这个命令执行完成（程序退出）容器即停止</span></span></code></pre>
<p>在这个新镜像的构建过程中，需要在 Debian 8 的基础上，添加 DotDeb 软件源，apt-get，添加自己的配置文件，开放端口供其它容器访问，设置启动命令。我的
Dockerfile 是这样的：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">FROM</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> debian:jessie</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">MAINTAINER</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> Lan Tian </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"lantian@lantian.pub"</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">ADD</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> dotdeb.gpg /dotdeb.gpg</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">RUN</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> echo </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"deb http://packages.dotdeb.org jessie all"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> >> /etc/apt/sources.list \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; echo </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"deb-src http://packages.dotdeb.org jessie all"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> >> /etc/apt/sources.list \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; apt-key add /dotdeb.gpg \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; apt-get update \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; apt-get install -y php7.0-fpm php7.0-bz2 php7.0-curl php7.0-gd php7.0-json php7.0-mbstring php7.0-mcrypt php7.0-memcached php7.0-mysql php7.0-redis php7.0-sqlite3 php7.0-xml php7.0-xmlrpc php7.0-zip \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; apt-get clean</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">ADD</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> www.conf /etc/php/7.0/fpm/pool.d/www.conf</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">ADD</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> php.ini /etc/php/7.0/fpm/php.ini</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">ADD</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> php-fpm.conf /etc/php/7.0/fpm/php-fpm.conf</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">EXPOSE</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> 9000</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">ENTRYPOINT</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> [</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"php-fpm7.0"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">]</span></span></code></pre>
<p>dotdeb.gpg 是 DotDeb 软件源的密钥，因为 Docker 官方的 Debian 镜像居然连 wget 都没有，我又不想浪费一次 <code>apt-get update</code>，就直接把密钥提前下载下来放在 Dockerfile
同文件夹里；<a href="http://www.conf%EF%BC%8Cphp.ini" rel="noopener noreferrer" target="_blank">www.conf，php.ini</a> 和 php-fpm.conf 是我自己的配置文件，你在构建时，如果直接用默认配置，把对应的 ADD 行删掉即可；如果你要自定义配置，就把对应配置文件放在 Dockerfile 同文件夹里。</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">wget</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> https://www.dotdeb.org/dotdeb.gpg</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">cp</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /etc/php/7.0/fpm/pool.d/www.conf</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ./</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">cp</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /etc/php/7.0/fpm/php.ini</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ./</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">cp</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /etc/php/7.0/fpm/php-fpm.conf</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ./</span></span></code></pre>
<p>在当前文件夹开始构建：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">docker</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> build</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -t</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> lt-php7-fpm</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> .</span></span></code></pre>
<p>docker-compose.yml 里加上这些内容：（注意空格，# 号后删掉）</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">lt-php-fpm</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">lt-php7-fpm</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  container_name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">lt-php-fpm</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  restart</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">always</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  volumes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'./www:/srv/www'</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # 将你的 www 文件夹映射进去</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'./owncloud:/srv/owncloud'</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # OwnCloud 数据文件夹，没有 OwnCloud 就删掉这行</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'/etc/timezone:/etc/timezone'</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # 时区</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'/etc/localtime:/etc/localtime'</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # 时区</span></span></code></pre>
<h2 id="自己编译软件镜像">自己编译软件镜像</h2>
<p>我的 Nginx 要更麻烦一些，因为我给 Nginx 加了一堆奇怪的东西，包括 HTTP2+SPDY 补丁、Google PageSpeed、Certificate Transparency 补丁、Brotli 压缩格式之类的。很明显，我找不到现有的镜像，所以我只能自己编译了。</p>
<p>要把这些做成镜像，原理其实很简单：把你在编译过程中输的命令全部写进 Dockerfile
里。但是在你编译的时候，你是不是要输好几次软件的版本号，比如 <code>cd nginx-1.11.8</code>
之类的？在 Dockerfile 里，类似的版本号都可以写成变量，在以后升级时可以方便地修改。</p>
<p>在 Dockerfile 中可以如此使用变量：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">ENV</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> NGINX_VERSION=1.11.8 # 设置一个名为 NGINX_VERSION 的变量，值是 1.11.8</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">RUN</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> cd nginx-${NGINX_VERSION} # ${NGINX_VERSION} 就等同于 1.11.8，此例中相当于 cd nginx-1.11.8</span></span></code></pre>
<p>我们要做的事情：安装编译环境，下载 Nginx 和各个补丁的源代码，编译安装。我的
Dockerfile 如下：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">FROM</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> debian</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">MAINTAINER</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> Lan Tian </span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"lantian@lantian.pub"</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">ENV</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> NGINX_VERSION=1.11.8 OPENSSL_VERSION=1.1.0c NPS_VERSION=1.12.34.2</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">RUN</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> mkdir /tmp/build &#x26;&#x26; cd /tmp/build \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; apt-get update -q\</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; apt-get -y install build-essential git autoconf automake libtool wget tar zlib1g-dev libpcre3 libpcre3-dev unzip \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; wget http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      &#x26;&#x26; tar xvf nginx-${NGINX_VERSION}.tar.gz \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; git clone https://github.com/bagder/libbrotli.git \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      &#x26;&#x26; cd /tmp/build/libbrotli &#x26;&#x26; ./autogen.sh &#x26;&#x26; ./configure &#x26;&#x26; make &#x26;&#x26; make install &#x26;&#x26; cd /tmp/build \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      &#x26;&#x26; ln -s /usr/local/lib/libbrotlienc.so.1 /usr/lib/libbrotlienc.so.1 \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; git clone https://github.com/google/ngx_brotli.git \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      &#x26;&#x26; cd /tmp/build/ngx_brotli &#x26;&#x26; git submodule update --init &#x26;&#x26; cd /tmp/build/ \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; git clone https://github.com/grahamedgecombe/nginx-ct.git \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; wget https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      &#x26;&#x26; tar xvf openssl-${OPENSSL_VERSION}.tar.gz \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; wget https://github.com/pagespeed/ngx_pagespeed/archive/v${NPS_VERSION}-beta.zip \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      &#x26;&#x26; unzip v${NPS_VERSION}-beta.zip \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      &#x26;&#x26; cd /tmp/build/ngx_pagespeed-${NPS_VERSION}-beta/ \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      &#x26;&#x26; wget https://dl.google.com/dl/page-speed/psol/${NPS_VERSION}-x64.tar.gz \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      &#x26;&#x26; tar -xvf ${NPS_VERSION}-x64.tar.gz \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      &#x26;&#x26; cd /tmp/build \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; wget https://raw.githubusercontent.com/cujanovic/nginx-http2-spdy-patch/master/nginx-spdy-1.11.5%2B.patch -O nginx-spdy.patch \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; cd nginx-${NGINX_VERSION} \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; patch -p1 &#x3C; /tmp/build/nginx-spdy.patch \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; ./configure \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">       --with-threads \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">       --with-file-aio \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">       --with-ipv6 \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">       --with-http_ssl_module \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">       --with-http_spdy_module \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">       --with-http_v2_module \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">       --with-http_gzip_static_module \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">       --with-http_gunzip_module \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">       --with-http_stub_status_module \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">       --with-http_sub_module \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">       --add-module=/tmp/build/ngx_pagespeed-${NPS_VERSION}-beta \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">       --add-module=/tmp/build/nginx-ct \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">       --add-module=/tmp/build/ngx_brotli \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">       --with-openssl=/tmp/build/openssl-${OPENSSL_VERSION} \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">       --with-cc-opt=</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">"-O3 -fPIE -fstack-protector-strong -Wformat -Werror=format-security -Wno-deprecated-declarations"</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; make \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; make install \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; cd / &#x26;&#x26; rm -rf /tmp/build \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; apt-get purge -y unzip git autoconf libtool wget automake build-essential \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; apt-get autoremove -y --purge \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    &#x26;&#x26; ln -sf /dev/stdout /usr/local/nginx/logs/access.log \</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">      &#x26;&#x26; ln -sf /dev/stderr /usr/local/nginx/logs/error.log</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">EXPOSE</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> 80 443</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">ADD</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> start.sh /start.sh</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">ENTRYPOINT</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000"> /bin/bash /start.sh</span></span></code></pre>
<p>这里涉及到一个问题，就是 nginx 默认后台运行。但是，一旦它后台运行，Docker 就认为它的主进程已经结束了，就把这个容器停掉了！因此，我们要用点小技巧。</p>
<p>start.sh 的内容如下：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000">#!/bin/bash</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">/usr/local/nginx/sbin/nginx</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">tail</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -F</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /usr/local/nginx/logs/access.log</span></span></code></pre>
<p><code>tail -F</code> 会不断地加载这个文件，并显示它的新内容。这个 start.sh 就是启动 nginx
并不断显示它的内容。只要 start.sh 不停，容器就能一直保持运行。</p>
<p>另外一点，在编译完之后，最好把编译环境和源代码都删掉，否则会无谓地增大镜像的占用空间。</p>
<p>开始构建：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">docker</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> build</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -t</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> lt-nginx</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> .</span></span></code></pre>
<p>向 docker-compose.yml 添加：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">lt-nginx</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  image</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">lt-nginx</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  container_name</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">lt-nginx</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  restart</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">: </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">always</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  volumes</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'./nginx:/usr/local/nginx/conf'</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # 配置文件</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'./www:/srv/www'</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # www 文件夹</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'/etc/timezone:/etc/timezone'</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # 时区</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'/etc/localtime:/etc/localtime'</span><span style="--shiki-dark:#6A9955;--shiki-light:#008000"> # 时区</span></span>
<span class="line"><span style="--shiki-dark:#569CD6;--shiki-light:#800000">  ports</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">:</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'80:80'</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">    - </span><span style="--shiki-dark:#CE9178;--shiki-light:#0000FF">'443:443'</span></span></code></pre>
<h2 id="结语">结语</h2>
<p>在上面，我们建立了 MariaDB、PHP-FPM、Nginx 三个容器。以后它们可以用
<code>docker-compose up -d</code> 统一启动，<code>docker-compose down</code> 统一关闭并删除，极大地方便了管理和部署。</p>  </div>  <div class="clearfix" id="post-navi" data-astro-cid-gfbmwgei=""> <div class="float-end text-end" data-astro-cid-gfbmwgei=""> <a href="/article/modify-computer/linux-memory-leak-check.lantian/" title="一次 Linux 内存泄漏的排查" data-astro-cid-gfbmwgei=""> 一次 Linux 内存泄漏的排查 </a> <br data-astro-cid-gfbmwgei=""> 下一篇文章 »
</div> <div class="float-start text-start position-absolute" data-astro-cid-gfbmwgei="">
« 上一篇文章 <br data-astro-cid-gfbmwgei=""> <a href="/article/modify-website/mailgun-typecho-comment-email-notification.lantian/" title="基于 Mailgun 的 Typecho 评论邮件提醒插件" data-astro-cid-gfbmwgei=""> 基于 Mailgun 的 Typecho 评论邮件提醒插件 </a> </div> </div>  <div id="waline" data-waline-language="zh-CN" data-waline-path="/article/modify-website/migrate-website-docker.lantian"></div> <script type="module" src="/assets/WalineComment.astro_astro_type_script_index_0_lang.Dqib3X1E.js"></script>  </div> </div> </article>  </div> <aside class="d-none d-xl-block"> <section class="widget"> <h3>最新文章</h3> <ul class="list-unstyled"> <li> 07-20  <a href="/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/">用 Open5GS 搭建合法的 LTE 网络</a> </li><li> 06-27  <a href="/article/modify-computer/sidestore-without-stosvpn-across-lan.lantian/">在内网中免 StosVPN 使用 SideStore</a> </li><li> 05-19  <a href="/article/modify-computer/nix-logarithmetic-math-library-from-zero.lantian/">从零开始实现 Nix 对数函数库</a> </li><li> 04-06  <a href="/article/modify-computer/legal-lte-network-at-home-for-100-bucks.lantian/">$100，DIY 搭建合法的 LTE 网络</a> </li><li> 02-10  <a href="/article/modify-computer/build-custom-android-kernel-with-nix.lantian/">用 Nix 编译自定义 Android 内核</a> </li><li> 04-20  <a href="/article/modify-website/migrate-blog-to-astro-js.lantian/">使用 Astro.js 重构我的博客</a> </li><li> 12-16  <a href="/article/modify-computer/nixos-low-ram-vps.lantian/">NixOS 系列（五）：制作小内存 VPS 的 DD 磁盘镜像</a> </li><li> 09-20  <a href="/article/modify-computer/nix-trigonometric-math-library-from-zero.lantian/">从零开始实现 Nix 三角函数库</a> </li><li> 05-29  <a href="/article/random-notes/pipewire-sigkill-fix.lantian/">解决 Pipewire 被 SIGKILL 的问题</a> </li><li> 05-12  <a href="/article/modify-website/how-to-kill-the-dn42-network.lantian/">如何引爆 DN42 网络（2023-05-12 更新）</a> </li><li> 05-08  <a href="/article/modify-computer/laptop-muxed-nvidia-passthrough.lantian/">Optimus MUXed 笔记本上的 NVIDIA 虚拟机显卡直通（2023-05 更新）</a> </li><li> 04-17  <a href="/article/random-notes/fix-china-telecom-roaming-no-4g-on-aosp-rom.lantian/">修改 APN 解决 AOSP ROM 上中国电信无法 4G 漫游问题</a> </li><li> 03-26  <a href="/article/random-notes/old-hp-workstation-as-all-in-one.lantian/">老款 HP 工作站配置 NAS+软路由笔记</a> </li><li> 01-14  <a href="/article/modify-computer/nixos-impermanence.lantian/">NixOS 系列（四）：“无状态”操作系统</a> </li><li> 06-21  <a href="/article/modify-computer/nixos-packaging.lantian/">NixOS 系列（三）：软件打包，从入门到放弃</a> </li> </ul> </section> <section class="widget"> <h3>最新评论</h3> <ul class="list-unstyled" id="recent-comments">  <li><a href="#">Loading...</a></li>  </ul> </section> <script type="module">const i=window.location.hostname=="localhost"?"https://comments.lantian.pub":window.location.origin;fetch(`${i}/api/comment?type=recent&count=10`).then(t=>{if(t.status!==200)throw new Error(`Server returned bad HTTP status ${t.status}`);return t.json()}).then(t=>{const e=document.getElementById("recent-comments");e&&(e.innerHTML=t.data.map(n=>{const o=n.comment.replace(/(<([^>]+)>)/gi,"");return"<li>"+n.nick+' <a href="'+n.url+'">'+o+"</a></li>"}).join(""))});</script> <section class="widget"> <h3>其它功能</h3> <ul class="list-unstyled">  <li> <i class="fas fa-fw fa-rss"></i>  <a href="/rss2.xml" target="_blank">RSS 订阅</a> |  <a href="/feed.xml" target="_blank">Atom</a> |  <a href="/feed.json" target="_blank">JSON</a> </li> <li> <i class="fas fa-fw fa-globe"></i>  <a href="https://stats.uptimerobot.com/BLK6VsRkR" target="_blank"> 服务器状态 </a> </li> <li> <i class="fas fa-fw fa-sitemap"></i>  <a href="https://lg.lantian.pub" target="_blank">DN42 节点状态</a> </li> <li> <i class="fas fa-fw fa-link"></i>  <a href="gopher://lantian.pub" target="_blank">使用 Gopher 协议访问</a> </li>  </ul> </section> <section class="widget"> <h3>友情链接</h3> <ul class="list-unstyled"> <li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://0x7f.cc"> 0x7f Blog 🐑 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://alanyhq.com"> Alanyhq </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.cas7.moe"> Blog of Moecast </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://jerryxiao.cc"> JerryXiao </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://snli.org"> Shucheng Li </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://sangsir.com"> SangSir | 艺术界的一朵奇葩 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://yuetau.net"> YuetAu&#39;s Spot </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.baoshuo.ren/?utm_source=friends"> 宝硕博客 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="http://foreverblog.cn"> 十年之约 </a> </li> </ul> </section> </aside> </div> <footer class="lantian clearfix" data-astro-cid-w3csb3e3="">  <div id="copyright" class="float-end text-end" data-astro-cid-w3csb3e3=""> <i class="fas fa-copyright" data-astro-cid-w3csb3e3=""></i> 2012-2025 Lan Tian @ Blog<br data-astro-cid-w3csb3e3=""> <small data-astro-cid-w3csb3e3=""> 基于 Astro v5.15.1 构建 @ 2025-10-25 23:46:35 </small> </div> <script type="module">function v(c,o,r){const h=/^localhost$|^127(?:\.[0-9]+){0,2}\.[0-9]+$|^(?:0*:)*?:?0*1$/.test(location.hostname)||location.protocol==="file:";if(!o.trackLocalhost&&h)return console.warn("[Plausible] Ignoring event because website is running locally");try{if(window.localStorage.plausible_ignore==="true")return console.warn('[Plausible] Ignoring event because "plausible_ignore" is set to "true" in localStorage')}catch{}const p={n:c,u:o.url,d:o.domain,r:o.referrer,w:o.deviceWidth,h:o.hashMode?1:0,p:r&&r.props?JSON.stringify(r.props):void 0},s=new XMLHttpRequest;s.open("POST",`${o.apiHost}/api/event`,!0),s.setRequestHeader("Content-Type","text/plain"),s.send(JSON.stringify(p)),s.onreadystatechange=()=>{s.readyState===4&&r&&r.callback&&r.callback()}}function b(c){const o=()=>({hashMode:!1,trackLocalhost:!1,url:location.href,domain:location.hostname,referrer:document.referrer||null,deviceWidth:window.innerWidth,apiHost:"https://plausible.io",...c}),r=(t,n,i)=>{v(t,{...o(),...i},n)},h=(t,n)=>{r("pageview",n,t)};return{trackEvent:r,trackPageview:h,enableAutoPageviews:()=>{const t=()=>h(),n=history.pushState;return n&&(history.pushState=function(i,l,u){n.apply(this,[i,l,u]),t()},addEventListener("popstate",t)),c&&c.hashMode&&addEventListener("hashchange",t),h(),function(){n&&(history.pushState=n,removeEventListener("popstate",t)),c&&c.hashMode&&removeEventListener("hashchange",t)}},enableAutoOutboundTracking:(t=document,n={subtree:!0,childList:!0,attributes:!0,attributeFilter:["href"]})=>{function i(e){r("Outbound Link: Click",{props:{url:this.href}}),typeof process<"u"&&process,setTimeout(()=>{location.href=this.href},150),e.preventDefault()}const l=new Set;function u(e){e instanceof HTMLAnchorElement?e.host!==location.host&&(e.addEventListener("click",i),l.add(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(u)}function f(e){e instanceof HTMLAnchorElement?(e.removeEventListener("click",i),l.delete(e)):"querySelectorAll"in e&&e.querySelectorAll("a").forEach(f)}const d=new MutationObserver(e=>{e.forEach(a=>{a.type==="attributes"?(f(a.target),u(a.target)):a.type==="childList"&&(a.addedNodes.forEach(u),a.removedNodes.forEach(f))})});return t.querySelectorAll("a").forEach(u),d.observe(t,n),function(){l.forEach(a=>{a.removeEventListener("click",i)}),l.clear(),d.disconnect()}}}}const g=b({domain:"lantian.pub",trackLocalhost:!0,apiHost:""});g.trackPageview();</script> </footer>  </div>  </body> </html>