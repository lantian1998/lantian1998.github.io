<!DOCTYPE html><html lang="zh-CN" itemscope="" itemtype="https://schema.org/Article" data-astro-cid-porej7z2=""> <head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>将 nginx 用作 DN42 WHOIS 服务器 - Lan Tian @ Blog</title><script>
  ;(() => {
    try {
      const mode = localStorage.getItem('user-color-scheme')
      if (mode == 'dark' || mode == 'light') {
        document.documentElement.setAttribute('data-user-color-scheme', mode)
      }
    } catch {
      // Ignore errors
    }
  })()
  ;(() => {
    window.lantianImageFallback = (img, src) => {
      img.onerror = null
      img.srcset = src
      img.src = src
      if (img.parentNode.nodeName.toLowerCase() === 'picture') {
        const picture = img.parentNode
        picture.innerHTML = ''
        picture.appendChild(img)
      }
    }
  })()
</script><link rel="stylesheet" href="/assets/index.CN3CN3hr.css"><style>.post-image-wrap[data-astro-cid-potdituc]{margin:0 -5px}.post-image-wrap[data-astro-cid-potdituc] img[data-astro-cid-potdituc]{height:150px;-o-object-fit:cover;object-fit:cover;-o-object-position:center;object-position:center}@media(min-width:768px){.post-image-wrap[data-astro-cid-potdituc]{padding:5px;float:right}.post-image-wrap[data-astro-cid-potdituc] img[data-astro-cid-potdituc]{max-width:200px}}@media(max-width:767.98px){.post-image-wrap[data-astro-cid-potdituc]{text-align:center}.post-image-wrap[data-astro-cid-potdituc] img[data-astro-cid-potdituc]{max-width:100%}}#post-navi[data-astro-cid-gfbmwgei]{padding:5px;border-top:1px solid var(--lt-border-weak);border-bottom:1px solid var(--lt-border-weak)}
</style><link rel="stylesheet" href="/assets/index.DC6W6NZY.css"><script type="module" src="/assets/PageLayout.astro_astro_type_script_index_0_lang.Co1i7321.js"></script><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Referrer-Policy" content="no-referrer, strict-origin-when-cross-origin"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="imagemode" content="force"><meta name="nightmode" content="disable"><meta name="wap-font-scale" content="no"><meta name="title" content="将 nginx 用作 DN42 WHOIS 服务器 - Lan Tian @ Blog"><meta name="keywords" content=""><meta name="author" content="Lan Tian"><link rel="canonical" href="https://lantian.pub/article/modify-website/serve-dn42-whois-with-nginx.lantian/"><link rel="alternate" type="application/rss+xml" title="Lan Tian @ Blog" href="https://lantian.pub/rss2.xml"><link rel="alternate" type="application/atom+xml" title="Lan Tian @ Blog" href="https://lantian.pub/feed.xml"><link rel="alternate" href="https://lantian.pub/article/modify-website/serve-dn42-whois-with-nginx.lantian/" hreflang="zh"><link rel="alternate" href="https://lantian.pub/en/article/modify-website/serve-dn42-whois-with-nginx.lantian/" hreflang="en"><meta name="copyright" content="Copyright 2012-2026 Lan Tian @ Blog"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#03a9f4"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#212121"><meta name="application-name" content="Lan Tian @ Blog"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="apple-touch-icon" sizes="1024x1024" href="/apple-touch-icon-1024x1024.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#03a9f4"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Lan Tian @ Blog"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-640x1136.png"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1136x640.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-750x1334.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1334x750.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1125x2436.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2436x1125.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1170x2532.png"><link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2532x1170.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1179x2556.png"><link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2556x1179.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-828x1792.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1792x828.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2688.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2688x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2208.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2208x1242.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1284x2778.png"><link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2778x1284.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1290x2796.png"><link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2796x1290.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1488x2266.png"><link rel="apple-touch-startup-image" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2266x1488.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1536x2048.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2048x1536.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1620x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1620.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1640x2160.png"><link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1640.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2388.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2388x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2224.png"><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2224x1668.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-2048x2732.png"><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2732x2048.png"><meta name="msapplication-TileColor" content="#bbdefb"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"><meta property="og:url" content="https://lantian.pub/article/modify-website/serve-dn42-whois-with-nginx.lantian/"><meta property="og:type" content="website"><meta property="og:title" content="将 nginx 用作 DN42 WHOIS 服务器 - Lan Tian @ Blog"><meta property="og:image" content="https://lantian.pub/apple-touch-icon.png"><meta content="在前一篇文章《 用 nginx 建立 Gopher 网站 》中我提到，用 nginx 提供 Gopher 服务只是魔改的副产物，我原本的计划是将 nginx 魔改成一个 WHOIS 服务器，用于 DN42。这篇文章将介绍详细过程。 WHOIS 协议 首先，我们可以找一个 WHOIS 服务器，来观察它都返回了哪些数据。以向 .pub 域名的 WHOIS 服务器查询我的域名信息为例，执行 telnet whois.nic.pub 43 ： # 输入下面一行并按回车 lantian.pub # WHOIS 服务器返回以下信息 Domain Name: lantian.pub Registry Domain ID: c69e5ccf9d834900be26f88fddc5c9e4-DONUTS Registrar WHOIS Server: whois.dnspod.cn Registrar URL: https://www.dnspod.cn Updated Date: 2021-01-07T14:09:11Z Creation Date: 2016-10-23T08:36:41Z Registry Expiry Date: 2029-10-23T08:36:41Z Registrar: DNSPod, Inc. # 略过部分内容 # 随后 WHOIS 服务器关闭连接 和 Gopher 一模一样，一问一答的协议。..."><meta property="og:site_name" content="Lan Tian @ Blog"><meta property="og:locale" content="zh"><meta name="twitter:card" content="summary"><meta name="twitter:url" content="https://lantian.pub/article/modify-website/serve-dn42-whois-with-nginx.lantian/"><meta name="twitter:title" content="将 nginx 用作 DN42 WHOIS 服务器 - Lan Tian @ Blog"><meta property="twitter:image" content="https://lantian.pub/apple-touch-icon.png"><meta content="在前一篇文章《 用 nginx 建立 Gopher 网站 》中我提到，用 nginx 提供 Gopher 服务只是魔改的副产物，我原本的计划是将 nginx 魔改成一个 WHOIS 服务器，用于 DN42。这篇文章将介绍详细过程。 WHOIS 协议 首先，我们可以找一个 WHOIS 服务器，来观察它都返回了哪些数据。以向 .pub 域名的 WHOIS 服务器查询我的域名信息为例，执行 telnet whois.nic.pub 43 ： # 输入下面一行并按回车 lantian.pub # WHOIS 服务器返回以下信息 Domain Name: lantian.pub Registry Domain ID: c69e5ccf9d834900be26f88fddc5c9e4-DONUTS Registrar WHOIS Server: whois.dnspod.cn Registrar URL: https://www.dnspod.cn Updated Date: 2021-01-07T14:09:11Z Creation Date: 2016-10-23T08:36:41Z Registry Expiry Date: 2029-10-23T08:36:41Z Registrar: DNSPod, Inc. # 略过部分内容 # 随后 WHOIS 服务器关闭连接 和 Gopher 一模一样，一问一答的协议。..."><meta name="twitter:dnt" content="on"><meta itemprop="name" content="将 nginx 用作 DN42 WHOIS 服务器 - Lan Tian @ Blog"><meta property="image" content="https://lantian.pub/apple-touch-icon.png"><meta content="在前一篇文章《 用 nginx 建立 Gopher 网站 》中我提到，用 nginx 提供 Gopher 服务只是魔改的副产物，我原本的计划是将 nginx 魔改成一个 WHOIS 服务器，用于 DN42。这篇文章将介绍详细过程。 WHOIS 协议 首先，我们可以找一个 WHOIS 服务器，来观察它都返回了哪些数据。以向 .pub 域名的 WHOIS 服务器查询我的域名信息为例，执行 telnet whois.nic.pub 43 ： # 输入下面一行并按回车 lantian.pub # WHOIS 服务器返回以下信息 Domain Name: lantian.pub Registry Domain ID: c69e5ccf9d834900be26f88fddc5c9e4-DONUTS Registrar WHOIS Server: whois.dnspod.cn Registrar URL: https://www.dnspod.cn Updated Date: 2021-01-07T14:09:11Z Creation Date: 2016-10-23T08:36:41Z Registry Expiry Date: 2029-10-23T08:36:41Z Registrar: DNSPod, Inc. # 略过部分内容 # 随后 WHOIS 服务器关闭连接 和 Gopher 一模一样，一问一答的协议。..."><meta content="在前一篇文章《 用 nginx 建立 Gopher 网站 》中我提到，用 nginx 提供 Gopher 服务只是魔改的副产物，我原本的计划是将 nginx 魔改成一个 WHOIS 服务器，用于 DN42。这篇文章将介绍详细过程。 WHOIS 协议 首先，我们可以找一个 WHOIS 服务器，来观察它都返回了哪些数据。以向 .pub 域名的 WHOIS 服务器查询我的域名信息为例，执行 telnet whois.nic.pub 43 ： # 输入下面一行并按回车 lantian.pub # WHOIS 服务器返回以下信息 Domain Name: lantian.pub Registry Domain ID: c69e5ccf9d834900be26f88fddc5c9e4-DONUTS Registrar WHOIS Server: whois.dnspod.cn Registrar URL: https://www.dnspod.cn Updated Date: 2021-01-07T14:09:11Z Creation Date: 2016-10-23T08:36:41Z Registry Expiry Date: 2029-10-23T08:36:41Z Registrar: DNSPod, Inc. # 略过部分内容 # 随后 WHOIS 服务器关闭连接 和 Gopher 一模一样，一问一答的协议。..."><link rel="me" href="https://mastodon.social/@lantian"></head> <body data-astro-cid-porej7z2=""> <div id="bg" data-astro-cid-j6vmxtef=""></div>   <div id="container" class="container" data-astro-cid-porej7z2=""> <nav class="lantian navbar navbar-expand-lg" data-astro-cid-wu5dj4rx=""> <div class="container-fluid" data-astro-cid-wu5dj4rx=""> <a class="navbar-brand" href="/" data-astro-cid-wu5dj4rx="">Lan Tian @ Blog</a> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#lantian-navbar" aria-controls="lantian-navbar" aria-expanded="false" aria-label="Toggle navigation" data-astro-cid-wu5dj4rx=""> <span class="navbar-toggler-icon" data-astro-cid-wu5dj4rx=""></span> </button> <div class="collapse navbar-collapse" id="lantian-navbar" data-astro-cid-wu5dj4rx=""> <ul class="navbar-nav" data-astro-cid-wu5dj4rx=""> <li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/page/archive/index.html" data-astro-cid-wu5dj4rx=""> 文章们 </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> 俯瞰地球 </a> </li><li class="nav-item d-none d-lg-block" data-astro-cid-wu5dj4rx=""> <a class="nav-link" href="/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> <li class="nav-item dropdown d-block d-lg-none" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="pages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-file" data-astro-cid-wu5dj4rx=""></i> 页面  <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="pages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/page/archive/index.html" data-astro-cid-wu5dj4rx=""> 文章们 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/page/himawari/index.html" data-astro-cid-wu5dj4rx=""> 俯瞰地球 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/page/dn42/index.html" data-astro-cid-wu5dj4rx=""> DN42 </a> </li> </ul> </li> </ul> <ul class="navbar-nav ms-auto" data-astro-cid-wu5dj4rx=""> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="languages-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-language" data-astro-cid-wu5dj4rx=""></i> Language <span class="caret" data-astro-cid-wu5dj4rx=""></span> </a> <ul class="dropdown-menu" aria-labelledby="languages-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item active" href="/article/modify-website/serve-dn42-whois-with-nginx.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-cn" data-astro-cid-wu5dj4rx=""></span> Chinese Simplified / 简体中文 </a> </li><li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item" href="/en/article/modify-website/serve-dn42-whois-with-nginx.lantian/" data-astro-cid-wu5dj4rx=""> <span class="flag-icon flag-icon-us" data-astro-cid-wu5dj4rx=""></span> English </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">Not all pages have translations.</a> </li> <li data-astro-cid-wu5dj4rx=""> <a class="dropdown-item disabled" href="#" data-astro-cid-wu5dj4rx="">You may see 404 - this is normal.</a> </li> </ul> </li> <li class="nav-item dropdown" data-astro-cid-wu5dj4rx=""> <a href="#" class="nav-link dropdown-toggle" id="color-scheme-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-astro-cid-wu5dj4rx=""> <i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> 夜间模式 </a> <ul class="dropdown-menu" aria-labelledby="color-scheme-dropdown" data-astro-cid-wu5dj4rx=""> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-auto" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-adjust" data-astro-cid-wu5dj4rx=""></i> 自动 </a> </li> <li data-astro-cid-wu5dj4rx=""><hr class="dropdown-divider" data-astro-cid-wu5dj4rx=""></li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-light" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-sun" data-astro-cid-wu5dj4rx=""></i> 浅色</a> </li> <li data-astro-cid-wu5dj4rx=""> <a id="color-scheme-dark" class="dropdown-item" href="#" data-astro-cid-wu5dj4rx=""><i class="fas fa-fw fa-moon" data-astro-cid-wu5dj4rx=""></i> 深色</a> </li> </ul> </li> </ul> </div> </div> </nav> <script type="module">const m="user-color-scheme",s="data-user-color-scheme",u=(e,t)=>{try{localStorage.setItem(e,t)}catch{}},i=e=>{try{return localStorage.getItem(e)}catch{return null}},c=e=>{const t={dark:!0,light:!0,auto:!0},o=e===null||!Object.keys(t).includes(e)?"auto":e;u(m,o);for(const l in t){const n=document.getElementById("color-scheme-"+l);n&&(l==o?n.classList.add("active"):n.classList.remove("active"))}o!="auto"?document.documentElement.setAttribute(s,o):document.documentElement.removeAttribute(s)};c(i(m));const r=document.getElementById("color-scheme-auto");r&&r.addEventListener("click",()=>c("auto"));const a=document.getElementById("color-scheme-light");a&&a.addEventListener("click",()=>c("light"));const d=document.getElementById("color-scheme-dark");d&&d.addEventListener("click",()=>c("dark"));</script>  <div class="d-flex" data-astro-cid-porej7z2=""> <div id="content" data-astro-cid-porej7z2="">  <article> <div class="d-flex"> <div class="post-info-wrap" data-astro-cid-dckccua4=""> <div class="post-info" data-astro-cid-dckccua4=""> <div class="post-meta-wrap" data-astro-cid-tde7heiu=""> <div class="post-meta" data-astro-cid-tde7heiu=""> <p data-astro-cid-tde7heiu=""> <span class="fas fa-clock" data-astro-cid-tde7heiu=""></span> <br data-astro-cid-tde7heiu=""> <small data-astro-cid-tde7heiu="">04-19</small> </p> <div class="post-meta-value" data-astro-cid-tde7heiu=""> 发布于<span class="badge badge-tag" data-astro-cid-dckccua4=""> 2021-04-19 02:12 </span>  </div> </div> </div>   <div class="post-meta-wrap" data-astro-cid-tde7heiu=""> <div class="post-meta" data-astro-cid-tde7heiu=""> <p data-astro-cid-tde7heiu=""> <span class="fas fa-file-alt" data-astro-cid-tde7heiu=""></span> <br data-astro-cid-tde7heiu=""> <small data-astro-cid-tde7heiu="">网站与服务端</small> </p> <div class="post-meta-value" data-astro-cid-tde7heiu=""> 分类 <a class="badge badge-tag" href="/category/modify-website" data-astro-cid-dckccua4=""> 网站与服务端 </a>  </div> </div> </div>   <div class="post-meta-wrap" data-astro-cid-tde7heiu=""> <div class="post-meta" data-astro-cid-tde7heiu=""> <p data-astro-cid-tde7heiu=""> <span class="fas fa-tag" data-astro-cid-tde7heiu=""></span> <br data-astro-cid-tde7heiu=""> <small data-astro-cid-tde7heiu="">3 标签</small> </p> <div class="post-meta-value" data-astro-cid-tde7heiu=""> 标签  <a class="badge badge-tag" href="/tag/nginx" data-astro-cid-dckccua4=""> nginx </a>  <a class="badge badge-tag" href="/tag/WHOIS" data-astro-cid-dckccua4=""> WHOIS </a>  <a class="badge badge-tag" href="/tag/DN42" data-astro-cid-dckccua4=""> DN42 </a>  </div> </div> </div>   <div class="post-meta-wrap" data-astro-cid-tde7heiu=""> <div class="post-meta" data-astro-cid-tde7heiu=""> <p data-astro-cid-tde7heiu=""> <span class="fas fa-list" data-astro-cid-tde7heiu=""></span> <br data-astro-cid-tde7heiu=""> <small data-astro-cid-tde7heiu="">目录</small> </p> <div class="post-meta-value" data-astro-cid-tde7heiu="">  <ol data-astro-cid-nj3qel45=""> <li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#whois-协议" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">WHOIS 协议</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#将查询进行分类" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">将查询进行分类</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#匹配最小-ip-段" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">匹配最小 IP 段</span> </a> </li><li class="toc-item toc-level-2" data-astro-cid-nj3qel45=""> <a class="toc-link" href="#效果" data-astro-cid-nj3qel45=""> <span class="toc-text" data-astro-cid-nj3qel45="">效果</span> </a> </li> </ol>   </div> </div> </div>   </div>  </div>  <div class="post-wrap">  <h1 class="post-title"> <a href="/article/modify-website/serve-dn42-whois-with-nginx.lantian/" rel="bookmark" title="将 nginx 用作 DN42 WHOIS 服务器">将 nginx 用作 DN42 WHOIS 服务器</a> </h1> <div class="post-text">   <p>在前一篇文章《<a href="/article/modify-website/serve-gopher-with-nginx.lantian/">用 nginx 建立 Gopher 网站</a>》中我提到，用 nginx 提供 Gopher 服务只是魔改的副产物，我原本的计划是将 nginx 魔改成一个 WHOIS 服务器，用于 DN42。这篇文章将介绍详细过程。</p>
<h2 id="whois-协议">WHOIS 协议</h2>
<p>首先，我们可以找一个 WHOIS 服务器，来观察它都返回了哪些数据。以向 <code>.pub</code> 域名的
WHOIS 服务器查询我的域名信息为例，执行 <code>telnet whois.nic.pub 43</code>：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 输入下面一行并按回车</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">lantian.pub</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># WHOIS 服务器返回以下信息</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Domain</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Name:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> lantian.pub</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Registry</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Domain</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ID:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> c69e5ccf9d834900be26f88fddc5c9e4-DONUTS</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Registrar</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> WHOIS</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Server:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> whois.dnspod.cn</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Registrar</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> URL:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> https://www.dnspod.cn</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Updated</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Date:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> 2021-01-07T14:09:11Z</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Creation</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Date:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> 2016-10-23T08:36:41Z</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Registry</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Expiry</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Date:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> 2029-10-23T08:36:41Z</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">Registrar:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> DNSPod,</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Inc.</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 略过部分内容</span></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 随后 WHOIS 服务器关闭连接</span></span></code></pre>
<p>和 Gopher 一模一样，一问一答的协议。所以建立 WHOIS 服务器可以直接沿用之前 Gopher
的代码，不需要再额外修改代码。</p>
<h2 id="将查询进行分类">将查询进行分类</h2>
<p>既然 nginx 已经支持了 WHOIS，下一步只需要加入数据。但是对于一个 WHOIS 服务器来说，「加入数据」并不简单。以 <a href="https://git.dn42.dev/dn42/registry" rel="noopener noreferrer" target="_blank">DN42 Registry</a>
为例，其中的数据被分为以下类别：</p>
<ul>
<li><code>as-block</code>：一段 ASN 的范围，代表每段编号的分配规则。</li>
<li><code>as-set</code>：ASN 的集合，由各个 AS 自行管理。在互联网上被用来标记每个 AS 的对等连接（Peer）和下游客户，以便自动化配置路由策略，但在 DN42 中没什么用。</li>
<li><code>aut-num</code>：ASN 本身的信息。</li>
<li><code>dns</code>：域名信息。</li>
<li><code>inet6num</code>：IPv6 地址块<strong>分配</strong>的信息，注意和路由信息不同。</li>
<li><code>inetnum</code>：IPv4 地址块分配的信息。</li>
<li><code>key-cert</code>：用户的 GPG 密钥，如果用户不想/不能把自己的 GPG 公钥传到 Keyserver
上，可以选择放在这里。</li>
<li><code>mntner</code>：网络所有者（Maintainer）的信息。</li>
<li><code>organisation</code>：组织的信息。例如，DN42 中有个大学教授，让他的学生来 DN42 接
Peer 作为网络实践，他和他的学生就可以组成一个 Organization。</li>
<li><code>person</code>：用户的信息。与 <code>mntner</code> 不同的是，这里更侧重于用户本人的联系方式。</li>
<li><code>registry</code>：各个「注册局」的信息，注册局就是像 RIPE、APNIC 这样的管理 IP、ASN 资源的机构。同时还有与 DN42 互联的网络的内容，例如 ChaosVPN 和 NeoNetwork。</li>
<li><code>role</code>：用户角色信息，用于分配权限，在 DN42 中不常用。</li>
<li><code>route</code>：IPv4 地址块的<strong>路由</strong>信息，一段地址可以被分拆成更小的块来发布路由。</li>
<li><code>route6</code>：IPv6 地址块的路由信息。</li>
<li><code>route-set</code>：定义了 DN42 占用的地址空间。</li>
<li><code>schema</code>：定义了 Registry 里各种文件的格式。</li>
<li><code>tinc-key</code>：Tinc VPN 的公钥。</li>
</ul>
<p>而用户查询时不会先输入类别信息，只会输入查询内容本身，例如
<code>lantian.dn42</code>，<code>172.22.76.185</code> 或 <code>LANTIAN-MNT</code>。幸运的是，DN42 中各种类别的文件格式都有对应的规律，可以据此判断查询类别，从而查找相应的文件夹。</p>
<blockquote>
<p>当然也没人拦着你把所有内容复制到同一个文件夹下，只是这样会把文件夹搞得一团乱就是了。</p>
</blockquote>
<p>于是我就写了一点点正则表达式：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([0-9]{1})$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /aut-num/AS424242000</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$1</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([0-9]{2})$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /aut-num/AS42424200</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$1</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([0-9]{3})$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /aut-num/AS4242420</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$1</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([0-9]{4})$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /aut-num/AS424242</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$1</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([Aa][Ss]|)([0-9]+)$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /aut-num/AS</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$2</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([0-9]+)\.([0-9]+)\.([0-9]+)\.([0-9]+)/([0-9]+)$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /inetnum/</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$1</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$2</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$3</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$4_$5</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([0-9]+)\.([0-9]+)\.([0-9]+)\.([0-9]+)$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /inetnum/</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$1</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$2</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$3</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">.</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$4_32</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([0-9a-fA-F:]+)/([0-9]+)$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /inet6num/</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$1_$2</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([0-9a-fA-F:]+)$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /inet6num/</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$1_128</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([^/]+)-([Dd][Nn]42)$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /person/</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$1</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">-DN42</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([^/]+)-([Mm][Nn][Tt])$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /mntner/</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$1</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">-MNT</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([^/]+)-([Ss][Cc][Hh][Ee][Mm][Aa])$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /schema/</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$1</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">-SCHEMA</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([Oo][Rr][Gg])-(.+)$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /organisation/ORG-</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$2</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([Ss][Ee][Tt])-(.+)-([Tt][Ii][Nn][Cc])$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /tinc-keyset/SET-</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$2</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">-TINC</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([^/]+)-([Tt][Ii][Nn][Cc])$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /tinc-key/</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$1</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">-TINC</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([Rr][Ss])-(.+)$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /route-set/RS-</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$2</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([Aa][Ss])([0-9]+)-([Aa][Ss])([0-9]+)$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /as-block/</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$1$2</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">-</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$3$4</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/[Aa][Ss](.+)$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /as-set/AS</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$1</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">rewrite</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/([^/]+)$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /dns/</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080">$1</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> last</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span></code></pre>
<p>还没完，因为 Linux ext4 文件系统是区分大小写的，如果 Registry 里的文件名是
<code>LANTIAN-MNT</code>，你查 <code>lantian-mnt</code> 就会 404。而 Linux 的 WHOIS 客户端会将所有查询转成小写，因此我们还要对每个文件夹转换 URL 的大小写，例如这样：</p>
<blockquote>
<p>这里我用了 Lua，因为 nginx 本身无法将 URL 转换大小写。</p>
<p>要使用 Lua，你需要用 <a href="https://openresty.org" rel="noopener noreferrer" target="_blank">OpenResty</a> 替换 nginx。</p>
</blockquote>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">location</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ~</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">*</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/(dns)/(.*)$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">    set_by_lua</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> $uri_norm</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "return '/' .. ngx.arg[1]:lower() .. '/' .. ngx.arg[2]:lower()"</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> $1</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> $2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">    try_files</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> $uri_norm</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> $uri</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> =</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">404</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">location</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> ~</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF">*</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "^/(aut-num|person|mntner|schema|organisation|tinc-keyset|tinc-key|as-set|route-set|as-block)/(.*)$"</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> {</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">    set_by_lua</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> $uri_norm</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "return '/' .. ngx.arg[1]:lower() .. '/' .. ngx.arg[2]:upper()"</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> $1</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> $2</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">    try_files</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> $uri_norm</span><span style="--shiki-dark:#9CDCFE;--shiki-light:#001080"> $uri</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> =</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">404</span><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">;</span></span>
<span class="line"><span style="--shiki-dark:#D4D4D4;--shiki-light:#000000">}</span></span></code></pre>
<h2 id="匹配最小-ip-段">匹配最小 IP 段</h2>
<p>上面的正则表达式和大小写转换可以处理 Registry 中的大部分内容，却缺失了最重要的一部分：IP 地址。用户查询的可能是单个 IP 地址，也可能是一个 IP 段，此时 WHOIS 服务器需要返回大于等于这个 IP 段大小的、同时包含查询 IP 的信息。假设我们的 Registry
里有这样三个 IP 段：</p>
<ul>
<li><code>192.168.0.0/16</code></li>
<li><code>192.168.16.0/20</code></li>
<li><code>192.168.18.0/24</code></li>
</ul>
<p>用户查询以下内容时就要被分到不同的 IP 段：</p>
<ul>
<li><code>192.168.18.18</code> -> <code>192.168.18.0/24</code></li>
<li><code>192.168.18.18/24</code> -> <code>192.168.18.0/24</code></li>
<li><code>192.168.18.18/20</code> -> <code>192.168.16.0/20</code></li>
<li><code>192.168.17.1</code> -> <code>192.168.16.0/20</code></li>
<li><code>192.168.17.1/16</code> -> <code>192.168.0.0/16</code></li>
</ul>
<p>这样的逻辑用正则表达式和大小写转换是无法完成的，我们需要用 Lua 写一些更复杂的逻辑，大概流程如下：</p>
<p><!--?xml version="1.0" encoding="UTF-8" standalone="no"?--><!-- Generated by graphviz version 14.1.2 (0)
 --><!-- Pages: 1 -->
<svg width="331pt" height="425pt" viewBox="0.00 0.00 331.00 425.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 420.8)">
<polygon fill="white" stroke="none" points="-4,4 -4,-420.8 327.19,-420.8 327.19,4 -4,4"></polygon><!-- S -->
<g id="node1" class="node">
<title>S</title>
<polygon fill="none" stroke="black" points="234.47,-416.8 180.47,-416.8 180.47,-380.8 234.47,-380.8 234.47,-416.8"></polygon>
<text xml:space="preserve" text-anchor="middle" x="207.47" y="-394.6" font-family="Times,serif" font-size="14.00">开始</text>
</g><!-- A -->
<g id="node2" class="node">
<title>A</title>
<polygon fill="none" stroke="black" points="269.92,-343.8 145.02,-343.8 145.02,-307.8 269.92,-307.8 269.92,-343.8"></polygon>
<text xml:space="preserve" text-anchor="middle" x="207.47" y="-321.6" font-family="Times,serif" font-size="14.00">计算 IP 段的第一个 IP</text>
</g><!-- S&#45;&gt;A -->
<g id="edge1" class="edge">
<title>S->A</title>
<path fill="none" stroke="black" d="M207.47,-380.61C207.47,-373.03 207.47,-363.9 207.47,-355.34"></path>
<polygon fill="black" stroke="black" points="210.97,-355.34 207.47,-345.34 203.97,-355.34 210.97,-355.34"></polygon>
</g><!-- B -->
<g id="node3" class="node">
<title>B</title>
<polygon fill="none" stroke="black" points="323.19,-270.8 91.74,-270.8 91.74,-234.8 323.19,-234.8 323.19,-270.8"></polygon>
<text xml:space="preserve" text-anchor="middle" x="207.47" y="-248.6" font-family="Times,serif" font-size="14.00">从用户输入 IP 段大小 n（默认 32）开始递减</text>
</g><!-- A&#45;&gt;B -->
<g id="edge2" class="edge">
<title>A->B</title>
<path fill="none" stroke="black" d="M207.47,-307.61C207.47,-300.03 207.47,-290.9 207.47,-282.34"></path>
<polygon fill="black" stroke="black" points="210.97,-282.34 207.47,-272.34 203.97,-282.34 210.97,-282.34"></polygon>
</g><!-- C -->
<g id="node4" class="node">
<title>C</title>
<polygon fill="none" stroke="black" points="206.93,-197.8 0,-197.8 0,-161.8 206.93,-161.8 206.93,-197.8"></polygon>
<text xml:space="preserve" text-anchor="middle" x="103.47" y="-175.6" font-family="Times,serif" font-size="14.00">只保留 IP 的前 n 位，后 (32-n) 位清零</text>
</g><!-- B&#45;&gt;C -->
<g id="edge3" class="edge">
<title>B->C</title>
<path fill="none" stroke="black" d="M182.03,-234.43C168.93,-225.49 152.77,-214.46 138.51,-204.72"></path>
<polygon fill="black" stroke="black" points="140.49,-201.84 130.26,-199.09 136.54,-207.62 140.49,-201.84"></polygon>
</g><!-- D -->
<g id="node5" class="node">
<title>D</title>
<polygon fill="none" stroke="black" points="172.47,-124.8 65.81,-106.8 172.47,-88.8 279.13,-106.8 172.47,-124.8"></polygon>
<text xml:space="preserve" text-anchor="middle" x="172.47" y="-102.6" font-family="Times,serif" font-size="14.00">IP/位数 文件存在？</text>
</g><!-- C&#45;&gt;D -->
<g id="edge4" class="edge">
<title>C->D</title>
<path fill="none" stroke="black" d="M120.17,-161.61C129.27,-152.25 140.64,-140.55 150.46,-130.45"></path>
<polygon fill="black" stroke="black" points="152.73,-133.13 157.19,-123.52 147.71,-128.25 152.73,-133.13"></polygon>
</g><!-- D&#45;&gt;B -->
<g id="edge6" class="edge">
<title>D->B</title>
<path fill="none" stroke="black" d="M188.41,-122.13C198.29,-132.14 210.09,-146.41 215.47,-161.8 222.39,-181.6 219.9,-205.27 215.94,-223.36"></path>
<polygon fill="black" stroke="black" points="212.59,-222.34 213.57,-232.88 219.38,-224.02 212.59,-222.34"></polygon>
<text xml:space="preserve" text-anchor="middle" x="225.07" y="-175.6" font-family="Times,serif" font-size="14.00">否</text>
</g><!-- E -->
<g id="node6" class="node">
<title>E</title>
<polygon fill="none" stroke="black" points="227.72,-36 117.22,-36 117.22,0 227.72,0 227.72,-36"></polygon>
<text xml:space="preserve" text-anchor="middle" x="172.47" y="-13.8" font-family="Times,serif" font-size="14.00">读取文件，返回结果</text>
</g><!-- D&#45;&gt;E -->
<g id="edge5" class="edge">
<title>D->E</title>
<path fill="none" stroke="black" d="M172.47,-88.65C172.47,-76.96 172.47,-61.19 172.47,-47.62"></path>
<polygon fill="black" stroke="black" points="175.97,-47.92 172.47,-37.92 168.97,-47.92 175.97,-47.92"></polygon>
<text xml:space="preserve" text-anchor="middle" x="177.72" y="-58.2" font-family="Times,serif" font-size="14.00">是</text>
</g>
</g>
</svg>
</p>
<p>简单来说，就是从 /32，/31 暴力查下去，直到查找到目标为止。这样查询的效率并不高，但优点是不需要对 Registry 的数据做任何预处理或者缓存。</p>
<p>详细代码可以在<a href="https://gist.github.com/xddxdd/53efacf5b750c0f38759beff8e7b070d" rel="noopener noreferrer" target="_blank">这个 GitHub Gist</a>看到。</p>
<h2 id="效果">效果</h2>
<p>我的 WHOIS 服务器已经部署在我的<a href="/page/dn42/">所有 DN42 节点上</a>，可以从公网或
DN42 进行查询：</p>
<pre class="shiki shiki-themes dark-plus light-plus" style="--shiki-dark:#D4D4D4;--shiki-light:#000000;--shiki-dark-bg:#1E1E1E;--shiki-light-bg:#FFFFFF" tabindex="0"><code><span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># 用户输入命令</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">whois</span><span style="--shiki-dark:#569CD6;--shiki-light:#0000FF"> -h</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 185.186.147.110</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> "172.22.76.185"</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#6A9955;--shiki-light:#008000"># WHOIS 结果返回</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">%</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Lan</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Tian</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Nginx-based</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> WHOIS</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Server</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Lua</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Logic</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">%</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> GET</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> /172.22.76.185</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">inetnum:</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658">            172.22.76.184</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> -</span><span style="--shiki-dark:#B5CEA8;--shiki-light:#098658"> 172.22.76.191</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">netname:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">            LANTIAN-IPV4</span></span>
<span class="line"><span style="--shiki-dark:#DCDCAA;--shiki-light:#795E26">descr:</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">              Lan</span><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"> Tian's IP space</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">remarks:            My network is open to peering; see https://lantian.pub/page/dn42</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">remarks:            or directly contact me at dn42@lantian.pub</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515">country:            CN</span></span>
<span class="line"><span style="--shiki-dark:#CE9178;--shiki-light:#A31515"># 下略</span></span></code></pre>
<p>你可以自行尝试用上述 WHOIS 服务器查询 DN42 内的 IP、域名、用户等信息。</p>  </div>  <script type="module" src="/assets/WalineComment.astro_astro_type_script_index_0_lang.Cd-Au78J.js"></script> <div class="clearfix" id="post-navi" data-astro-cid-gfbmwgei=""> <div class="float-end text-end" data-astro-cid-gfbmwgei=""> <a href="/article/modify-website/serve-gopher-with-nginx.lantian/" title="用 nginx 建立 Gopher 网站" data-astro-cid-gfbmwgei=""> 用 nginx 建立 Gopher 网站 </a> <br data-astro-cid-gfbmwgei=""> 下一篇文章 »
</div> <div class="float-start text-start position-absolute" data-astro-cid-gfbmwgei="">
« 上一篇文章 <br data-astro-cid-gfbmwgei=""> <a href="/article/modify-website/dn42-experimental-network-2020.lantian/" title="DN42 实验网络介绍及注册教程（2022-12 更新）" data-astro-cid-gfbmwgei=""> DN42 实验网络介绍及注册教程（2022-12 更新） </a> </div> </div>  <div id="waline" data-waline-language="zh-CN" data-waline-path="/article/modify-website/serve-dn42-whois-with-nginx.lantian"></div>   </div> </div> </article>  </div> <aside class="d-none d-xl-block" data-astro-cid-porej7z2=""> <section class="widget"> <h3>最新文章</h3> <ul class="list-unstyled"> <li> 12-07  <a href="/article/modify-website/dn42-flapalerted-reduce-flapping.lantian/">在 DN42 中使用 FlapAlerted 抑制 Flapping</a> </li><li> 07-20  <a href="/article/modify-computer/legal-lte-network-at-home-with-open5gs.lantian/">用 Open5GS 搭建合法的 LTE 网络</a> </li><li> 06-27  <a href="/article/modify-computer/sidestore-without-stosvpn-across-lan.lantian/">在内网中免 StosVPN 使用 SideStore</a> </li><li> 05-19  <a href="/article/modify-computer/nix-logarithmetic-math-library-from-zero.lantian/">从零开始实现 Nix 对数函数库</a> </li><li> 04-06  <a href="/article/modify-computer/legal-lte-network-at-home-for-100-bucks.lantian/">$100，DIY 搭建合法的 LTE 网络</a> </li><li> 02-10  <a href="/article/modify-computer/build-custom-android-kernel-with-nix.lantian/">用 Nix 编译自定义 Android 内核</a> </li><li> 04-20  <a href="/article/modify-website/migrate-blog-to-astro-js.lantian/">使用 Astro.js 重构我的博客</a> </li><li> 12-16  <a href="/article/modify-computer/nixos-low-ram-vps.lantian/">NixOS 系列（五）：制作小内存 VPS 的 DD 磁盘镜像</a> </li><li> 09-20  <a href="/article/modify-computer/nix-trigonometric-math-library-from-zero.lantian/">从零开始实现 Nix 三角函数库</a> </li><li> 05-29  <a href="/article/random-notes/pipewire-sigkill-fix.lantian/">解决 Pipewire 被 SIGKILL 的问题</a> </li><li> 05-12  <a href="/article/modify-website/how-to-kill-the-dn42-network.lantian/">如何引爆 DN42 网络（2023-05-12 更新）</a> </li><li> 05-08  <a href="/article/modify-computer/laptop-muxed-nvidia-passthrough.lantian/">Optimus MUXed 笔记本上的 NVIDIA 虚拟机显卡直通（2023-05 更新）</a> </li><li> 04-17  <a href="/article/random-notes/fix-china-telecom-roaming-no-4g-on-aosp-rom.lantian/">修改 APN 解决 AOSP ROM 上中国电信无法 4G 漫游问题</a> </li><li> 03-26  <a href="/article/random-notes/old-hp-workstation-as-all-in-one.lantian/">老款 HP 工作站配置 NAS+软路由笔记</a> </li><li> 01-14  <a href="/article/modify-computer/nixos-impermanence.lantian/">NixOS 系列（四）：“无状态”操作系统</a> </li> </ul> </section>  <section class="widget"> <h3>最新评论</h3> <ul class="list-unstyled" id="recent-comments">  <li><a href="#">Loading...</a></li>  </ul> </section>  <script type="module" src="/assets/WalineRecentComments.astro_astro_type_script_index_0_lang.Cu-GBWyK.js"></script> <section class="widget"> <h3>其它功能</h3> <ul class="list-unstyled">  <li> <i class="fas fa-fw fa-rss"></i>  <a href="/rss2.xml" target="_blank">RSS 订阅</a> |  <a href="/feed.xml" target="_blank">Atom</a> |  <a href="/feed.json" target="_blank">JSON</a> </li> <li> <i class="fas fa-fw fa-globe"></i>  <a href="https://stats.uptimerobot.com/NLYPbrSal6" target="_blank"> 服务器状态 </a> </li> <li> <i class="fas fa-fw fa-sitemap"></i>  <a href="https://lg.lantian.pub" target="_blank">DN42 节点状态</a> </li> <li> <i class="fas fa-fw fa-link"></i>  <a href="gopher://lantian.pub" target="_blank">使用 Gopher 协议访问</a> </li>  </ul> </section>  <section class="widget"> <h3>友情链接</h3> <ul class="list-unstyled"> <li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://0x7f.cc"> 0x7f Blog 🐑 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://alanyhq.com"> Alanyhq </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.cas7.moe"> Blog of Moecast </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://jerryxiao.cc"> JerryXiao </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://snli.org"> Shucheng Li </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://sangsir.com"> SangSir | 艺术界的一朵奇葩 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://yuetau.net"> YuetAu&#39;s Spot </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="https://blog.baoshuo.ren/?utm_source=friends"> 宝硕博客 </a> </li><li> <i class="fas fa-fw fa-link"></i>  <a target="_blank" href="http://foreverblog.cn"> 十年之约 </a> </li> </ul> </section>  </aside> </div> <footer class="clearfix" data-astro-cid-w3csb3e3="">  <div id="copyright" class="float-end text-end" data-astro-cid-w3csb3e3=""> <i class="fas fa-copyright" data-astro-cid-w3csb3e3=""></i> 2012-2026 Lan Tian @ Blog<br data-astro-cid-w3csb3e3=""> <small data-astro-cid-w3csb3e3=""> 基于 Astro v5.17.1 构建 @ 2026-02-12 02:27:04 </small> </div> <script type="module" src="/assets/PlausibleAnalytics.astro_astro_type_script_index_0_lang.C6V0cCkY.js"></script> </footer>  </div>  </body> </html>